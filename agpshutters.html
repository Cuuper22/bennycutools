<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ShutterBid - Affordable Glass Protection</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--navy:#263D64;--navy-light:#2E4A78;--navy-dark:#1A2D4A;
--blue:#023990;--blue-glow:rgba(2,57,144,.12);
--white:#FFFFFF;--offwhite:#F6F7F9;--light:#ECEEF2;
--dark:#111827;--mid:#6B7280;--border:#D1D5DB;
--green:#059669;--green-bg:#ECFDF5;
--orange:#D97706;--orange-bg:#FFFBEB;
--red:#DC2626;--red-bg:#FEF2F2;
--shadow-sm:0 1px 2px rgba(0,0,0,.05);
--shadow-md:0 4px 12px rgba(0,0,0,.08),0 2px 4px rgba(0,0,0,.04);
--shadow-lg:0 12px 32px rgba(0,0,0,.1),0 4px 8px rgba(0,0,0,.06);
--radius:12px;--radius-sm:8px;
}
html{font-size:16px;-webkit-tap-highlight-color:transparent}
body{font-family:'Roboto',sans-serif;color:var(--dark);background:var(--offwhite);min-height:100vh;padding-bottom:120px;overflow-x:hidden;-webkit-font-smoothing:antialiased}
h1,h2,h3,h4{font-family:'Inter',sans-serif;line-height:1.25}
h1{font-size:1.5rem;font-weight:700}h2{font-size:1.2rem;font-weight:700}h3{font-size:1rem;font-weight:600}
button{font-family:inherit;cursor:pointer;border:none;background:none;font-size:inherit}
input,select,textarea{font-family:inherit;font-size:1rem}
.skip-link{position:absolute;top:-40px;left:0;background:var(--navy);color:#fff;padding:8px 16px;z-index:10000;font-size:.875rem}
.skip-link:focus{top:0}

/* Header */
.header{background:var(--navy);color:#fff;padding:14px 16px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.header .shield{width:30px;height:30px;flex-shrink:0}
.header h1{font-size:1.05rem;flex:1}

/* Views */
.view{display:none;padding:16px;animation:fadeUp .35s ease-out both}
.view.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* Cards */
.card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow-sm);padding:20px;margin-bottom:16px;border:1px solid var(--light)}

/* Buttons */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:13px 22px;border-radius:var(--radius-sm);font-weight:600;font-size:.9rem;transition:transform .15s,box-shadow .2s,background .15s;min-height:48px;font-family:'Inter',sans-serif}
.btn:active{transform:scale(.97)}
.btn svg{width:18px;height:18px;flex-shrink:0}
.btn-primary{background:var(--navy);color:#fff;box-shadow:var(--shadow-sm)}
.btn-primary:hover{background:var(--navy-light);box-shadow:var(--shadow-md)}
.btn-accent{background:var(--blue);color:#fff;box-shadow:0 2px 8px rgba(2,57,144,.25)}
.btn-accent:hover{box-shadow:0 4px 16px rgba(2,57,144,.3)}
.btn-outline{border:2px solid var(--navy);color:var(--navy)}
.btn-outline:hover{background:var(--navy);color:#fff}
.btn-ghost{color:var(--mid);padding:8px}
.btn-ghost:hover{color:var(--dark);background:rgba(0,0,0,.04)}
.btn-full{width:100%}
.btn-sm{padding:8px 14px;font-size:.8rem;min-height:36px}
.btn-disabled{opacity:.35;pointer-events:none;background:#D1D5DB;color:#9CA3AF}
*:focus-visible{outline:2px solid var(--blue);outline-offset:2px}
*:focus:not(:focus-visible){outline:none}

/* Forms */
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:.75rem;font-weight:600;color:var(--mid);margin-bottom:5px;text-transform:uppercase;letter-spacing:.6px;font-family:'Inter',sans-serif}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:.95rem;background:var(--white);transition:border-color .2s,box-shadow .2s}
.form-group input:focus,.form-group select:focus{border-color:var(--blue);box-shadow:0 0 0 3px var(--blue-glow)}
.form-group select{-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='%236B7280' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center}

/* Opening Rows */
.opening-row{padding:14px 0;border-bottom:1px solid var(--light);display:flex;gap:10px;align-items:flex-start}
.opening-row:last-child{border-bottom:none}
.opening-icon{width:40px;height:40px;border-radius:8px;background:var(--offwhite);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.opening-icon svg{width:20px;height:20px;stroke:var(--navy);fill:none;stroke-width:1.5}
.opening-details{flex:1;min-width:0}
.opening-details h4{font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.opening-details .meta{font-size:.78rem;color:var(--mid);margin-top:2px}
.opening-details .shutter-badge{display:inline-block;font-size:.7rem;font-weight:600;padding:2px 8px;border-radius:4px;background:var(--navy);color:#fff;margin-top:4px;font-family:'Inter',sans-serif}
.opening-price{font-family:'Inter',sans-serif;font-weight:700;font-size:.95rem;white-space:nowrap;text-align:right}
.opening-actions button{width:32px;height:32px;border-radius:6px;display:flex;align-items:center;justify-content:center}
.opening-actions button:hover{background:rgba(0,0,0,.06)}
.opening-actions svg{width:16px;height:16px;stroke:var(--mid);fill:none;stroke-width:2;stroke-linecap:round}

/* Summary */
.total-bar{background:linear-gradient(135deg,var(--navy) 0%,var(--blue) 100%);color:#fff;padding:18px 20px;border-radius:var(--radius);display:flex;align-items:center;justify-content:space-between;margin:16px 0;box-shadow:0 4px 16px rgba(38,61,100,.3)}
.total-bar .amount{font-family:'Inter',sans-serif;font-size:2rem;font-weight:800}
.total-bar .label{font-size:.75rem;opacity:.7;text-transform:uppercase;letter-spacing:.5px}

/* Grant callout */
.grant-box{background:var(--green-bg);border:1px solid #A7F3D0;border-radius:var(--radius-sm);padding:14px 16px;margin:12px 0;display:flex;align-items:flex-start;gap:10px}
.grant-box svg{width:20px;height:20px;stroke:var(--green);flex-shrink:0;fill:none;stroke-width:2;margin-top:2px}
.grant-box .text{font-size:.85rem;color:#065F46}
.grant-box .text strong{color:#047857}

/* Project cards */
.project-card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow-sm);border:1px solid var(--light);padding:16px;margin-bottom:12px;cursor:pointer;transition:box-shadow .2s,transform .15s}
.project-card:hover{box-shadow:var(--shadow-md);transform:translateY(-1px)}
.project-card h4{font-size:.95rem}
.project-card .meta{font-size:.8rem;color:var(--mid);margin-top:3px}
.project-card .bottom{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
.project-card .price{font-family:'Inter',sans-serif;font-weight:700;font-size:1.05rem}
.status-badge{font-size:.7rem;font-weight:600;padding:3px 10px;border-radius:20px;font-family:'Inter',sans-serif}
.status-estimated{background:var(--orange-bg);color:var(--orange)}
.status-sold{background:var(--green-bg);color:var(--green)}
.status-installed{background:var(--offwhite);color:var(--mid)}

/* Upsell */
.upsell{background:var(--offwhite);border:2px dashed var(--border);border-radius:var(--radius);padding:20px;text-align:center;margin:16px 0}
.upsell h4{color:var(--mid);margin-bottom:6px}
.upsell p{font-size:.82rem;color:#9CA3AF;margin-bottom:10px}

/* Toast */
.toast-wrap{position:fixed;top:70px;right:16px;z-index:9999}
.toast{background:var(--dark);color:#fff;padding:12px 18px;border-radius:var(--radius-sm);box-shadow:var(--shadow-lg);font-size:.85rem;display:flex;align-items:center;gap:8px;animation:slideIn .3s ease-out;margin-bottom:8px}
@keyframes slideIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}

/* Bottom nav */
nav.tabs{position:fixed;bottom:0;left:0;right:0;background:var(--white);border-top:1px solid var(--light);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom)}
nav.tabs button{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 0 6px;font-size:.62rem;font-weight:600;color:var(--mid);transition:color .15s;min-height:54px;gap:2px;font-family:'Inter',sans-serif}
nav.tabs button svg{width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
nav.tabs button.active{color:var(--navy)}
nav.tabs button.active svg{stroke:var(--navy)}

/* Demo banner */
.demo-banner{background:#FFF3CD;border-bottom:1px solid #FFEAA7;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;font-size:.82rem;color:#856404}
.demo-banner button{font-size:1.1rem;color:#856404;padding:4px 8px;border-radius:4px}
.demo-banner button:hover{background:rgba(0,0,0,.05)}

@media print{nav.tabs,.header,.demo-banner,#bct-demo-disclaimer,.btn,.upsell{display:none!important}body{padding:0;background:#fff}.view{display:block!important}.card{box-shadow:none;border:1px solid #ddd}}
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:.01ms!important;transition-duration:.01ms!important}}
@media(min-width:768px){.view{max-width:600px;margin:0 auto}nav.tabs{max-width:600px;left:50%;transform:translateX(-50%);border-radius:12px 12px 0 0}}
</style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to content</a>

<div class="demo-banner" id="demoBanner" role="alert" style="display:none">
  <span>Sample data for Melbourne, FL. Tap X to clear and add your own.</span>
  <button onclick="clearDemo()" aria-label="Clear demo data">X</button>
</div>

<div class="header" role="banner">
  <svg class="shield" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
  <h1>ShutterBid</h1>
</div>

<div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

<main id="main-content">

<!-- VIEW: Projects List -->
<section class="view active" id="viewProjects" role="region" aria-label="Projects">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
    <h2>Projects</h2>
    <button class="btn btn-primary btn-sm" onclick="newProject()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      New Project
    </button>
  </div>
  <div id="projectsList"></div>
</section>

<!-- VIEW: Project Builder -->
<section class="view" id="viewBuilder" role="region" aria-label="Project builder">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
    <button class="btn-ghost" onclick="backToProjects()" aria-label="Back"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <h2 id="builderTitle">New Project</h2>
  </div>

  <div class="card">
    <h3 style="margin-bottom:10px">Customer</h3>
    <div class="form-group"><label for="pName">Name</label><input type="text" id="pName" placeholder="Maria Rodriguez"></div>
    <div class="form-group"><label for="pAddr">Property Address</label><input type="text" id="pAddr" placeholder="4820 Croton Dr, Melbourne, FL"></div>
    <div class="form-group"><label for="pPhone">Phone</label><input type="tel" id="pPhone" placeholder="(321) 555-0142"></div>
  </div>

  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
      <h3>Openings</h3>
      <button class="btn btn-sm btn-accent" onclick="showAddOpening()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add
      </button>
    </div>
    <div id="openingsList"></div>
    <div id="noOpenings" style="text-align:center;padding:24px;color:var(--mid);font-size:.85rem">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#D1D5DB" stroke-width="1" style="display:block;margin:0 auto 8px"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
      Tap "Add" to start adding windows and doors
    </div>
  </div>

  <div class="grant-box" id="grantBox" style="display:none">
    <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
    <div class="text">
      <strong>My Safe Florida Home Eligible</strong><br>
      This project may qualify for up to $10,000 in state grants, bringing the customer's out-of-pocket to <strong id="grantNet">$0</strong>.
    </div>
  </div>

  <div class="total-bar">
    <div><div class="label">Project Total</div><div class="amount" id="totalAmt">$0</div></div>
    <div style="text-align:right"><div class="label" id="openingCount">0 openings</div></div>
  </div>

  <button class="btn btn-primary btn-full" onclick="saveProject()" style="margin-bottom:10px">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>
    Save Project
  </button>
  <button class="btn btn-accent btn-full" onclick="shareProject()" style="margin-bottom:10px">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
    Share Proposal
  </button>
  <div class="upsell">
    <h4>Insurance Savings Report</h4>
    <p>Show customers their estimated annual insurance savings and ROI timeline with branded PDF reports.</p>
    <button class="btn btn-sm btn-disabled" aria-disabled="true">Available in Full Version</button>
  </div>
</section>

<!-- VIEW: Add Opening -->
<section class="view" id="viewAddOpening" role="dialog" aria-label="Add opening">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
    <button class="btn-ghost" onclick="cancelOpening()" aria-label="Cancel"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <h2 id="openingFormTitle">Add Opening</h2>
  </div>
  <div class="card">
    <div class="form-group"><label for="oType">Opening Type</label>
      <select id="oType">
        <option value="window">Window</option>
        <option value="slider">Sliding Glass Door</option>
        <option value="entry">Entry Door</option>
        <option value="french">French Doors</option>
        <option value="garage">Garage Door</option>
        <option value="other">Other</option>
      </select>
    </div>
    <div class="form-group"><label for="oLocation">Location / Label</label><input type="text" id="oLocation" placeholder="Master bedroom, south wall"></div>
    <div style="display:flex;gap:12px">
      <div class="form-group" style="flex:1"><label for="oWidth">Width (inches)</label><input type="number" id="oWidth" placeholder="48" min="1" max="360"></div>
      <div class="form-group" style="flex:1"><label for="oHeight">Height (inches)</label><input type="number" id="oHeight" placeholder="60" min="1" max="240"></div>
    </div>
    <div class="form-group"><label for="oShutter">Shutter Type</label>
      <select id="oShutter" onchange="updateOpeningPreview()">
        <option value="accordion">Accordion Shutters</option>
        <option value="rolldown">Roll-Down Shutters</option>
        <option value="panel">Storm Panels (aluminum)</option>
        <option value="colonial">Colonial Shutters</option>
        <option value="bahama">Bahama Shutters</option>
        <option value="impact">Impact Window (replacement)</option>
      </select>
    </div>
    <div class="form-group"><label for="oNotes">Notes</label><input type="text" id="oNotes" placeholder="Header clearance 6 in, spigot below"></div>
    <div style="background:var(--offwhite);border-radius:8px;padding:12px;margin-top:8px;text-align:center">
      <div style="font-size:.75rem;color:var(--mid);text-transform:uppercase;letter-spacing:.5px">Estimated cost for this opening</div>
      <div style="font-family:'Inter',sans-serif;font-size:1.5rem;font-weight:800;color:var(--navy)" id="openingPreview">$0</div>
    </div>
  </div>
  <button class="btn btn-primary btn-full" onclick="confirmOpening()" style="margin-top:10px">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
    <span id="confirmOpeningText">Add Opening</span>
  </button>
</section>

<!-- VIEW: Settings -->
<section class="view" id="viewSettings" role="region" aria-label="Settings">
  <h2 style="margin-bottom:14px">Pricing Setup</h2>
  <div class="card">
    <h3 style="margin-bottom:10px">Shutter Pricing (per sq ft installed)</h3>
    <div id="shutterPrices"></div>
  </div>
  <div class="card">
    <h3 style="margin-bottom:10px">Data</h3>
    <button class="btn btn-outline btn-full" onclick="doExport()" style="margin-bottom:8px">Export All (JSON)</button>
    <button class="btn btn-outline btn-full" onclick="document.getElementById('impFile').click()">Import (JSON)</button>
    <input type="file" id="impFile" accept=".json" style="display:none">
  </div>
</section>

</main>

<nav class="tabs" role="navigation" aria-label="Main">
  <button class="active" onclick="switchTab('viewProjects',this)" aria-label="Projects" aria-current="page">
    <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    Projects
  </button>
  <button onclick="newProject();switchTab('viewBuilder',this)" aria-label="New project">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
    New
  </button>
  <button onclick="switchTab('viewSettings',this)" aria-label="Settings">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.32 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
    Pricing
  </button>
</nav>

<div id="bct-demo-disclaimer" role="contentinfo" aria-label="Demo disclaimer" style="position:fixed;bottom:54px;left:0;right:0;background:#f8f8f8;border-top:1px solid #ddd;padding:8px 16px;font-size:11px;line-height:1.4;color:#666;z-index:99999;display:flex;flex-wrap:wrap;align-items:center;justify-content:center;gap:6px 12px;text-align:center;">
  <p style="margin:0;max-width:600px;"><strong style="color:#333;">DEMO NOTICE:</strong> This tool was created by BennyCuTools as a free demonstration only. It is not affiliated with, endorsed by, or authorized by Affordable Glass Protection Inc. All brand references are used solely for demonstration purposes.</p>
  <a href="mailto:cuuper225@gmail.com?subject=Delete%20Demo%3A%20Affordable%20Glass%20Protection&body=I%20am%20the%20owner%20and%20I%20request%20permanent%20deletion%20of%20this%20demo." style="display:inline-flex;align-items:center;gap:4px;background:#dc3545;color:#fff;padding:4px 10px;border-radius:4px;text-decoration:none;font-size:10px;font-weight:500;white-space:nowrap;">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
    Request Permanent Deletion
  </a>
</div>

<script>
function _h(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return h;}
const _V=-976399822;
const _k=new URLSearchParams(window.location.search).get('key');
if(!_k||_h(_k)!==_V){document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;background:#111;color:#fff;text-align:center;padding:20px"><div><h1 style="font-size:2rem;margin-bottom:1rem">Access Required</h1><p style="color:#999">This tool needs a valid access key.</p><p style="margin-top:1rem"><a href="mailto:ben@bennycutools.com" style="color:#4da6ff">ben@bennycutools.com</a></p></div></div>';throw new Error('No key');}
document.addEventListener('contextmenu',e=>e.preventDefault());

// DB
let db;
function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open('ShutterBidDB',1);r.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('projects'))d.createObjectStore('projects',{keyPath:'id'})};r.onsuccess=e=>{db=e.target.result;res()};r.onerror=rej})}
function dbPut(d){return new Promise((res,rej)=>{const tx=db.transaction('projects','readwrite');tx.objectStore('projects').put(d);tx.oncomplete=res;tx.onerror=rej})}
function dbAll(){return new Promise((res,rej)=>{const tx=db.transaction('projects','readonly');const r=tx.objectStore('projects').getAll();r.onsuccess=()=>res(r.result);r.onerror=rej})}
function dbDel(id){return new Promise((res,rej)=>{const tx=db.transaction('projects','readwrite');tx.objectStore('projects').delete(id);tx.oncomplete=res;tx.onerror=rej})}

// Pricing
const SHUTTER_TYPES={accordion:'Accordion',rolldown:'Roll-Down',panel:'Storm Panels',colonial:'Colonial',bahama:'Bahama',impact:'Impact Window'};
const DEF_PRICES={accordion:18,rolldown:32,panel:8,colonial:24,bahama:22,impact:45};
function getPrices(){try{return JSON.parse(localStorage.getItem('sb_prices'))||{...DEF_PRICES}}catch(e){return{...DEF_PRICES}}}
function savePrices(){const p={};document.querySelectorAll('[data-sp]').forEach(el=>{p[el.dataset.sp]=parseFloat(el.value)||0});localStorage.setItem('sb_prices',JSON.stringify(p));toast('Pricing saved')}
function loadSettings(){const p=getPrices();let h='';for(const[k,name]of Object.entries(SHUTTER_TYPES)){h+=`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--light)"><span style="font-size:.9rem">${name}</span><input type="number" data-sp="${k}" value="${p[k]||0}" style="width:80px;text-align:right;padding:8px;border:1.5px solid var(--border);border-radius:6px" step="0.5" min="0" onchange="savePrices()"></div>`}document.getElementById('shutterPrices').innerHTML=h}

function calcOpeningCost(o){const p=getPrices();const sqft=(o.w*o.h)/144;return sqft*(p[o.shutter]||0)}

// State
let curProject=null;let curOpenings=[];let editIdx=-1;

// Views
function showView(id){document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));document.getElementById(id).classList.add('active');window.scrollTo(0,0)}
function switchTab(v,btn){document.querySelectorAll('nav.tabs button').forEach(b=>{b.classList.remove('active');b.removeAttribute('aria-current')});if(btn){btn.classList.add('active');btn.setAttribute('aria-current','page')}if(v==='viewProjects')loadProjects();if(v==='viewSettings')loadSettings();showView(v)}
function backToProjects(){switchTab('viewProjects',document.querySelector('nav.tabs button:first-child'))}

// Projects list
async function loadProjects(){const all=await dbAll();const c=document.getElementById('projectsList');if(!all.length){c.innerHTML='<div style="text-align:center;padding:48px 16px;color:var(--mid)"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#D1D5DB" stroke-width="1" style="display:block;margin:0 auto 12px"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg><h3 style="color:var(--dark);margin-bottom:4px">No projects yet</h3><p style="font-size:.85rem">Tap "New Project" to start your first proposal</p></div>';return}
all.sort((a,b)=>b.created-a.created);
c.innerHTML=all.map(p=>{const d=new Date(p.created).toLocaleDateString('en-US',{month:'short',day:'numeric'});const st=p.status||'estimated';return`<div class="project-card" tabindex="0" role="button" aria-label="Open project for ${p.name}" onclick="openProject('${p.id}')" onkeypress="if(event.key==='Enter')openProject('${p.id}')"><h4>${p.name||'Unnamed'}</h4><div class="meta">${p.address||'No address'} -- ${d}</div><div class="bottom"><div class="price">$${(p.total||0).toLocaleString()}</div><span class="status-badge status-${st}">${st.charAt(0).toUpperCase()+st.slice(1)}</span></div></div>`}).join('')}

function newProject(){curProject={id:crypto.randomUUID(),created:Date.now(),status:'estimated'};curOpenings=[];document.getElementById('pName').value='';document.getElementById('pAddr').value='';document.getElementById('pPhone').value='';document.getElementById('builderTitle').textContent='New Project';renderOpenings();recalc();showView('viewBuilder')}

async function openProject(id){const all=await dbAll();const p=all.find(x=>x.id===id);if(!p)return;curProject=p;curOpenings=p.openings||[];document.getElementById('pName').value=p.name||'';document.getElementById('pAddr').value=p.address||'';document.getElementById('pPhone').value=p.phone||'';document.getElementById('builderTitle').textContent='Edit Project';renderOpenings();recalc();showView('viewBuilder')}

// Openings
function showAddOpening(){editIdx=-1;document.getElementById('oType').value='window';document.getElementById('oLocation').value='';document.getElementById('oWidth').value='';document.getElementById('oHeight').value='';document.getElementById('oShutter').value='accordion';document.getElementById('oNotes').value='';document.getElementById('openingFormTitle').textContent='Add Opening';document.getElementById('confirmOpeningText').textContent='Add Opening';updateOpeningPreview();showView('viewAddOpening')}

function cancelOpening(){showView('viewBuilder')}

function updateOpeningPreview(){const w=parseFloat(document.getElementById('oWidth').value)||48;const h=parseFloat(document.getElementById('oHeight').value)||60;const sh=document.getElementById('oShutter').value;const cost=calcOpeningCost({w,h,shutter:sh});document.getElementById('openingPreview').textContent='$'+Math.round(cost).toLocaleString()}
document.getElementById('oWidth').addEventListener('input',updateOpeningPreview);
document.getElementById('oHeight').addEventListener('input',updateOpeningPreview);

function confirmOpening(){const w=parseFloat(document.getElementById('oWidth').value);const h=parseFloat(document.getElementById('oHeight').value);if(!w||!h){toast('Enter width and height','err');return}
const o={type:document.getElementById('oType').value,location:document.getElementById('oLocation').value.trim(),w,h,shutter:document.getElementById('oShutter').value,notes:document.getElementById('oNotes').value.trim()};
if(editIdx>=0){curOpenings[editIdx]=o}else{curOpenings.push(o)}
renderOpenings();recalc();showView('viewBuilder');toast(editIdx>=0?'Opening updated':'Opening added')}

function editOpening(i){editIdx=i;const o=curOpenings[i];document.getElementById('oType').value=o.type;document.getElementById('oLocation').value=o.location||'';document.getElementById('oWidth').value=o.w;document.getElementById('oHeight').value=o.h;document.getElementById('oShutter').value=o.shutter;document.getElementById('oNotes').value=o.notes||'';document.getElementById('openingFormTitle').textContent='Edit Opening';document.getElementById('confirmOpeningText').textContent='Update';updateOpeningPreview();showView('viewAddOpening')}

function removeOpening(i){curOpenings.splice(i,1);renderOpenings();recalc();toast('Opening removed')}

const OPENING_ICONS={window:'<rect x="5" y="3" width="14" height="18" rx="1"/><line x1="12" y1="3" x2="12" y2="21"/><line x1="5" y1="12" x2="19" y2="12"/>',slider:'<rect x="2" y="4" width="20" height="16" rx="1"/><line x1="12" y1="4" x2="12" y2="20"/><path d="M8 12h4"/>',entry:'<rect x="6" y="2" width="12" height="20" rx="1"/><circle cx="15" cy="12" r="1"/>',french:'<rect x="2" y="2" width="20" height="20" rx="1"/><line x1="12" y1="2" x2="12" y2="22"/><circle cx="10" cy="12" r=".8"/><circle cx="14" cy="12" r=".8"/>',garage:'<rect x="2" y="4" width="20" height="16" rx="2"/><line x1="2" y1="8" x2="22" y2="8"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="16" x2="22" y2="16"/>',other:'<rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="12" x2="21" y2="12"/>'};

function renderOpenings(){const c=document.getElementById('openingsList');const no=document.getElementById('noOpenings');if(!curOpenings.length){c.innerHTML='';no.style.display='block';return}no.style.display='none';
c.innerHTML=curOpenings.map((o,i)=>{const cost=calcOpeningCost(o);const icon=OPENING_ICONS[o.type]||OPENING_ICONS.other;const dims=`${o.w}"x${o.h}"`;return`<div class="opening-row"><div class="opening-icon"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">${icon}</svg></div><div class="opening-details"><h4>${o.location||o.type}</h4><div class="meta">${dims} -- ${(o.w*o.h/144).toFixed(1)} sq ft</div><span class="shutter-badge">${SHUTTER_TYPES[o.shutter]||o.shutter}</span></div><div class="opening-price">$${Math.round(cost).toLocaleString()}</div><div class="opening-actions"><button onclick="editOpening(${i})" aria-label="Edit opening ${i+1}"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button><button onclick="removeOpening(${i})" aria-label="Remove opening ${i+1}"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button></div></div>`}).join('')}

function recalc(){let total=0;curOpenings.forEach(o=>{total+=calcOpeningCost(o)});document.getElementById('totalAmt').textContent='$'+Math.round(total).toLocaleString();document.getElementById('openingCount').textContent=curOpenings.length+' opening'+(curOpenings.length!==1?'s':'');
const gb=document.getElementById('grantBox');if(total>=2000){gb.style.display='flex';const net=Math.max(0,total-10000);document.getElementById('grantNet').textContent='$'+Math.round(net).toLocaleString()}else{gb.style.display='none'}}

async function saveProject(){const name=document.getElementById('pName').value.trim();if(!name){toast('Enter customer name','err');document.getElementById('pName').focus();return}
curProject.name=name;curProject.address=document.getElementById('pAddr').value.trim();curProject.phone=document.getElementById('pPhone').value.trim();curProject.openings=[...curOpenings];let t=0;curOpenings.forEach(o=>{t+=calcOpeningCost(o)});curProject.total=Math.round(t);curProject.updated=Date.now();await dbPut(curProject);toast('Project saved');loadProjects()}

async function shareProject(){const name=document.getElementById('pName').value.trim();if(!name){toast('Save the project first','err');return}await saveProject();
let text=`PROPOSAL - Affordable Glass Protection\n${curProject.name}\n${curProject.address}\n\n`;
curOpenings.forEach((o,i)=>{const cost=Math.round(calcOpeningCost(o));text+=`${i+1}. ${o.location||o.type} (${o.w}"x${o.h}") - ${SHUTTER_TYPES[o.shutter]} - $${cost.toLocaleString()}\n`});
text+=`\nProject Total: $${curProject.total.toLocaleString()}\n`;
if(curProject.total>=2000)text+=`My Safe FL Home eligible - up to $10,000 grant\nYour est. out-of-pocket: $${Math.max(0,curProject.total-10000).toLocaleString()}\n`;
text+=`\nAffordable Glass Protection Inc\n(321) 878-8879\nSince 1992`;
if(navigator.share){try{await navigator.share({title:`Proposal for ${curProject.name}`,text});curProject.shared=true;await dbPut(curProject);toast('Shared')}catch(e){if(e.name!=='AbortError')clipCopy(text)}}else{clipCopy(text)}}

async function clipCopy(t){try{await navigator.clipboard.writeText(t);toast('Copied to clipboard')}catch(e){toast('Could not copy','err')}}

// Export/Import
async function doExport(){const all=await dbAll();const d=JSON.stringify({projects:all,prices:getPrices()},null,2);const b=new Blob([d],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='shutterbid-backup.json';a.click();URL.revokeObjectURL(u);toast('Exported')}
document.getElementById('impFile').addEventListener('change',async function(e){const f=e.target.files[0];if(!f)return;try{const d=JSON.parse(await f.text());if(d.projects)for(const p of d.projects)await dbPut(p);if(d.prices)localStorage.setItem('sb_prices',JSON.stringify(d.prices));toast('Imported');loadProjects();loadSettings()}catch(er){toast('Invalid file','err')}e.target.value=''});

// Demo
const DEMO=[
  {id:'demo-1',created:Date.now()-3600000,name:'Rodriguez Home',address:'4820 Croton Dr, Melbourne',phone:'(321) 555-0189',status:'estimated',openings:[
    {type:'window',location:'Living room front',w:60,h:48,shutter:'accordion',notes:''},
    {type:'window',location:'Master bedroom',w:48,h:36,shutter:'accordion',notes:''},
    {type:'window',location:'Guest bedroom',w:36,h:48,shutter:'accordion',notes:''},
    {type:'slider',location:'Lanai slider',w:96,h:80,shutter:'rolldown',notes:''},
    {type:'slider',location:'Family room slider',w:72,h:80,shutter:'rolldown',notes:''},
    {type:'entry',location:'Front door',w:36,h:80,shutter:'colonial',notes:'Decorative preference'},
    {type:'window',location:'Kitchen',w:48,h:36,shutter:'accordion',notes:'Above sink'},
    {type:'garage',location:'Garage double',w:192,h:96,shutter:'panel',notes:''}
  ],total:0,isDemo:true},
  {id:'demo-2',created:Date.now()-86400000,name:'Patel Rental Property',address:'1190 Malabar Rd SE, Palm Bay',phone:'(321) 555-0244',status:'sold',openings:[
    {type:'window',location:'Front windows (x3)',w:36,h:48,shutter:'panel',notes:''},
    {type:'window',location:'Side windows (x2)',w:48,h:36,shutter:'panel',notes:''},
    {type:'slider',location:'Back slider',w:72,h:80,shutter:'panel',notes:''},
    {type:'entry',location:'Front door',w:36,h:80,shutter:'panel',notes:''}
  ],total:0,isDemo:true}
];

async function loadDemo(){const all=await dbAll();if(all.length>0||localStorage.getItem('sb_demoCleared'))return;
for(const p of DEMO){let t=0;p.openings.forEach(o=>{t+=calcOpeningCost(o)});p.total=Math.round(t);await dbPut(p)}
document.getElementById('demoBanner').style.display='flex';loadProjects()}

async function clearDemo(){const all=await dbAll();for(const p of all){if(p.isDemo)await dbDel(p.id)}document.getElementById('demoBanner').style.display='none';localStorage.setItem('sb_demoCleared','1');loadProjects();toast('Demo data cleared')}

function toast(msg,type){const w=document.getElementById('toastWrap');const t=document.createElement('div');t.className='toast';const svg=type==='err'?'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>';t.innerHTML=svg+msg;w.appendChild(t);setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity .3s';setTimeout(()=>t.remove(),300)},2500)}

async function init(){await openDB();await loadDemo();const all=await dbAll();if(all.some(x=>x.isDemo))document.getElementById('demoBanner').style.display='flex';await loadProjects();loadSettings()}
init();
</script>
</body>
</html>
