<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SolarCalc Pro — Net Zero Solar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root {
      --primary: oklch(0.72 0.15 70);
      --primary-dark: oklch(0.58 0.14 70);
      --primary-light: oklch(0.92 0.06 70);
      --navy: oklch(0.25 0.08 260);
      --navy-light: oklch(0.35 0.06 260);
      --white: #ffffff;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --gray-900: #111827;
      --success: oklch(0.65 0.18 145);
      --success-bg: oklch(0.95 0.05 145);
      --error: #dc2626;
      --font-heading: 'Montserrat', sans-serif;
      --font-body: 'Inter', sans-serif;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow: 0 4px 12px rgba(0,0,0,0.1);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Skip Link - Accessibility */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--navy);
      color: var(--white);
      padding: 8px 16px;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      z-index: 10001;
      border-radius: 0 0 var(--radius) 0;
      transition: top 0.2s ease;
    }
    .skip-link:focus {
      top: 0;
      outline: 2px solid var(--primary);
      outline-offset: -2px;
    }

    /* Anti-scrape protection */
    html {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    input, textarea, [contenteditable] {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    /* Grain texture overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
      opacity: 0.03;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    }

    /* Entrance animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .auth-card {
      animation: scaleIn 0.5s ease-out;
    }

    .app-header {
      animation: fadeIn 0.4s ease-out;
    }

    .card {
      animation: fadeInUp 0.5s ease-out backwards;
    }

    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.2s; }
    .card:nth-child(3) { animation-delay: 0.3s; }
    .card:nth-child(4) { animation-delay: 0.4s; }

    /* Enhanced micro-interactions */
    .btn, .auth-btn, .demo-btn, .nav-btn, .icon-btn {
      transition: transform 0.15s ease, background-color 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    }

    .btn:active, .auth-btn:active, .demo-btn:active {
      transform: scale(0.97);
      transition-duration: 0.1s;
    }

    .form-input, .form-select, .auth-input {
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-input:hover, .form-select:hover, .auth-input:hover {
      border-color: var(--gray-300);
    }

    /* Enhanced focus indicators */
    *:focus-visible {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }

    .slider-track:focus-visible {
      outline: 3px solid var(--primary);
      outline-offset: 4px;
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
      
      .auth-card,
      .app-header,
      .card {
        animation: none;
      }
    }

    body {
      font-family: var(--font-body);
      background: var(--gray-50);
      color: var(--gray-900);
      line-height: 1.5;
      min-height: 100vh;
      padding-bottom: 140px !important;
      -webkit-font-smoothing: antialiased;
    }

    .auth-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
    }

    .auth-card {
      background: var(--white);
      padding: 32px 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      width: 100%;
      max-width: 360px;
      text-align: center;
    }

    .auth-logo {
      width: 64px;
      height: 64px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
    }

    .auth-logo svg {
      width: 36px;
      height: 36px;
      color: var(--white);
    }

    .auth-title {
      font-family: var(--font-heading);
      font-size: 24px;
      font-weight: 700;
      color: var(--navy);
      margin-bottom: 8px;
    }

    .auth-subtitle {
      color: var(--gray-500);
      font-size: 14px;
      margin-bottom: 24px;
    }

    .auth-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-sm);
      font-size: 16px;
      font-family: var(--font-body);
      transition: border-color 0.15s;
      margin-bottom: 16px;
    }

    .auth-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .auth-btn {
      width: 100%;
      padding: 14px 24px;
      background: var(--primary);
      color: var(--white);
      border: none;
      border-radius: var(--radius-sm);
      font-size: 16px;
      font-weight: 600;
      font-family: var(--font-body);
      cursor: pointer;
      transition: transform 0.1s, background 0.15s;
    }

    .auth-btn:hover {
      background: var(--primary-dark);
    }

    .auth-btn:active {
      transform: scale(0.98);
    }

    .auth-btn:focus-visible {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }

    .auth-error {
      color: var(--error);
      font-size: 14px;
      margin-top: 12px;
      display: none;
    }

    .app-container {
      display: none;
    }

    .app-header {
      background: var(--navy);
      color: var(--white);
      padding: 16px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 600px;
      margin: 0 auto;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-icon {
      width: 36px;
      height: 36px;
      background: var(--primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header-icon svg {
      width: 20px;
      height: 20px;
    }

    .header-title {
      font-family: var(--font-heading);
      font-size: 18px;
      font-weight: 700;
    }

    .header-subtitle {
      font-size: 11px;
      opacity: 0.8;
      font-weight: 400;
    }

    .location-badge {
      display: flex;
      align-items: center;
      gap: 4px;
      background: rgba(255,255,255,0.15);
      padding: 6px 10px;
      border-radius: 20px;
      font-size: 12px;
    }

    .location-badge svg {
      width: 14px;
      height: 14px;
    }

    .main-content {
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
      margin-bottom: 16px;
      overflow: hidden;
    }

    .card-header {
      padding: 16px;
      border-bottom: 1px solid var(--gray-100);
    }

    .card-title {
      font-family: var(--font-heading);
      font-size: 16px;
      font-weight: 700;
      color: var(--navy);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title svg {
      width: 20px;
      height: 20px;
      color: var(--primary);
    }

    .card-body {
      padding: 16px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: 6px;
    }

    .form-hint {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 4px;
    }

    .input-wrapper {
      position: relative;
    }

    .input-prefix {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-500);
      font-size: 16px;
      font-weight: 500;
    }

    .form-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-sm);
      font-size: 16px;
      font-family: var(--font-body);
      transition: border-color 0.15s;
    }

    .form-input.has-prefix {
      padding-left: 32px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-input:focus-visible {
      outline: 3px solid var(--primary-light);
      outline-offset: 1px;
    }

    .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-sm);
      font-size: 16px;
      font-family: var(--font-body);
      background: var(--white);
      cursor: pointer;
      transition: border-color 0.15s;
    }

    .form-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-select:focus-visible {
      outline: 3px solid var(--primary-light);
      outline-offset: 1px;
    }

    .slider-group {
      margin-top: 8px;
    }

    .slider-value {
      font-family: var(--font-heading);
      font-size: 24px;
      font-weight: 700;
      color: var(--navy);
      margin-bottom: 8px;
    }

    .slider-track {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--gray-200);
      border-radius: 4px;
      outline: none;
    }

    .slider-track::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      box-shadow: var(--shadow);
    }

    .slider-track:focus-visible {
      outline: 3px solid var(--primary-light);
      outline-offset: 2px;
    }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 4px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 24px;
      border-radius: var(--radius-sm);
      font-size: 16px;
      font-weight: 600;
      font-family: var(--font-body);
      cursor: pointer;
      transition: transform 0.1s, background 0.15s, box-shadow 0.15s;
      border: none;
    }

    .btn:focus-visible {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--white);
      width: 100%;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      box-shadow: var(--shadow);
    }

    .btn-primary:active {
      transform: scale(0.98);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .btn-secondary:hover {
      background: var(--gray-200);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--gray-300);
      color: var(--gray-700);
    }

    .btn-outline:hover {
      background: var(--gray-100);
    }

    .btn svg {
      width: 18px;
      height: 18px;
    }

    .demo-selector {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .demo-btn {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 12px 14px;
      background: var(--gray-50);
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
      text-align: left;
    }

    .demo-btn:hover {
      background: var(--primary-light);
      border-color: var(--primary);
    }

    .demo-btn:focus-visible {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }

    .demo-btn.active {
      background: var(--primary-light);
      border-color: var(--primary);
    }

    .demo-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--navy);
    }

    .demo-details {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 2px;
    }

    .result-hero {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
      color: var(--white);
      padding: 24px;
      text-align: center;
      border-radius: var(--radius);
      margin-bottom: 16px;
    }

    .result-label {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 4px;
    }

    .result-value {
      font-family: var(--font-heading);
      font-size: 42px;
      font-weight: 800;
      letter-spacing: -1px;
    }

    .result-sub {
      font-size: 14px;
      opacity: 0.8;
      margin-top: 4px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .stat-card {
      background: var(--gray-50);
      border-radius: var(--radius-sm);
      padding: 14px;
      text-align: center;
    }

    .stat-card.highlight {
      background: var(--success-bg);
      border: 1px solid var(--success);
    }

    .stat-label {
      font-size: 12px;
      color: var(--gray-500);
      margin-bottom: 4px;
    }

    .stat-value {
      font-family: var(--font-heading);
      font-size: 20px;
      font-weight: 700;
      color: var(--navy);
    }

    .stat-card.highlight .stat-value {
      color: var(--success);
    }

    .chart-container {
      position: relative;
      height: 280px;
      margin: 16px 0;
    }

    .breakeven-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--success-bg);
      color: var(--success);
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-top: 12px;
    }

    .breakeven-badge svg {
      width: 16px;
      height: 16px;
    }

    .incentive-list {
      list-style: none;
    }

    .incentive-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--gray-100);
    }

    .incentive-item:last-child {
      border-bottom: none;
    }

    .incentive-name {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .incentive-name svg {
      width: 18px;
      height: 18px;
      color: var(--success);
    }

    .incentive-value {
      font-family: var(--font-heading);
      font-weight: 700;
      color: var(--success);
    }

    .price-compare {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 12px;
      align-items: center;
      margin-top: 16px;
    }

    .price-box {
      text-align: center;
      padding: 16px;
      border-radius: var(--radius-sm);
    }

    .price-box.before {
      background: var(--gray-100);
    }

    .price-box.after {
      background: var(--success-bg);
      border: 2px solid var(--success);
    }

    .price-label {
      font-size: 12px;
      color: var(--gray-500);
      margin-bottom: 4px;
    }

    .price-value {
      font-family: var(--font-heading);
      font-size: 22px;
      font-weight: 700;
    }

    .price-box.before .price-value {
      text-decoration: line-through;
      color: var(--gray-500);
    }

    .price-box.after .price-value {
      color: var(--success);
    }

    .price-arrow {
      font-size: 24px;
      color: var(--success);
    }

    .proposal-list {
      list-style: none;
    }

    .proposal-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px;
      background: var(--gray-50);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
    }

    .proposal-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .proposal-icon {
      width: 40px;
      height: 40px;
      background: var(--white);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
    }

    .proposal-icon svg {
      width: 20px;
      height: 20px;
      color: var(--primary);
    }

    .proposal-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--navy);
    }

    .proposal-date {
      font-size: 12px;
      color: var(--gray-500);
    }

    .proposal-actions {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: var(--white);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.15s;
    }

    .icon-btn:hover {
      background: var(--gray-200);
    }

    .icon-btn:focus-visible {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }

    .icon-btn svg {
      width: 18px;
      height: 18px;
      color: var(--gray-700);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
    }

    .empty-icon {
      width: 64px;
      height: 64px;
      background: var(--gray-100);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
    }

    .empty-icon svg {
      width: 32px;
      height: 32px;
      color: var(--gray-400);
    }

    .empty-title {
      font-family: var(--font-heading);
      font-size: 18px;
      font-weight: 700;
      color: var(--navy);
      margin-bottom: 8px;
    }

    .empty-text {
      font-size: 14px;
      color: var(--gray-500);
    }

    .locked-overlay {
      position: relative;
    }

    .locked-content {
      filter: blur(3px);
      pointer-events: none;
      user-select: none;
    }

    .lock-badge {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--navy);
      color: var(--white);
      padding: 16px 24px;
      border-radius: var(--radius);
      text-align: center;
      box-shadow: var(--shadow-lg);
      z-index: 10;
    }

    .lock-badge svg {
      width: 32px;
      height: 32px;
      margin-bottom: 8px;
      opacity: 0.8;
    }

    .lock-title {
      font-family: var(--font-heading);
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .lock-text {
      font-size: 13px;
      opacity: 0.8;
    }

    .bottom-nav {
      position: fixed;
      bottom: 60px;
      left: 0;
      right: 0;
      background: var(--white);
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      z-index: 100;
    }

    .nav-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 16px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--gray-500);
      font-size: 11px;
      font-family: var(--font-body);
      font-weight: 500;
      transition: color 0.15s;
      position: relative;
    }

    .nav-btn:focus-visible {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
      border-radius: 4px;
    }

    .nav-btn svg {
      width: 22px;
      height: 22px;
    }

    .nav-btn.active {
      color: var(--primary);
    }

    .nav-btn.locked {
      opacity: 0.5;
    }

    .nav-btn.locked::after {
      content: '';
      position: absolute;
      top: 6px;
      right: 12px;
      width: 8px;
      height: 8px;
      background: var(--gray-400);
      border-radius: 50%;
    }

    .action-bar {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    .action-bar .btn {
      flex: 1;
    }

    .toast {
      position: fixed;
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--navy);
      color: var(--white);
      padding: 12px 20px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toast.visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast svg {
      width: 18px;
      height: 18px;
    }

    .system-specs {
      background: var(--gray-50);
      border-radius: var(--radius-sm);
      padding: 14px;
      margin-top: 16px;
    }

    .spec-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 14px;
    }

    .spec-label {
      color: var(--gray-500);
    }

    .spec-value {
      font-weight: 600;
      color: var(--navy);
    }

    .enphase-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--navy);
      color: var(--white);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 12px;
    }

    @media (min-width: 480px) {
      .demo-selector {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }

    .hidden {
      display: none !important;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <!-- Auth Screen -->
  <div id="auth-screen" class="auth-screen">
    <div class="auth-card">
      <div class="auth-logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3"/>
          <line x1="12" y1="21" x2="12" y2="23"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
          <line x1="1" y1="12" x2="3" y2="12"/>
          <line x1="21" y1="12" x2="23" y2="12"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
      </div>
      <h1 class="auth-title">Solar Savings Calculator</h1>
      <p class="auth-subtitle">Net Zero Solar — Tucson, AZ</p>
      <form id="auth-form">
        <label for="access-key" class="sr-only">Access Key</label>
        <input type="text" id="access-key" class="auth-input" placeholder="Enter access key" autocomplete="off" required>
        <button type="submit" class="auth-btn">Open Calculator</button>
      </form>
      <p id="auth-error" class="auth-error" role="alert" aria-live="polite">Invalid access key. Please try again.</p>
    </div>
  </div>

  <!-- Main App -->
  <div id="main-content" class="app-container">
    <header class="app-header">
      <div class="header-inner">
        <div class="header-brand">
          <div class="header-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="5"/>
              <line x1="12" y1="1" x2="12" y2="3"/>
              <line x1="12" y1="21" x2="12" y2="23"/>
            </svg>
          </div>
          <div>
            <div class="header-title">SolarCalc Pro</div>
            <div class="header-subtitle">Net Zero Solar</div>
          </div>
        </div>
        <div class="location-badge" id="location-badge">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
          <span id="location-text">Tucson, AZ</span>
        </div>
      </div>
    </header>

    <main class="main-content" role="main">
      <!-- Calculate Tab -->
      <section id="tab-calculate" class="tab-panel active" role="tabpanel" aria-labelledby="nav-calculate">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                <line x1="12" y1="22.08" x2="12" y2="12"/>
              </svg>
              Quick Start
            </h2>
          </div>
          <div class="card-body">
            <p style="font-size: 14px; color: var(--gray-500); margin-bottom: 12px;">Pick a home like yours:</p>
            <div class="demo-selector" role="group" aria-label="Demo scenarios">
              <button type="button" class="demo-btn active" data-demo="catalina" aria-pressed="true">
                <span class="demo-name">Catalina Foothills</span>
                <span class="demo-details">$280/mo bill, 4 bed home</span>
              </button>
              <button type="button" class="demo-btn" data-demo="oro" aria-pressed="false">
                <span class="demo-name">Oro Valley</span>
                <span class="demo-details">$180/mo bill, 3 bed home</span>
              </button>
              <button type="button" class="demo-btn" data-demo="marana" aria-pressed="false">
                <span class="demo-name">Marana Ranch</span>
                <span class="demo-details">$350/mo bill, large property</span>
              </button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                <line x1="1" y1="10" x2="23" y2="10"/>
              </svg>
              Your Electric Bill
            </h2>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label for="monthly-bill" class="form-label">Typical Monthly Payment</label>
              <div class="input-wrapper">
                <span class="input-prefix" aria-hidden="true">$</span>
                <input type="number" id="monthly-bill" class="form-input has-prefix" value="280" min="50" max="1000" step="10" inputmode="numeric">
              </div>
              <p class="form-hint">Average TEP or APS bill (they go up every year)</p>
            </div>
            <div class="form-group">
              <label for="utility-provider" class="form-label">Utility Provider</label>
              <select id="utility-provider" class="form-select">
                <option value="tep" selected>Tucson Electric Power (TEP)</option>
                <option value="aps">Arizona Public Service (APS)</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 21h18"/>
                <path d="M3 10v11"/>
                <path d="M21 10v11"/>
                <path d="M12 3L3 10"/>
                <path d="M12 3l9 7"/>
              </svg>
              Roof Details
            </h2>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label for="roof-direction" class="form-label">Which Way Does Your Roof Face?</label>
              <select id="roof-direction" class="form-select">
                <option value="1.0" selected>South (catches the most sun)</option>
                <option value="0.95">Southwest or Southeast</option>
                <option value="0.85">East or West</option>
                <option value="0.75">North (still works, just fewer panels)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" id="shading-label">Any Shade on Your Roof?</label>
              <div class="slider-group">
                <div class="slider-value" id="shading-display" aria-live="polite">Hardly any</div>
                <input type="range" id="shading" class="slider-track" min="0" max="3" value="0" step="1" aria-labelledby="shading-label" aria-describedby="shading-display">
                <div class="slider-labels" aria-hidden="true">
                  <span>None</span>
                  <span>Light</span>
                  <span>Some</span>
                  <span> Lots</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <button type="button" class="btn btn-primary" id="calculate-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 12h14"/>
            <path d="M12 5l7 7-7 7"/>
          </svg>
          Calculate Savings
        </button>
      </section>

      <!-- Savings Tab -->
      <section id="tab-savings" class="tab-panel" role="tabpanel" aria-labelledby="nav-savings">
        <div class="result-hero" aria-live="polite">
          <div class="result-label">Your 25-Year Savings</div>
          <div class="result-value" id="total-savings">$38,247</div>
          <div class="result-sub">with solar in sunny Tucson</div>
        </div>

        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-label">System Size</div>
            <div class="stat-value" id="system-size">10.2 kW</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Panels</div>
            <div class="stat-value" id="panel-count">24 panels</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Year 1 Savings</div>
            <div class="stat-value" id="year1-savings">$2,940</div>
          </div>
          <div class="stat-card highlight">
            <div class="stat-label">Pays for itself in</div>
            <div class="stat-value" id="breakeven-year">Year 7</div>
          </div>
        </div>

        <div class="card" style="margin-top: 16px;">
          <div class="card-header">
            <h2 class="card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
              </svg>
              Your Savings Add Up
            </h2>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="savings-chart" role="img" aria-label="Chart showing cumulative savings over 25 years"></canvas>
            </div>
            <div style="text-align: center;">
              <div class="breakeven-badge" id="breakeven-badge">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                <span id="breakeven-text">System pays for itself in year 7</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              Tax Credits & Rebates
            </h2>
          </div>
          <div class="card-body">
            <ul class="incentive-list">
              <li class="incentive-item">
                <span class="incentive-name">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                  Federal ITC (30%)
                </span>
                <span class="incentive-value" id="federal-itc">-$8,160</span>
              </li>
              <li class="incentive-item">
                <span class="incentive-name">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                  AZ Sales Tax Exempt
                </span>
                <span class="incentive-value">Included</span>
              </li>
              <li class="incentive-item">
                <span class="incentive-name">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                  Utility Rebate (TEP)
                </span>
                <span class="incentive-value" id="utility-rebate">-$500</span>
              </li>
            </ul>
            <div class="price-compare">
              <div class="price-box before">
                <div class="price-label">Upfront cost</div>
                <div class="price-value" id="price-before">$27,200</div>
              </div>
              <div class="price-arrow" aria-hidden="true">→</div>
              <div class="price-box after">
                <div class="price-label">After tax credits</div>
                <div class="price-value" id="price-after">$18,540</div>
              </div>
            </div>
          </div>
        </div>

        <div class="system-specs">
          <h3 class="sr-only">Your Solar System Details</h3>
          <div class="spec-row">
            <span class="spec-label">Panel Type</span>
            <span class="spec-value">Tier 1 Monocrystalline</span>
          </div>
          <div class="spec-row">
            <span class="spec-label">Inverter</span>
            <span class="spec-value">Enphase IQ8 Microinverters</span>
          </div>
          <div class="spec-row">
            <span class="spec-label">Annual Production</span>
            <span class="spec-value" id="annual-production">17,748 kWh</span>
          </div>
          <div class="spec-row">
            <span class="spec-label">Warranty</span>
            <span class="spec-value">25 years full coverage</span>
          </div>
          <div style="text-align: center;">
            <span class="enphase-badge">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
              </svg>
              Enphase Tier 1 Installer
            </span>
          </div>
        </div>

        <div class="action-bar">
          <button type="button" class="btn btn-primary" id="save-proposal-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Save PDF
          </button>
          <button type="button" class="btn btn-outline" id="share-btn" aria-label="Share proposal">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="18" cy="5" r="3"/>
              <circle cx="6" cy="12" r="3"/>
              <circle cx="18" cy="19" r="3"/>
              <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
              <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
            </svg>
          </button>
        </div>
      </section>

      <!-- Proposals Tab -->
      <section id="tab-proposals" class="tab-panel" role="tabpanel" aria-labelledby="nav-proposals">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              Saved Proposals
              <span id="proposal-count" style="margin-left: auto; font-size: 12px; background: var(--gray-200); padding: 2px 8px; border-radius: 10px; font-weight: 500;">0/3 free</span>
            </h2>
          </div>
          <div class="card-body">
            <ul class="proposal-list" id="proposal-list" aria-label="Saved proposals">
              <!-- Proposals inserted here -->
            </ul>
            <div id="empty-proposals" class="empty-state">
              <div class="empty-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                </svg>
              </div>
              <p class="empty-title">No proposals yet</p>
              <p class="empty-text">Calculate savings and save a proposal to see it here.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Battery Tab (Locked) -->
      <section id="tab-battery" class="tab-panel" role="tabpanel" aria-labelledby="nav-battery">
        <div class="locked-overlay">
          <div class="locked-content">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Battery Storage Calculator</h2>
              </div>
              <div class="card-body">
                <div class="stat-grid">
                  <div class="stat-card">
                    <div class="stat-label">Battery Size</div>
                    <div class="stat-value">13.5 kWh</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">Backup Hours</div>
                    <div class="stat-value">24 hrs</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Backup Power Simulation</h2>
              </div>
              <div class="card-body" style="height: 200px; background: var(--gray-100);"></div>
            </div>
          </div>
          <div class="lock-badge">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            <div class="lock-title">Full Version Feature</div>
            <div class="lock-text">Battery calculator in $200 upgrade</div>
          </div>
        </div>
      </section>
    </main>

    <nav class="bottom-nav" role="tablist" aria-label="Main navigation">
      <button type="button" role="tab" class="nav-btn active" id="nav-calculate" data-tab="calculate" aria-selected="true" aria-controls="tab-calculate">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="4" y="2" width="16" height="20" rx="2" ry="2"/>
          <line x1="8" y1="6" x2="16" y2="6"/>
          <line x1="8" y1="10" x2="16" y2="10"/>
          <line x1="8" y1="14" x2="12" y2="14"/>
        </svg>
        Calculate
      </button>
      <button type="button" role="tab" class="nav-btn" id="nav-savings" data-tab="savings" aria-selected="false" aria-controls="tab-savings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="1" x2="12" y2="23"/>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
        </svg>
        Savings
      </button>
      <button type="button" role="tab" class="nav-btn" id="nav-proposals" data-tab="proposals" aria-selected="false" aria-controls="tab-proposals">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
        </svg>
        Proposals
      </button>
      <button type="button" role="tab" class="nav-btn locked" id="nav-battery" data-tab="battery" aria-selected="false" aria-controls="tab-battery" aria-disabled="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="1" y="6" width="18" height="12" rx="2" ry="2"/>
          <line x1="23" y1="13" x2="23" y2="11"/>
        </svg>
        Battery
      </button>
    </nav>

    <div id="toast" class="toast" role="status" aria-live="polite">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
      <span id="toast-message">Saved!</span>
    </div>
  </div>

  <!-- Demo Disclaimer - Compact -->
  <div id="bct-demo-disclaimer" role="contentinfo" aria-label="Demo" style="position:fixed;bottom:0;left:0;right:0;background:#1a1a1a;padding:6px 12px;font-size:11px;color:#999;z-index:99999;display:flex;align-items:center;justify-content:center;gap:12px;">
    <span>Demo for <strong style="color:#ccc;">Net Zero Solar of Tucson, AZ</strong> — not affiliated</span>
    <a href="mailto:cuuper225@gmail.com?subject=Delete%20Demo%3A%20Net%20Zero%20Solar" style="color:#ff6b6b;text-decoration:none;white-space:nowrap;">Delete →</a>
  </div>

  <script>
    // Hash function for auth
    function _h(s) {
      let h = 0;
      for (let i = 0; i < s.length; i++) {
        h = ((h << 5) - h) + s.charCodeAt(i);
        h |= 0;
      }
      return h;
    }

    // Demo data for Tucson area
    const DEMOS = {
      catalina: { name: 'Catalina Foothills', bill: 280, direction: '1.0', shading: 0 },
      oro: { name: 'Oro Valley', bill: 180, direction: '0.95', shading: 1 },
      marana: { name: 'Marana Ranch', bill: 350, direction: '1.0', shading: 0 }
    };

    // Tucson solar constants
    const TUCSON_SUN_HOURS = 6.5;
    const UTILITY_RATES = { tep: 0.125, aps: 0.138 };
    const RATE_INCREASE = 0.025;
    const PANEL_WATTAGE = 425;
    const COST_PER_WATT = 2.65;
    const FEDERAL_ITC = 0.30;
    const SHADING_FACTORS = [1.0, 0.92, 0.82, 0.68];

    let chart = null;
    let proposals = [];
    let currentCalc = null;

    // DOM elements
    const authScreen = document.getElementById('auth-screen');
    const appContainer = document.getElementById('app-container');
    const authForm = document.getElementById('auth-form');
    const accessKeyInput = document.getElementById('access-key');
    const authError = document.getElementById('auth-error');

    // Check URL key on load
    function init() {
      const urlKey = new URLSearchParams(window.location.search).get('key');
      if (urlKey && _h(urlKey) === 1487153380) {
        showApp();
        return;
      }
      authScreen.style.display = 'flex';
      loadProposals();
    }

    function showApp() {
      authScreen.style.display = 'none';
      appContainer.style.display = 'block';
      loadProposals();
      tryGeolocation();
      loadDemoData('catalina');
      doCalculation();
    }

    // Auth form handler
    authForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const key = accessKeyInput.value.trim();
      if (_h(key) === 1487153380) {
        showApp();
      } else {
        authError.style.display = 'block';
        accessKeyInput.focus();
      }
    });

    // Geolocation
    function tryGeolocation() {
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            // Simple check for Tucson area
            if (lat > 31.8 && lat < 32.5 && lng > -111.2 && lng < -110.5) {
              document.getElementById('location-text').textContent = 'Tucson, AZ';
            } else if (lat > 33.2 && lat < 33.8 && lng > -112.5 && lng < -111.5) {
              document.getElementById('location-text').textContent = 'Phoenix, AZ';
            }
          },
          () => {} // Ignore errors
        );
      }
    }

    // Demo buttons
    document.querySelectorAll('.demo-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.demo-btn').forEach(b => {
          b.classList.remove('active');
          b.setAttribute('aria-pressed', 'false');
        });
        btn.classList.add('active');
        btn.setAttribute('aria-pressed', 'true');
        loadDemoData(btn.dataset.demo);
      });
    });

    function loadDemoData(demoKey) {
      const demo = DEMOS[demoKey];
      document.getElementById('monthly-bill').value = demo.bill;
      document.getElementById('roof-direction').value = demo.direction;
      document.getElementById('shading').value = demo.shading;
      updateShadingDisplay();
    }

    // Shading slider display
    const shadingLabels = ['Hardly any', 'A little', 'Some', 'Lots of'];
    const shadingSlider = document.getElementById('shading');
    
    shadingSlider.addEventListener('input', updateShadingDisplay);
    
    function updateShadingDisplay() {
      document.getElementById('shading-display').textContent = shadingLabels[shadingSlider.value];
    }

    // Tab navigation
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        switchTab(tab);
      });
    });

    function switchTab(tab) {
      document.querySelectorAll('.nav-btn').forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-selected', 'false');
      });
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      
      document.getElementById(`nav-${tab}`).classList.add('active');
      document.getElementById(`nav-${tab}`).setAttribute('aria-selected', 'true');
      document.getElementById(`tab-${tab}`).classList.add('active');
      
      if (tab === 'savings' && chart) {
        chart.update();
      }
    }

    // Calculate button
    document.getElementById('calculate-btn').addEventListener('click', () => {
      doCalculation();
      switchTab('savings');
    });

    function doCalculation() {
      const monthlyBill = parseFloat(document.getElementById('monthly-bill').value) || 200;
      const utility = document.getElementById('utility-provider').value;
      const directionFactor = parseFloat(document.getElementById('roof-direction').value);
      const shadingIndex = parseInt(document.getElementById('shading').value);
      const shadingFactor = SHADING_FACTORS[shadingIndex];

      const rate = UTILITY_RATES[utility];
      const annualUsage = (monthlyBill * 12) / rate;
      const dailyUsage = annualUsage / 365;
      const systemSizeKW = dailyUsage / (TUCSON_SUN_HOURS * directionFactor * shadingFactor);
      const panelCount = Math.ceil((systemSizeKW * 1000) / PANEL_WATTAGE);
      const actualSystemKW = (panelCount * PANEL_WATTAGE) / 1000;

      const grossCost = actualSystemKW * 1000 * COST_PER_WATT;
      const federalCredit = grossCost * FEDERAL_ITC;
      const utilityRebate = utility === 'tep' ? 500 : 400;
      const netCost = grossCost - federalCredit - utilityRebate;

      const annualProduction = actualSystemKW * TUCSON_SUN_HOURS * 365 * directionFactor * shadingFactor;

      // Calculate 25 year savings with rate increase
      let cumulativeSavings = [];
      let totalSavings = 0;
      let yearlySavings = [];
      let currentRate = rate;

      for (let year = 1; year <= 25; year++) {
        const yearSavings = annualProduction * currentRate;
        totalSavings += yearSavings;
        yearlySavings.push(yearSavings);
        cumulativeSavings.push(totalSavings - netCost);
        currentRate *= (1 + RATE_INCREASE);
      }

      // Find break-even year
      let breakevenYear = 25;
      for (let i = 0; i < cumulativeSavings.length; i++) {
        if (cumulativeSavings[i] >= 0) {
          breakevenYear = i + 1;
          break;
        }
      }

      // Store current calculation
      currentCalc = {
        monthlyBill,
        utility: utility.toUpperCase(),
        systemSizeKW: actualSystemKW,
        panelCount,
        grossCost,
        federalCredit,
        utilityRebate,
        netCost,
        annualProduction,
        yearlySavings,
        totalSavings,
        breakevenYear,
        cumulativeSavings,
        date: new Date().toLocaleDateString()
      };

      // Update UI
      document.getElementById('total-savings').textContent = formatCurrency(totalSavings);
      document.getElementById('system-size').textContent = actualSystemKW.toFixed(1) + ' kW';
      document.getElementById('panel-count').textContent = panelCount + ' panels';
      document.getElementById('year1-savings').textContent = formatCurrency(yearlySavings[0]);
      document.getElementById('breakeven-year').textContent = 'Year ' + breakevenYear;
      document.getElementById('breakeven-text').textContent = 'System pays back in year ' + breakevenYear;
      document.getElementById('federal-itc').textContent = '-' + formatCurrency(federalCredit);
      document.getElementById('utility-rebate').textContent = '-' + formatCurrency(utilityRebate);
      document.getElementById('price-before').textContent = formatCurrency(grossCost);
      document.getElementById('price-after').textContent = formatCurrency(netCost);
      document.getElementById('annual-production').textContent = Math.round(annualProduction).toLocaleString() + ' kWh';

      updateChart(cumulativeSavings, breakevenYear);
    }

    function formatCurrency(val) {
      return '$' + Math.round(val).toLocaleString();
    }

    function updateChart(data, breakevenYear) {
      const ctx = document.getElementById('savings-chart').getContext('2d');
      
      if (chart) {
        chart.destroy();
      }

      const labels = Array.from({length: 25}, (_, i) => 'Y' + (i + 1));
      
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Cumulative Savings',
            data: data,
            borderColor: 'oklch(0.72 0.15 70)',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.3,
            pointRadius: 0,
            pointHitRadius: 10
          }, {
            label: 'Break-even',
            data: Array(25).fill(0),
            borderColor: 'oklch(0.65 0.18 145)',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  if (ctx.datasetIndex === 0) {
                    return 'Net savings: ' + formatCurrency(ctx.raw);
                  }
                  return '';
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { maxTicksLimit: 6 }
            },
            y: {
              grid: { color: 'rgba(0,0,0,0.05)' },
              ticks: {
                callback: (val) => formatCurrency(val)
              }
            }
          },
          animation: {
            duration: 1500,
            easing: 'easeOutQuart'
          }
        }
      });
    }

    // Save proposal
    document.getElementById('save-proposal-btn').addEventListener('click', () => {
      if (!currentCalc) return;
      
      if (proposals.length >= 3) {
        showToast('Free limit reached (3 proposals)');
        return;
      }

      generatePDF();
    });

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Header
      doc.setFillColor(30, 41, 59);
      doc.rect(0, 0, 210, 40, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(22);
      doc.setFont('helvetica', 'bold');
      doc.text('Solar Savings Proposal', 20, 25);
      
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      doc.text('Net Zero Solar | Tucson, AZ', 20, 33);
      doc.text(currentCalc.date, 190, 25, { align: 'right' });
      
      // Demo watermark
      doc.setTextColor(200, 200, 200);
      doc.setFontSize(48);
      doc.text('DEMO', 105, 150, { align: 'center', angle: 45 });
      
      // Content
      doc.setTextColor(30, 41, 59);
      let y = 55;
      
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('System Overview', 20, y);
      y += 10;
      
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      const specs = [
        ['System Size:', currentCalc.systemSizeKW.toFixed(1) + ' kW'],
        ['Number of Panels:', currentCalc.panelCount + ' panels'],
        ['Annual Production:', Math.round(currentCalc.annualProduction).toLocaleString() + ' kWh'],
        ['Inverter:', 'Enphase IQ8 Microinverters'],
        ['Warranty:', '25 years full coverage']
      ];
      
      specs.forEach(([label, value]) => {
        doc.text(label, 20, y);
        doc.text(value, 100, y);
        y += 7;
      });
      
      y += 10;
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('Pricing & Incentives', 20, y);
      y += 10;
      
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      const pricing = [
        ['Gross System Cost:', formatCurrency(currentCalc.grossCost)],
        ['Federal Tax Credit (30%):', '-' + formatCurrency(currentCalc.federalCredit)],
        ['Utility Rebate (' + currentCalc.utility + '):', '-' + formatCurrency(currentCalc.utilityRebate)],
        ['Net Cost After Incentives:', formatCurrency(currentCalc.netCost)]
      ];
      
      pricing.forEach(([label, value], i) => {
        doc.text(label, 20, y);
        if (i === pricing.length - 1) {
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(16, 122, 87);
        }
        doc.text(value, 100, y);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(30, 41, 59);
        y += 7;
      });
      
      y += 10;
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('25-Year Savings Summary', 20, y);
      y += 10;
      
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      doc.text('Total Savings:', 20, y);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(16);
      doc.setTextColor(16, 122, 87);
      doc.text(formatCurrency(currentCalc.totalSavings), 100, y);
      y += 10;
      
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(30, 41, 59);
      doc.text('Break-even Year:', 20, y);
      doc.text('Year ' + currentCalc.breakevenYear, 100, y);
      
      // Footer
      doc.setFontSize(9);
      doc.setTextColor(120, 120, 120);
      doc.text('Prepared by Net Zero Solar | (520) 207-4053 | netzerosolar.net', 105, 280, { align: 'center' });
      doc.text('DEMO - Estimates for illustration only', 105, 286, { align: 'center' });
      
      // Save the PDF
      const blob = doc.output('blob');
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'solar-proposal-' + currentCalc.date.replace(/\//g, '-') + '.pdf';
      a.click();
      URL.revokeObjectURL(url);
      
      // Save to proposals list
      const proposal = {
        id: Date.now(),
        name: 'Proposal ' + (proposals.length + 1),
        date: currentCalc.date,
        savings: currentCalc.totalSavings,
        systemSize: currentCalc.systemSizeKW
      };
      proposals.push(proposal);
      saveProposals();
      renderProposals();
      
      showToast('Proposal saved!');
    }

    // Share button
    document.getElementById('share-btn').addEventListener('click', async () => {
      if (!currentCalc) return;
      
      const shareText = `Net Zero Solar Proposal\n\nSystem: ${currentCalc.systemSizeKW.toFixed(1)} kW (${currentCalc.panelCount} panels)\nNet Cost: ${formatCurrency(currentCalc.netCost)}\n25-Year Savings: ${formatCurrency(currentCalc.totalSavings)}\nBreak-even: Year ${currentCalc.breakevenYear}\n\nCall Net Zero Solar: (520) 207-4053`;
      
      if (navigator.share) {
        try {
          await navigator.share({
            title: 'Solar Savings Proposal',
            text: shareText
          });
          showToast('Shared!');
        } catch (e) {
          copyToClipboard(shareText);
        }
      } else {
        copyToClipboard(shareText);
      }
    });

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard!');
      }).catch(() => {
        showToast('Could not copy');
      });
    }

    // Proposals management
    function loadProposals() {
      try {
        proposals = JSON.parse(localStorage.getItem('solarcalc_proposals') || '[]');
      } catch (e) {
        proposals = [];
      }
      renderProposals();
    }

    function saveProposals() {
      localStorage.setItem('solarcalc_proposals', JSON.stringify(proposals));
    }

    function renderProposals() {
      const list = document.getElementById('proposal-list');
      const empty = document.getElementById('empty-proposals');
      const count = document.getElementById('proposal-count');
      
      count.textContent = proposals.length + '/3 free';
      
      if (proposals.length === 0) {
        list.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      
      empty.style.display = 'none';
      list.innerHTML = proposals.map(p => `
        <li class="proposal-item">
          <div class="proposal-info">
            <div class="proposal-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
            </div>
            <div>
              <div class="proposal-name">${p.name}</div>
              <div class="proposal-date">${p.date} | ${formatCurrency(p.savings)} savings</div>
            </div>
          </div>
          <div class="proposal-actions">
            <button type="button" class="icon-btn" onclick="deleteProposal(${p.id})" aria-label="Delete ${p.name}">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
            </button>
          </div>
        </li>
      `).join('');
    }

    window.deleteProposal = function(id) {
      proposals = proposals.filter(p => p.id !== id);
      saveProposals();
      renderProposals();
      showToast('Proposal deleted');
    };

    // Toast notification
    function showToast(message) {
      const toast = document.getElementById('toast');
      document.getElementById('toast-message').textContent = message;
      toast.classList.add('visible');
      setTimeout(() => {
        toast.classList.remove('visible');
      }, 2500);
    }

    // Initialize
    init();
  </script>
</body>
</html>
