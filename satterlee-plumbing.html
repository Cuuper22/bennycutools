<!--
  SATTERLEE LEGACY LINK - Service Transparency Portal
  Reviewed by: benny-polish agent
  Review Date: 2026-02-06
  Status: ACCEPT with security enhancements
  
  Changes made:
  - Added access key security layer
  - Added anti-scrape protection (right-click, keyboard shortcuts)
  - Added user-select protection on non-input elements
  - Enhanced CSS for premium feel
  
  Original: tool.html
  Polished: tool-final.html
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Satterlee Plumbing Service Transparency Portal - Track your service call in real-time. Since 1892.">
    <meta name="theme-color" content="#214426">
    <title>Satterlee Legacy Link â€” Service Transparency Portal</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23214426' width='100' height='100' rx='15'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-family='Georgia' font-size='60' fill='%23ffd100'%3ES%3C/text%3E%3C/svg%3E">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tienne:wght@400;700;900&family=Raleway:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <style>
        /* ===== SATTERLEE DESIGN SYSTEM ===== */
        :root {
            /* Primary Palette */
            --satterlee-green: #214426;
            --satterlee-green-dark: #1a3620;
            --satterlee-green-light: #2d5c33;
            --satterlee-gold: #ffd100;
            --satterlee-gold-dark: #e6bc00;
            --satterlee-gold-light: #ffe44d;
            
            /* Neutrals */
            --bg-primary: #f5f5f0;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8e8e3;
            --text-primary: #1a1a1a;
            --text-secondary: #4a4a4a;
            --text-muted: #7a7a7a;
            --border-light: #d4d4c9;
            --border-medium: #b8b8ad;
            
            /* Semantic Colors */
            --success: #2d7a3d;
            --success-bg: #e8f5ea;
            --warning: #b8860b;
            --warning-bg: #fef9e7;
            --error: #c53030;
            --error-bg: #fee;
            --info: #2c5aa0;
            --info-bg: #e8f0fa;
            
            /* Status Colors */
            --status-scheduled: #6b7280;
            --status-assigned: #2c5aa0;
            --status-enroute: #b8860b;
            --status-inprogress: #214426;
            --status-complete: #2d7a3d;
            
            /* Spacing Scale */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 24px;
            --space-6: 32px;
            --space-7: 48px;
            --space-8: 64px;
            
            /* Typography Scale */
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
            --text-4xl: 2.25rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(33, 68, 38, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(33, 68, 38, 0.08), 0 2px 4px -1px rgba(33, 68, 38, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(33, 68, 38, 0.1), 0 4px 6px -2px rgba(33, 68, 38, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(33, 68, 38, 0.12), 0 10px 10px -5px rgba(33, 68, 38, 0.04);
            --shadow-gold: 0 4px 14px rgba(255, 209, 0, 0.3);
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-base: 250ms ease;
            --transition-slow: 400ms ease;
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;
        }
        
        /* ===== RESET & BASE ===== */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
        }
        
        body {
            font-family: 'Raleway', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Allow text selection in inputs and textareas only */
        input, textarea, select, [contenteditable] {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Tienne', Georgia, serif;
            font-weight: 700;
            line-height: 1.2;
            color: var(--satterlee-green);
        }
        
        /* ===== APP LAYOUT ===== */
        .app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            min-height: 100dvh;
            max-width: 100vw;
        }
        
        .app-header {
            background: linear-gradient(135deg, var(--satterlee-green) 0%, var(--satterlee-green-dark) 100%);
            padding: var(--space-4) var(--space-4);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* Premium card enhancements */
        .card {
            transition: var(--transition-base), transform 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-4px);
        }
        
        /* Enhanced focus states for accessibility */
        .btn:focus-visible,
        .form-input:focus-visible,
        .icon-btn:focus-visible,
        .tab-item:focus-visible,
        .tracker-btn:focus-visible {
            outline: 3px solid var(--satterlee-gold);
            outline-offset: 2px;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .brand-icon {
            width: 44px;
            height: 44px;
            background: var(--satterlee-gold);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-gold);
        }
        
        .brand-icon svg {
            color: var(--satterlee-green);
            width: 26px;
            height: 26px;
        }
        
        .brand-text {
            display: flex;
            flex-direction: column;
        }
        
        .brand-name {
            font-family: 'Tienne', serif;
            font-size: var(--text-lg);
            font-weight: 900;
            color: white;
            letter-spacing: 0.5px;
            line-height: 1.1;
        }
        
        .brand-tagline {
            font-size: var(--text-xs);
            color: var(--satterlee-gold);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        
        .header-actions {
            display: flex;
            gap: var(--space-2);
        }
        
        .icon-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }
        
        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .icon-btn:active {
            transform: scale(0.95);
        }
        
        .icon-btn svg {
            width: 22px;
            height: 22px;
        }
        
        /* ===== MAIN CONTENT ===== */
        .app-main {
            flex: 1;
            padding: var(--space-4);
            padding-bottom: 100px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        .view {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .view.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ===== DEMO BANNER ===== */
        .demo-banner {
            background: linear-gradient(135deg, var(--warning-bg) 0%, #fff8e1 100%);
            border: 2px solid var(--satterlee-gold);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-5);
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            animation: slideDown 0.4s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .demo-banner.hidden {
            display: none;
        }
        
        .demo-banner svg {
            color: var(--warning);
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .demo-banner-content {
            flex: 1;
        }
        
        .demo-banner-title {
            font-family: 'Tienne', serif;
            font-size: var(--text-base);
            font-weight: 700;
            color: var(--satterlee-green);
            margin-bottom: var(--space-1);
        }
        
        .demo-banner-text {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .demo-banner-actions {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-3);
        }
        
        .demo-banner .btn-sm {
            padding: var(--space-2) var(--space-3);
            font-size: var(--text-sm);
        }
        
        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-5);
            font-family: 'Raleway', sans-serif;
            font-size: var(--text-base);
            font-weight: 600;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            text-decoration: none;
            min-height: 44px;
        }
        
        .btn svg {
            width: 20px;
            height: 20px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--satterlee-gold) 0%, var(--satterlee-gold-dark) 100%);
            color: var(--satterlee-green);
            box-shadow: var(--shadow-gold);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 209, 0, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0) scale(0.98);
        }
        
        /* Premium button shimmer effect */
        .btn-primary {
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .btn-primary:hover::after {
            left: 100%;
        }
        
        .btn-secondary {
            background: var(--satterlee-green);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary:hover {
            background: var(--satterlee-green-light);
        }
        
        .btn-ghost {
            background: transparent;
            color: var(--satterlee-green);
            border: 2px solid var(--border-medium);
        }
        
        .btn-ghost:hover {
            border-color: var(--satterlee-green);
            background: rgba(33, 68, 38, 0.05);
        }
        
        .btn-danger {
            background: var(--error);
            color: white;
        }
        
        .btn-danger:hover {
            background: #b52828;
        }
        
        .btn-sm {
            padding: var(--space-2) var(--space-3);
            font-size: var(--text-sm);
            min-height: 36px;
        }
        
        .btn-lg {
            padding: var(--space-4) var(--space-6);
            font-size: var(--text-lg);
            min-height: 52px;
        }
        
        .btn-block {
            width: 100%;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* ===== CARDS ===== */
        .card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: var(--transition-base);
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
        }
        
        .card-header {
            padding: var(--space-4) var(--space-5);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card-title {
            font-family: 'Tienne', serif;
            font-size: var(--text-lg);
            font-weight: 700;
        }
        
        .card-body {
            padding: var(--space-5);
        }
        
        .card-footer {
            padding: var(--space-4) var(--space-5);
            border-top: 1px solid var(--border-light);
            background: var(--bg-primary);
        }
        
        /* ===== JOB CARDS ===== */
        .job-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }
        
        .job-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: var(--transition-base), transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-left: 4px solid var(--status-scheduled);
            cursor: pointer;
        }
        
        .job-card:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-4px) scale(1.005);
        }
        
        .job-card:active {
            transform: translateY(-2px) scale(0.998);
        }
        
        .job-card[data-status="scheduled"] { border-left-color: var(--status-scheduled); }
        .job-card[data-status="assigned"] { border-left-color: var(--status-assigned); }
        .job-card[data-status="enroute"] { border-left-color: var(--status-enroute); }
        .job-card[data-status="inprogress"] { border-left-color: var(--status-inprogress); }
        .job-card[data-status="complete"] { border-left-color: var(--status-complete); }
        
        .job-card-header {
            padding: var(--space-4);
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: var(--space-3);
        }
        
        .job-customer {
            font-family: 'Tienne', serif;
            font-size: var(--text-lg);
            font-weight: 700;
            color: var(--satterlee-green);
            margin-bottom: var(--space-1);
        }
        
        .job-address {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .job-address svg {
            width: 14px;
            height: 14px;
            color: var(--text-muted);
        }
        
        .job-status-badge {
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        
        .job-status-badge.scheduled { background: #e5e7eb; color: #374151; }
        .job-status-badge.assigned { background: #dbeafe; color: #1e40af; }
        .job-status-badge.enroute { background: #fef3c7; color: #92400e; }
        .job-status-badge.inprogress { background: #d1fae5; color: var(--satterlee-green); }
        .job-status-badge.complete { background: var(--success-bg); color: var(--success); }
        
        .job-card-body {
            padding: 0 var(--space-4) var(--space-4);
        }
        
        .job-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-3);
        }
        
        .job-detail {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        
        .job-detail-label {
            font-size: var(--text-xs);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .job-detail-value {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .job-card-actions {
            padding: var(--space-3) var(--space-4);
            background: var(--bg-primary);
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: var(--space-2);
        }
        
        .job-card-actions .btn {
            flex: 1;
        }
        
        /* ===== TIME TRACKER (THE CORE FEATURE) ===== */
        .time-tracker {
            background: linear-gradient(135deg, var(--satterlee-green) 0%, var(--satterlee-green-dark) 100%);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            color: white;
            text-align: center;
            margin-bottom: var(--space-5);
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }
        
        .time-tracker::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 209, 0, 0.1) 0%, transparent 50%);
            animation: pulse-glow 3s ease-in-out infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .time-tracker-content {
            position: relative;
            z-index: 1;
        }
        
        .tracker-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }
        
        .tracker-status-dot {
            width: 12px;
            height: 12px;
            background: var(--satterlee-gold);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
        }
        
        .tracker-status-text {
            font-size: var(--text-sm);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
            color: var(--satterlee-gold);
        }
        
        .tracker-time {
            font-family: 'Tienne', serif;
            font-size: var(--text-4xl);
            font-weight: 900;
            margin-bottom: var(--space-2);
            letter-spacing: 2px;
        }
        
        .tracker-label {
            font-size: var(--text-sm);
            opacity: 0.9;
            margin-bottom: var(--space-5);
        }
        
        .tracker-tech {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
            padding-top: var(--space-4);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .tech-avatar {
            width: 48px;
            height: 48px;
            background: var(--satterlee-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Tienne', serif;
            font-size: var(--text-lg);
            font-weight: 700;
            color: var(--satterlee-green);
        }
        
        .tech-info {
            text-align: left;
        }
        
        .tech-name {
            font-family: 'Tienne', serif;
            font-size: var(--text-lg);
            font-weight: 700;
        }
        
        .tech-tenure {
            font-size: var(--text-sm);
            opacity: 0.8;
        }
        
        /* ===== TRACKER CONTROLS ===== */
        .tracker-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-3);
            margin-top: var(--space-5);
        }
        
        .tracker-btn {
            padding: var(--space-4);
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            color: white;
            font-family: 'Raleway', sans-serif;
            font-size: var(--text-sm);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-2);
        }
        
        .tracker-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--satterlee-gold);
        }
        
        .tracker-btn:active {
            transform: scale(0.98);
        }
        
        .tracker-btn svg {
            width: 24px;
            height: 24px;
        }
        
        .tracker-btn.active {
            background: var(--satterlee-gold);
            color: var(--satterlee-green);
            border-color: var(--satterlee-gold);
        }
        
        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: var(--space-5);
        }
        
        .form-label {
            display: block;
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            font-family: 'Raleway', sans-serif;
            font-size: 16px; /* Prevents zoom on iOS */
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: var(--transition-fast);
            min-height: 44px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--satterlee-green);
            box-shadow: 0 0 0 3px rgba(33, 68, 38, 0.1);
        }
        
        .form-input.error {
            border-color: var(--error);
            animation: shake 0.5s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        
        .form-input::placeholder {
            color: var(--text-muted);
        }
        
        textarea.form-input {
            min-height: 100px;
            resize: vertical;
        }
        
        select.form-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%237a7a7a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 44px;
        }
        
        .form-hint {
            font-size: var(--text-xs);
            color: var(--text-muted);
            margin-top: var(--space-2);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
        }
        
        /* ===== BOTTOM TAB BAR ===== */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: space-around;
            padding: var(--space-2) var(--space-2) calc(var(--space-2) + env(safe-area-inset-bottom));
            z-index: 100;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-2) var(--space-3);
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: var(--text-xs);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
            min-width: 60px;
            border-radius: var(--radius-md);
        }
        
        .tab-item svg {
            width: 24px;
            height: 24px;
            transition: var(--transition-fast);
        }
        
        .tab-item:hover {
            color: var(--satterlee-green);
        }
        
        .tab-item.active {
            color: var(--satterlee-green);
        }
        
        .tab-item.active svg {
            color: var(--satterlee-gold);
        }
        
        /* ===== TOASTS ===== */
        .toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            pointer-events: none;
            width: calc(100% - var(--space-8));
            max-width: 400px;
        }
        
        .toast {
            background: var(--satterlee-green);
            color: white;
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            animation: toastIn 0.3s ease;
            pointer-events: auto;
        }
        
        .toast.leaving {
            animation: toastOut 0.3s ease forwards;
        }
        
        @keyframes toastIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes toastOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 700;
            margin-bottom: var(--space-1);
        }
        
        .toast-message {
            font-size: var(--text-sm);
            opacity: 0.9;
        }
        
        .toast-action {
            background: var(--satterlee-gold);
            color: var(--satterlee-green);
            border: none;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: var(--text-sm);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .toast-action:hover {
            background: var(--satterlee-gold-light);
        }
        
        .toast.success { background: var(--success); }
        .toast.warning { background: var(--warning); }
        .toast.error { background: var(--error); }
        
        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: var(--space-8) var(--space-5);
        }
        
        .empty-state-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto var(--space-5);
            background: var(--bg-tertiary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .empty-state-icon svg {
            width: 40px;
            height: 40px;
            color: var(--text-muted);
        }
        
        .empty-state-title {
            font-family: 'Tienne', serif;
            font-size: var(--text-2xl);
            margin-bottom: var(--space-3);
        }
        
        .empty-state-text {
            color: var(--text-secondary);
            margin-bottom: var(--space-5);
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .empty-state-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            align-items: center;
        }
        
        .empty-state-link {
            color: var(--satterlee-green);
            font-weight: 600;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .empty-state-link:hover {
            text-decoration: underline;
        }
        
        /* ===== TECH LIST ===== */
        .tech-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        
        .tech-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: var(--space-4);
            transition: var(--transition-base);
        }
        
        .tech-card:hover {
            box-shadow: var(--shadow-md);
        }
        
        .tech-card-avatar {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--satterlee-green) 0%, var(--satterlee-green-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Tienne', serif;
            font-size: var(--text-xl);
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }
        
        .tech-card-info {
            flex: 1;
        }
        
        .tech-card-name {
            font-family: 'Tienne', serif;
            font-size: var(--text-lg);
            font-weight: 700;
            color: var(--satterlee-green);
            margin-bottom: var(--space-1);
        }
        
        .tech-card-meta {
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }
        
        .tech-card-status {
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .tech-card-status.available {
            background: var(--success-bg);
            color: var(--success);
        }
        
        .tech-card-status.busy {
            background: var(--warning-bg);
            color: var(--warning);
        }
        
        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-base);
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: var(--transition-base);
        }
        
        .modal-overlay.active .modal {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: var(--space-5);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 1;
        }
        
        .modal-title {
            font-family: 'Tienne', serif;
            font-size: var(--text-xl);
            font-weight: 700;
        }
        
        .modal-close {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }
        
        .modal-close:hover {
            background: var(--border-light);
        }
        
        .modal-body {
            padding: var(--space-5);
        }
        
        .modal-footer {
            padding: var(--space-4) var(--space-5);
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: var(--space-3);
        }
        
        .modal-footer .btn {
            flex: 1;
        }
        
        /* ===== DATA/SETTINGS PAGE ===== */
        .settings-section {
            margin-bottom: var(--space-6);
        }
        
        .settings-title {
            font-family: 'Tienne', serif;
            font-size: var(--text-lg);
            font-weight: 700;
            color: var(--satterlee-green);
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-2);
            border-bottom: 2px solid var(--satterlee-gold);
            display: inline-block;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-3);
        }
        
        .settings-btn {
            padding: var(--space-4);
            background: var(--bg-secondary);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-2);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .settings-btn:hover {
            border-color: var(--satterlee-green);
            box-shadow: var(--shadow-md);
        }
        
        .settings-btn svg {
            width: 28px;
            height: 28px;
            color: var(--satterlee-green);
        }
        
        .settings-btn span {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        /* ===== STATS BANNER ===== */
        .stats-banner {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-3);
            margin-bottom: var(--space-5);
        }
        
        .stat-item {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            text-align: center;
            box-shadow: var(--shadow-sm);
        }
        
        .stat-value {
            font-family: 'Tienne', serif;
            font-size: var(--text-2xl);
            font-weight: 900;
            color: var(--satterlee-green);
        }
        
        .stat-label {
            font-size: var(--text-xs);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: var(--space-1);
        }
        
        /* ===== PRINT STYLES ===== */
        @media print {
            .app-header,
            .tab-bar,
            .demo-banner,
            .toast-container,
            .modal-overlay,
            .btn,
            .tracker-controls {
                display: none !important;
            }
            
            .app-main {
                padding: 0;
                max-width: 100%;
            }
            
            .job-card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ccc;
            }
            
            .time-tracker {
                background: white !important;
                color: black !important;
                box-shadow: none;
                border: 2px solid var(--satterlee-green);
            }
            
            .time-tracker::before {
                display: none;
            }
            
            body {
                background: white;
            }
        }
        
        /* ===== DESKTOP STYLES ===== */
        @media (min-width: 1024px) {
            .tab-bar {
                display: none;
            }
            
            .app-main {
                padding-bottom: var(--space-6);
            }
            
            .header-content {
                gap: var(--space-6);
            }
            
            .desktop-nav {
                display: flex;
                gap: var(--space-2);
            }
            
            .desktop-nav-item {
                padding: var(--space-2) var(--space-4);
                background: transparent;
                border: none;
                color: rgba(255, 255, 255, 0.8);
                font-weight: 600;
                font-size: var(--text-sm);
                cursor: pointer;
                border-radius: var(--radius-md);
                transition: var(--transition-fast);
                display: flex;
                align-items: center;
                gap: var(--space-2);
            }
            
            .desktop-nav-item:hover {
                background: rgba(255, 255, 255, 0.1);
                color: white;
            }
            
            .desktop-nav-item.active {
                background: rgba(255, 255, 255, 0.15);
                color: var(--satterlee-gold);
            }
            
            .desktop-nav-item svg {
                width: 18px;
                height: 18px;
            }
            
            .job-list {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-row {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .modal {
                border-radius: var(--radius-xl);
                max-width: 600px;
                margin: auto;
            }
            
            .modal-overlay.active .modal {
                transform: translateY(0);
            }
            
            .settings-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* Hide desktop nav on mobile */
        @media (max-width: 1023px) {
            .desktop-nav {
                display: none;
            }
        }
        
        /* ===== LOADING STATES ===== */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-primary) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-md);
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-light);
            border-top-color: var(--satterlee-gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== VISUALLY HIDDEN ===== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* ===== FILE INPUT ===== */
        .file-input-wrapper {
            position: relative;
        }
        
        .file-input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }
        
        .file-input-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-6);
            border: 2px dashed var(--border-medium);
            border-radius: var(--radius-lg);
            text-align: center;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .file-input-label:hover {
            border-color: var(--satterlee-green);
            background: rgba(33, 68, 38, 0.03);
        }
        
        .file-input-label svg {
            width: 40px;
            height: 40px;
            color: var(--text-muted);
        }
        
        .file-input-label span {
            color: var(--text-secondary);
            font-size: var(--text-sm);
        }
        
        .file-input-label strong {
            color: var(--satterlee-green);
        }
        
        /* ===== LEGACY BADGE (Satterlee-specific) ===== */
        .legacy-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: linear-gradient(135deg, var(--satterlee-gold) 0%, var(--satterlee-gold-dark) 100%);
            color: var(--satterlee-green);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .legacy-badge svg {
            width: 14px;
            height: 14px;
        }
    </style>
</head>
<body>
    <!-- SECURITY LAYER: Access Key Gate -->
    <script>
    (function(){
        function _h(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return h;}
        const _V=-2117083312;
        const _k=new URLSearchParams(window.location.search).get('key');
        if(!_k||_h(_k)!==_V){document.body.innerHTML='<div style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#214426;color:white;text-align:center;padding:40px;font-family:sans-serif"><h1>Access Restricted</h1><p style="opacity:0.8;margin-top:16px">Contact ben@bennycutools.com for access.</p></div>';throw new Error('denied');}
    })();
    </script>
    
    <!-- ANTI-SCRAPE PROTECTION -->
    <script>
    (function(){
        // Disable right-click context menu
        document.addEventListener('contextmenu', e => e.preventDefault());
        
        // Block keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // F12 (DevTools)
            if(e.key==='F12'){e.preventDefault();return false;}
            // Ctrl+U (View Source)
            if(e.ctrlKey&&e.key.toLowerCase()==='u'){e.preventDefault();return false;}
            // Ctrl+S (Save Page)
            if(e.ctrlKey&&e.key.toLowerCase()==='s'){e.preventDefault();return false;}
            // Ctrl+Shift+I (DevTools)
            if(e.ctrlKey&&e.shiftKey&&e.key.toLowerCase()==='i'){e.preventDefault();return false;}
        });
    })();
    </script>
    
    <div class="app">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="brand">
                    <div class="brand-icon">
                        <i data-lucide="wrench"></i>
                    </div>
                    <div class="brand-text">
                        <span class="brand-name">Satterlee</span>
                        <span class="brand-tagline">Since 1892</span>
                    </div>
                </div>
                
                <nav class="desktop-nav">
                    <button class="desktop-nav-item active" data-view="jobs">
                        <i data-lucide="clipboard-list"></i>
                        Jobs
                    </button>
                    <button class="desktop-nav-item" data-view="techs">
                        <i data-lucide="users"></i>
                        Techs
                    </button>
                    <button class="desktop-nav-item" data-view="new">
                        <i data-lucide="plus-circle"></i>
                        New Job
                    </button>
                    <button class="desktop-nav-item" data-view="settings">
                        <i data-lucide="settings"></i>
                        Settings
                    </button>
                </nav>
                
                <div class="header-actions">
                    <button class="icon-btn" id="refreshBtn" title="Refresh">
                        <i data-lucide="refresh-cw"></i>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="app-main">
            <!-- Demo Banner -->
            <div class="demo-banner" id="demoBanner">
                <i data-lucide="info" style="width: 24px; height: 24px;"></i>
                <div class="demo-banner-content">
                    <div class="demo-banner-title">Showing sample data for Satterlee Plumbing</div>
                    <div class="demo-banner-text">
                        This is demo data to show you how the Legacy Link works. Clear it to start fresh with your own jobs.
                    </div>
                    <div class="demo-banner-actions">
                        <button class="btn btn-primary btn-sm" id="clearDemoBtn">
                            <i data-lucide="trash-2"></i>
                            Clear Demo Data
                        </button>
                        <button class="btn btn-ghost btn-sm" id="dismissDemoBtn">
                            Dismiss
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- JOBS VIEW (Primary/First Screen) -->
            <div class="view active" id="jobsView">
                <!-- Active Job Time Tracker (shown when a job is in progress) -->
                <div class="time-tracker" id="activeTracker" style="display: none;">
                    <div class="time-tracker-content">
                        <div class="tracker-status">
                            <div class="tracker-status-dot"></div>
                            <span class="tracker-status-text" id="trackerStatusText">Tech En Route</span>
                        </div>
                        <div class="tracker-time" id="trackerTime">00:00</div>
                        <div class="tracker-label" id="trackerLabel">Travel time from N Main St</div>
                        <div class="tracker-tech">
                            <div class="tech-avatar" id="trackerTechAvatar">R</div>
                            <div class="tech-info">
                                <div class="tech-name" id="trackerTechName">Ryan Mitchell</div>
                                <div class="tech-tenure" id="trackerTechTenure">5 years with Satterlee</div>
                            </div>
                        </div>
                        <div class="tracker-controls">
                            <button class="tracker-btn" id="startTravelBtn">
                                <i data-lucide="truck"></i>
                                Start Travel
                            </button>
                            <button class="tracker-btn" id="arriveBtn">
                                <i data-lucide="map-pin"></i>
                                Arrived
                            </button>
                            <button class="tracker-btn" id="startJobBtn">
                                <i data-lucide="play"></i>
                                Start Job
                            </button>
                            <button class="tracker-btn" id="completeBtn">
                                <i data-lucide="check-circle"></i>
                                Complete
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Stats -->
                <div class="stats-banner" id="statsContainer">
                    <div class="stat-item">
                        <div class="stat-value" id="statToday">0</div>
                        <div class="stat-label">Today</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statActive">0</div>
                        <div class="stat-label">Active</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statComplete">0</div>
                        <div class="stat-label">Complete</div>
                    </div>
                </div>
                
                <!-- Jobs List -->
                <div class="job-list" id="jobsList">
                    <!-- Jobs rendered here -->
                </div>
                
                <!-- Empty State -->
                <div class="empty-state" id="emptyJobsState" style="display: none;">
                    <div class="empty-state-icon">
                        <i data-lucide="clipboard-list"></i>
                    </div>
                    <h2 class="empty-state-title">No Jobs Yet</h2>
                    <p class="empty-state-text">
                        Create your first service job and start tracking with complete transparency.
                    </p>
                    <div class="empty-state-actions">
                        <button class="btn btn-primary btn-lg" onclick="showView('new')">
                            <i data-lucide="plus"></i>
                            Create First Job
                        </button>
                        <a href="#" class="empty-state-link" onclick="showImportModal(); return false;">
                            <i data-lucide="upload"></i>
                            Import from CSV
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- TECHS VIEW -->
            <div class="view" id="techsView">
                <h2 style="font-family: 'Tienne', serif; font-size: var(--text-2xl); margin-bottom: var(--space-5);">Your Team</h2>
                
                <div class="tech-list" id="techsList">
                    <!-- Techs rendered here -->
                </div>
                
                <button class="btn btn-primary btn-block" style="margin-top: var(--space-5);" onclick="showAddTechModal()">
                    <i data-lucide="user-plus"></i>
                    Add Technician
                </button>
            </div>
            
            <!-- NEW JOB VIEW -->
            <div class="view" id="newView">
                <h2 style="font-family: 'Tienne', serif; font-size: var(--text-2xl); margin-bottom: var(--space-5);">New Service Job</h2>
                
                <form id="newJobForm" class="card">
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label" for="customerName">Customer Name *</label>
                            <input type="text" class="form-input" id="customerName" placeholder="e.g., Johnson Family" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="customerPhone">Phone</label>
                            <input type="tel" class="form-input" id="customerPhone" placeholder="(417) 555-0123">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="address">Service Address *</label>
                            <input type="text" class="form-input" id="address" placeholder="123 Main St, Joplin, MO" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="serviceType">Service Type *</label>
                                <select class="form-input" id="serviceType" required>
                                    <option value="">Select...</option>
                                    <option value="plumbing">Plumbing</option>
                                    <option value="hvac">HVAC</option>
                                    <option value="drain">Drain Cleaning</option>
                                    <option value="water-heater">Water Heater</option>
                                    <option value="commercial">Commercial</option>
                                    <option value="emergency">Emergency</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="assignedTech">Assign Tech</label>
                                <select class="form-input" id="assignedTech">
                                    <option value="">Unassigned</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="scheduledDate">Date *</label>
                                <input type="date" class="form-input" id="scheduledDate" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="scheduledTime">Time</label>
                                <input type="time" class="form-input" id="scheduledTime">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="notes">Job Notes</label>
                            <textarea class="form-input" id="notes" placeholder="Customer says water heater making noise..."></textarea>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <button type="submit" class="btn btn-primary btn-block btn-lg">
                            <i data-lucide="plus"></i>
                            Create Job
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- SETTINGS VIEW -->
            <div class="view" id="settingsView">
                <h2 style="font-family: 'Tienne', serif; font-size: var(--text-2xl); margin-bottom: var(--space-5);">Settings & Data</h2>
                
                <div class="settings-section">
                    <h3 class="settings-title">Import Data</h3>
                    <div class="settings-grid">
                        <button class="settings-btn" onclick="showImportModal()">
                            <i data-lucide="file-up"></i>
                            <span>Import CSV</span>
                        </button>
                        <button class="settings-btn" onclick="showPasteModal()">
                            <i data-lucide="clipboard-paste"></i>
                            <span>Paste Data</span>
                        </button>
                        <button class="settings-btn" onclick="triggerJsonRestore()">
                            <i data-lucide="database"></i>
                            <span>Restore Backup</span>
                        </button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3 class="settings-title">Export Data</h3>
                    <div class="settings-grid">
                        <button class="settings-btn" onclick="exportCSV()">
                            <i data-lucide="file-down"></i>
                            <span>Export CSV</span>
                        </button>
                        <button class="settings-btn" onclick="exportJSON()">
                            <i data-lucide="hard-drive-download"></i>
                            <span>Full Backup</span>
                        </button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3 class="settings-title">Data Management</h3>
                    <div class="settings-grid">
                        <button class="settings-btn" onclick="loadDemoData()">
                            <i data-lucide="sparkles"></i>
                            <span>Load Demo</span>
                        </button>
                        <button class="settings-btn" onclick="confirmClearAll()" style="border-color: var(--error);">
                            <i data-lucide="trash-2" style="color: var(--error);"></i>
                            <span style="color: var(--error);">Clear All</span>
                        </button>
                    </div>
                </div>
                
                <div class="card" style="margin-top: var(--space-6);">
                    <div class="card-body" style="text-align: center;">
                        <div class="legacy-badge" style="margin-bottom: var(--space-3);">
                            <i data-lucide="award"></i>
                            130+ Years of Service
                        </div>
                        <h3 style="font-family: 'Tienne', serif; margin-bottom: var(--space-2);">Satterlee Legacy Link</h3>
                        <p style="color: var(--text-secondary); font-size: var(--text-sm);">
                            Built for transparency. Every minute tracked.<br>
                            Just like we've done since 1892.
                        </p>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Bottom Tab Bar (Mobile) -->
        <nav class="tab-bar">
            <button class="tab-item active" data-view="jobs">
                <i data-lucide="clipboard-list"></i>
                <span>Jobs</span>
            </button>
            <button class="tab-item" data-view="techs">
                <i data-lucide="users"></i>
                <span>Techs</span>
            </button>
            <button class="tab-item" data-view="new">
                <i data-lucide="plus-circle"></i>
                <span>New</span>
            </button>
            <button class="tab-item" data-view="settings">
                <i data-lucide="settings"></i>
                <span>Settings</span>
            </button>
        </nav>
        
        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>
        
        <!-- Import Modal -->
        <div class="modal-overlay" id="importModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Import CSV</h3>
                    <button class="modal-close" onclick="closeModal('importModal')">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="file-input-wrapper">
                        <input type="file" class="file-input" id="csvFileInput" accept=".csv">
                        <label class="file-input-label" for="csvFileInput">
                            <i data-lucide="upload-cloud"></i>
                            <span>Drop your CSV here or <strong>browse</strong></span>
                        </label>
                    </div>
                    <p class="form-hint" style="margin-top: var(--space-4); text-align: center;">
                        Expected columns: Customer, Phone, Address, Type, Date, Time, Tech, Notes
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Paste Modal -->
        <div class="modal-overlay" id="pasteModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Paste Data</h3>
                    <button class="modal-close" onclick="closeModal('pasteModal')">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Paste CSV or tab-separated data</label>
                        <textarea class="form-input" id="pasteArea" rows="8" placeholder="Customer&#9;Phone&#9;Address&#9;Type&#10;Johnson&#9;417-555-0123&#9;123 Main St&#9;Plumbing"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-ghost" onclick="closeModal('pasteModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="processPastedData()">Import</button>
                </div>
            </div>
        </div>
        
        <!-- Add Tech Modal -->
        <div class="modal-overlay" id="addTechModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Add Technician</h3>
                    <button class="modal-close" onclick="closeModal('addTechModal')">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addTechForm">
                        <div class="form-group">
                            <label class="form-label" for="techName">Name *</label>
                            <input type="text" class="form-input" id="techName" placeholder="Ryan Mitchell" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="techYears">Years with Company</label>
                            <input type="number" class="form-input" id="techYears" placeholder="5" min="0" max="50">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="techSpecialty">Specialty</label>
                            <select class="form-input" id="techSpecialty">
                                <option value="general">General</option>
                                <option value="plumbing">Plumbing</option>
                                <option value="hvac">HVAC</option>
                                <option value="commercial">Commercial</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-ghost" onclick="closeModal('addTechModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveTech()">
                        <i data-lucide="user-plus"></i>
                        Add Tech
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Job Detail Modal -->
        <div class="modal-overlay" id="jobDetailModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Job Details</h3>
                    <button class="modal-close" onclick="closeModal('jobDetailModal')">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body" id="jobDetailContent">
                    <!-- Filled dynamically -->
                </div>
                <div class="modal-footer">
                    <button class="btn btn-ghost" onclick="deleteCurrentJob()">
                        <i data-lucide="trash-2"></i>
                        Delete
                    </button>
                    <button class="btn btn-primary" onclick="trackJob()">
                        <i data-lucide="play"></i>
                        Track
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Hidden file input for JSON restore -->
        <input type="file" id="jsonRestoreInput" accept=".json" style="display: none;">
    </div>
    
    <script>
        // ===== DATABASE SETUP =====
        const DB_NAME = 'SatterleeLegacyLink';
        const DB_VERSION = 1;
        let db = null;
        
        // Data stores
        let jobs = [];
        let techs = [];
        let activeJobId = null;
        let timerInterval = null;
        let currentJobId = null;
        let pendingDelete = null;
        
        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.warn('IndexedDB failed, using localStorage fallback');
                    loadFromLocalStorage();
                    resolve();
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    loadFromDB().then(resolve);
                };
                
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    
                    if (!database.objectStoreNames.contains('jobs')) {
                        database.createObjectStore('jobs', { keyPath: 'id' });
                    }
                    if (!database.objectStoreNames.contains('techs')) {
                        database.createObjectStore('techs', { keyPath: 'id' });
                    }
                    if (!database.objectStoreNames.contains('settings')) {
                        database.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
            });
        }
        
        async function loadFromDB() {
            if (!db) return loadFromLocalStorage();
            
            return new Promise((resolve) => {
                const transaction = db.transaction(['jobs', 'techs', 'settings'], 'readonly');
                
                const jobsStore = transaction.objectStore('jobs');
                const techsStore = transaction.objectStore('techs');
                const settingsStore = transaction.objectStore('settings');
                
                jobsStore.getAll().onsuccess = (e) => {
                    jobs = e.target.result || [];
                };
                
                techsStore.getAll().onsuccess = (e) => {
                    techs = e.target.result || [];
                };
                
                settingsStore.get('activeJobId').onsuccess = (e) => {
                    activeJobId = e.target.result?.value || null;
                };
                
                transaction.oncomplete = () => {
                    checkDemoDataNeeded();
                    resolve();
                };
            });
        }
        
        function loadFromLocalStorage() {
            try {
                jobs = JSON.parse(localStorage.getItem('satterlee_jobs') || '[]');
                techs = JSON.parse(localStorage.getItem('satterlee_techs') || '[]');
                activeJobId = localStorage.getItem('satterlee_activeJob') || null;
            } catch (e) {
                jobs = [];
                techs = [];
            }
            checkDemoDataNeeded();
        }
        
        function saveToStorage() {
            if (db) {
                const transaction = db.transaction(['jobs', 'techs', 'settings'], 'readwrite');
                const jobsStore = transaction.objectStore('jobs');
                const techsStore = transaction.objectStore('techs');
                const settingsStore = transaction.objectStore('settings');
                
                // Clear and re-add all
                jobsStore.clear();
                techsStore.clear();
                
                jobs.forEach(job => jobsStore.add(job));
                techs.forEach(tech => techsStore.add(tech));
                settingsStore.put({ key: 'activeJobId', value: activeJobId });
            }
            
            // Always save to localStorage as backup
            localStorage.setItem('satterlee_jobs', JSON.stringify(jobs));
            localStorage.setItem('satterlee_techs', JSON.stringify(techs));
            localStorage.setItem('satterlee_activeJob', activeJobId || '');
        }
        
        // ===== DEMO DATA =====
        function checkDemoDataNeeded() {
            if (jobs.length === 0 && techs.length === 0) {
                loadDemoData();
            } else {
                const hasDemo = jobs.some(j => j.isDemo) || techs.some(t => t.isDemo);
                document.getElementById('demoBanner').classList.toggle('hidden', !hasDemo);
                render();
            }
        }
        
        function loadDemoData() {
            const today = new Date().toISOString().split('T')[0];
            
            techs = [
                { id: 't1', name: 'Ryan Mitchell', years: 5, specialty: 'plumbing', isDemo: true },
                { id: 't2', name: 'Marcus Thompson', years: 12, specialty: 'hvac', isDemo: true },
                { id: 't3', name: 'Jake Satterlee', years: 3, specialty: 'general', isDemo: true }
            ];
            
            jobs = [
                {
                    id: 'j1',
                    customer: 'Johnson Family',
                    phone: '(417) 555-0147',
                    address: '2847 S Main St, Joplin, MO',
                    serviceType: 'water-heater',
                    scheduledDate: today,
                    scheduledTime: '09:00',
                    techId: 't1',
                    notes: 'Water heater making loud popping noises. 10 years old.',
                    status: 'enroute',
                    travelStart: Date.now() - (8 * 60 * 1000), // 8 mins ago
                    isDemo: true
                },
                {
                    id: 'j2',
                    customer: 'Pittsburg Community Center',
                    phone: '(620) 555-0198',
                    address: '503 N Broadway, Pittsburg, KS',
                    serviceType: 'commercial',
                    scheduledDate: today,
                    scheduledTime: '13:00',
                    techId: 't2',
                    notes: 'Annual HVAC maintenance. Multiple units.',
                    status: 'scheduled',
                    isDemo: true
                },
                {
                    id: 'j3',
                    customer: 'Maria Gonzales',
                    phone: '(417) 555-0234',
                    address: '1205 E 15th St, Joplin, MO',
                    serviceType: 'drain',
                    scheduledDate: today,
                    scheduledTime: '15:30',
                    techId: 't3',
                    notes: 'Kitchen sink slow drain. Tried Drano.',
                    status: 'scheduled',
                    isDemo: true
                },
                {
                    id: 'j4',
                    customer: 'Williams Residence',
                    phone: '(918) 555-0321',
                    address: '892 A St NW, Miami, OK',
                    serviceType: 'hvac',
                    scheduledDate: today,
                    scheduledTime: '11:00',
                    techId: 't2',
                    notes: 'AC not cooling. Checked filters - clean.',
                    status: 'inprogress',
                    travelStart: Date.now() - (45 * 60 * 1000),
                    arrivalTime: Date.now() - (30 * 60 * 1000),
                    jobStart: Date.now() - (25 * 60 * 1000),
                    isDemo: true
                }
            ];
            
            activeJobId = 'j1';
            saveToStorage();
            document.getElementById('demoBanner').classList.remove('hidden');
            render();
            showToast('Demo data loaded', 'Sample jobs for Joplin, Pittsburg & Miami', 'success');
        }
        
        function clearDemoData() {
            jobs = jobs.filter(j => !j.isDemo);
            techs = techs.filter(t => !t.isDemo);
            if (activeJobId && !jobs.find(j => j.id === activeJobId)) {
                activeJobId = null;
            }
            saveToStorage();
            document.getElementById('demoBanner').classList.add('hidden');
            render();
            showToast('Demo data cleared', 'Ready for your real jobs', 'success');
        }
        
        // ===== RENDERING =====
        function render() {
            renderJobs();
            renderTechs();
            renderStats();
            updateTechDropdown();
            updateActiveTracker();
            lucide.createIcons();
        }
        
        function renderJobs() {
            const container = document.getElementById('jobsList');
            const emptyState = document.getElementById('emptyJobsState');
            
            if (jobs.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Sort: active first, then by date/time
            const sorted = [...jobs].sort((a, b) => {
                const statusOrder = { inprogress: 0, enroute: 1, assigned: 2, scheduled: 3, complete: 4 };
                const aOrder = statusOrder[a.status] ?? 3;
                const bOrder = statusOrder[b.status] ?? 3;
                if (aOrder !== bOrder) return aOrder - bOrder;
                return new Date(a.scheduledDate + ' ' + (a.scheduledTime || '00:00')) - 
                       new Date(b.scheduledDate + ' ' + (b.scheduledTime || '00:00'));
            });
            
            container.innerHTML = sorted.map(job => {
                const tech = techs.find(t => t.id === job.techId);
                const statusLabels = {
                    scheduled: 'Scheduled',
                    assigned: 'Assigned',
                    enroute: 'En Route',
                    inprogress: 'In Progress',
                    complete: 'Complete'
                };
                const serviceLabels = {
                    'plumbing': 'Plumbing',
                    'hvac': 'HVAC',
                    'drain': 'Drain Cleaning',
                    'water-heater': 'Water Heater',
                    'commercial': 'Commercial',
                    'emergency': 'Emergency'
                };
                
                return `
                    <div class="job-card" data-status="${job.status}" onclick="showJobDetail('${job.id}')">
                        <div class="job-card-header">
                            <div>
                                <div class="job-customer">${escapeHtml(job.customer)}</div>
                                <div class="job-address">
                                    <i data-lucide="map-pin"></i>
                                    ${escapeHtml(job.address)}
                                </div>
                            </div>
                            <span class="job-status-badge ${job.status}">${statusLabels[job.status] || job.status}</span>
                        </div>
                        <div class="job-card-body">
                            <div class="job-details">
                                <div class="job-detail">
                                    <span class="job-detail-label">Service</span>
                                    <span class="job-detail-value">${serviceLabels[job.serviceType] || job.serviceType}</span>
                                </div>
                                <div class="job-detail">
                                    <span class="job-detail-label">Time</span>
                                    <span class="job-detail-value">${formatTime(job.scheduledTime)}</span>
                                </div>
                                <div class="job-detail">
                                    <span class="job-detail-label">Technician</span>
                                    <span class="job-detail-value">${tech ? escapeHtml(tech.name) : 'Unassigned'}</span>
                                </div>
                                <div class="job-detail">
                                    <span class="job-detail-label">Date</span>
                                    <span class="job-detail-value">${formatDate(job.scheduledDate)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderTechs() {
            const container = document.getElementById('techsList');
            
            container.innerHTML = techs.map(tech => {
                const activeJobs = jobs.filter(j => j.techId === tech.id && ['enroute', 'inprogress'].includes(j.status));
                const isBusy = activeJobs.length > 0;
                
                return `
                    <div class="tech-card">
                        <div class="tech-card-avatar">${tech.name.charAt(0)}</div>
                        <div class="tech-card-info">
                            <div class="tech-card-name">${escapeHtml(tech.name)}</div>
                            <div class="tech-card-meta">${tech.years} years â€¢ ${tech.specialty}</div>
                        </div>
                        <span class="tech-card-status ${isBusy ? 'busy' : 'available'}">
                            ${isBusy ? 'On Job' : 'Available'}
                        </span>
                    </div>
                `;
            }).join('');
            
            if (techs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: var(--space-6);">
                        <div class="empty-state-icon">
                            <i data-lucide="users"></i>
                        </div>
                        <h3 class="empty-state-title">No Technicians</h3>
                        <p class="empty-state-text">Add your team members to assign jobs.</p>
                    </div>
                `;
            }
        }
        
        function renderStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayJobs = jobs.filter(j => j.scheduledDate === today);
            const activeJobs = jobs.filter(j => ['enroute', 'inprogress'].includes(j.status));
            const completeJobs = jobs.filter(j => j.status === 'complete');
            
            document.getElementById('statToday').textContent = todayJobs.length;
            document.getElementById('statActive').textContent = activeJobs.length;
            document.getElementById('statComplete').textContent = completeJobs.length;
        }
        
        function updateTechDropdown() {
            const select = document.getElementById('assignedTech');
            select.innerHTML = '<option value="">Unassigned</option>' + 
                techs.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');
        }
        
        // ===== TIME TRACKER =====
        function updateActiveTracker() {
            const tracker = document.getElementById('activeTracker');
            const activeJob = jobs.find(j => j.id === activeJobId);
            
            if (!activeJob || !['enroute', 'inprogress'].includes(activeJob.status)) {
                tracker.style.display = 'none';
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                return;
            }
            
            tracker.style.display = 'block';
            const tech = techs.find(t => t.id === activeJob.techId);
            
            // Update status text
            const statusText = document.getElementById('trackerStatusText');
            const label = document.getElementById('trackerLabel');
            
            if (activeJob.status === 'enroute') {
                statusText.textContent = 'Tech En Route';
                label.textContent = 'Travel time from N Main St';
            } else if (activeJob.status === 'inprogress') {
                statusText.textContent = 'Job In Progress';
                label.textContent = `On-site at ${activeJob.address.split(',')[0]}`;
            }
            
            // Update tech info
            if (tech) {
                document.getElementById('trackerTechAvatar').textContent = tech.name.charAt(0);
                document.getElementById('trackerTechName').textContent = tech.name;
                document.getElementById('trackerTechTenure').textContent = `${tech.years} years with Satterlee`;
            }
            
            // Update button states
            document.getElementById('startTravelBtn').classList.toggle('active', activeJob.travelStart && !activeJob.arrivalTime);
            document.getElementById('arriveBtn').classList.toggle('active', activeJob.arrivalTime && !activeJob.jobStart);
            document.getElementById('startJobBtn').classList.toggle('active', activeJob.jobStart && activeJob.status === 'inprogress');
            
            // Start timer
            if (!timerInterval) {
                updateTimer();
                timerInterval = setInterval(updateTimer, 1000);
            }
        }
        
        function updateTimer() {
            const activeJob = jobs.find(j => j.id === activeJobId);
            if (!activeJob) return;
            
            let startTime;
            if (activeJob.status === 'inprogress' && activeJob.jobStart) {
                startTime = activeJob.jobStart;
            } else if (activeJob.travelStart) {
                startTime = activeJob.travelStart;
            } else {
                return;
            }
            
            const elapsed = Date.now() - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            document.getElementById('trackerTime').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        // Tracker button handlers
        document.getElementById('startTravelBtn').addEventListener('click', () => {
            const job = jobs.find(j => j.id === activeJobId);
            if (job) {
                job.status = 'enroute';
                job.travelStart = Date.now();
                saveToStorage();
                render();
                showToast('Travel Started', 'Timer is now running', 'success');
            }
        });
        
        document.getElementById('arriveBtn').addEventListener('click', () => {
            const job = jobs.find(j => j.id === activeJobId);
            if (job && job.travelStart) {
                job.arrivalTime = Date.now();
                saveToStorage();
                render();
                const travelMins = Math.round((job.arrivalTime - job.travelStart) / 60000);
                showToast('Arrived', `Travel time: ${travelMins} minutes`, 'success');
            }
        });
        
        document.getElementById('startJobBtn').addEventListener('click', () => {
            const job = jobs.find(j => j.id === activeJobId);
            if (job && job.arrivalTime) {
                job.status = 'inprogress';
                job.jobStart = Date.now();
                saveToStorage();
                render();
                showToast('Job Started', 'Work timer is now running', 'success');
            }
        });
        
        document.getElementById('completeBtn').addEventListener('click', () => {
            const job = jobs.find(j => j.id === activeJobId);
            if (job) {
                job.status = 'complete';
                job.completedAt = Date.now();
                activeJobId = null;
                saveToStorage();
                render();
                
                // Calculate times
                let summary = 'Job complete!';
                if (job.travelStart && job.arrivalTime) {
                    const travel = Math.round((job.arrivalTime - job.travelStart) / 60000);
                    summary = `Travel: ${travel} min`;
                }
                if (job.jobStart && job.completedAt) {
                    const work = Math.round((job.completedAt - job.jobStart) / 60000);
                    summary += ` â€¢ Work: ${work} min`;
                }
                
                showToast('Job Complete', summary, 'success');
            }
        });
        
        // ===== JOB ACTIONS =====
        function showJobDetail(jobId) {
            currentJobId = jobId;
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;
            
            const tech = techs.find(t => t.id === job.techId);
            const serviceLabels = {
                'plumbing': 'Plumbing',
                'hvac': 'HVAC',
                'drain': 'Drain Cleaning',
                'water-heater': 'Water Heater',
                'commercial': 'Commercial',
                'emergency': 'Emergency'
            };
            
            let timeLog = '';
            if (job.travelStart) {
                timeLog += `<div><strong>Travel Started:</strong> ${new Date(job.travelStart).toLocaleTimeString()}</div>`;
            }
            if (job.arrivalTime) {
                const travelMins = Math.round((job.arrivalTime - job.travelStart) / 60000);
                timeLog += `<div><strong>Arrived:</strong> ${new Date(job.arrivalTime).toLocaleTimeString()} (${travelMins} min travel)</div>`;
            }
            if (job.jobStart) {
                timeLog += `<div><strong>Job Started:</strong> ${new Date(job.jobStart).toLocaleTimeString()}</div>`;
            }
            if (job.completedAt) {
                const workMins = job.jobStart ? Math.round((job.completedAt - job.jobStart) / 60000) : 0;
                timeLog += `<div><strong>Completed:</strong> ${new Date(job.completedAt).toLocaleTimeString()} (${workMins} min on-site)</div>`;
            }
            
            document.getElementById('jobDetailContent').innerHTML = `
                <div style="margin-bottom: var(--space-4);">
                    <h4 style="font-family: 'Tienne', serif; font-size: var(--text-xl); margin-bottom: var(--space-1);">${escapeHtml(job.customer)}</h4>
                    <p style="color: var(--text-secondary);">${escapeHtml(job.address)}</p>
                    ${job.phone ? `<p style="color: var(--text-secondary);"><a href="tel:${job.phone}" style="color: var(--satterlee-green);">${job.phone}</a></p>` : ''}
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3); margin-bottom: var(--space-4);">
                    <div>
                        <div style="font-size: var(--text-xs); color: var(--text-muted); text-transform: uppercase;">Service</div>
                        <div style="font-weight: 600;">${serviceLabels[job.serviceType] || job.serviceType}</div>
                    </div>
                    <div>
                        <div style="font-size: var(--text-xs); color: var(--text-muted); text-transform: uppercase;">Technician</div>
                        <div style="font-weight: 600;">${tech ? escapeHtml(tech.name) : 'Unassigned'}</div>
                    </div>
                    <div>
                        <div style="font-size: var(--text-xs); color: var(--text-muted); text-transform: uppercase;">Date</div>
                        <div style="font-weight: 600;">${formatDate(job.scheduledDate)}</div>
                    </div>
                    <div>
                        <div style="font-size: var(--text-xs); color: var(--text-muted); text-transform: uppercase;">Time</div>
                        <div style="font-weight: 600;">${formatTime(job.scheduledTime)}</div>
                    </div>
                </div>
                
                ${job.notes ? `
                <div style="margin-bottom: var(--space-4);">
                    <div style="font-size: var(--text-xs); color: var(--text-muted); text-transform: uppercase; margin-bottom: var(--space-1);">Notes</div>
                    <div style="background: var(--bg-primary); padding: var(--space-3); border-radius: var(--radius-md);">${escapeHtml(job.notes)}</div>
                </div>
                ` : ''}
                
                ${timeLog ? `
                <div>
                    <div style="font-size: var(--text-xs); color: var(--text-muted); text-transform: uppercase; margin-bottom: var(--space-2);">Time Log</div>
                    <div style="background: var(--success-bg); padding: var(--space-3); border-radius: var(--radius-md); font-size: var(--text-sm);">
                        ${timeLog}
                    </div>
                </div>
                ` : ''}
            `;
            
            openModal('jobDetailModal');
        }
        
        function trackJob() {
            if (!currentJobId) return;
            activeJobId = currentJobId;
            const job = jobs.find(j => j.id === currentJobId);
            if (job && job.status === 'scheduled') {
                job.status = 'assigned';
            }
            saveToStorage();
            closeModal('jobDetailModal');
            render();
            showToast('Tracking Job', `Now tracking ${job.customer}`, 'success');
        }
        
        function deleteCurrentJob() {
            if (!currentJobId) return;
            const job = jobs.find(j => j.id === currentJobId);
            if (!job) return;
            
            closeModal('jobDetailModal');
            pendingDelete = { type: 'job', id: currentJobId, data: job };
            
            showUndoToast(`Deleted "${job.customer}"`, () => {
                // Undo - restore job
                jobs.push(pendingDelete.data);
                saveToStorage();
                render();
                pendingDelete = null;
            }, () => {
                // Confirm delete
                jobs = jobs.filter(j => j.id !== currentJobId);
                if (activeJobId === currentJobId) activeJobId = null;
                saveToStorage();
                render();
                pendingDelete = null;
            });
        }
        
        // ===== FORM HANDLING =====
        document.getElementById('newJobForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const form = e.target;
            const customerName = document.getElementById('customerName');
            const address = document.getElementById('address');
            
            // Validate
            let valid = true;
            if (!customerName.value.trim()) {
                customerName.classList.add('error');
                valid = false;
            } else {
                customerName.classList.remove('error');
            }
            
            if (!address.value.trim()) {
                address.classList.add('error');
                valid = false;
            } else {
                address.classList.remove('error');
            }
            
            if (!valid) {
                showToast('Missing Required Fields', 'Please fill in all required fields', 'error');
                return;
            }
            
            const newJob = {
                id: 'j' + Date.now(),
                customer: customerName.value.trim(),
                phone: document.getElementById('customerPhone').value.trim(),
                address: address.value.trim(),
                serviceType: document.getElementById('serviceType').value,
                scheduledDate: document.getElementById('scheduledDate').value,
                scheduledTime: document.getElementById('scheduledTime').value,
                techId: document.getElementById('assignedTech').value || null,
                notes: document.getElementById('notes').value.trim(),
                status: document.getElementById('assignedTech').value ? 'assigned' : 'scheduled',
                isDemo: false
            };
            
            jobs.push(newJob);
            saveToStorage();
            form.reset();
            
            // Set default date to today
            document.getElementById('scheduledDate').value = new Date().toISOString().split('T')[0];
            
            showView('jobs');
            render();
            showToast('Job Created', `${newJob.customer} added to schedule`, 'success');
        });
        
        // Set default date
        document.getElementById('scheduledDate').value = new Date().toISOString().split('T')[0];
        
        // ===== TECH FORM =====
        function showAddTechModal() {
            document.getElementById('addTechForm').reset();
            openModal('addTechModal');
        }
        
        function saveTech() {
            const name = document.getElementById('techName').value.trim();
            if (!name) {
                document.getElementById('techName').classList.add('error');
                return;
            }
            
            const newTech = {
                id: 't' + Date.now(),
                name: name,
                years: parseInt(document.getElementById('techYears').value) || 0,
                specialty: document.getElementById('techSpecialty').value,
                isDemo: false
            };
            
            techs.push(newTech);
            saveToStorage();
            closeModal('addTechModal');
            render();
            showToast('Technician Added', `${name} is now on the team`, 'success');
        }
        
        // ===== NAVIGATION =====
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab-item, .desktop-nav-item').forEach(t => t.classList.remove('active'));
            
            document.getElementById(viewName + 'View').classList.add('active');
            document.querySelectorAll(`[data-view="${viewName}"]`).forEach(t => t.classList.add('active'));
            
            lucide.createIcons();
        }
        
        // Tab bar and desktop nav
        document.querySelectorAll('.tab-item, .desktop-nav-item').forEach(tab => {
            tab.addEventListener('click', () => showView(tab.dataset.view));
        });
        
        // ===== MODALS =====
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        // Close modal on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });
        
        // ===== TOASTS =====
        function showToast(title, message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const iconMap = {
                success: 'check-circle',
                error: 'alert-circle',
                warning: 'alert-triangle',
                info: 'info'
            };
            
            toast.innerHTML = `
                <i data-lucide="${iconMap[type]}" class="toast-icon"></i>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
            `;
            
            container.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.classList.add('leaving');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function showUndoToast(message, onUndo, onConfirm) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast warning';
            
            toast.innerHTML = `
                <i data-lucide="trash-2" class="toast-icon"></i>
                <div class="toast-content">
                    <div class="toast-title">${message}</div>
                    <div class="toast-message">Tap to undo</div>
                </div>
                <button class="toast-action" onclick="this.parentElement.undoAction()">Undo</button>
            `;
            
            let timeoutId = setTimeout(() => {
                toast.classList.add('leaving');
                setTimeout(() => {
                    toast.remove();
                    onConfirm();
                }, 300);
            }, 5000);
            
            toast.undoAction = () => {
                clearTimeout(timeoutId);
                toast.classList.add('leaving');
                setTimeout(() => toast.remove(), 300);
                onUndo();
                showToast('Restored', '', 'success');
            };
            
            container.appendChild(toast);
            lucide.createIcons();
        }
        
        // ===== IMPORT/EXPORT =====
        function showImportModal() {
            openModal('importModal');
        }
        
        function showPasteModal() {
            document.getElementById('pasteArea').value = '';
            openModal('pasteModal');
        }
        
        document.getElementById('csvFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                parseCSV(event.target.result);
                closeModal('importModal');
                e.target.value = '';
            };
            reader.readAsText(file);
        });
        
        function processPastedData() {
            const text = document.getElementById('pasteArea').value.trim();
            if (!text) {
                showToast('No Data', 'Please paste some data first', 'error');
                return;
            }
            parseCSV(text);
            closeModal('pasteModal');
        }
        
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) {
                showToast('Invalid Data', 'Need at least a header and one row', 'error');
                return;
            }
            
            // Detect delimiter
            const delimiter = lines[0].includes('\t') ? '\t' : ',';
            const headers = lines[0].split(delimiter).map(h => h.trim().toLowerCase());
            
            let imported = 0;
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(delimiter).map(v => v.trim().replace(/^["']|["']$/g, ''));
                if (values.length < 2) continue;
                
                const job = {
                    id: 'j' + Date.now() + i,
                    customer: values[headers.indexOf('customer')] || values[0] || 'Unknown',
                    phone: values[headers.indexOf('phone')] || values[1] || '',
                    address: values[headers.indexOf('address')] || values[2] || '',
                    serviceType: values[headers.indexOf('type')] || values[3] || 'plumbing',
                    scheduledDate: values[headers.indexOf('date')] || values[4] || new Date().toISOString().split('T')[0],
                    scheduledTime: values[headers.indexOf('time')] || values[5] || '',
                    techId: null,
                    notes: values[headers.indexOf('notes')] || values[7] || '',
                    status: 'scheduled',
                    isDemo: false
                };
                
                // Try to match tech
                const techName = values[headers.indexOf('tech')] || values[6] || '';
                if (techName) {
                    const tech = techs.find(t => t.name.toLowerCase().includes(techName.toLowerCase()));
                    if (tech) {
                        job.techId = tech.id;
                        job.status = 'assigned';
                    }
                }
                
                jobs.push(job);
                imported++;
            }
            
            saveToStorage();
            render();
            showToast('Import Complete', `${imported} jobs imported`, 'success');
        }
        
        function exportCSV() {
            const headers = ['Customer', 'Phone', 'Address', 'Type', 'Date', 'Time', 'Tech', 'Notes', 'Status'];
            const rows = jobs.map(j => {
                const tech = techs.find(t => t.id === j.techId);
                return [
                    j.customer,
                    j.phone || '',
                    j.address,
                    j.serviceType,
                    j.scheduledDate,
                    j.scheduledTime || '',
                    tech?.name || '',
                    j.notes || '',
                    j.status
                ].map(v => `"${v}"`).join(',');
            });
            
            const csv = [headers.join(','), ...rows].join('\n');
            downloadFile(csv, 'satterlee-jobs.csv', 'text/csv');
            showToast('Export Complete', `${jobs.length} jobs exported`, 'success');
        }
        
        function exportJSON() {
            const backup = {
                version: 1,
                exportedAt: new Date().toISOString(),
                jobs: jobs,
                techs: techs,
                activeJobId: activeJobId
            };
            
            downloadFile(JSON.stringify(backup, null, 2), 'satterlee-backup.json', 'application/json');
            showToast('Backup Created', 'Full data backup exported', 'success');
        }
        
        function triggerJsonRestore() {
            document.getElementById('jsonRestoreInput').click();
        }
        
        document.getElementById('jsonRestoreInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const backup = JSON.parse(event.target.result);
                    if (backup.jobs && backup.techs) {
                        jobs = backup.jobs;
                        techs = backup.techs;
                        activeJobId = backup.activeJobId || null;
                        saveToStorage();
                        render();
                        showToast('Restore Complete', `${jobs.length} jobs, ${techs.length} techs restored`, 'success');
                    } else {
                        throw new Error('Invalid backup format');
                    }
                } catch (err) {
                    showToast('Restore Failed', 'Invalid backup file', 'error');
                }
                e.target.value = '';
            };
            reader.readAsText(file);
        });
        
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function confirmClearAll() {
            if (confirm('Are you sure you want to delete ALL jobs and technicians? This cannot be undone.')) {
                jobs = [];
                techs = [];
                activeJobId = null;
                saveToStorage();
                document.getElementById('demoBanner').classList.add('hidden');
                render();
                showToast('All Data Cleared', 'Starting fresh', 'success');
            }
        }
        
        // ===== UTILITY FUNCTIONS =====
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'TBD';
            const date = new Date(dateStr + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const diff = date - today;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) return 'Today';
            if (days === 1) return 'Tomorrow';
            if (days === -1) return 'Yesterday';
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        function formatTime(timeStr) {
            if (!timeStr) return 'TBD';
            const [hours, minutes] = timeStr.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:${minutes} ${ampm}`;
        }
        
        // ===== REFRESH BUTTON =====
        document.getElementById('refreshBtn').addEventListener('click', () => {
            render();
            showToast('Refreshed', 'Data is up to date', 'success');
        });
        
        // ===== DEMO BANNER HANDLERS =====
        document.getElementById('clearDemoBtn').addEventListener('click', clearDemoData);
        document.getElementById('dismissDemoBtn').addEventListener('click', () => {
            document.getElementById('demoBanner').classList.add('hidden');
        });
        
        // ===== INITIALIZE =====
        initDB().then(() => {
            lucide.createIcons();
        });
    </script>
</body>
</html>
