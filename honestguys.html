<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DuctSnap - Honest Guys Duct Cleaning</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--blue:#1A73A7;--blue-light:#2B8DC5;--blue-dark:#145C86;--green:#2ECC71;--green-dark:#27AE60;
--bg:#F8FAFB;--card:#FFFFFF;--border:#E5E9ED;--muted:#6B7B8D;--text:#1C2833;
--amber:#E67E22;--error:#E74C3C;
--shadow-sm:0 1px 3px rgba(28,40,51,0.06);--shadow-md:0 4px 14px rgba(28,40,51,0.08);--shadow-lg:0 12px 36px rgba(28,40,51,0.12);
--radius:12px;--radius-sm:8px;
--font-head:'Nunito',sans-serif;--font-body:'Work Sans',sans-serif;
}
html{font-size:16px}
body{font-family:var(--font-body);background:var(--bg);color:var(--text);line-height:1.5;padding-bottom:120px!important;min-height:100vh;overflow-x:hidden}
h1,h2,h3{font-family:var(--font-head);font-weight:700;line-height:1.2}
h1{font-size:1.4rem}h2{font-size:1.2rem}h3{font-size:1rem}
button,input,select,textarea{font-family:var(--font-body);font-size:16px}
*:focus-visible{outline:2px solid var(--blue);outline-offset:2px}
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:0.01ms!important;transition-duration:0.01ms!important}}
.skip-link{position:absolute;top:-100px;left:16px;background:var(--blue);color:#fff;padding:8px 16px;border-radius:var(--radius-sm);z-index:100000}
.skip-link:focus{top:8px}
#app{display:none;max-width:480px;margin:0 auto}
@media(min-width:1024px){#app{max-width:720px}}

.app-header{background:var(--blue);color:#fff;padding:14px 20px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:100}
.app-header h1{color:#fff;font-size:1.15rem;flex:1}
.header-count{font-size:12px;color:rgba(255,255,255,0.6)}

.demo-banner{background:#E8F8F0;border-bottom:1px solid #B8E6CF;padding:8px 16px;display:flex;align-items:center;gap:8px;font-size:12px;color:#1A8046}
.demo-banner button{background:none;border:none;color:var(--green-dark);cursor:pointer;font-weight:700;padding:4px;margin-left:auto}

.tab-content{padding:16px;display:none;animation:fadeUp 0.3s ease-out}
.tab-content.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

.bottom-nav{position:fixed;bottom:48px;left:0;right:0;background:var(--card);border-top:1px solid var(--border);display:flex;z-index:90;padding:4px 0 8px}
.bottom-nav button{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 4px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:10px;transition:color 0.15s}
.bottom-nav button.active{color:var(--blue)}
.bottom-nav button svg{width:22px;height:22px}
.bottom-nav button:active{transform:scale(0.95)}

.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow-sm);border:1px solid var(--border);margin-bottom:10px;overflow:hidden}

.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 18px;border:none;border-radius:var(--radius-sm);font-weight:600;font-size:14px;cursor:pointer;transition:transform 0.12s}
.btn:active{transform:scale(0.97)}
.btn-blue{background:var(--blue);color:#fff}
.btn-green{background:var(--green);color:#fff}
.btn-outline{background:transparent;border:1.5px solid var(--border);color:var(--text)}
.btn-block{width:100%}
.btn-sm{padding:6px 12px;font-size:12px}
.btn svg{width:16px;height:16px}

/* Big Camera Button */
.camera-hero{display:flex;flex-direction:column;align-items:center;gap:16px;padding:32px 20px;text-align:center}
.shutter-btn{width:80px;height:80px;border-radius:50%;background:var(--blue);border:4px solid var(--blue-light);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow-lg);transition:transform 0.15s,box-shadow 0.15s}
.shutter-btn:hover{transform:scale(1.05);box-shadow:0 16px 40px rgba(26,115,167,0.3)}
.shutter-btn:active{transform:scale(0.95)}
.shutter-btn svg{width:36px;height:36px}

/* Photo Grid */
.photo-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:12px 0}
.photo-cell{position:relative;aspect-ratio:1;border-radius:var(--radius-sm);overflow:hidden;background:var(--bg);border:1px solid var(--border)}
.photo-cell img{width:100%;height:100%;object-fit:cover}
.photo-cell .photo-label{position:absolute;top:6px;left:6px;background:rgba(0,0,0,0.6);color:#fff;font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px;text-transform:uppercase}
.photo-cell .photo-label.before{background:var(--error)}
.photo-cell .photo-label.after{background:var(--green)}
.photo-cell button{position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.5);color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.photo-cell button:active{transform:scale(0.9)}

/* Before/After Slider */
.ba-slider{position:relative;width:100%;aspect-ratio:4/3;border-radius:var(--radius);overflow:hidden;margin:12px 0;touch-action:none}
.ba-slider img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover}
.ba-slider .ba-after{clip-path:inset(0 0 0 50%)}
.ba-handle{position:absolute;top:0;bottom:0;left:50%;width:4px;background:#fff;cursor:ew-resize;z-index:5;box-shadow:0 0 8px rgba(0,0,0,0.3)}
.ba-handle::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:32px;height:32px;border-radius:50%;background:#fff;box-shadow:var(--shadow-md);display:flex;align-items:center;justify-content:center}

/* Job Card */
.job-card{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;cursor:pointer;transition:background 0.15s}
.job-card:hover{background:var(--bg)}
.job-card:last-child{border-bottom:none}
.job-thumb{width:48px;height:48px;border-radius:var(--radius-sm);overflow:hidden;flex-shrink:0;background:var(--bg)}
.job-thumb img{width:100%;height:100%;object-fit:cover}
.job-info{flex:1;min-width:0}
.job-info h3{font-size:14px;margin-bottom:2px}
.job-info p{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.job-meta{text-align:right;flex-shrink:0}
.job-meta .photo-count{font-weight:700;font-size:14px;color:var(--blue)}
.job-meta .job-date{font-size:11px;color:var(--muted)}

.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:12px;font-weight:600;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.04em}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--radius-sm);background:var(--card);color:var(--text);transition:border-color 0.15s}
.form-group input:focus,.form-group select:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(26,115,167,0.12)}

.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(28,40,51,0.6);backdrop-filter:blur(4px);z-index:200;display:none;align-items:flex-end;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border-radius:var(--radius) var(--radius) 0 0;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;padding:24px 20px;animation:slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-close{position:absolute;top:12px;right:12px;background:none;border:none;cursor:pointer;padding:8px;color:var(--muted)}

.camera-view{position:relative;width:100%;aspect-ratio:4/3;background:#000;border-radius:var(--radius);overflow:hidden;margin-bottom:10px}
.camera-view video{width:100%;height:100%;object-fit:cover}
.camera-view canvas{display:none}
.cv-shutter{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,0.9);border:4px solid var(--green);cursor:pointer}
.cv-shutter:active{transform:translateX(-50%) scale(0.9)}

.summary-strip{display:flex;gap:0;background:var(--blue);border-radius:var(--radius);overflow:hidden;margin-bottom:16px}
.summary-item{flex:1;padding:14px 8px;text-align:center;border-right:1px solid rgba(255,255,255,0.1)}
.summary-item:last-child{border-right:none}
.summary-item .val{font-size:1.3rem;font-weight:800;color:#fff;font-family:var(--font-head)}
.summary-item .lbl{font-size:10px;color:rgba(255,255,255,0.5);text-transform:uppercase;margin-top:2px}

.toast-box{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:10000;pointer-events:none}
.toast{background:var(--blue);color:#fff;padding:10px 20px;border-radius:var(--radius);font-size:14px;box-shadow:var(--shadow-lg);animation:toastIn 0.3s;margin-bottom:8px}
@keyframes toastIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

.upsell-box{background:var(--bg);border:1.5px dashed var(--border);border-radius:var(--radius);padding:24px;text-align:center;margin-top:20px}
.upsell-tag{background:var(--blue);color:#fff;font-size:10px;font-weight:700;padding:3px 10px;border-radius:8px;text-transform:uppercase;display:inline-block;margin-bottom:10px}

.phase-toggle{display:flex;background:var(--bg);border-radius:var(--radius-sm);padding:3px;margin-bottom:16px}
.phase-toggle button{flex:1;padding:8px;border:none;border-radius:6px;background:transparent;font-weight:600;font-size:13px;cursor:pointer;color:var(--muted);transition:all 0.2s}
.phase-toggle button.active{background:var(--card);color:var(--text);box-shadow:var(--shadow-sm)}

@media print{
.bottom-nav,.demo-banner,.app-header,.toast-box,.modal-overlay,#bct-demo-disclaimer{display:none!important}
body{background:#fff;padding:0}
}
</style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to main content</a>

<div id="gate" style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:var(--font-body);background:var(--blue);color:#fff;text-align:center;padding:20px">
<div>
<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#2ECC71" stroke-width="1.5"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
<h1 style="font-family:var(--font-head);font-size:1.6rem;margin:16px 0 8px">DuctSnap</h1>
<p style="color:rgba(255,255,255,0.6);margin-bottom:24px">Enter your access key</p>
<form id="gate-form" style="max-width:280px;margin:0 auto">
<input type="text" id="gate-key" placeholder="Access key" aria-label="Access key" style="width:100%;padding:12px;border:1.5px solid rgba(255,255,255,0.2);border-radius:8px;background:rgba(255,255,255,0.1);color:#fff;font-size:16px;text-align:center;margin-bottom:12px">
<button type="submit" style="width:100%;padding:12px;background:var(--green);color:#fff;border:none;border-radius:8px;font-weight:700;font-size:15px;cursor:pointer">Open</button>
</form>
<p style="margin-top:24px;font-size:13px"><a href="mailto:ben@bennycutools.com" style="color:rgba(255,255,255,0.5)">ben@bennycutools.com</a></p>
</div>
</div>

<div id="app">
<header class="app-header" role="banner">
<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
<h1>DuctSnap</h1>
<span class="header-count" id="headerCount"></span>
</header>

<div id="demoBanner" class="demo-banner" role="status">
<span>Sample jobs for Phoenix area. Clear to start fresh.</span>
<button onclick="clearDemo()" aria-label="Clear demo data">Clear</button>
</div>

<main id="main-content">
<!-- Tab: Active Job -->
<section id="tab-job" class="tab-content active" role="tabpanel" aria-label="Current job">
<div id="jobEmpty" style="display:none;text-align:center;padding:40px 20px">
<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--border)" stroke-width="1"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
<h2 style="margin-top:16px">Ready to document</h2>
<p style="color:var(--muted);margin:8px 0 24px;font-size:14px">Start a job, snap before/after photos, and share the proof with your customer.</p>
<button class="btn btn-blue btn-block" onclick="showNewJob()">Start New Job</button>
</div>

<div id="jobActive" style="display:none">
<div class="card" style="padding:14px 16px">
<div style="display:flex;justify-content:space-between;align-items:center">
<div><h2 id="jobTitle" style="font-size:1rem"></h2><p id="jobAddr" style="font-size:12px;color:var(--muted)"></p></div>
<button class="btn btn-sm btn-outline" onclick="editJobInfo()" aria-label="Edit job">
<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
</button>
</div>
</div>

<div class="phase-toggle" id="phaseToggle">
<button class="active" onclick="setPhase('before')" data-phase="before">Before</button>
<button onclick="setPhase('after')" data-phase="after">After</button>
</div>

<div id="beforeSection">
<div class="photo-grid" id="beforeGrid"></div>
<div class="camera-hero" id="beforeCameraHero">
<button class="shutter-btn" onclick="takePhoto('before')" aria-label="Take before photo">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
</button>
<p style="font-size:13px;color:var(--muted)">Snap the dirty vents before you start</p>
</div>
</div>

<div id="afterSection" style="display:none">
<div class="photo-grid" id="afterGrid"></div>
<div class="camera-hero" id="afterCameraHero">
<button class="shutter-btn" onclick="takePhoto('after')" aria-label="Take after photo" style="background:var(--green);border-color:var(--green-dark)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
</button>
<p style="font-size:13px;color:var(--muted)">Snap the clean vents after the job</p>
</div>
</div>

<div style="margin-top:16px;display:flex;gap:8px">
<button class="btn btn-green btn-block" onclick="shareJob()" style="flex:2">
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2L15 22l-4-9-9-4z"/></svg>
Share with Customer
</button>
<button class="btn btn-blue" onclick="completeJob()" aria-label="Complete job">
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
</button>
</div>
</div>
</section>

<!-- Tab: Jobs History -->
<section id="tab-history" class="tab-content" role="tabpanel" aria-label="Job history">
<h2 style="margin-bottom:12px">Completed Jobs</h2>
<div id="histSummary" class="summary-strip"></div>
<div id="histList"></div>
<div id="histEmpty" style="display:none;text-align:center;padding:40px 20px">
<p style="color:var(--muted);font-size:14px">Completed jobs show here</p>
</div>
<div class="upsell-box">
<span class="upsell-tag">Full Version</span>
<h3 style="margin-bottom:8px">Follow-Up Reminders</h3>
<p style="font-size:13px;color:var(--muted);margin-bottom:12px">Get notified when a customer is due for their next cleaning. "Garcia -- 3 years since last service. Send a reminder?"</p>
<a href="mailto:ben@bennycutools.com?subject=DuctSnap%20Full%20Version" style="color:var(--blue);font-weight:600;font-size:14px">Ask about the full version -- $200</a>
</div>
</section>
</main>

<nav class="bottom-nav" role="navigation" aria-label="Main navigation">
<button class="active" onclick="switchTab('job')" data-tab="job" aria-label="Current job">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
Job
</button>
<button onclick="switchTab('history')" data-tab="history" aria-label="History">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
History
</button>
</nav>

<!-- New Job Modal -->
<div id="newJobModal" class="modal-overlay" role="dialog" aria-modal="true" aria-label="New job">
<div class="modal" style="position:relative">
<button class="modal-close" onclick="closeModal('newJobModal')" aria-label="Close">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
</button>
<h2>New Job</h2>
<div class="form-group"><label for="njName">Customer Name</label><input type="text" id="njName" placeholder="e.g. Garcia"></div>
<div class="form-group"><label for="njAddr">Address / Cross Streets</label><input type="text" id="njAddr" placeholder="e.g. 32nd St & Thunderbird, Phoenix"></div>
<div class="form-group"><label for="njService">Service</label>
<select id="njService"><option>Air Duct Cleaning</option><option>Dryer Vent Cleaning</option><option>Ducts + Dryer Vent</option><option>Ozone Treatment</option></select></div>
<div class="form-group"><label for="njNotes">Notes</label><textarea id="njNotes" rows="2" placeholder="Pets, access issues, sq footage..."></textarea></div>
<button class="btn btn-blue btn-block" style="margin-top:8px" onclick="createJob()">Start Job</button>
</div>
</div>

<!-- Camera Modal -->
<div id="cameraModal" class="modal-overlay" role="dialog" aria-modal="true" aria-label="Camera">
<div class="modal" style="position:relative;padding:16px">
<button class="modal-close" onclick="stopCam()" aria-label="Close" style="z-index:10">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
</button>
<div id="camPhaseLabel" style="text-align:center;font-weight:700;font-size:14px;margin-bottom:8px;text-transform:uppercase;color:var(--blue)">BEFORE</div>
<div class="camera-view"><video id="camVid" autoplay playsinline></video><canvas id="camCan"></canvas>
<button class="cv-shutter" onclick="snapPhoto()" aria-label="Capture"></button></div>
</div>
</div>

<!-- Job Detail Modal -->
<div id="detailModal" class="modal-overlay" role="dialog" aria-modal="true" aria-label="Job detail">
<div class="modal" style="position:relative">
<button class="modal-close" onclick="closeModal('detailModal')" aria-label="Close">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
</button>
<div id="detailContent"></div>
</div>
</div>

<div class="toast-box" aria-live="polite" id="toastBox"></div>
</div>

<!-- DEMO DISCLAIMER -->
<div id="bct-demo-disclaimer" role="contentinfo" aria-label="Demo disclaimer" style="position:fixed;bottom:0;left:0;right:0;background:#f8f8f8;border-top:1px solid #ddd;padding:10px 16px;font-size:12px;line-height:1.4;color:#666;z-index:99999;display:flex;flex-wrap:wrap;align-items:center;justify-content:center;gap:8px 16px;text-align:center;">
<p style="margin:0;max-width:700px;"><strong style="color:#333;">DEMO NOTICE:</strong> This tool was created by BennyCuTools as a free demonstration only. It is not affiliated with, endorsed by, or authorized by Honest Guys Duct Cleaning. All brand references are used solely for demonstration purposes.</p>
<a href="mailto:cuuper225@gmail.com?subject=Delete%20Demo%3A%20Honest%20Guys%20Duct%20Cleaning&body=I%20am%20the%20owner%20and%20I%20request%20permanent%20deletion%20of%20this%20demo." style="display:inline-flex;align-items:center;gap:4px;background:#dc3545;color:#fff;padding:5px 12px;border-radius:4px;text-decoration:none;font-size:11px;font-weight:500;white-space:nowrap;">
<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
Request Permanent Deletion
</a>
</div>

<script>
function _h(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return h;}
const _V=-214829463;
(function(){
const k=new URLSearchParams(window.location.search).get('key');
if(k&&_h(k)===_V){auth();return;}
document.getElementById('gate').style.display='flex';document.getElementById('app').style.display='none';
document.getElementById('gate-form').addEventListener('submit',function(e){e.preventDefault();const v=document.getElementById('gate-key').value.trim();if(_h(v)===_V)auth();else{document.getElementById('gate-key').style.borderColor='var(--error)';toast('Wrong key');}});
})();
function auth(){document.getElementById('gate').style.display='none';document.getElementById('app').style.display='block';document.addEventListener('contextmenu',e=>e.preventDefault());initApp();}

let db;
function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open('ductsnap_db',1);r.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('jobs'))d.createObjectStore('jobs',{keyPath:'id'});};r.onsuccess=e=>{db=e.target.result;res();};r.onerror=rej;});}
function put(d){return new Promise((r,j)=>{const t=db.transaction('jobs','readwrite');t.objectStore('jobs').put(d);t.oncomplete=()=>r();t.onerror=j;});}
function getAll(){return new Promise((r,j)=>{const t=db.transaction('jobs','readonly');const q=t.objectStore('jobs').getAll();q.onsuccess=()=>r(q.result);q.onerror=j;});}
function del(id){return new Promise((r,j)=>{const t=db.transaction('jobs','readwrite');t.objectStore('jobs').delete(id);t.oncomplete=()=>r();t.onerror=j;});}

let jobs=[];let currentJob=null;let currentPhase='before';let camStream=null;let camTarget='before';

async function initApp(){
await openDB();
if(!localStorage.getItem('ds_init')){await loadDemo();localStorage.setItem('ds_init','1');}
await refresh();
}

async function loadDemo(){
// Create demo jobs with placeholder "photos" (colored rectangles as data URLs)
function makePhoto(color,text){
const c=document.createElement('canvas');c.width=320;c.height=240;
const ctx=c.getContext('2d');
ctx.fillStyle=color;ctx.fillRect(0,0,320,240);
ctx.fillStyle='#fff';ctx.font='bold 16px sans-serif';ctx.textAlign='center';
ctx.fillText(text,160,125);
return c.toDataURL('image/jpeg',0.6);
}
const demos=[
{id:'d1',name:'Garcia',address:'32nd St & Thunderbird, Scottsdale',service:'Air Duct Cleaning',notes:'2,400 SF. Two dogs.',status:'active',
beforePhotos:[makePhoto('#8B4513','Main Return - Before'),makePhoto('#654321','Supply Vent FL1 - Before'),makePhoto('#5C4033','Dryer Vent - Before')],
afterPhotos:[],createdAt:new Date(Date.now()-1800000).toISOString(),isDemo:true},
{id:'d2',name:'Tyndal',address:'Baseline & Gilbert Rd, Mesa',service:'Ducts + Dryer Vent',notes:'1,800 SF. New homeowner.',status:'complete',
beforePhotos:[makePhoto('#7B5B3A','Kitchen Vent - Before'),makePhoto('#8B6914','Hall Return - Before')],
afterPhotos:[makePhoto('#87CEEB','Kitchen Vent - After'),makePhoto('#B0E0E6','Hall Return - After')],
createdAt:new Date(Date.now()-86400000).toISOString(),isDemo:true},
{id:'d3',name:'Becker',address:'Ray & I-10, Chandler',service:'Air Duct Cleaning',notes:'3,200 SF with ozone.',status:'complete',
beforePhotos:[makePhoto('#6B4226','Master BR Vent - Before'),makePhoto('#5C3317','Living Room - Before'),makePhoto('#704214','Garage Return - Before')],
afterPhotos:[makePhoto('#ADD8E6','Master BR Vent - After'),makePhoto('#E0F7FA','Living Room - After'),makePhoto('#B2EBF2','Garage Return - After')],
createdAt:new Date(Date.now()-172800000).toISOString(),isDemo:true},
];
for(const d of demos)await put(d);
}

async function clearDemo(){
const all=await getAll();for(const j of all)if(j.isDemo)await del(j.id);
document.getElementById('demoBanner').style.display='none';
currentJob=null;toast('Demo cleared');await refresh();
}

async function refresh(){
jobs=await getAll();
const active=jobs.find(j=>j.status==='active');
if(active){currentJob=active;renderJob();}
else{currentJob=null;document.getElementById('jobEmpty').style.display='block';document.getElementById('jobActive').style.display='none';}
renderHistory();
const hasDemo=jobs.some(j=>j.isDemo);
document.getElementById('demoBanner').style.display=hasDemo?'flex':'none';
const completed=jobs.filter(j=>j.status==='complete');
document.getElementById('headerCount').textContent=completed.length+' job'+(completed.length!==1?'s':'')+' logged';
}

function renderJob(){
if(!currentJob)return;
document.getElementById('jobEmpty').style.display='none';
document.getElementById('jobActive').style.display='block';
document.getElementById('jobTitle').textContent=currentJob.name;
document.getElementById('jobAddr').textContent=[currentJob.address,currentJob.service].filter(Boolean).join(' | ');
renderPhotoGrid('beforeGrid',currentJob.beforePhotos||[],'before');
renderPhotoGrid('afterGrid',currentJob.afterPhotos||[],'after');
setPhase(currentPhase);
}

function renderPhotoGrid(containerId,photos,phase){
const el=document.getElementById(containerId);
if(photos.length===0){el.innerHTML='';return;}
el.innerHTML=photos.map((p,i)=>`<div class="photo-cell">
<img src="${p}" alt="${phase} photo ${i+1}">
<span class="photo-label ${phase}">${phase}</span>
<button onclick="removePhoto('${phase}',${i})" aria-label="Remove photo"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
</div>`).join('');
}

function setPhase(p){
currentPhase=p;
document.querySelectorAll('#phaseToggle button').forEach(b=>b.classList.toggle('active',b.dataset.phase===p));
document.getElementById('beforeSection').style.display=p==='before'?'block':'none';
document.getElementById('afterSection').style.display=p==='after'?'block':'none';
}

async function removePhoto(phase,idx){
if(!currentJob)return;
const arr=phase==='before'?currentJob.beforePhotos:currentJob.afterPhotos;
arr.splice(idx,1);
await put(currentJob);toast('Photo removed');renderJob();
}

// New Job
function showNewJob(){
document.getElementById('njName').value='';document.getElementById('njAddr').value='';document.getElementById('njNotes').value='';
document.getElementById('newJobModal').classList.add('show');document.getElementById('njName').focus();
}

async function createJob(){
const name=document.getElementById('njName').value.trim();
const addr=document.getElementById('njAddr').value.trim();
const service=document.getElementById('njService').value;
const notes=document.getElementById('njNotes').value.trim();
if(!name){toast('Add customer name');return;}
const job={id:'j'+Date.now(),name,address:addr,service,notes,status:'active',beforePhotos:[],afterPhotos:[],createdAt:new Date().toISOString(),isDemo:false};
await put(job);closeModal('newJobModal');toast('Job started -- take before photos');currentPhase='before';await refresh();
}

function editJobInfo(){
if(!currentJob)return;
document.getElementById('njName').value=currentJob.name;
document.getElementById('njAddr').value=currentJob.address||'';
document.getElementById('njService').value=currentJob.service;
document.getElementById('njNotes').value=currentJob.notes||'';
const btn=document.querySelector('#newJobModal .btn-blue');
const origClick=btn.onclick;
btn.onclick=async function(){
currentJob.name=document.getElementById('njName').value.trim();
currentJob.address=document.getElementById('njAddr').value.trim();
currentJob.service=document.getElementById('njService').value;
currentJob.notes=document.getElementById('njNotes').value.trim();
await put(currentJob);closeModal('newJobModal');btn.onclick=createJob;toast('Updated');renderJob();
};
document.getElementById('newJobModal').classList.add('show');
}

// Camera
function takePhoto(phase){
camTarget=phase;
document.getElementById('camPhaseLabel').textContent=phase.toUpperCase();
document.getElementById('camPhaseLabel').style.color=phase==='before'?'var(--error)':'var(--green)';
if(navigator.mediaDevices?.getUserMedia){
navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1280}}}).then(s=>{
camStream=s;document.getElementById('camVid').srcObject=s;document.getElementById('cameraModal').classList.add('show');
}).catch(()=>useFallback(phase));
}else{useFallback(phase);}
}

function useFallback(phase){
const inp=document.createElement('input');inp.type='file';inp.accept='image/*';inp.capture='environment';
inp.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>addPhoto(phase,ev.target.result);r.readAsDataURL(f);};
inp.click();
}

async function snapPhoto(){
const v=document.getElementById('camVid');const c=document.getElementById('camCan');
c.width=v.videoWidth;c.height=v.videoHeight;c.getContext('2d').drawImage(v,0,0);
const data=c.toDataURL('image/jpeg',0.7);
stopCam();
await addPhoto(camTarget,data);
}

async function addPhoto(phase,data){
if(!currentJob)return;
if(phase==='before'){if(!currentJob.beforePhotos)currentJob.beforePhotos=[];currentJob.beforePhotos.push(data);}
else{if(!currentJob.afterPhotos)currentJob.afterPhotos=[];currentJob.afterPhotos.push(data);}
await put(currentJob);toast(phase+' photo added');renderJob();
}

function stopCam(){if(camStream){camStream.getTracks().forEach(t=>t.stop());camStream=null;}closeModal('cameraModal');}

// Share & Complete
function shareJob(){
if(!currentJob)return;
const bCount=(currentJob.beforePhotos||[]).length;
const aCount=(currentJob.afterPhotos||[]).length;
let text='Duct Cleaning Report\n'+currentJob.name+'\n'+(currentJob.address||'')+'\n'+currentJob.service+'\nDate: '+new Date(currentJob.createdAt).toLocaleDateString()+'\n\n';
text+=bCount+' before photos, '+aCount+' after photos taken.\n\n';
text+='Your ducts are clean! Thanks for choosing Honest Guys Duct Cleaning.\n(602) 503-2431 | honestguysductcleaning.com';
if(navigator.share){navigator.share({title:'Duct Cleaning - '+currentJob.name,text}).catch(()=>copyTxt(text));}
else{copyTxt(text);}
}

function copyTxt(t){navigator.clipboard.writeText(t).then(()=>toast('Report copied -- paste into a text')).catch(()=>toast('Could not copy'));}

async function completeJob(){
if(!currentJob)return;
currentJob.status='complete';
await put(currentJob);
toast('Job completed');
currentJob=null;
currentPhase='before';
await refresh();
}

// History
function renderHistory(){
const done=jobs.filter(j=>j.status==='complete');
const el=document.getElementById('histList');
const empty=document.getElementById('histEmpty');
const totalPhotos=done.reduce((s,j)=>s+(j.beforePhotos||[]).length+(j.afterPhotos||[]).length,0);
document.getElementById('histSummary').innerHTML=`
<div class="summary-item"><div class="val">${done.length}</div><div class="lbl">Jobs</div></div>
<div class="summary-item"><div class="val">${totalPhotos}</div><div class="lbl">Photos</div></div>`;
if(done.length===0){empty.style.display='block';el.innerHTML='';return;}
empty.style.display='none';
const sorted=[...done].sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
el.innerHTML='<div class="card">'+sorted.map(j=>{
const thumb=(j.afterPhotos||[])[0]||(j.beforePhotos||[])[0]||'';
const pCount=(j.beforePhotos||[]).length+(j.afterPhotos||[]).length;
return `<div class="job-card" onclick="showJobDetail('${j.id}')">
<div class="job-thumb">${thumb?`<img src="${thumb}" alt="${esc(j.name)}">`:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="1.5" style="margin:12px"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>'}</div>
<div class="job-info"><h3>${esc(j.name)}</h3><p>${esc(j.address||'')} | ${j.service}</p></div>
<div class="job-meta"><div class="photo-count">${pCount} pics</div><div class="job-date">${new Date(j.createdAt).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</div></div>
</div>`;}).join('')+'</div>';
}

function showJobDetail(id){
const j=jobs.find(j=>j.id===id);if(!j)return;
let html=`<h2>${esc(j.name)}</h2><p style="color:var(--muted);font-size:13px;margin-bottom:12px">${esc(j.address||'')} | ${j.service} | ${new Date(j.createdAt).toLocaleDateString()}</p>`;
if(j.notes)html+=`<p style="font-size:13px;margin-bottom:12px">${esc(j.notes)}</p>`;
if((j.beforePhotos||[]).length>0){
html+=`<h3 style="color:var(--error);font-size:12px;text-transform:uppercase;margin-bottom:8px">Before</h3>`;
html+=`<div class="photo-grid" style="margin-bottom:16px">${j.beforePhotos.map((p,i)=>`<div class="photo-cell"><img src="${p}" alt="Before ${i+1}"></div>`).join('')}</div>`;
}
if((j.afterPhotos||[]).length>0){
html+=`<h3 style="color:var(--green);font-size:12px;text-transform:uppercase;margin-bottom:8px">After</h3>`;
html+=`<div class="photo-grid" style="margin-bottom:16px">${j.afterPhotos.map((p,i)=>`<div class="photo-cell"><img src="${p}" alt="After ${i+1}"></div>`).join('')}</div>`;
}
html+=`<div style="display:flex;gap:8px;margin-top:16px">`;
html+=`<button class="btn btn-green btn-block" onclick="shareHistJob('${j.id}')">Share Report</button>`;
html+=`<button class="btn btn-outline" style="color:var(--error)" onclick="deleteJob('${j.id}')" aria-label="Delete">
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button></div>`;
document.getElementById('detailContent').innerHTML=html;
document.getElementById('detailModal').classList.add('show');
}

function shareHistJob(id){
const j=jobs.find(j=>j.id===id);if(!j)return;
let text='Duct Cleaning Report\n'+j.name+'\n'+(j.address||'')+'\n'+j.service+'\n\nThank you for choosing Honest Guys!\n(602) 503-2431';
if(navigator.share){navigator.share({title:'Cleaning Report - '+j.name,text}).catch(()=>copyTxt(text));}
else{copyTxt(text);}
}

async function deleteJob(id){await del(id);closeModal('detailModal');toast('Deleted');await refresh();}

function switchTab(t){document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));document.getElementById('tab-'+t).classList.add('active');document.querySelectorAll('.bottom-nav button').forEach(b=>b.classList.toggle('active',b.dataset.tab===t));}
function closeModal(id){document.getElementById(id).classList.remove('show');}
function toast(m){const c=document.getElementById('toastBox');const t=document.createElement('div');t.className='toast';t.textContent=m;c.appendChild(t);setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity 0.3s';setTimeout(()=>t.remove(),300);},2500);}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
</script>
</body>
</html>
