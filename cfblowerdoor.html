<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>BlowerSnap - Central Florida Blower Door Testing</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --blu:#1565C0;--blu-d:#0D47A1;--blu-l:#1E88E5;--blu-p:#E3F2FD;
  --grn:#2E7D32;--grn-p:#E8F5E9;--red:#C62828;--red-p:#FFEBEE;
  --org:#EF6C00;--org-p:#FFF3E0;
  --bg:#F5F5F5;--wh:#FFF;--tx:#212121;--tx2:#616161;--tx3:#9E9E9E;--bdr:#E0E0E0;
  --sh-s:0 1px 3px rgba(0,0,0,.06);--sh-m:0 4px 12px rgba(0,0,0,.08);--sh-l:0 8px 24px rgba(0,0,0,.1);
  --r:8px;--rm:12px;--rl:16px;
}
*{margin:0;padding:0;box-sizing:border-box}
*:focus-visible{outline:2px solid var(--blu);outline-offset:2px}
body{font-family:'Roboto',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;padding-bottom:120px;-webkit-font-smoothing:antialiased}
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:.01ms!important;transition-duration:.01ms!important}}

.hdr{background:linear-gradient(135deg,var(--blu-d),var(--blu));color:#fff;padding:16px 20px;position:sticky;top:0;z-index:100;box-shadow:var(--sh-m)}
.hdr h1{font-family:'Roboto Condensed',sans-serif;font-size:22px;font-weight:700;letter-spacing:-.3px}
.hdr .sub{font-size:12px;opacity:.8;margin-top:2px;font-weight:300}

.demo-bar{background:var(--blu-p);border-bottom:1px solid var(--blu-l);padding:10px 20px;font-size:13px;color:var(--blu-d);display:flex;align-items:center;justify-content:space-between;gap:12px}
.demo-bar button{background:none;border:1px solid var(--blu);color:var(--blu);padding:4px 12px;border-radius:4px;cursor:pointer;font-size:12px;font-family:inherit}

.wrap{padding:0 16px;max-width:500px;margin:0 auto}
.vw{display:none}.vw.on{display:block}

/* TEST CARDS */
.tcard{background:var(--wh);border-radius:var(--rl);padding:20px;margin:16px 0;box-shadow:var(--sh-m);border:1px solid var(--bdr);cursor:pointer;transition:transform .15s;animation:sUp .4s cubic-bezier(.34,1.56,.64,1) both;position:relative}
.tcard:active{transform:scale(.98)}
.tcard:nth-child(1){animation-delay:.05s}.tcard:nth-child(2){animation-delay:.1s}.tcard:nth-child(3){animation-delay:.15s}
.tc-addr{font-family:'Roboto Condensed',sans-serif;font-size:17px;font-weight:600;margin-bottom:4px}
.tc-meta{font-size:13px;color:var(--tx2);margin-bottom:12px}
.tc-result{display:flex;align-items:center;gap:12px;margin-bottom:8px}
.tc-badge{padding:6px 14px;border-radius:var(--r);font-family:'Roboto Condensed',sans-serif;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.tc-badge.pass{background:var(--grn-p);color:var(--grn)}.tc-badge.fail{background:var(--red-p);color:var(--red)}
.tc-ach{font-family:'Roboto Condensed',sans-serif;font-size:28px;font-weight:700}
.tc-ach.pass{color:var(--grn)}.tc-ach.fail{color:var(--red)}
.tc-ach-label{font-size:12px;color:var(--tx3)}
.tc-foot{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--tx3);margin-top:8px}

.fab{position:fixed;bottom:130px;right:20px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--blu-l),var(--blu-d));color:#fff;border:none;box-shadow:var(--sh-l);cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:90;transition:transform .2s;animation:pulse 2s ease-in-out infinite}
.fab:active{transform:scale(.9)}.fab svg{width:26px;height:26px}
@keyframes pulse{0%,100%{box-shadow:var(--sh-l),0 0 0 0 rgba(21,101,192,.3)}50%{box-shadow:var(--sh-l),0 0 0 10px rgba(21,101,192,0)}}

.bsec{background:var(--wh);border-radius:var(--rl);padding:20px;margin:16px 0;box-shadow:var(--sh-s);border:1px solid var(--bdr);animation:sUp .3s ease-out both}
.bsec h2{font-family:'Roboto Condensed',sans-serif;font-size:15px;font-weight:600;color:var(--blu-d);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.bsec h2 svg{width:20px;height:20px}
.fg{margin-bottom:14px}.fg label{display:block;font-size:12px;font-weight:500;color:var(--tx2);margin-bottom:5px}
.fg input,.fg select{width:100%;padding:12px 14px;border:1.5px solid var(--bdr);border-radius:var(--r);font-size:16px;font-family:inherit;background:var(--wh);color:var(--tx);transition:.15s}
.fg input:focus,.fg select:focus{border-color:var(--blu);box-shadow:0 0 0 3px rgba(21,101,192,.12)}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:10px}

/* ACH GAUGE - BIG RESULT */
.result-box{text-align:center;padding:24px;border-radius:var(--rl);margin:16px 0;transition:background .4s}
.result-box.pass{background:var(--grn-p);border:2px solid var(--grn)}
.result-box.fail{background:var(--red-p);border:2px solid var(--red)}
.result-box.neutral{background:var(--bg);border:2px solid var(--bdr)}
.rb-status{font-family:'Roboto Condensed',sans-serif;font-size:18px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.rb-status.pass{color:var(--grn)}.rb-status.fail{color:var(--red)}.rb-status.neutral{color:var(--tx3)}
.rb-ach{font-family:'Roboto Condensed',sans-serif;font-size:64px;font-weight:700;line-height:1;transition:transform .3s cubic-bezier(.34,1.56,.64,1)}
.rb-ach.pass{color:var(--grn)}.rb-ach.fail{color:var(--red)}.rb-ach.neutral{color:var(--tx3)}
.rb-ach.bump{transform:scale(1.1)}
.rb-label{font-size:13px;color:var(--tx2);margin-top:8px}
.rb-bar{height:10px;background:var(--bdr);border-radius:5px;margin:16px auto 0;max-width:300px;position:relative;overflow:hidden}
.rb-fill{height:100%;border-radius:5px;transition:width .6s ease,background .3s}
.rb-scale{display:flex;justify-content:space-between;font-size:10px;color:var(--tx3);max-width:300px;margin:6px auto 0}
.rb-code{font-size:12px;color:var(--tx2);margin-top:8px;padding:4px 12px;display:inline-block;border-radius:4px;background:rgba(0,0,0,.04)}

/* PHOTO STRIP */
.photo-strip{display:flex;gap:8px;overflow-x:auto;padding:8px 0}
.ph-thumb{width:72px;height:72px;border-radius:var(--r);overflow:hidden;background:var(--blu-p);flex-shrink:0;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px dashed var(--bdr)}
.ph-thumb img{width:100%;height:100%;object-fit:cover}
.ph-thumb.has{border:solid;border-color:transparent}

.abr{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
.btn{padding:14px 20px;border-radius:var(--rm);font-family:'Roboto Condensed',sans-serif;font-size:15px;font-weight:600;cursor:pointer;transition:transform .1s;border:none;display:flex;align-items:center;justify-content:center;gap:8px}
.btn:active{transform:scale(.97)}.btn svg{width:18px;height:18px}
.bp{background:linear-gradient(135deg,var(--blu-l),var(--blu-d));color:#fff;box-shadow:var(--sh-m)}
.bs{background:var(--wh);color:var(--blu-d);border:2px solid var(--blu)}
.bf{grid-column:1/-1}

.bnav{position:fixed;bottom:60px;left:0;right:0;background:var(--wh);border-top:1px solid var(--bdr);display:flex;justify-content:space-around;padding:8px 0 12px;z-index:100;box-shadow:0 -2px 8px rgba(0,0,0,.06)}
.nb{background:none;border:none;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;padding:4px 16px;color:var(--tx3);transition:.15s;font-family:inherit}
.nb.on{color:var(--blu-d)}.nb svg{width:22px;height:22px}.nb span{font-size:11px;font-weight:500}

.tc-box{position:fixed;top:80px;left:50%;transform:translateX(-50%);z-index:9999;pointer-events:none}
.tst{background:var(--tx);color:#fff;padding:12px 20px;border-radius:var(--rm);font-size:14px;box-shadow:var(--sh-l);animation:tIn .3s ease-out;margin-bottom:8px}
.tst.ok{background:var(--grn)}.tst.err{background:var(--red)}

.empty{text-align:center;padding:48px 24px}
.empty svg{width:80px;height:80px;color:var(--tx3);opacity:.4;margin-bottom:16px}
.empty h3{font-family:'Roboto Condensed',sans-serif;font-size:18px;margin-bottom:8px}
.empty p{font-size:14px;color:var(--tx3);max-width:260px;margin:0 auto 20px}

.sg{background:var(--wh);border-radius:var(--rl);padding:20px;margin:16px 0;box-shadow:var(--sh-s);border:1px solid var(--bdr)}
.sg h3{font-family:'Roboto Condensed',sans-serif;font-size:15px;font-weight:600;margin-bottom:12px;color:var(--blu-d)}
.locked{position:relative;opacity:.5;min-height:120px}
.lock-ov{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(255,255,255,.85);border-radius:var(--rl);z-index:10}
.lock-lbl{font-family:'Roboto Condensed',sans-serif;font-size:14px;font-weight:600;color:var(--tx2);margin-top:8px}

/* STATS */
.stat-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:16px 0}
.stat-card{background:var(--wh);border-radius:var(--rm);padding:14px;text-align:center;box-shadow:var(--sh-s);border:1px solid var(--bdr)}
.stat-val{font-family:'Roboto Condensed',sans-serif;font-size:24px;font-weight:700;color:var(--blu-d)}
.stat-lbl{font-size:10px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;margin-top:2px}

@keyframes sUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes tIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

@media print{.bnav,.fab,.demo-bar,.tc-box,.hdr,#bct-demo-disclaimer{display:none!important}body{padding:0;background:#fff}.wrap{max-width:100%}.result-box{break-inside:avoid}}
@media(min-width:1024px){.bnav{display:none}body{padding-bottom:80px}.wrap{max-width:600px}.fab{bottom:80px}}
body{padding-bottom:60px!important}
</style>
</head>
<body>
<header class="hdr" role="banner">
  <h1>BlowerSnap</h1>
  <div class="sub">Central Florida Blower Door Testing</div>
</header>
<div class="demo-bar" id="demoBanner" style="display:none" role="status">
  <span>Sample Polk County area tests loaded. Clear to start fresh.</span>
  <button onclick="clearDemo()" aria-label="Clear sample data">Clear</button>
</div>
<div class="tc-box" id="toasts" aria-live="polite" aria-atomic="true"></div>

<main class="wrap" role="main">
  <section class="vw on" id="listView" aria-label="Test list">
    <div class="stat-row" id="statsRow">
      <div class="stat-card"><div class="stat-val" id="stTotal">0</div><div class="stat-lbl">Tests</div></div>
      <div class="stat-card"><div class="stat-val" id="stPass">0</div><div class="stat-lbl">Passed</div></div>
      <div class="stat-card"><div class="stat-val" id="stRate">0%</div><div class="stat-lbl">Pass Rate</div></div>
    </div>
    <div id="testList"></div>
    <div class="empty" id="emptyState" style="display:none">
      <svg viewBox="0 0 80 80" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><circle cx="40" cy="40" r="25"/><path d="M40 25v15l10 5"/><rect x="15" y="55" width="50" height="10" rx="2"/></svg>
      <h3>No tests recorded</h3>
      <p>Tap below to log your first blower door test result.</p>
      <button class="btn bp" onclick="switchVw('build')">New Test</button>
    </div>
  </section>

  <section class="vw" id="buildView" aria-label="Test entry">
    <div class="bsec" style="animation-delay:.05s">
      <h2><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Property</h2>
      <div class="fg"><label for="tAddr">Address</label><input type="text" id="tAddr" placeholder="1234 Lake View Dr, Davenport, FL"></div>
      <div class="frow">
        <div class="fg"><label for="tBuilder">Builder / Contact</label><input type="text" id="tBuilder" placeholder="ABC Homes"></div>
        <div class="fg"><label for="tPermit">Permit #</label><input type="text" id="tPermit" placeholder="BLD-2026-1234"></div>
      </div>
    </div>

    <div class="bsec" style="animation-delay:.1s">
      <h2><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> Test Data</h2>
      <div class="frow">
        <div class="fg"><label for="tSqft">Conditioned Area (sqft)</label><input type="number" id="tSqft" placeholder="2100" inputmode="numeric" oninput="calcResult()"></div>
        <div class="fg"><label for="tCeil">Ceiling Height (ft)</label><input type="number" id="tCeil" value="9" step="0.5" oninput="calcResult()"></div>
      </div>
      <div class="fg">
        <label for="tCfm">CFM50 Reading</label>
        <input type="number" id="tCfm" placeholder="1842" inputmode="numeric" oninput="calcResult()" style="font-size:20px;font-weight:600;text-align:center;padding:16px">
      </div>
    </div>

    <div class="result-box neutral" id="resultBox">
      <div class="rb-status neutral" id="rbStatus">Enter readings above</div>
      <div class="rb-ach neutral" id="rbAch">--</div>
      <div class="rb-label">Air Changes per Hour (ACH50)</div>
      <div class="rb-bar"><div class="rb-fill" id="rbFill" style="width:0"></div></div>
      <div class="rb-scale"><span>Tight (3)</span><span>Code (7)</span><span>Leaky (12+)</span></div>
      <div class="rb-code" id="rbCode">Florida Energy Code: 7 ACH50 max</div>
    </div>

    <div class="bsec" style="animation-delay:.2s">
      <h2><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg> Photos</h2>
      <div class="photo-strip" id="photoStrip">
        <div class="ph-thumb" onclick="addPh(0)" tabindex="0" role="button" aria-label="Add photo"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div>
        <div class="ph-thumb" onclick="addPh(1)" tabindex="0" role="button" aria-label="Add photo"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div>
        <div class="ph-thumb" onclick="addPh(2)" tabindex="0" role="button" aria-label="Add photo"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div>
      </div>
      <button class="btn bs bf" onclick="document.getElementById('phIn').click()" style="margin-top:8px">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
        Snap Manometer
      </button>
    </div>

    <div class="bsec" style="animation-delay:.25s">
      <div class="fg" style="margin-bottom:0">
        <label for="tNotes">Notes</label>
        <input type="text" id="tNotes" placeholder="Front door sealed, AC registers taped, exhaust fans off">
      </div>
    </div>

    <div class="abr">
      <button class="btn bs" onclick="saveTest()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg> Save</button>
      <button class="btn bp" onclick="shareCert()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg> Share Certificate</button>
    </div>
    <button class="btn bs bf" onclick="resetBuild()" style="margin-bottom:24px">Start Over</button>
  </section>

  <section class="vw" id="settingsView" aria-label="Settings">
    <div class="sg">
      <h3>Data</h3>
      <div style="display:flex;flex-direction:column;gap:10px">
        <button class="btn bs" onclick="exportAll()">Export Backup (JSON)</button>
        <button class="btn bs" onclick="document.getElementById('fileIn').click()">Import Backup (JSON)</button>
      </div>
    </div>
    <div class="sg locked">
      <div class="lock-ov">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--tx3)" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
        <span class="lock-lbl">Monthly Summary Report -- Full Version</span>
        <span style="font-size:12px;color:var(--tx3);margin-top:4px">Test counts, pass rates, and builder breakdowns</span>
      </div>
      <h3>Monthly Report</h3>
    </div>
  </section>
</main>

<button class="fab" id="fab" onclick="switchVw('build')" aria-label="New test"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>

<nav class="bnav" aria-label="Main navigation">
  <button class="nb on" onclick="switchVw('list')" data-v="list" aria-label="Tests"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><span>Tests</span></button>
  <button class="nb" onclick="switchVw('build')" data-v="build" aria-label="New test"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg><span>New</span></button>
  <button class="nb" onclick="switchVw('settings')" data-v="settings" aria-label="Settings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg><span>Settings</span></button>
</nav>

<div id="bct-demo-disclaimer" role="contentinfo" aria-label="Demo disclaimer" style="position:fixed;bottom:0;left:0;right:0;background:#f8f8f8;border-top:1px solid #ddd;padding:10px 16px;font-size:12px;line-height:1.4;color:#666;z-index:99999;display:flex;flex-wrap:wrap;align-items:center;justify-content:center;gap:8px 16px;text-align:center;">
  <p style="margin:0;max-width:700px;"><strong style="color:#333;">DEMO NOTICE:</strong> This tool was created by BennyCuTools as a free demonstration only. It is not affiliated with, endorsed by, or authorized by Central Florida Blower Door Testing LLC. All brand references are used solely for demonstration purposes.</p>
  <a href="mailto:cuuper225@gmail.com?subject=Delete%20Demo%3A%20CF%20Blower%20Door&body=I%20am%20the%20owner%20and%20I%20request%20permanent%20deletion%20of%20this%20demo." style="display:inline-flex;align-items:center;gap:4px;background:#dc3545;color:#fff;padding:5px 12px;border-radius:4px;text-decoration:none;font-size:11px;font-weight:500;white-space:nowrap;">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
    Request Permanent Deletion
  </a>
</div>
<input type="file" id="phIn" accept="image/*" capture="environment" style="display:none" onchange="handlePh(event)">
<input type="file" id="fileIn" accept=".json" style="display:none" onchange="handleImport(event)">

<script>
function _h(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return h;}
const _V=1516043698;
const _k=new URLSearchParams(window.location.search).get('key');
if(!_k||_h(_k)!==_V){
  document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;background:#111;color:#fff;text-align:center;padding:20px"><div><h1 style="font-size:2rem;margin-bottom:1rem">Access Required</h1><p style="color:#999">Valid access key needed.</p><p style="margin-top:1rem"><a href="mailto:ben@bennycutools.com" style="color:#4da6ff">ben@bennycutools.com</a></p></div></div><div id="bct-demo-disclaimer" role="contentinfo" style="position:fixed;bottom:0;left:0;right:0;background:#f8f8f8;border-top:1px solid #ddd;padding:10px 16px;font-size:12px;color:#666;z-index:99999;text-align:center;"><p style="margin:0"><strong style="color:#333;">DEMO NOTICE:</strong> Not affiliated with Central Florida Blower Door Testing LLC.</p></div>';throw new Error('x');
}
document.addEventListener('contextmenu',e=>e.preventDefault());

let tests=[],editId=null,photos=[null,null,null],phTarget=0,DB;
const FL_CODE=7;

function initDB(){return new Promise((r,j)=>{const q=indexedDB.open('BlowerSnapDB',1);q.onupgradeneeded=e=>{if(!e.target.result.objectStoreNames.contains('tests'))e.target.result.createObjectStore('tests',{keyPath:'id'})};q.onsuccess=e=>{DB=e.target.result;r()};q.onerror=j})}
function dbPut(t){return new Promise((r,j)=>{const x=DB.transaction('tests','readwrite');x.objectStore('tests').put(t);x.oncomplete=r;x.onerror=j})}
function dbAll(){return new Promise((r,j)=>{const x=DB.transaction('tests','readonly');const q=x.objectStore('tests').getAll();q.onsuccess=()=>r(q.result);q.onerror=j})}
function dbDel(id){return new Promise((r,j)=>{const x=DB.transaction('tests','readwrite');x.objectStore('tests').delete(id);x.oncomplete=r;x.onerror=j})}

function getDemos(){const n=Date.now();return[
  {id:'d1',isDemo:true,addr:'2847 Lakeshore Dr, Davenport, FL',builder:'Meritage Homes',permit:'BLD-2026-3847',sqft:2100,ceil:9,cfm:1842,ach:5.8,pass:true,notes:'Standard test, all windows closed, HVAC registers taped',photos:[],created:n-86400000*2},
  {id:'d2',isDemo:true,addr:'1024 Citrus Grove Rd, Winter Haven, FL',builder:'DR Horton',permit:'BLD-2026-2156',sqft:1750,ceil:9,cfm:2380,ach:9.1,pass:false,notes:'Failed - leaks around attic access, plumbing penetrations, and recessed cans. Builder notified for re-seal.',photos:[],created:n-86400000},
  {id:'d3',isDemo:true,addr:'455 Orange Blossom Trl, Clermont, FL',builder:'DR Horton',permit:'BLD-2026-2156-R',sqft:1750,ceil:9,cfm:1620,ach:6.2,pass:true,notes:'Retest after builder sealed attic access, caulked penetrations. Improved from 9.1 to 6.2. Pass.',photos:[],created:n-3600000*4}
]}

async function loadDemos(){const ex=await dbAll();if(!ex.length&&!localStorage.getItem('bs_cleared')){for(const d of getDemos())await dbPut(d);document.getElementById('demoBanner').style.display='flex';await loadTests()}}
async function clearDemo(){const all=await dbAll();for(const t of all)if(t.isDemo)await dbDel(t.id);localStorage.setItem('bs_cleared','1');document.getElementById('demoBanner').style.display='none';toast('Sample data cleared');await loadTests()}

function switchVw(v){document.querySelectorAll('.vw').forEach(x=>x.classList.remove('on'));document.getElementById(v+'View').classList.add('on');document.querySelectorAll('.nb').forEach(b=>b.classList.toggle('on',b.dataset.v===v));document.getElementById('fab').style.display=v==='build'?'none':'flex';if(v==='list')loadTests();if(v==='build'&&!editId)resetBuild()}

async function loadTests(){
  tests=await dbAll();tests.sort((a,b)=>(b.created||0)-(a.created||0));
  document.getElementById('demoBanner').style.display=tests.some(t=>t.isDemo)?'flex':'none';
  const total=tests.length,passed=tests.filter(t=>t.pass).length;
  document.getElementById('stTotal').textContent=total;
  document.getElementById('stPass').textContent=passed;
  document.getElementById('stRate').textContent=total?Math.round(passed/total*100)+'%':'0%';

  const list=document.getElementById('testList'),empty=document.getElementById('emptyState');
  if(!tests.length){list.innerHTML='';empty.style.display='block';return}
  empty.style.display='none';
  list.innerHTML=tests.map(t=>{
    const cls=t.pass?'pass':'fail';
    return`<div class="tcard" onclick="openTest('${t.id}')">
      <div class="tc-addr">${esc(t.addr||'Untitled')}</div>
      <div class="tc-meta">${esc(t.builder||'')} ${t.permit?'| '+esc(t.permit):''}</div>
      <div class="tc-result">
        <span class="tc-badge ${cls}">${t.pass?'PASS':'FAIL'}</span>
        <div><div class="tc-ach ${cls}">${t.ach||'--'}</div><div class="tc-ach-label">ACH50</div></div>
      </div>
      <div class="tc-foot"><span>${timeAgo(t.created)}</span><span>${(t.sqft||0).toLocaleString()} sqft | ${t.cfm||0} CFM50</span></div>
    </div>`}).join('');
}

function openTest(id){
  const t=tests.find(x=>x.id===id);if(!t)return;editId=id;
  document.getElementById('tAddr').value=t.addr||'';
  document.getElementById('tBuilder').value=t.builder||'';
  document.getElementById('tPermit').value=t.permit||'';
  document.getElementById('tSqft').value=t.sqft||'';
  document.getElementById('tCeil').value=t.ceil||9;
  document.getElementById('tCfm').value=t.cfm||'';
  document.getElementById('tNotes').value=t.notes||'';
  photos=t.photos?[...t.photos]:new Array(3).fill(null);while(photos.length<3)photos.push(null);
  renderPhotos();calcResult();switchVw('build');
}

function resetBuild(){
  editId=null;
  ['tAddr','tBuilder','tPermit','tSqft','tCfm','tNotes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('tCeil').value='9';
  photos=new Array(3).fill(null);renderPhotos();
  const rb=document.getElementById('resultBox');rb.className='result-box neutral';
  document.getElementById('rbStatus').textContent='Enter readings above';document.getElementById('rbStatus').className='rb-status neutral';
  document.getElementById('rbAch').textContent='--';document.getElementById('rbAch').className='rb-ach neutral';
  document.getElementById('rbFill').style.width='0';document.getElementById('rbFill').style.background='var(--bdr)';
}

function calcResult(){
  const cfm=parseFloat(document.getElementById('tCfm').value)||0;
  const sqft=parseFloat(document.getElementById('tSqft').value)||0;
  const ceil=parseFloat(document.getElementById('tCeil').value)||9;
  if(!cfm||!sqft){document.getElementById('rbAch').textContent='--';return}
  const vol=sqft*ceil;
  const ach=Math.round((cfm*60/vol)*10)/10;
  const pass=ach<=FL_CODE;
  const cls=pass?'pass':'fail';

  const achEl=document.getElementById('rbAch');achEl.textContent=ach.toFixed(1);achEl.className='rb-ach '+cls;achEl.classList.add('bump');setTimeout(()=>achEl.classList.remove('bump'),300);
  document.getElementById('rbStatus').textContent=pass?'PASS':'FAIL';document.getElementById('rbStatus').className='rb-status '+cls;
  document.getElementById('resultBox').className='result-box '+cls;

  const pct=Math.min(ach/14*100,100);
  const fill=document.getElementById('rbFill');
  fill.style.width=pct+'%';
  fill.style.background=pass?'var(--grn)':'var(--red)';
}

function renderPhotos(){
  document.getElementById('photoStrip').innerHTML=photos.map((p,i)=>
    `<div class="ph-thumb${p?' has':''}" onclick="addPh(${i})" tabindex="0" role="button" aria-label="Photo ${i+1}">
      ${p?`<img src="${p}" alt="Test photo ${i+1}">`:`<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`}
    </div>`).join('');
}
function addPh(i){phTarget=i;document.getElementById('phIn').click()}
function handlePh(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{const img=new Image();img.onload=()=>{const c=document.createElement('canvas');let w=img.width,h=img.height;if(w>600){h=h*(600/w);w=600}c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);photos[phTarget]=c.toDataURL('image/jpeg',.7);renderPhotos()};img.src=ev.target.result};r.readAsDataURL(f);e.target.value=''}

async function saveTest(){
  const addr=document.getElementById('tAddr').value.trim();
  if(!addr){toast('Add an address','err');return}
  const cfm=parseFloat(document.getElementById('tCfm').value)||0;
  const sqft=parseFloat(document.getElementById('tSqft').value)||0;
  const ceil=parseFloat(document.getElementById('tCeil').value)||9;
  const ach=sqft&&cfm?Math.round((cfm*60/(sqft*ceil))*10)/10:0;
  const pass=ach<=FL_CODE&&ach>0;
  const test={
    id:editId||'t-'+Date.now(),addr,builder:document.getElementById('tBuilder').value,
    permit:document.getElementById('tPermit').value,sqft,ceil,cfm,ach,pass,
    notes:document.getElementById('tNotes').value,photos:photos.filter(Boolean),
    created:editId?(tests.find(t=>t.id===editId)||{}).created||Date.now():Date.now()
  };
  await dbPut(test);toast('Test saved','ok');editId=null;switchVw('list');
}

async function shareCert(){
  await saveTest();
  const addr=document.getElementById('tAddr').value;
  const builder=document.getElementById('tBuilder').value;
  const ach=document.getElementById('rbAch').textContent;
  const cfm=document.getElementById('tCfm').value;
  const sqft=document.getElementById('tSqft').value;
  const pass=parseFloat(ach)<=FL_CODE;
  const text=`BLOWER DOOR TEST CERTIFICATE\nCentral Florida Blower Door Testing LLC\n(863) 267-7728\n\nProperty: ${addr}\nBuilder: ${builder}\nDate: ${new Date().toLocaleDateString()}\n\nConditioned Area: ${sqft} sqft\nCFM50: ${cfm}\nACH50: ${ach}\nFL Energy Code Max: ${FL_CODE}\n\nResult: ${pass?'PASS':'FAIL'}\n\nTested by: Rodney Pullen\nCentral Florida Blower Door Testing LLC`;

  if(navigator.share){try{await navigator.share({title:'Blower Door Certificate',text});toast('Certificate shared','ok')}catch(e){}}
  else{try{await navigator.clipboard.writeText(text);toast('Certificate copied','ok')}catch(e){toast('Could not share','err')}}
}

async function exportAll(){const all=await dbAll();const b=new Blob([JSON.stringify({tests:all,exported:new Date().toISOString()},null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`blowersnap-${new Date().toISOString().split('T')[0]}.json`;a.click();toast('Exported','ok')}
async function handleImport(e){const f=e.target.files[0];if(!f)return;try{const d=JSON.parse(await f.text());if(d.tests)for(const t of d.tests)await dbPut(t);toast('Imported','ok');await loadTests()}catch(e){toast('Could not read file','err')}e.target.value=''}

function toast(m,t){const el=document.createElement('div');el.className='tst'+(t?' '+t:'');el.textContent=m;document.getElementById('toasts').appendChild(el);setTimeout(()=>el.remove(),4000)}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function timeAgo(ts){const d=Date.now()-ts,m=Math.floor(d/60000);if(m<1)return'Just now';if(m<60)return m+'m ago';const h=Math.floor(m/60);if(h<24)return h+'h ago';const dy=Math.floor(h/24);if(dy<7)return dy+'d ago';return new Date(ts).toLocaleDateString()}

(async function(){await initDB();await loadDemos();await loadTests()})();
</script>
</body>
</html>
