<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>GeoProposal - Geothermal Professionals</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--primary:#2D7A4F;--primary-light:#48BB78;--primary-dark:#1A5C38;
--secondary:#1A365D;--surface:#F7F4EF;--white:#FFFFFF;
--success:#38A169;--error:#E53E3E;--warning:#DD6B20;
--text:#1A202C;--text-muted:#718096;--border:#E2D8CC;
--shadow-2:0 4px 12px rgba(26,54,93,.1),0 1px 3px rgba(26,54,93,.06);
--shadow-3:0 8px 24px rgba(26,54,93,.12),0 2px 8px rgba(26,54,93,.08);
--shadow-glow:0 0 20px rgba(45,122,79,.15);
--radius:12px;--radius-sm:8px;
}
html{font-size:16px;-webkit-tap-highlight-color:transparent}
body{padding-bottom:80px;font-family:'DM Sans',sans-serif;background:var(--surface);color:var(--text);min-height:100dvh;padding-bottom:120px !important;overflow-x:hidden;-webkit-font-smoothing:antialiased}
h1,h2,h3{font-family:'DM Serif Display',serif;font-weight:400;line-height:1.25}
button{font-family:'DM Sans',sans-serif;cursor:pointer;border:none;background:none}
input,select,textarea{font-family:'DM Sans',sans-serif;font-size:16px}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
.skip-link{position:absolute;top:-100%;left:16px;background:var(--primary);color:#fff;padding:10px 18px;border-radius:var(--radius-sm);z-index:10000;font-size:14px;font-weight:600;text-decoration:none;box-shadow:var(--shadow-3)}
.skip-link:focus{top:16px;outline:3px solid #fff;outline-offset:2px}
#app{display:none}#gate{display:flex;align-items:center;justify-content:center;height:100dvh;background:linear-gradient(135deg,var(--secondary) 0%,#0F2942 100%);color:#fff;text-align:center;padding:24px}
#gate h1{font-size:1.75rem;margin-bottom:16px}#gate p{color:rgba(255,255,255,.7);margin-bottom:12px;font-size:.95rem}
#gate a{color:#48BB78;text-decoration:none;font-weight:500}
#gate a:hover{text-decoration:underline}
.app-header{background:linear-gradient(135deg,var(--secondary),#244A7C);color:#fff;padding:18px 20px;position:sticky;top:0;z-index:100;box-shadow:var(--shadow-2)}
.app-header h1{font-size:1.15rem;letter-spacing:-0.01em}
.app-header p{font-size:.75rem;color:rgba(255,255,255,.65);margin-top:4px}
.demo-banner{background:linear-gradient(90deg,var(--primary),#38A169);color:#fff;padding:12px 16px;font-size:.85rem;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:var(--shadow-2)}
.demo-banner button{background:rgba(255,255,255,.25);color:#fff;padding:6px 14px;border-radius:var(--radius-sm);font-size:.75rem;font-weight:600;transition:background .2s}
.demo-banner button:hover{background:rgba(255,255,255,.35)}
.demo-banner button:focus-visible{outline:2px solid #fff;outline-offset:2px}
.content{padding:16px;max-width:640px;margin:0 auto}
.card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow-2);padding:18px;margin-bottom:14px;animation:fadeUp .45s ease-out both;transition:transform .2s,box-shadow .2s}
.card:hover{box-shadow:var(--shadow-3)}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
*:focus-visible{outline:2px solid var(--primary);outline-offset:3px}
.view{display:none}.view.active{display:block}
.form-group{margin-bottom:18px}
.form-group label{display:block;font-size:.85rem;font-weight:600;color:var(--text);margin-bottom:6px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:13px 16px;border:2px solid var(--border);border-radius:var(--radius-sm);background:#fff;transition:border-color .2s,box-shadow .2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(45,122,79,.12)}
.form-group input::placeholder,.form-group textarea::placeholder{color:#A0AEC0}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 28px;border-radius:var(--radius-sm);font-size:.95rem;font-weight:600;transition:transform .15s,background .2s,box-shadow .2s}
.btn:active{transform:scale(.97)}
.btn-primary{background:var(--primary);color:#fff;box-shadow:var(--shadow-2)}
.btn-primary:hover{background:var(--primary-dark);box-shadow:var(--shadow-3)}
.btn-outline{border:2px solid var(--border);color:var(--text);background:#fff}
.btn-outline:hover{border-color:var(--primary);color:var(--primary)}
.btn-danger{background:var(--error);color:#fff}
.btn-danger:hover{background:#C53030}
.btn-block{width:100%}
.fab{position:fixed;bottom:80px;right:20px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow-3);z-index:90;transition:transform .2s,box-shadow .2s}
.fab:hover{box-shadow:var(--shadow-glow);transform:translateY(-2px)}
.fab:active{transform:scale(.93)}
.fab:focus-visible{outline:3px solid var(--primary);outline-offset:3px}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--border);display:flex;z-index:99;padding-bottom:env(safe-area-inset-bottom,0);box-shadow:0 -2px 10px rgba(0,0,0,.04)}
.bottom-nav button{flex:1;display:flex;flex-direction:column;align-items:center;padding:10px 0 8px;font-size:.7rem;color:var(--text-muted);transition:color .2s,background .2s;background:transparent;border-radius:0}
.bottom-nav button:hover{color:var(--primary)}
.bottom-nav button.active{color:var(--primary);background:rgba(45,122,79,.06)}
.bottom-nav button:focus-visible{outline:2px solid var(--primary);outline-offset:-2px}
.bottom-nav button svg{width:24px;height:24px;margin-bottom:3px}
/* Proposal cards */
.proposal-card{cursor:pointer;border-left:4px solid var(--primary);position:relative}
.proposal-card:focus-visible{border-left-color:var(--primary-dark);outline-offset:2px}
.proposal-card h3{font-size:1rem;margin:6px 0;color:var(--text)}
.proposal-card .proposal-amount{font-family:'DM Serif Display',serif;font-size:1.4rem;color:var(--primary);margin-top:10px}
.proposal-card .meta{font-size:.85rem;color:var(--text-muted);display:flex;gap:12px;flex-wrap:wrap;margin-top:4px}
.status-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.03em}
.badge-pending{background:#FEF3C7;color:#92400E}
.badge-sent{background:#DBEAFE;color:#1E40AF}
.badge-accepted{background:#D1FAE5;color:#065F46}
.badge-declined{background:#FEE2E2;color:#991B1B}
/* Energy comparison chart */
.energy-chart{margin:24px 0}
.chart-bars{display:flex;gap:32px;justify-content:center;align-items:flex-end;height:180px;padding:0 20px}
.chart-bar{display:flex;flex-direction:column;align-items:center;flex:1;max-width:130px}
.chart-bar .bar{width:100%;border-radius:8px 8px 0 0;transition:height 1s cubic-bezier(.34,1.56,.64,1);position:relative;min-height:4px}
.chart-bar .bar-current{background:linear-gradient(180deg,#E53E3E,#C53030);box-shadow:0 4px 12px rgba(229,62,62,.25)}
.chart-bar .bar-geo{background:linear-gradient(180deg,var(--primary-light),var(--primary));box-shadow:0 4px 12px rgba(45,122,79,.25)}
.chart-bar .bar-value{position:absolute;top:-32px;left:50%;transform:translateX(-50%);font-weight:700;font-size:1rem;white-space:nowrap;color:var(--text)}
.chart-bar .bar-label{margin-top:10px;font-size:.8rem;color:var(--text-muted);text-align:center;font-weight:500}
.savings-callout{text-align:center;padding:20px;background:linear-gradient(135deg,#F0FFF4,#C6F6D5);border-radius:var(--radius-sm);margin-top:20px;border:1px solid #9AE6B4}
.savings-callout .amount{font-family:'DM Serif Display',serif;font-size:2rem;color:var(--primary);text-shadow:0 2px 4px rgba(45,122,79,.1)}
.savings-callout .label{font-size:.9rem;color:var(--text-muted);margin-top:6px;font-weight:500}
/* Payback timeline */
.payback-row{display:flex;gap:16px;align-items:center;margin:14px 0;padding:10px 0}
.payback-row:not(:last-child){border-bottom:1px solid var(--border)}
.payback-row .number{font-family:'DM Serif Display',serif;font-size:1.6rem;color:var(--primary);min-width:60px;text-align:right}
.payback-row .desc{font-size:.9rem;color:var(--text-muted);line-height:1.4}
/* Photo grid */
.photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:14px 0}
.photo-grid .photo-cell{aspect-ratio:1;border-radius:var(--radius-sm);overflow:hidden;position:relative;background:var(--surface)}
.photo-grid .photo-cell img{width:100%;height:100%;object-fit:cover}
.photo-grid .add-photo{display:flex;align-items:center;justify-content:center;border:2px dashed var(--border);cursor:pointer;transition:border-color .2s,background .2s}
.photo-grid .add-photo:hover{border-color:var(--primary);background:rgba(45,122,79,.04)}
.photo-grid .add-photo:focus-visible{border-color:var(--primary);outline-offset:-2px}
.upsell-card{background:linear-gradient(135deg,var(--surface),#EDE8E0);border:2px dashed #C4B8A8;opacity:.85;text-align:center;padding:28px 24px}
.upsell-card h3{color:var(--text-muted);font-size:1.05rem}
.upsell-badge{display:inline-block;background:var(--primary);color:#fff;font-size:.65rem;padding:4px 10px;border-radius:12px;font-weight:700;margin-left:10px;vertical-align:middle;letter-spacing:.02em}
.back-btn{display:inline-flex;align-items:center;gap:6px;color:var(--text-muted);font-size:.9rem;margin-bottom:14px;cursor:pointer;padding:8px 12px;margin-left:-12px;border-radius:var(--radius-sm);transition:background .2s,color .2s}
.back-btn:hover{color:var(--primary);background:rgba(45,122,79,.06)}
.back-btn:focus-visible{outline:2px solid var(--primary);outline-offset:0}
.camera-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:#000;z-index:10001;display:none}
.camera-overlay video{width:100%;height:100%;object-fit:cover}
.camera-overlay .controls{position:absolute;bottom:50px;left:0;right:0;display:flex;justify-content:center;gap:40px}
.camera-overlay .shutter{width:72px;height:72px;border-radius:50%;background:#fff;border:4px solid rgba(255,255,255,.4);box-shadow:0 4px 20px rgba(0,0,0,.3);transition:transform .15s}
.camera-overlay .shutter:active{transform:scale(.92)}
.camera-overlay .shutter:focus-visible{outline:3px solid var(--primary);outline-offset:4px}
.camera-overlay .close-cam{position:absolute;top:20px;right:20px;color:#fff;background:rgba(0,0,0,.5);width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background .2s}
.camera-overlay .close-cam:hover{background:rgba(0,0,0,.7)}
.camera-overlay .close-cam:focus-visible{outline:2px solid #fff;outline-offset:2px}
.toast-container{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:10000}
.toast{background:var(--secondary);color:#fff;padding:14px 24px;border-radius:var(--radius);font-size:.9rem;box-shadow:var(--shadow-3);animation:toastIn .35s ease-out;margin-bottom:10px;min-width:200px;text-align:center;font-weight:500}
@keyframes toastIn{from{opacity:0;transform:translate(-50%,-15px)}to{opacity:1;transform:translate(-50%,0)}}
/* Empty state */
.empty-state{text-align:center;padding:60px 20px}
.empty-state svg{color:var(--border);transition:color .3s}
.empty-state:hover svg{color:#CBD5E0}
.empty-state h2{margin-top:20px;font-size:1.25rem;color:var(--text)}
.empty-state p{color:var(--text-muted);font-size:.9rem;margin-top:10px;line-height:1.5;max-width:280px;margin-left:auto;margin-right:auto}
/* Section headers in forms */
.card h3{font-size:1rem;margin-bottom:14px;color:var(--secondary);font-weight:600}
/* Status buttons in detail */
.status-btn{padding:8px 16px;border-radius:20px;font-size:.8rem;font-weight:600;border:2px solid var(--border);background:#fff;transition:all .2s}
.status-btn:hover{border-color:var(--primary);color:var(--primary)}
.status-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.status-btn:focus-visible{outline:2px solid var(--primary);outline-offset:2px}
/* Milestone badge for #100 */
.milestone-badge{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#FFD700,#FFA500);color:#744210;padding:4px 12px;border-radius:20px;font-size:.7rem;font-weight:700;letter-spacing:.03em;margin-left:8px;box-shadow:0 2px 8px rgba(255,165,0,.3)}
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:.01ms !important;transition-duration:.01ms !important}}
@media print{.bottom-nav,.fab,.demo-banner,.app-header,#bct-demo-disclaimer{display:none !important}body{padding-bottom:80px;background:#fff;padding:0}.card{box-shadow:none;border:1px solid #ddd;page-break-inside:avoid}.energy-chart{break-inside:avoid}}
</style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to main content</a>
<div id="gate">
  <div>
    <h1>GeoProposal</h1>
    <p>This tool requires a valid access key.</p>
    <p>Contact <a href="mailto:ben@bennycutools.com">ben@bennycutools.com</a> for access</p>
  </div>
</div>
<div id="app">
  <header class="app-header">
    <h1>GeoProposal <span class="milestone-badge" aria-label="100th tool milestone">#100</span></h1>
    <p>Geothermal Professionals, Ltd.</p>
  </header>
  <div class="demo-banner" id="demoBanner" style="display:none" role="status" aria-live="polite">
    <span>Sample data loaded for northeast Ohio. Tap Clear to start fresh.</span>
    <button onclick="clearDemo()" aria-label="Clear demo data">Clear</button>
  </div>
  <main id="main-content">
    <!-- Proposals List -->
    <div class="view active" id="viewProposals">
      <div class="content">
        <div id="proposalsList"></div>
        <div class="card upsell-card" style="--i:5">
          <h3>Full Proposal Package <span class="upsell-badge">Full Version</span></h3>
          <p style="font-size:.85rem;color:var(--text-muted);margin-top:12px;line-height:1.5">Branded PDF with your logo, equipment specs, warranty details, maintenance schedule, and financing options.</p>
        </div>
      </div>
    </div>
    <!-- New/Edit Proposal -->
    <div class="view" id="viewEdit">
      <div class="content">
        <button class="back-btn" onclick="showView('viewProposals')" aria-label="Back to proposals list">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M19 12H5"/><polyline points="12 19 5 12 12 5"/></svg>
          Back
        </button>
        <h2 id="editTitle" style="margin-bottom:18px">New Proposal</h2>
        <div class="card">
          <h3>Homeowner</h3>
          <div class="form-group">
            <label for="pName">Name</label>
            <input type="text" id="pName" placeholder="e.g., Chen family" autocomplete="name">
          </div>
          <div class="form-group">
            <label for="pPhone">Phone</label>
            <input type="tel" id="pPhone" placeholder="(440) 555-0123" autocomplete="tel">
          </div>
          <div class="form-group">
            <label for="pAddr">Property Address</label>
            <input type="text" id="pAddr" placeholder="123 Maple St, Chagrin Falls OH" autocomplete="street-address">
          </div>
        </div>
        <div class="card">
          <h3>Property Details</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
            <div class="form-group" style="margin:0">
              <label for="pSqft">Square Footage</label>
              <input type="number" id="pSqft" placeholder="2400" onchange="calcProposal()">
            </div>
            <div class="form-group" style="margin:0">
              <label for="pInsulation">Insulation Quality</label>
              <select id="pInsulation" onchange="calcProposal()">
                <option value="poor">Poor (pre-1980)</option>
                <option value="average">Average (1980-2005)</option>
                <option value="good" selected>Good (2005+)</option>
                <option value="excellent">Excellent (new build)</option>
              </select>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>System Design</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
            <div class="form-group" style="margin:0">
              <label for="pTonnage">System Size</label>
              <select id="pTonnage" onchange="calcProposal()">
                <option value="2">2 ton</option>
                <option value="3">3 ton</option>
                <option value="4" selected>4 ton</option>
                <option value="5">5 ton</option>
                <option value="6">6 ton</option>
              </select>
            </div>
            <div class="form-group" style="margin:0">
              <label for="pLoop">Loop Type</label>
              <select id="pLoop" onchange="calcProposal()">
                <option value="vertical">Vertical (tight lots)</option>
                <option value="horizontal">Horizontal (open lots)</option>
              </select>
            </div>
          </div>
          <div class="form-group" style="margin-top:16px;margin-bottom:0">
            <label for="pEquip">Equipment</label>
            <select id="pEquip" onchange="calcProposal()">
              <option value="waterfurnace">WaterFurnace 7 Series</option>
              <option value="waterfurnace5">WaterFurnace 5 Series</option>
              <option value="climatemaster">ClimateMaster Trilogy</option>
            </select>
          </div>
        </div>
        <div class="card">
          <h3>Current Energy Costs</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
            <div class="form-group" style="margin:0">
              <label for="pCurrentBill">Avg Monthly Bill ($)</label>
              <input type="number" id="pCurrentBill" placeholder="280" onchange="calcProposal()">
            </div>
            <div class="form-group" style="margin:0">
              <label for="pFuelType">Current Heating</label>
              <select id="pFuelType" onchange="calcProposal()">
                <option value="gas">Natural Gas</option>
                <option value="electric">Electric</option>
                <option value="propane">Propane</option>
                <option value="oil">Heating Oil</option>
              </select>
            </div>
          </div>
        </div>
        <!-- Live calculation results -->
        <div class="card" id="calcResults" style="display:none">
          <h3>Proposal Summary</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
            <div>
              <span style="font-size:.8rem;color:var(--text-muted);font-weight:500">System Cost</span>
              <div style="font-size:1.15rem;font-weight:700;margin-top:2px" id="rCost">$0</div>
            </div>
            <div>
              <span style="font-size:.8rem;color:var(--text-muted);font-weight:500">30% Tax Credit</span>
              <div style="font-size:1.15rem;font-weight:700;color:var(--success);margin-top:2px" id="rCredit">-$0</div>
            </div>
            <div>
              <span style="font-size:.8rem;color:var(--text-muted);font-weight:500">Net Cost</span>
              <div style="font-size:1.15rem;font-weight:700;color:var(--primary);margin-top:2px" id="rNet">$0</div>
            </div>
            <div>
              <span style="font-size:.8rem;color:var(--text-muted);font-weight:500">Payback Period</span>
              <div style="font-size:1.15rem;font-weight:700;margin-top:2px" id="rPayback">-- years</div>
            </div>
          </div>
          <div class="energy-chart">
            <h3 style="font-size:.9rem;text-align:center;margin-bottom:16px;color:var(--text-muted);font-weight:500">Annual Heating & Cooling Cost</h3>
            <div class="chart-bars">
              <div class="chart-bar">
                <div class="bar bar-current" id="barCurrent" style="height:0"><span class="bar-value" id="barCurrentVal">$0</span></div>
                <div class="bar-label">Current System</div>
              </div>
              <div class="chart-bar">
                <div class="bar bar-geo" id="barGeo" style="height:0"><span class="bar-value" id="barGeoVal">$0</span></div>
                <div class="bar-label">Geothermal</div>
              </div>
            </div>
          </div>
          <div class="savings-callout">
            <div class="amount" id="rSavings">$0</div>
            <div class="label">saved per year with geothermal</div>
          </div>
        </div>
        <div class="card">
          <h3>Site Photos</h3>
          <div class="photo-grid" id="pPhotoGrid">
            <div class="photo-cell add-photo" onclick="openCamera()" role="button" tabindex="0" aria-label="Take photo" onkeydown="if(event.key==='Enter'||event.key===' ')openCamera()">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.5" aria-hidden="true">
                <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
                <circle cx="12" cy="13" r="4"/>
              </svg>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="form-group" style="margin:0">
            <label for="pNotes">Notes</label>
            <textarea id="pNotes" rows="3" placeholder="Soil conditions, ductwork notes, special requirements..."></textarea>
          </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:18px">
          <button class="btn btn-primary btn-block" onclick="saveProposal()">Save Proposal</button>
        </div>
        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn btn-outline btn-block" onclick="shareProposal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
              <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
            </svg>
            Share with Homeowner
          </button>
        </div>
      </div>
    </div>
    <!-- Proposal Detail -->
    <div class="view" id="viewDetail">
      <div class="content" id="detailContent"></div>
    </div>
    <!-- Settings -->
    <div class="view" id="viewSettings">
      <div class="content">
        <h2 style="margin-bottom:18px">Settings</h2>
        <div class="card">
          <h3>Data Management</h3>
          <button class="btn btn-outline btn-block" onclick="exportData()" style="margin-bottom:10px">Export All Data (JSON)</button>
          <button class="btn btn-outline btn-block" onclick="document.getElementById('importFile').click()">Import Data (JSON)</button>
          <input type="file" id="importFile" accept=".json" onchange="importData(event)" style="display:none" aria-label="Import JSON file">
        </div>
        <div class="card">
          <button class="btn btn-danger btn-block" onclick="if(confirm('Delete all proposals? This cannot be undone.'))clearAllData()">Delete All Data</button>
        </div>
      </div>
    </div>
  </main>
  <button class="fab" onclick="newProposal()" aria-label="Create new proposal" id="fabBtn">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
      <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
    </svg>
  </button>
  <nav class="bottom-nav" role="navigation" aria-label="Main navigation">
    <button onclick="showView('viewProposals')" class="active" id="navProposals" aria-label="Proposals">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>
      </svg>
      Proposals
    </button>
    <button onclick="showView('viewSettings')" id="navSettings" aria-label="Settings">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
        <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
      </svg>
      Settings
    </button>
  </nav>
  <div class="camera-overlay" id="cameraOverlay" role="dialog" aria-label="Camera" aria-modal="true">
    <video id="cameraVideo" autoplay playsinline></video>
    <button class="close-cam" onclick="closeCamera()" aria-label="Close camera">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
    <div class="controls">
      <button class="shutter" onclick="capturePhoto()" aria-label="Take photo"></button>
    </div>
  </div>
  <canvas id="cameraCanvas" style="display:none" aria-hidden="true"></canvas>
  <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>
</div>
<!-- DEMO DISCLAIMER -->
<div id="bct-demo-disclaimer" role="contentinfo" aria-label="Demo information" style="position:fixed;bottom:0;left:0;right:0;background:linear-gradient(to right,#f8f9fa,#fff);border-top:1px solid #e9ecef;padding:8px 16px;font-size:11px;line-height:1.4;color:#6c757d;z-index:99999;display:flex;align-items:center;justify-content:space-between;gap:12px;min-height:36px;">
<p style="margin:0;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"><strong style="color:#495057;font-weight:600;">Demo:</strong> Created by BennyCuTools for demonstration. Not affiliated with Geothermal Professionals, Ltd.</p>
<div style="display:flex;align-items:center;gap:12px;flex-shrink:0;">
<a href="https://bennycutools.com" target="_blank" rel="noopener" style="color:#6c757d;text-decoration:underline;text-underline-offset:2px;white-space:nowrap;">Learn more</a>
<a href="mailto:cuuper225@gmail.com?subject=Remove%20Demo%3A%20Geothermal%20Professionals%2C%20Ltd.&body=I%20am%20the%20owner%20and%20request%20removal%20of%20this%20demo." style="color:#adb5bd;text-decoration:underline;text-underline-offset:2px;white-space:nowrap;font-size:10px;">Remove</a>
</div>
</div>
<script>
function _h(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return h;}
const _V=-279447735;
const _k=new URLSearchParams(window.location.search).get('key');
if(_k&&_h(_k)===_V){initApp().catch(e => {console.error('initApp failed:', e); const t=document.createElement('div');t.style.cssText='position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#b91c1c;color:#fff;padding:12px 20px;border-radius:8px;z-index:9999';t.textContent='Error loading data. Please refresh.';document.body.appendChild(t);setTimeout(()=>t.remove(),3000);});}else{document.getElementById('gate').style.display='flex';document.getElementById('app').style.display='none';}
document.addEventListener('contextmenu',e=>e.preventDefault());

let db,currentPropId=null,currentPhotos=[],cameraStream=null;

// Pricing tables (realistic 2026 Ohio market)
const PRICING={
  'waterfurnace':{2:16000,3:19500,4:23000,5:27000,6:32000},
  'waterfurnace5':{2:13000,3:16000,4:19000,5:22500,6:27000},
  'climatemaster':{2:14500,3:17500,4:21000,5:25000,6:29500}
};
const LOOP_COST={vertical:{perTon:3500},horizontal:{perTon:2500}};
const LABOR_BASE=4000;
const EFFICIENCY_FACTOR={poor:1.3,average:1.1,good:1.0,excellent:0.9};
const FUEL_COST_PER_YEAR={gas:0.55,electric:0.65,propane:0.75,oil:0.80};
const GEO_SAVINGS_FACTOR=0.55;

function initApp(){
  document.getElementById('gate').style.display='none';
  document.getElementById('app').style.display='block';
  openDB().then(()=>{checkFirstVisit();renderProposals();});
}

function openDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open('GeoProposalDB',1);
    r.onupgradeneeded=e=>{
      const d=e.target.result;
      if(!d.objectStoreNames.contains('proposals'))d.createObjectStore('proposals',{keyPath:'id'});
    };
    r.onsuccess=e=>{db=e.target.result;res();};
    r.onerror=e=>rej(e);
  });
}

function dbPut(s,d){
  return new Promise((res,rej)=>{
    const tx=db.transaction(s,'readwrite');
    tx.objectStore(s).put(d);
    tx.oncomplete=()=>res();
    tx.onerror=e=>rej(e);
  });
}

function dbGetAll(s){
  return new Promise((res,rej)=>{
    const tx=db.transaction(s,'readonly');
    const r=tx.objectStore(s).getAll();
    r.onsuccess=()=>res(r.result);
    r.onerror=e=>rej(e);
  });
}

function dbGet(s,id){
  return new Promise((res,rej)=>{
    const tx=db.transaction(s,'readonly');
    const r=tx.objectStore(s).get(id);
    r.onsuccess=()=>res(r.result);
    r.onerror=e=>rej(e);
  });
}

function dbDelete(s,id){
  return new Promise((res,rej)=>{
    const tx=db.transaction(s,'readwrite');
    tx.objectStore(s).delete(id);
    tx.oncomplete=()=>res();
    tx.onerror=e=>rej(e);
  });
}

function checkFirstVisit(){
  if(!localStorage.getItem('gp_visited')){
    localStorage.setItem('gp_visited','1');
    loadDemoData();
  }
}

function loadDemoData(){
  const demos=[
    {id:'demo-1',isDemo:true,customer:{name:'Chen Residence',phone:'(440) 555-0234',address:'15 Chagrin Blvd, Chagrin Falls OH'},property:{sqft:2400,insulation:'good'},system:{tonnage:4,loop:'vertical',equipment:'waterfurnace'},energy:{currentBill:280,fuelType:'gas'},calc:{systemCost:23000,loopCost:14000,totalCost:41000,taxCredit:12300,netCost:28700,currentAnnual:3360,geoAnnual:1512,annualSavings:1848,paybackYears:15.5},photos:[],notes:'2015 build, good insulation. Lot is 0.3 acres — too narrow for horizontal loops. Existing ductwork in good condition.',status:'pending',created:Date.now()-86400000},
    {id:'demo-2',isDemo:true,customer:{name:'Novak New Build',phone:'(440) 555-0567',address:'Lot 14 Orchard Estates, Chardon OH'},property:{sqft:3200,insulation:'excellent'},system:{tonnage:5,loop:'horizontal',equipment:'waterfurnace'},energy:{currentBill:0,fuelType:'gas'},calc:{systemCost:27000,loopCost:12500,totalCost:43500,taxCredit:13050,netCost:30450,currentAnnual:4200,geoAnnual:1680,annualSavings:2520,paybackYears:12.1},photos:[],notes:'New construction on 2-acre lot. Builder wants geothermal as selling point. Horizontal loops will go in before foundation pour.',status:'accepted',created:Date.now()-604800000},
    {id:'demo-3',isDemo:true,customer:{name:'Petroski Retrofit',phone:'(440) 555-0891',address:'892 State Rd, Middlefield OH'},property:{sqft:1800,insulation:'average'},system:{tonnage:3,loop:'vertical',equipment:'climatemaster'},energy:{currentBill:320,fuelType:'propane'},calc:{systemCost:17500,loopCost:10500,totalCost:32000,taxCredit:9600,netCost:22400,currentAnnual:3840,geoAnnual:1344,annualSavings:2496,paybackYears:9.0},photos:[],notes:'Propane conversion — high current costs make payback fast. 1985 ranch, average insulation. Recommended blown-in attic insulation first.',status:'sent',created:Date.now()-259200000}
  ];
  demos.forEach(d=>dbPut('proposals',d));
  setTimeout(()=>{document.getElementById('demoBanner').style.display='flex';renderProposals();},300);
}

function clearDemo(){
  dbGetAll('proposals').then(p=>Promise.all(p.filter(x=>x.isDemo).map(x=>dbDelete('proposals',x.id)))).then(()=>{
    document.getElementById('demoBanner').style.display='none';
    renderProposals();
    toast('Demo data cleared');
  });
}

function renderProposals(){
  dbGetAll('proposals').then(props=>{
    props.sort((a,b)=>b.created-a.created);
    const el=document.getElementById('proposalsList');
    if(!props.length){
      el.innerHTML=`<div class="empty-state"><svg width="72" height="72" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" aria-hidden="true"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><h2>No proposals yet</h2><p>Tap the + button to create your first geothermal proposal for a homeowner.</p></div>`;
      return;
    }
    el.innerHTML=props.map((p,i)=>{
      const statusLabels={pending:'Pending',sent:'Sent',accepted:'Accepted',declined:'Declined'};
      const badgeClass={pending:'badge-pending',sent:'badge-sent',accepted:'badge-accepted',declined:'badge-declined'};
      const loopLabel={vertical:'Vertical',horizontal:'Horizontal'};
      return`<div class="card proposal-card" style="--i:${i}" onclick="viewProposal('${p.id}')" tabindex="0" role="button" aria-label="View proposal for ${p.customer?.name||'Unnamed'}, ${p.calc?.netCost? '$'+p.calc.netCost.toLocaleString():''}" onkeydown="if(event.key==='Enter'||event.key===' ')viewProposal('${p.id}')">
        <div style="display:flex;justify-content:space-between;align-items:center"><span class="status-badge ${badgeClass[p.status]||''}">${statusLabels[p.status]||p.status}</span><span style="font-size:.8rem;color:var(--text-muted);font-weight:500">${p.system?.tonnage||'?'}-ton ${loopLabel[p.system?.loop]||''}</span></div>
        <h3>${p.customer?.name||'Unnamed'}</h3>
        <div class="meta"><span>${p.customer?.address?.split(',')[0]||''}</span><span>${p.property?.sqft||'?'} sq ft</span></div>
        <div class="proposal-amount">$${(p.calc?.netCost||0).toLocaleString()} <span style="font-size:.75rem;color:var(--success);font-family:'DM Sans',sans-serif;font-weight:600">saves $${(p.calc?.annualSavings||0).toLocaleString()}/yr</span></div>
      </div>`;
    }).join('');
    document.getElementById('demoBanner').style.display=props.some(p=>p.isDemo)?'flex':'none';
  });
}

function showView(id){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.bottom-nav button').forEach(b=>b.classList.remove('active'));
  if(id==='viewProposals')document.getElementById('navProposals').classList.add('active');
  if(id==='viewSettings')document.getElementById('navSettings').classList.add('active');
  document.getElementById('fabBtn').style.display=(id==='viewProposals')?'flex':'none';
  window.scrollTo({top:0,behavior:'smooth'});
}

function newProposal(){
  currentPropId=null;currentPhotos=[];
  document.getElementById('editTitle').textContent='New Proposal';
  ['pName','pPhone','pAddr','pSqft','pCurrentBill','pNotes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('pInsulation').value='good';
  document.getElementById('pTonnage').value='4';
  document.getElementById('pLoop').value='vertical';
  document.getElementById('pEquip').value='waterfurnace';
  document.getElementById('pFuelType').value='gas';
  document.getElementById('calcResults').style.display='none';
  renderPropPhotos();
  showView('viewEdit');
}

function calcProposal(){
  const sqft=parseInt(document.getElementById('pSqft').value)||0;
  const bill=parseInt(document.getElementById('pCurrentBill').value)||0;
  if(!sqft&&!bill)return;
  const insulation=document.getElementById('pInsulation').value;
  const tonnage=parseInt(document.getElementById('pTonnage').value);
  const loop=document.getElementById('pLoop').value;
  const equip=document.getElementById('pEquip').value;
  const fuel=document.getElementById('pFuelType').value;

  const equipCost=PRICING[equip]?.[tonnage]||20000;
  const loopCost=LOOP_COST[loop].perTon*tonnage;
  const totalCost=equipCost+loopCost+LABOR_BASE;
  const taxCredit=Math.round(totalCost*0.30);
  const netCost=totalCost-taxCredit;

  const hvacFraction=FUEL_COST_PER_YEAR[fuel]||0.55;
  const currentAnnual=bill>0?Math.round(bill*12*hvacFraction):Math.round(sqft*1.5*EFFICIENCY_FACTOR[insulation]);
  const geoAnnual=Math.round(currentAnnual*(1-GEO_SAVINGS_FACTOR));
  const annualSavings=currentAnnual-geoAnnual;
  const paybackYears=annualSavings>0?Math.round((netCost/annualSavings)*10)/10:0;

  document.getElementById('calcResults').style.display='block';
  document.getElementById('rCost').textContent='$'+totalCost.toLocaleString();
  document.getElementById('rCredit').textContent='-$'+taxCredit.toLocaleString();
  document.getElementById('rNet').textContent='$'+netCost.toLocaleString();
  document.getElementById('rPayback').textContent=paybackYears+' years';
  document.getElementById('rSavings').textContent='$'+annualSavings.toLocaleString();

  const maxH=150;
  const scale=maxH/Math.max(currentAnnual,geoAnnual,1);
  setTimeout(()=>{
    document.getElementById('barCurrent').style.height=Math.round(currentAnnual*scale)+'px';
    document.getElementById('barGeo').style.height=Math.round(geoAnnual*scale)+'px';
    document.getElementById('barCurrentVal').textContent='$'+currentAnnual.toLocaleString();
    document.getElementById('barGeoVal').textContent='$'+geoAnnual.toLocaleString();
  },50);

  return{systemCost:equipCost,loopCost,totalCost,taxCredit,netCost,currentAnnual,geoAnnual,annualSavings,paybackYears};
}

function saveProposal(){
  const name=document.getElementById('pName').value.trim();
  if(!name){toast('Enter homeowner name');document.getElementById('pName').focus();return;}
  const calc=calcProposal()||{};
  const prop={
    id:currentPropId||'p-'+Date.now(),
    customer:{name,phone:document.getElementById('pPhone').value.trim(),address:document.getElementById('pAddr').value.trim()},
    property:{sqft:parseInt(document.getElementById('pSqft').value)||0,insulation:document.getElementById('pInsulation').value},
    system:{tonnage:parseInt(document.getElementById('pTonnage').value),loop:document.getElementById('pLoop').value,equipment:document.getElementById('pEquip').value},
    energy:{currentBill:parseInt(document.getElementById('pCurrentBill').value)||0,fuelType:document.getElementById('pFuelType').value},
    calc,photos:[...currentPhotos],notes:document.getElementById('pNotes').value.trim(),
    status:currentPropId?undefined:'pending',created:currentPropId?undefined:Date.now()
  };
  if(currentPropId){
    dbGet('proposals',currentPropId).then(ex=>{prop.status=ex?.status||'pending';prop.created=ex?.created||Date.now();return dbPut('proposals',prop);}).then(()=>{toast('Proposal updated');renderProposals();showView('viewProposals');});
  }else{
    dbPut('proposals',prop).then(()=>{toast('Proposal saved');renderProposals();showView('viewProposals');});
  }
}

function viewProposal(id){
  dbGet('proposals',id).then(p=>{
    if(!p)return;
    const c=p.calc||{};
    const statusLabels={pending:'Pending',sent:'Sent',accepted:'Accepted',declined:'Declined'};
    const badgeClass={pending:'badge-pending',sent:'badge-sent',accepted:'badge-accepted',declined:'badge-declined'};
    const equipLabels={waterfurnace:'WaterFurnace 7 Series',waterfurnace5:'WaterFurnace 5 Series',climatemaster:'ClimateMaster Trilogy'};
    const loopLabels={vertical:'Vertical Loops',horizontal:'Horizontal Loops'};
    const fuelLabels={gas:'Natural Gas',electric:'Electric',propane:'Propane',oil:'Heating Oil'};
    const maxH=130;
    const scale=maxH/Math.max(c.currentAnnual||1,c.geoAnnual||1);
    const photosHtml=p.photos?.length?`<div class="photo-grid">${p.photos.map((ph,i)=>`<div class="photo-cell"><img src="${ph}" alt="Site photo ${i+1}"></div>`).join('')}</div>`:'';
    
    document.getElementById('detailContent').innerHTML=`
      <button class="back-btn" onclick="showView('viewProposals')" aria-label="Back to proposals">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M19 12H5"/><polyline points="12 19 5 12 12 5"/></svg>
        Back
      </button>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
          <div>
            <h2 style="font-size:1.25rem">${p.customer?.name}</h2>
            <p style="font-size:.9rem;color:var(--text-muted);margin-top:6px">${p.customer?.address||''}</p>
            <p style="font-size:.85rem;color:var(--text-muted);margin-top:4px">${p.property?.sqft||'?'} sq ft · ${p.system?.tonnage}-ton ${loopLabels[p.system?.loop]||''}</p>
            <p style="font-size:.8rem;color:var(--text-muted);margin-top:2px">${equipLabels[p.system?.equipment]||''} · Currently: ${fuelLabels[p.energy?.fuelType]||''}</p>
          </div>
          <span class="status-badge ${badgeClass[p.status]||''}">${statusLabels[p.status]||''}</span>
        </div>
      </div>
      <div class="card">
        <h3>Update Status</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          ${['pending','sent','accepted','declined'].map(s=>`<button class="status-btn ${p.status===s?'active':''}" onclick="updatePropStatus('${id}','${s}')">${statusLabels[s]}</button>`).join('')}
        </div>
      </div>
      <div class="card">
        <h3>Cost Breakdown</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div><span style="font-size:.8rem;color:var(--text-muted);font-weight:500">Equipment</span><div style="font-weight:600;margin-top:2px">$${(c.systemCost||0).toLocaleString()}</div></div>
          <div><span style="font-size:.8rem;color:var(--text-muted);font-weight:500">Loop Field</span><div style="font-weight:600;margin-top:2px">$${(c.loopCost||0).toLocaleString()}</div></div>
          <div><span style="font-size:.8rem;color:var(--text-muted);font-weight:500">Labor</span><div style="font-weight:600;margin-top:2px">$${LABOR_BASE.toLocaleString()}</div></div>
          <div><span style="font-size:.8rem;color:var(--text-muted);font-weight:500">Total</span><div style="font-weight:700;margin-top:2px">$${(c.totalCost||0).toLocaleString()}</div></div>
        </div>
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
          <div>
            <span style="font-size:.8rem;color:var(--success);font-weight:600">30% Federal Tax Credit</span>
            <div style="font-weight:700;color:var(--success)">-$${(c.taxCredit||0).toLocaleString()}</div>
          </div>
          <div style="text-align:right">
            <span style="font-size:.8rem;color:var(--primary);font-weight:600">Your Net Cost</span>
            <div style="font-family:'DM Serif Display',serif;font-size:1.5rem;color:var(--primary)">$${(c.netCost||0).toLocaleString()}</div>
          </div>
        </div>
      </div>
      <div class="card">
        <h3 style="text-align:center;margin-bottom:16px">Annual Heating & Cooling Cost</h3>
        <div class="chart-bars" style="height:160px">
          <div class="chart-bar">
            <div class="bar bar-current" style="height:${Math.round((c.currentAnnual||0)*scale)}px"><span class="bar-value">$${(c.currentAnnual||0).toLocaleString()}</span></div>
            <div class="bar-label">Current (${fuelLabels[p.energy?.fuelType]||''})</div>
          </div>
          <div class="chart-bar">
            <div class="bar bar-geo" style="height:${Math.round((c.geoAnnual||0)*scale)}px"><span class="bar-value">$${(c.geoAnnual||0).toLocaleString()}</span></div>
            <div class="bar-label">Geothermal</div>
          </div>
        </div>
        <div class="savings-callout">
          <div class="amount">$${(c.annualSavings||0).toLocaleString()}</div>
          <div class="label">saved per year</div>
        </div>
      </div>
      <div class="card">
        <h3>Payback Analysis</h3>
        <div class="payback-row"><div class="number">${c.paybackYears||'--'}</div><div class="desc">years to break even on your investment</div></div>
        <div class="payback-row"><div class="number">25+</div><div class="desc">year expected system lifespan</div></div>
        <div class="payback-row"><div class="number">$${((25-(c.paybackYears||0))*(c.annualSavings||0)).toLocaleString()}</div><div class="desc">total savings over system lifetime after payback</div></div>
      </div>
      ${p.notes?`<div class="card"><h3>Notes</h3><p style="font-size:.9rem;color:var(--text-muted);line-height:1.5">${p.notes}</p></div>`:''}
      ${photosHtml?`<div class="card"><h3>Photos</h3>${photosHtml}</div>`:''}
      <div style="display:flex;gap:10px;margin-top:18px">
        <button class="btn btn-primary" style="flex:1" onclick="editProposal('${id}')">Edit</button>
        <button class="btn btn-outline" style="flex:1" onclick="shareProposalById('${id}')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
          Share
        </button>
      </div>
      <button class="btn btn-danger btn-block" style="margin-top:10px" onclick="deleteProposal('${id}')">Delete</button>`;
    showView('viewDetail');
  });
}

function updatePropStatus(id,status){
  dbGet('proposals',id).then(p=>{p.status=status;return dbPut('proposals',p);}).then(()=>{toast('Status updated');viewProposal(id);renderProposals();});
}

function editProposal(id){
  dbGet('proposals',id).then(p=>{
    if(!p)return;
    currentPropId=id;
    currentPhotos=[...(p.photos||[])];
    document.getElementById('editTitle').textContent='Edit Proposal';
    document.getElementById('pName').value=p.customer?.name||'';
    document.getElementById('pPhone').value=p.customer?.phone||'';
    document.getElementById('pAddr').value=p.customer?.address||'';
    document.getElementById('pSqft').value=p.property?.sqft||'';
    document.getElementById('pInsulation').value=p.property?.insulation||'good';
    document.getElementById('pTonnage').value=p.system?.tonnage||4;
    document.getElementById('pLoop').value=p.system?.loop||'vertical';
    document.getElementById('pEquip').value=p.system?.equipment||'waterfurnace';
    document.getElementById('pCurrentBill').value=p.energy?.currentBill||'';
    document.getElementById('pFuelType').value=p.energy?.fuelType||'gas';
    document.getElementById('pNotes').value=p.notes||'';
    renderPropPhotos();
    calcProposal();
    showView('viewEdit');
  });
}

function deleteProposal(id){
  if(!confirm('Delete this proposal?'))return;
  dbDelete('proposals',id).then(()=>{toast('Proposal deleted');renderProposals();showView('viewProposals');});
}

function shareProposal(){
  const name=document.getElementById('pName').value||'Homeowner';
  const calc=calcProposal();
  if(!calc)return;
  const text=`Geothermal Professionals\nProposal for: ${name}\n\nSystem: ${document.getElementById('pTonnage').value}-ton ${document.getElementById('pLoop').selectedOptions[0]?.text}\nEquipment: ${document.getElementById('pEquip').selectedOptions[0]?.text}\n\nTotal Cost: $${calc.totalCost.toLocaleString()}\n30% Tax Credit: -$${calc.taxCredit.toLocaleString()}\nYour Net Cost: $${calc.netCost.toLocaleString()}\n\nAnnual Savings: $${calc.annualSavings.toLocaleString()}/year\nPayback: ${calc.paybackYears} years\n\nQuestions? Call (440) 543-5740`;
  if(navigator.share){navigator.share({title:'Geothermal Proposal',text}).catch(()=>{});}
  else{navigator.clipboard.writeText(text).then(()=>toast('Copied to clipboard'));}
}

function shareProposalById(id){
  dbGet('proposals',id).then(p=>{
    if(!p)return;
    const c=p.calc||{};
    const text=`Geothermal Professionals\nProposal for: ${p.customer?.name}\n\nSystem: ${p.system?.tonnage}-ton ${p.system?.loop} loops\n\nTotal: $${(c.totalCost||0).toLocaleString()}\nTax Credit: -$${(c.taxCredit||0).toLocaleString()}\nNet Cost: $${(c.netCost||0).toLocaleString()}\n\nAnnual Savings: $${(c.annualSavings||0).toLocaleString()}/yr\nPayback: ${c.paybackYears||'?'} years\n\nCall (440) 543-5740`;
    if(navigator.share){navigator.share({title:'Geothermal Proposal',text}).catch(()=>{});}
    else{navigator.clipboard.writeText(text).then(()=>toast('Copied'));}
  });
}

function openCamera(){
  navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(stream=>{
    cameraStream=stream;
    document.getElementById('cameraVideo').srcObject=stream;
    document.getElementById('cameraOverlay').style.display='block';
    document.querySelector('.shutter').focus();
  }).catch(()=>{
    const inp=document.createElement('input');
    inp.type='file';
    inp.accept='image/*';
    inp.capture='environment';
    inp.onchange=e=>{
      const f=e.target.files[0];
      if(!f)return;
      const r=new FileReader();
      r.onload=ev=>{currentPhotos.push(ev.target.result);renderPropPhotos();};
      r.readAsDataURL(f);
    };
    inp.click();
  });
}

function capturePhoto(){
  const v=document.getElementById('cameraVideo'),c=document.getElementById('cameraCanvas');
  c.width=v.videoWidth;
  c.height=v.videoHeight;
  c.getContext('2d').drawImage(v,0,0);
  currentPhotos.push(c.toDataURL('image/jpeg',0.7));
  renderPropPhotos();
  closeCamera();
  toast('Photo captured');
}

function closeCamera(){
  if(cameraStream){cameraStream.getTracks().forEach(t=>t.stop());cameraStream=null;}
  document.getElementById('cameraOverlay').style.display='none';
}

function renderPropPhotos(){
  const g=document.getElementById('pPhotoGrid');
  g.innerHTML=currentPhotos.map((p,i)=>`<div class="photo-cell"><img src="${p}" alt="Site photo ${i+1}"><button onclick="currentPhotos.splice(${i},1);renderPropPhotos()" style="position:absolute;top:6px;right:6px;background:rgba(0,0,0,.6);color:#fff;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;transition:background .2s" aria-label="Remove photo" onmouseover="this.style.background='rgba(0,0,0,.8)'" onmouseout="this.style.background='rgba(0,0,0,.6)'"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>`).join('')+`<div class="photo-cell add-photo" onclick="openCamera()" role="button" tabindex="0" aria-label="Take photo" onkeydown="if(event.key==='Enter'||event.key===' ')openCamera()"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.5"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg></div>`;
}

function exportData(){
  dbGetAll('proposals').then(d=>{
    const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
    const u=URL.createObjectURL(b);
    const a=document.createElement('a');
    a.href=u;
    a.download='geoproposal-backup.json';
    a.click();
    URL.revokeObjectURL(u);
    toast('Exported successfully');
  });
}

function importData(ev){
  const f=ev.target.files[0];
  if(!f)return;
  const r=new FileReader();
  r.onload=e=>{
    try{
      const d=JSON.parse(e.target.result);
      if(!Array.isArray(d)){toast('Invalid file format');return;}
      Promise.all(d.map(x=>dbPut('proposals',x))).then(()=>{toast('Imported successfully');renderProposals();});
    }catch{toast('Could not read file');}
  };
  r.readAsText(f);
  ev.target.value='';
}

function clearAllData(){
  const tx=db.transaction('proposals','readwrite');
  tx.objectStore('proposals').clear();
  tx.oncomplete=()=>{localStorage.removeItem('gp_visited');toast('All data deleted');renderProposals();};
}

function toast(msg){
  const el=document.createElement('div');
  el.className='toast';
  el.textContent=msg;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(()=>el.remove(),3000);
}
</script>
<script src="https://book.bennycutools.com/tracker.js" async></script>
</body>
</html>