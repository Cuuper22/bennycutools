<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SafeQuote - Texas Safe & Lock</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--navy:#0f1419;--navy-light:#1a2332;--navy-lighter:#242d3d;
--gold:#c9a227;--gold-light:#e0bc4a;--gold-dark:#a88920;--gold-pale:#f5ecd0;
--bg:#f8f7f5;--card:#ffffff;--border:#e8e5e0;--muted:#6b6560;--text:#1a1917;
--success:#1e6b3a;--error:#a82e2e;--info:#2563ab;--warning:#b45309;
--shadow-sm:0 1px 2px rgba(15,20,25,0.04),0 1px 3px rgba(15,20,25,0.02);
--shadow-md:0 4px 6px -1px rgba(15,20,25,0.06),0 2px 4px -2px rgba(15,20,25,0.04);
--shadow-lg:0 10px 15px -3px rgba(15,20,25,0.08),0 4px 6px -4px rgba(15,20,25,0.04);
--shadow-xl:0 20px 25px -5px rgba(15,20,25,0.1),0 8px 10px -6px rgba(15,20,25,0.04);
--radius:12px;--radius-sm:8px;
--font-head:'Oswald',sans-serif;--font-body:'Source Sans 3',sans-serif;
--focus-ring:0 0 0 3px rgba(201,162,39,0.25);
}
html{font-size:16px;-webkit-text-size-adjust:100%;scroll-behavior:smooth}
body{font-family:var(--font-body);background:var(--bg);color:var(--text);line-height:1.55;padding-bottom:140px!important;min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
a{color:var(--info);text-decoration:none;transition:color 0.15s}
a:hover{color:var(--gold-dark)}
h1,h2,h3{font-family:var(--font-head);font-weight:600;line-height:1.25;letter-spacing:0.01em}
h1{font-size:1.75rem;font-weight:700}h2{font-size:1.35rem}h3{font-size:1.1rem}
button,input,select,textarea{font-family:var(--font-body);font-size:16px}
*:focus-visible{outline:2px solid var(--gold);outline-offset:2px;box-shadow:var(--focus-ring)}
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:0.01ms!important;transition-duration:0.01ms!important}}

/* Skip Link */
.skip-link{position:absolute;top:-100px;left:16px;background:var(--navy);color:#fff;padding:10px 18px;border-radius:var(--radius-sm);z-index:100000;font-size:14px;font-weight:600;text-decoration:none;box-shadow:var(--shadow-lg);transition:top 0.2s}
.skip-link:focus{top:12px}

/* Loading State */
.loading-skeleton{background:linear-gradient(90deg,var(--border) 25%,#f0ede8 50%,var(--border) 75%);background-size:200% 100%;animation:skeleton 1.5s ease-in-out infinite;border-radius:var(--radius-sm)}
@keyframes skeleton{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* App Shell */
#app{display:none;max-width:480px;margin:0 auto;position:relative}
@media(min-width:1024px){#app{max-width:960px}}

/* Header */
.app-header{background:var(--navy);color:#fff;padding:16px 20px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:100;box-shadow:var(--shadow-md)}
.app-header h1{color:#fff;font-size:1.3rem;flex:1;font-weight:600}
.header-badge{background:var(--gold);color:var(--navy);font-size:11px;font-weight:700;padding:4px 10px;border-radius:20px;font-family:var(--font-head);letter-spacing:0.08em;text-transform:uppercase}

/* Demo Banner */
.demo-banner{background:var(--gold-pale);border-bottom:1px solid #e8dcb8;padding:12px 16px;display:flex;align-items:center;gap:10px;font-size:13px;color:#5c4d1f}
.demo-banner button{background:none;border:none;color:var(--gold-dark);cursor:pointer;font-weight:700;padding:6px 12px;margin-left:auto;flex-shrink:0;border-radius:var(--radius-sm);transition:background 0.15s}
.demo-banner button:hover{background:rgba(201,162,39,0.15)}
.demo-banner button:active{transform:scale(0.96)}
.demo-banner button:focus-visible{outline:2px solid var(--gold-dark);outline-offset:0}

/* Tabs */
.tab-content{padding:20px 16px;display:none;animation:fadeUp 0.35s ease-out}
.tab-content.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

/* Section Headings */
.section-header{margin-bottom:16px}
.section-header h2{font-size:1.25rem;color:var(--text);font-weight:600}
.section-header p{font-size:14px;color:var(--muted);margin-top:4px}

/* Bottom Nav */
.bottom-nav{position:fixed;bottom:48px;left:0;right:0;background:var(--card);border-top:1px solid var(--border);display:flex;z-index:90;padding:6px 8px 10px;box-shadow:0 -4px 12px rgba(15,20,25,0.04)}
.bottom-nav button{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 4px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:11px;font-family:var(--font-body);transition:all 0.15s;border-radius:var(--radius-sm);font-weight:500}
.bottom-nav button.active{color:var(--gold-dark);background:rgba(201,162,39,0.08)}
.bottom-nav button svg{width:22px;height:22px;transition:transform 0.15s}
.bottom-nav button:hover:not(.active){color:var(--text);background:rgba(15,20,25,0.03)}
.bottom-nav button:active{transform:scale(0.96)}
.bottom-nav button:focus-visible{outline:2px solid var(--gold);outline-offset:-2px}
@media(min-width:1024px){.bottom-nav{position:relative;bottom:auto;max-width:960px;margin:0 auto;border-top:none;border-bottom:1px solid var(--border);padding:8px;box-shadow:none}.bottom-nav button{flex-direction:row;gap:8px;padding:10px 16px;font-size:13px}}

/* Cards */
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow-sm);border:1px solid var(--border);margin-bottom:12px;overflow:hidden;transition:box-shadow 0.2s,transform 0.15s}
.card:hover{box-shadow:var(--shadow-md)}
.card-body{padding:18px}

/* Buttons */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border:none;border-radius:var(--radius-sm);font-weight:600;font-size:15px;cursor:pointer;transition:all 0.15s;position:relative;overflow:hidden}
.btn::before{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,0.1),transparent);opacity:0;transition:opacity 0.15s}
.btn:hover::before{opacity:1}
.btn:active{transform:scale(0.97)}
.btn:focus-visible{outline:2px solid var(--gold);outline-offset:2px;box-shadow:var(--focus-ring)}
.btn-primary{background:var(--gold);color:var(--navy)}
.btn-primary:hover{background:var(--gold-light);box-shadow:var(--shadow-md)}
.btn-navy{background:var(--navy);color:#fff}
.btn-navy:hover{background:var(--navy-light);box-shadow:var(--shadow-md)}
.btn-outline{background:transparent;border:2px solid var(--border);color:var(--text)}
.btn-outline:hover{border-color:var(--gold);color:var(--gold-dark);background:rgba(201,162,39,0.04)}
.btn-danger{background:var(--error);color:#fff}
.btn-danger:hover{background:#8b2626}
.btn-block{width:100%;justify-content:center}
.btn-sm{padding:8px 14px;font-size:13px}
.btn svg{width:18px;height:18px;flex-shrink:0}
.btn:disabled{opacity:0.5;cursor:not-allowed}

/* FAB */
.fab{position:fixed;bottom:130px;right:20px;width:60px;height:60px;border-radius:50%;background:var(--gold);color:var(--navy);border:none;box-shadow:var(--shadow-xl);cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:80;transition:all 0.2s cubic-bezier(0.34,1.56,0.64,1)}
.fab:hover{transform:scale(1.08) rotate(90deg);box-shadow:0 20px 40px rgba(201,162,39,0.35)}
.fab:active{transform:scale(0.95)}
.fab svg{width:28px;height:28px;transition:transform 0.2s}
.fab:focus-visible{outline:3px solid var(--gold-dark);outline-offset:4px}

/* Form */
.form-group{margin-bottom:18px}
.form-group label{display:block;font-size:12px;font-weight:700;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.06em}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:12px 14px;border:1.5px solid var(--border);border-radius:var(--radius-sm);background:var(--card);color:var(--text);font-size:16px;transition:all 0.15s}
.form-group input:hover,.form-group select:hover,.form-group textarea:hover{border-color:#d0ccc4}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--gold);box-shadow:var(--focus-ring)}
.form-group textarea{resize:vertical;min-height:90px;line-height:1.5}
.form-group select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b6560' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:40px}
.form-group input::placeholder,.form-group textarea::placeholder{color:#a8a39c}
.form-group .input-hint{font-size:12px;color:var(--muted);margin-top:6px}

/* Survey Item */
.survey-item{display:flex;gap:14px;align-items:flex-start;padding:16px;border-bottom:1px solid var(--border);animation:fadeUp 0.3s ease-out}
.survey-item:last-child{border-bottom:none}
.survey-item:hover{background:rgba(201,162,39,0.02)}
.survey-thumb{width:60px;height:60px;border-radius:var(--radius-sm);background:var(--bg);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;border:1px solid var(--border)}
.survey-thumb img{width:100%;height:100%;object-fit:cover}
.survey-thumb svg{width:24px;height:24px;color:var(--muted)}
.survey-info{flex:1;min-width:0}
.survey-info h3{font-size:15px;margin-bottom:3px;font-weight:600;color:var(--text)}
.survey-info p{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.survey-price{font-weight:700;color:var(--gold-dark);font-size:16px;white-space:nowrap;font-family:var(--font-head)}
.survey-actions{display:flex;gap:6px;margin-top:6px}
.survey-actions button{background:none;border:none;cursor:pointer;padding:6px;border-radius:var(--radius-sm);color:var(--muted);transition:all 0.15s}
.survey-actions button:hover{color:var(--text);background:rgba(15,20,25,0.05)}
.survey-actions button:active{transform:scale(0.9)}
.survey-actions button:focus-visible{outline:2px solid var(--gold);outline-offset:0}

/* Quote Summary */
.quote-summary{background:var(--navy);color:#fff;border-radius:var(--radius);padding:24px;margin-bottom:16px;box-shadow:var(--shadow-lg)}
.quote-summary .total-label{font-size:12px;color:rgba(255,255,255,0.55);text-transform:uppercase;letter-spacing:0.08em;font-family:var(--font-head);font-weight:600}
.quote-summary .total-amount{font-size:2.25rem;font-weight:700;font-family:var(--font-head);color:var(--gold);margin-top:6px}
.quote-summary .items-count{font-size:13px;color:rgba(255,255,255,0.45);margin-top:6px}

/* Status badges */
.badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.04em}
.badge-sent{background:rgba(37,99,171,0.12);color:var(--info)}
.badge-approved{background:rgba(30,107,58,0.12);color:var(--success)}
.badge-pending{background:rgba(201,162,39,0.15);color:var(--gold-dark)}
.badge-declined{background:rgba(168,46,46,0.12);color:var(--error)}

/* Catalog Item */
.catalog-item{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border);transition:background 0.15s}
.catalog-item:last-child{border-bottom:none}
.catalog-item:hover{background:rgba(15,20,25,0.02)}
.catalog-name{font-weight:600;font-size:14px;color:var(--text)}
.catalog-cat{font-size:12px;color:var(--muted);margin-top:2px}
.catalog-price{font-weight:700;color:var(--gold-dark);font-size:15px;font-family:var(--font-head)}

/* Toast */
.toast-container{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:10000;pointer-events:none;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--navy);color:#fff;padding:12px 24px;border-radius:var(--radius);font-size:14px;font-weight:500;box-shadow:var(--shadow-xl);animation:toastIn 0.3s ease-out;pointer-events:auto;max-width:90vw}
@keyframes toastIn{from{opacity:0;transform:translate(-50%,-12px)}to{opacity:1;transform:translate(-50%,0)}}
.toast.success{background:var(--success)}
.toast.error{background:var(--error)}

/* Modal */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(15,20,25,0.65);backdrop-filter:blur(4px);z-index:200;display:none;align-items:flex-end;justify-content:center;opacity:0;transition:opacity 0.2s}
.modal-overlay.show{display:flex;opacity:1}
.modal{background:var(--card);border-radius:var(--radius) var(--radius) 0 0;width:100%;max-width:480px;max-height:92vh;overflow-y:auto;padding:28px 24px 32px;animation:slideUp 0.35s cubic-bezier(0.34,1.56,0.64,1);box-shadow:var(--shadow-xl)}
@media(min-width:640px){.modal{border-radius:var(--radius);margin:20px;max-height:calc(100vh - 40px);animation:fadeIn 0.25s ease-out}}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0;transform:scale(0.96)}to{opacity:1;transform:scale(1)}}
.modal h2{margin-bottom:20px;font-size:1.4rem}
.modal-close{position:absolute;top:16px;right:16px;background:none;border:none;cursor:pointer;padding:10px;border-radius:var(--radius-sm);color:var(--muted);transition:all 0.15s}
.modal-close:hover{background:rgba(15,20,25,0.05);color:var(--text)}
.modal-close:focus-visible{outline:2px solid var(--gold);outline-offset:0}

/* Camera */
.camera-container{position:relative;width:100%;aspect-ratio:4/3;background:var(--navy);border-radius:var(--radius);overflow:hidden;margin-bottom:16px;box-shadow:var(--shadow-lg)}
.camera-container video{width:100%;height:100%;object-fit:cover}
.camera-container canvas{display:none}
.camera-btn{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);width:64px;height:64px;border-radius:50%;background:rgba(255,255,255,0.95);border:4px solid var(--gold);cursor:pointer;transition:all 0.15s;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
.camera-btn:hover{transform:translateX(-50%) scale(1.05);background:#fff}
.camera-btn:active{transform:translateX(-50%) scale(0.95)}
.camera-btn::after{content:'';display:block;width:52px;height:52px;border-radius:50%;background:var(--gold);margin:2px auto;transition:transform 0.15s}
.camera-btn:active::after{transform:scale(0.9)}
.camera-hint{position:absolute;top:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.6);color:#fff;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:500}

/* Upsell */
.upsell-lock{position:relative;opacity:0.65;pointer-events:none}
.upsell-label{position:absolute;top:12px;right:12px;background:var(--navy);color:var(--gold);font-size:10px;font-weight:700;padding:4px 10px;border-radius:12px;z-index:5;text-transform:uppercase;letter-spacing:0.06em}

/* Empty States */
.empty-state{text-align:center;padding:56px 24px;animation:fadeUp 0.4s ease-out}
.empty-state svg{color:var(--border);margin-bottom:20px}
.empty-state h2{font-size:1.25rem;color:var(--text);margin-bottom:8px;font-weight:600}
.empty-state p{color:var(--muted);margin-bottom:28px;font-size:15px;line-height:1.6;max-width:320px;margin-left:auto;margin-right:auto}
.empty-state .btn{min-width:200px}

/* Animations */
.stagger-1{animation-delay:0.05s}.stagger-2{animation-delay:0.1s}.stagger-3{animation-delay:0.15s}.stagger-4{animation-delay:0.2s}

/* Print Styles for Quote */
@media print{
@page{margin:0.5in}
.bottom-nav,.fab,.demo-banner,.app-header,.toast-container,.modal-overlay,#bct-demo-disclaimer{display:none!important}
body{background:#fff;padding:0;font-size:11pt;line-height:1.4}
#app{max-width:100%;padding:0}
.card{box-shadow:none;border:1px solid #ddd;break-inside:avoid;margin-bottom:16px}
.tab-content{display:block!important;padding:0}
.quote-summary{background:#1a1a2e!important;color:#fff!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
.quote-summary .total-amount{color:#c9a227!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
.survey-item{border-bottom:1px solid #ddd;padding:12px 0}
.badge{border:1px solid currentColor}
h1{font-size:18pt}h2{font-size:14pt}
}

/* Error States */
.input-error{border-color:var(--error)!important;box-shadow:0 0 0 3px rgba(168,46,46,0.15)!important}
.error-message{color:var(--error);font-size:13px;margin-top:6px;font-weight:500}

/* Scrollbar */
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:var(--muted)}

/* Selection */
::selection{background:rgba(201,162,39,0.3);color:var(--text)}
</style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to main content</a>

<div id="gate" style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:var(--font-body);background:var(--navy);color:#fff;text-align:center;padding:20px">
<div style="max-width:340px">
<div style="width:80px;height:80px;margin:0 auto 24px;background:var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center">
<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--navy)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
</div>
<h1 style="font-family:var(--font-head);font-size:2rem;margin-bottom:12px;color:#fff;font-weight:700">SafeQuote</h1>
<p style="color:rgba(255,255,255,0.55);margin-bottom:32px;font-size:16px">Built for Texas Safe & Lock</p>
<form id="gate-form" style="text-align:left">
<div class="form-group" style="margin-bottom:16px">
<label for="gate-key" style="color:rgba(255,255,255,0.7)">Access Key</label>
<input type="text" id="gate-key" placeholder="Enter your key" aria-label="Access key" style="width:100%;padding:14px;border:1.5px solid rgba(255,255,255,0.2);border-radius:var(--radius-sm);background:rgba(255,255,255,0.08);color:#fff;font-size:16px;text-align:center;transition:all 0.15s">
</div>
<button type="submit" style="width:100%;padding:14px;background:var(--gold);color:var(--navy);border:none;border-radius:var(--radius-sm);font-weight:700;font-size:16px;cursor:pointer;font-family:var(--font-head);letter-spacing:0.02em;transition:all 0.15s">Unlock Tool</button>
</form>
<p style="margin-top:28px;font-size:13px;color:rgba(255,255,255,0.35)">Questions? <a href="mailto:ben@bennycutools.com" style="color:rgba(255,255,255,0.55);text-decoration:underline">ben@bennycutools.com</a></p>
</div>
</div>

<div id="app">
<header class="app-header" role="banner">
<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
<h1>SafeQuote</h1>
<span class="header-badge">Field Tool</span>
</header>

<div id="demoBanner" class="demo-banner" role="status" aria-live="polite">
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
<span>Demo data loaded for Plano, TX. Clear to start fresh.</span>
<button onclick="clearDemoData()" aria-label="Clear all demo data">Clear Demo</button>
</div>

<main id="main-content">
<!-- Tab: Active Survey -->
<section id="tab-survey" class="tab-content active" role="tabpanel" aria-label="Active Survey">
<div id="surveyEmpty" class="empty-state" style="display:none">
<svg width="72" height="72" viewBox="0 0 24 24" fill="none" stroke="var(--border)" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="18" rx="2"/><line x1="2" y1="8" x2="22" y2="8"/><line x1="8" y1="3" x2="8" y2="8"/><circle cx="12" cy="15" r="2"/><path d="M12 13v-1"/></svg>
<h2>Start a New Survey</h2>
<p>Walk the site, snap photos of each door and lock, and walk out with a complete quote ready to send.</p>
<button class="btn btn-primary btn-block" onclick="startNewSurvey()">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
Start Site Survey
</button>
</div>

<div id="surveyActive" style="display:none">
<div id="surveyHeader" class="card" style="margin-bottom:12px">
<div class="card-body" style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px">
<div style="min-width:0">
<h2 id="surveyTitle" style="font-size:1.15rem;font-weight:600;margin-bottom:4px">Site Survey</h2>
<p id="surveyLocation" style="font-size:13px;color:var(--muted);line-height:1.5"></p>
</div>
<span id="surveyItemCount" class="badge badge-pending">0 items</span>
</div>
</div>

<div id="surveyItems" class="card"></div>

<div id="surveyTotals" class="quote-summary" style="margin-top:16px">
<div class="total-label">Quote Estimate</div>
<div class="total-amount" id="surveyTotal">$0</div>
<div class="items-count" id="surveyItemsLabel">0 line items</div>
</div>

<div style="display:flex;gap:10px;margin-top:16px">
<button class="btn btn-navy btn-block" onclick="generateQuote()" style="flex:2">
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
Generate Quote
</button>
<button class="btn btn-outline" onclick="editSurveyDetails()" aria-label="Edit survey details" style="padding:12px 16px">
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
</button>
</div>
</div>
</section>

<!-- Tab: Quotes History -->
<section id="tab-quotes" class="tab-content" role="tabpanel" aria-label="Quote History">
<div class="section-header">
<h2>Quote History</h2>
<p>Quotes you have generated and sent to clients</p>
</div>
<div id="quotesEmpty" class="empty-state" style="display:none;padding:40px 24px">
<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--border)" stroke-width="1"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
<h2 style="font-size:1.15rem">No Quotes Yet</h2>
<p>Completed site surveys appear here as quotes you can share with clients.</p>
</div>
<div id="quotesList"></div>
</section>

<!-- Tab: Price Catalog -->
<section id="tab-catalog" class="tab-content" role="tabpanel" aria-label="Price Catalog">
<div class="section-header" style="display:flex;justify-content:space-between;align-items:center;gap:16px">
<div>
<h2>Service Catalog</h2>
<p>Your standard services and pricing</p>
</div>
<button class="btn btn-sm btn-outline" onclick="showAddCatalogItem()">
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
Add Service
</button>
</div>
<div id="catalogList" class="card"></div>
</section>

<!-- Tab: Reports (Upsell) -->
<section id="tab-reports" class="tab-content" role="tabpanel" aria-label="Reports">
<div class="upsell-lock">
<span class="upsell-label">Full Version</span>
<div class="empty-state" style="padding:48px 24px">
<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--border)" stroke-width="1"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
<h2>Monthly Reports</h2>
<p>Track close rates, average quote size, and revenue trends. See which services bring in the most work.</p>
<div style="background:var(--bg);border-radius:var(--radius);padding:24px;text-align:left;margin-top:8px">
<p style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.04em">Full version includes:</p>
<ul style="list-style:none;font-size:14px;color:var(--muted);line-height:2">
<li style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Monthly revenue summaries</li>
<li style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Quote-to-close tracking</li>
<li style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Service breakdown by category</li>
<li style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Follow-up reminders</li>
</ul>
<p style="margin-top:16px;text-align:center"><a href="mailto:ben@bennycutools.com?subject=SafeQuote%20Full%20Version" style="color:var(--gold-dark);font-weight:700;font-size:14px">Get the full version — $200 one-time</a></p>
</div>
</div>
</div>
</section>
</main>

<!-- FAB for adding survey item -->
<button id="addItemFab" class="fab" onclick="showAddItemModal()" aria-label="Add item to survey" style="display:none">
<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
</button>

<!-- Bottom Nav -->
<nav class="bottom-nav" role="navigation" aria-label="Main navigation">
<button class="active" onclick="switchTab('survey')" aria-label="Survey" data-tab="survey" aria-current="page">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="3" x2="9" y2="9"/></svg>
Survey
</button>
<button onclick="switchTab('quotes')" aria-label="Quotes" data-tab="quotes">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
Quotes
</button>
<button onclick="switchTab('catalog')" aria-label="Catalog" data-tab="catalog">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
Catalog
</button>
<button onclick="switchTab('reports')" aria-label="Reports" data-tab="reports">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
Reports
</button>
</nav>

<!-- Add Item Modal -->
<div id="addItemModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="addItemTitle">
<div class="modal" style="position:relative">
<button class="modal-close" onclick="closeModal('addItemModal')" aria-label="Close dialog">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
</button>
<h2 id="addItemTitle">Add Survey Item</h2>
<div class="form-group">
<label for="itemLocation">Location / Door ID <span aria-label="required">*</span></label>
<input type="text" id="itemLocation" placeholder="e.g. Floor 2, Room 204" aria-required="true">
</div>
<div class="form-group">
<label for="itemService">Service <span aria-label="required">*</span></label>
<select id="itemService" onchange="updateItemPrice()">
<option value="">Choose a service...</option>
</select>
</div>
<div class="form-group">
<label for="itemPrice">Price ($) <span aria-label="required">*</span></label>
<input type="number" id="itemPrice" step="0.01" min="0" placeholder="0.00" aria-required="true">
</div>
<div class="form-group">
<label for="itemNotes">Notes</label>
<textarea id="itemNotes" placeholder="Condition, brand, special requirements..." rows="3"></textarea>
</div>
<div id="itemPhotoArea">
<label style="display:block;font-size:12px;font-weight:700;color:var(--muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.06em">Photo</label>
<div id="photoPreview" style="display:none;margin-bottom:16px;border-radius:var(--radius);overflow:hidden;border:1px solid var(--border)">
<img id="photoPreviewImg" style="width:100%;max-height:200px;object-fit:cover;display:block" alt="Photo preview of survey item">
</div>
<div style="display:flex;gap:10px">
<button type="button" class="btn btn-outline btn-block" onclick="openCamera()" id="cameraBtn">
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
Take Photo
</button>
<button type="button" class="btn btn-outline" onclick="uploadPhoto()" aria-label="Upload photo from device" style="padding:12px 16px">
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
</button>
</div>
<input type="file" id="photoFileInput" accept="image/*" style="display:none" onchange="handlePhotoFile(event)" aria-label="Upload photo">
</div>
<button class="btn btn-primary btn-block" style="margin-top:24px" onclick="saveItem()">
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
Save Item
</button>
</div>
</div>

<!-- New Survey Modal -->
<div id="newSurveyModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="newSurveyTitle">
<div class="modal" style="position:relative">
<button class="modal-close" onclick="closeModal('newSurveyModal')" aria-label="Close dialog">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
</button>
<h2 id="newSurveyTitle">Start New Survey</h2>
<div class="form-group">
<label for="surveyNameInput">Job Name <span aria-label="required">*</span></label>
<input type="text" id="surveyNameInput" placeholder="e.g. Parkway Office Building" aria-required="true">
</div>
<div class="form-group">
<label for="surveyAddr">Address</label>
<input type="text" id="surveyAddr" placeholder="e.g. 4500 W Plano Pkwy, Plano TX">
</div>
<div class="form-group">
<label for="surveyClientName">Client Name</label>
<input type="text" id="surveyClientName" placeholder="e.g. ABC Property Management">
</div>
<button class="btn btn-primary btn-block" style="margin-top:24px" onclick="createSurvey()">
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
Start Survey
</button>
</div>
</div>

<!-- Camera Modal -->
<div id="cameraModal" class="modal-overlay" role="dialog" aria-modal="true" aria-label="Take photo">
<div class="modal" style="position:relative;padding:16px">
<button class="modal-close" onclick="closeCamera()" aria-label="Close camera" style="z-index:10;background:rgba(0,0,0,0.5);border-radius:50%;color:#fff">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
</button>
<div class="camera-container">
<video id="cameraVideo" autoplay playsinline aria-label="Camera preview"></video>
<canvas id="cameraCanvas"></canvas>
<div class="camera-hint">Tap button to capture</div>
<button class="camera-btn" onclick="capturePhoto()" aria-label="Capture photo"></button>
</div>
</div>
</div>

<!-- Add Catalog Modal -->
<div id="catalogModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="catalogTitle">
<div class="modal" style="position:relative">
<button class="modal-close" onclick="closeModal('catalogModal')" aria-label="Close dialog">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
</button>
<h2 id="catalogTitle">Add Service to Catalog</h2>
<div class="form-group">
<label for="catName">Service Name <span aria-label="required">*</span></label>
<input type="text" id="catName" placeholder="e.g. Medeco Deadbolt Installation" aria-required="true">
</div>
<div class="form-group">
<label for="catCategory">Category</label>
<select id="catCategory">
<option value="Residential">Residential</option>
<option value="Commercial">Commercial</option>
<option value="Safe">Safe</option>
<option value="Automotive">Automotive</option>
<option value="Access Control">Access Control</option>
<option value="Door/Frame">Door & Frame</option>
</select>
</div>
<div class="form-group">
<label for="catPrice">Default Price ($) <span aria-label="required">*</span></label>
<input type="number" id="catPrice" step="0.01" min="0" placeholder="0.00" aria-required="true">
</div>
<button class="btn btn-primary btn-block" style="margin-top:24px" onclick="saveCatalogItem()">Save Service</button>
</div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>
</div>

<!-- DEMO DISCLAIMER - Legal Notice -->
<div id="bct-demo-disclaimer" role="contentinfo" aria-label="Demo disclaimer" style="position:fixed;bottom:0;left:0;right:0;background:#f8f8f8;border-top:1px solid #ddd;padding:10px 16px;font-size:12px;line-height:1.4;color:#666;z-index:99999;display:flex;flex-wrap:wrap;align-items:center;justify-content:center;gap:8px 16px;text-align:center;">
<p style="margin:0;max-width:700px;"><strong style="color:#333;">DEMO NOTICE:</strong> This tool was created by BennyCuTools as a free demonstration only. It is not affiliated with, endorsed by, or authorized by Texas Safe & Lock Corporation. All brand references are used solely for demonstration purposes.</p>
<a href="mailto:cuuper225@gmail.com?subject=Delete%20Demo%3A%20Texas%20Safe%20%26%20Lock&body=I%20am%20the%20owner%20and%20I%20request%20permanent%20deletion%20of%20this%20demo." style="display:inline-flex;align-items:center;gap:4px;background:#dc3545;color:#fff;padding:5px 12px;border-radius:4px;text-decoration:none;font-size:11px;font-weight:500;white-space:nowrap;">
<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
Request Permanent Deletion
</a>
</div>

<script>
// === AUTH ===
function _h(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return h;}
const _V=2069060520;

(function init(){
const k=new URLSearchParams(window.location.search).get('key');
if(k&&_h(k)===_V){auth();return;}
document.getElementById('gate').style.display='flex';
document.getElementById('app').style.display='none';
document.getElementById('gate-form').addEventListener('submit',function(e){
e.preventDefault();
const v=document.getElementById('gate-key').value.trim();
if(_h(v)===_V){auth();}else{
document.getElementById('gate-key').style.borderColor='#a82e2e';
document.getElementById('gate-key').classList.add('input-error');
showToast('Invalid access key','error');
}
});
})();

function auth(){
document.getElementById('gate').style.display='none';
document.getElementById('app').style.display='block';
document.addEventListener('contextmenu',e=>e.preventDefault());
initApp();
}

// === DB ===
let db;
const DB_NAME='safequote_db';
const DB_VER=1;

function openDB(){
return new Promise((resolve,reject)=>{
const req=indexedDB.open(DB_NAME,DB_VER);
req.onupgradeneeded=e=>{
const d=e.target.result;
if(!d.objectStoreNames.contains('surveys'))d.createObjectStore('surveys',{keyPath:'id'});
if(!d.objectStoreNames.contains('items'))d.createObjectStore('items',{keyPath:'id'});
if(!d.objectStoreNames.contains('quotes'))d.createObjectStore('quotes',{keyPath:'id'});
if(!d.objectStoreNames.contains('catalog'))d.createObjectStore('catalog',{keyPath:'id'});
};
req.onsuccess=e=>{db=e.target.result;resolve(db);};
req.onerror=e=>reject(e);
});
}

function dbPut(store,data){
return new Promise((r,j)=>{const t=db.transaction(store,'readwrite');t.objectStore(store).put(data);t.oncomplete=()=>r();t.onerror=e=>j(e);});
}
function dbGetAll(store){
return new Promise((r,j)=>{const t=db.transaction(store,'readonly');const req=t.objectStore(store).getAll();req.onsuccess=()=>r(req.result);req.onerror=e=>j(e);});
}
function dbDelete(store,id){
return new Promise((r,j)=>{const t=db.transaction(store,'readwrite');t.objectStore(store).delete(id);t.oncomplete=()=>r();t.onerror=e=>j(e);});
}
function dbClear(store){
return new Promise((r,j)=>{const t=db.transaction(store,'readwrite');t.objectStore(store).clear();t.oncomplete=()=>r();t.onerror=e=>j(e);});
}

// === STATE ===
let currentSurvey=null;
let surveyItems=[];
let catalogItems=[];
let quotes=[];
let currentPhoto=null;
let editingItemId=null;
let cameraStream=null;

// === INIT ===
async function initApp(){
await openDB();
const isFirst=!localStorage.getItem('sq_visited');
if(isFirst){
await loadDemoData();
localStorage.setItem('sq_visited','1');
}
await refreshAll();
}

async function loadDemoData(){
const demoSurvey={id:'demo-survey-1',name:'Parkway Office Complex',address:'4500 W Plano Pkwy, Plano TX',client:'Meridian Property Management',createdAt:new Date(Date.now()-3600000).toISOString(),status:'active',isDemo:true};
await dbPut('surveys',demoSurvey);

const demoItems=[
{id:'demo-item-1',surveyId:'demo-survey-1',location:'Floor 1 - Main Entrance',service:'Commercial Panic Bar Install',price:485,notes:'Current bar is rusted, not code compliant. Replace with Von Duprin 99.',photo:null,isDemo:true},
{id:'demo-item-2',surveyId:'demo-survey-1',location:'Floor 1 - Suite 101',service:'Rekey - Standard Deadbolt',price:85,notes:'Tenant moved out Jan 15. Schlage B560N.',photo:null,isDemo:true},
{id:'demo-item-3',surveyId:'demo-survey-1',location:'Floor 2 - Conference Room',service:'PDK Reader Install',price:650,notes:'Client wants cloud-based access. Run conduit from ceiling.',photo:null,isDemo:true},
{id:'demo-item-4',surveyId:'demo-survey-1',location:'Floor 2 - Server Room',service:'High Security Medeco Deadbolt',price:375,notes:'Restricted keyway. Keyed different from suite master.',photo:null,isDemo:true},
{id:'demo-item-5',surveyId:'demo-survey-1',location:'Floor 3 - Suite 302',service:'Door Closer Replacement',price:225,notes:'LCN 4040XP. Current one leaks oil, door slams.',photo:null,isDemo:true},
];
for(const item of demoItems)await dbPut('items',item);

const demoCatalog=[
{id:'cat-1',name:'Rekey - Standard Deadbolt',category:'Residential',price:85,isDemo:true},
{id:'cat-2',name:'Rekey - High Security (Medeco)',category:'Commercial',price:145,isDemo:true},
{id:'cat-3',name:'Commercial Panic Bar Install',category:'Commercial',price:485,isDemo:true},
{id:'cat-4',name:'PDK Reader Install',category:'Access Control',price:650,isDemo:true},
{id:'cat-5',name:'Door Closer Replacement',category:'Door/Frame',price:225,isDemo:true},
{id:'cat-6',name:'High Security Medeco Deadbolt',category:'Commercial',price:375,isDemo:true},
{id:'cat-7',name:'Safe Combination Change',category:'Safe',price:125,isDemo:true},
{id:'cat-8',name:'Transponder Key Cut',category:'Automotive',price:165,isDemo:true},
{id:'cat-9',name:'ADA Automatic Operator Install',category:'Door/Frame',price:1850,isDemo:true},
{id:'cat-10',name:'Security Camera (per unit)',category:'Commercial',price:350,isDemo:true},
];
for(const c of demoCatalog)await dbPut('catalog',c);

const demoQuote={id:'demo-quote-1',surveyName:'Richardson Medical Office',client:'Dr. S. Patel',address:'1200 E Campbell Rd, Richardson TX',items:[{location:'Floor 1 Lobby',service:'PDK Reader x2',price:1300},{location:'Floor 1 Exam 1-4',service:'Rekey x4',price:340},{location:'Floor 1 Back Exit',service:'Panic Bar',price:485}],total:2125,status:'sent',createdAt:new Date(Date.now()-86400000*2).toISOString(),isDemo:true};
const demoQuote2={id:'demo-quote-2',surveyName:'Heritage Estates HOA Gatehouse',client:'Heritage HOA Board',address:'8900 Heritage Dr, Frisco TX',items:[{location:'Gate Entry',service:'Keypad Lock Install',price:450},{location:'Clubhouse Front',service:'Rekey x2',price:170},{location:'Pool Storage',service:'Padlock Upgrade',price:95}],total:715,status:'approved',createdAt:new Date(Date.now()-86400000*5).toISOString(),isDemo:true};
await dbPut('quotes',demoQuote);
await dbPut('quotes',demoQuote2);
}

async function clearDemoData(){
const allSurveys=await dbGetAll('surveys');
const allItems=await dbGetAll('items');
const allCatalog=await dbGetAll('catalog');
const allQuotes=await dbGetAll('quotes');
for(const s of allSurveys){if(s.isDemo)await dbDelete('surveys',s.id);}
for(const i of allItems){if(i.isDemo)await dbDelete('items',i.id);}
for(const c of allCatalog){if(c.isDemo)await dbDelete('catalog',c.id);}
for(const q of allQuotes){if(q.isDemo)await dbDelete('quotes',q.id);}
document.getElementById('demoBanner').style.display='none';
currentSurvey=null;
showToast('Demo data cleared','success');
await refreshAll();
}

// === REFRESH ===
async function refreshAll(){
const surveys=await dbGetAll('surveys');
const activeSurvey=surveys.find(s=>s.status==='active');
surveyItems=await dbGetAll('items');
catalogItems=await dbGetAll('catalog');
quotes=await dbGetAll('quotes');

if(activeSurvey){
currentSurvey=activeSurvey;
renderSurvey();
}else{
currentSurvey=null;
document.getElementById('surveyEmpty').style.display='block';
document.getElementById('surveyActive').style.display='none';
document.getElementById('addItemFab').style.display='none';
}
renderQuotes();
renderCatalog();
updateServiceDropdown();

const hasDemo=surveys.some(s=>s.isDemo)||catalogItems.some(c=>c.isDemo);
document.getElementById('demoBanner').style.display=hasDemo?'flex':'none';
}

// === SURVEY ===
function startNewSurvey(){
document.getElementById('surveyNameInput').value='';
document.getElementById('surveyAddr').value='';
document.getElementById('surveyClientName').value='';
document.getElementById('newSurveyModal').classList.add('show');
document.getElementById('surveyNameInput').focus();
}

async function createSurvey(){
const name=document.getElementById('surveyNameInput').value.trim();
const addr=document.getElementById('surveyAddr').value.trim();
const client=document.getElementById('surveyClientName').value.trim();
if(!name){showToast('Enter a job name','error');document.getElementById('surveyNameInput').focus();return;}
const survey={id:'survey-'+Date.now(),name,address:addr,client,createdAt:new Date().toISOString(),status:'active',isDemo:false};
await dbPut('surveys',survey);
closeModal('newSurveyModal');
showToast('Survey started','success');
await refreshAll();
}

function renderSurvey(){
if(!currentSurvey)return;
document.getElementById('surveyEmpty').style.display='none';
document.getElementById('surveyActive').style.display='block';
document.getElementById('addItemFab').style.display=document.querySelector('.bottom-nav button.active').dataset.tab==='survey'?'flex':'none';
document.getElementById('surveyTitle').textContent=currentSurvey.name;
document.getElementById('surveyLocation').textContent=[currentSurvey.address,currentSurvey.client].filter(Boolean).join(' • ');

const items=surveyItems.filter(i=>i.surveyId===currentSurvey.id);
const container=document.getElementById('surveyItems');
if(items.length===0){
container.innerHTML='<div style="padding:40px 24px;text-align:center;color:var(--muted);font-size:14px"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--border)" stroke-width="1" style="margin-bottom:16px"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg><p>Tap the + button to add your first door or lock</p></div>';
}else{
container.innerHTML=items.map((item,idx)=>`
<div class="survey-item" style="animation-delay:${idx*0.05}s">
<div class="survey-thumb">${item.photo?`<img src="${item.photo}" alt="Photo of ${esc(item.location)}">`:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>`}</div>
<div class="survey-info">
<h3>${esc(item.location)}</h3>
<p>${esc(item.service)}</p>
<div class="survey-actions">
<button onclick="editItem('${item.id}')" aria-label="Edit ${esc(item.location)}"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
<button onclick="deleteItem('${item.id}')" aria-label="Delete ${esc(item.location)}"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button>
</div>
</div>
<div class="survey-price">$${item.price.toFixed(0)}</div>
</div>`).join('');
}

const total=items.reduce((s,i)=>s+i.price,0);
document.getElementById('surveyTotal').textContent='$'+total.toLocaleString('en-US',{minimumFractionDigits:0});
document.getElementById('surveyItemsLabel').textContent=items.length+' line item'+(items.length!==1?'s':'');
document.getElementById('surveyItemCount').textContent=items.length+' item'+(items.length!==1?'s':'');
}

// === ITEMS ===
function showAddItemModal(){
editingItemId=null;
document.getElementById('itemLocation').value='';
document.getElementById('itemService').value='';
document.getElementById('itemPrice').value='';
document.getElementById('itemNotes').value='';
currentPhoto=null;
document.getElementById('photoPreview').style.display='none';
document.getElementById('addItemTitle').textContent='Add Survey Item';
document.getElementById('addItemModal').classList.add('show');
document.getElementById('itemLocation').focus();
}

function updateItemPrice(){
const sel=document.getElementById('itemService');
const cat=catalogItems.find(c=>c.name===sel.value);
if(cat)document.getElementById('itemPrice').value=cat.price;
}

async function saveItem(){
const loc=document.getElementById('itemLocation').value.trim();
const svc=document.getElementById('itemService').value||document.getElementById('itemService').options[document.getElementById('itemService').selectedIndex]?.text||'';
const price=parseFloat(document.getElementById('itemPrice').value)||0;
const notes=document.getElementById('itemNotes').value.trim();

let hasError=false;
if(!loc){showToast('Enter a location','error');document.getElementById('itemLocation').focus();hasError=true;}
if(!price){showToast('Set a price','error');if(!hasError)document.getElementById('itemPrice').focus();hasError=true;}
if(hasError)return;

if(editingItemId){
const existing=surveyItems.find(i=>i.id===editingItemId);
if(existing){
existing.location=loc;existing.service=svc;existing.price=price;existing.notes=notes;
if(currentPhoto)existing.photo=currentPhoto;
await dbPut('items',existing);
}
}else{
const item={id:'item-'+Date.now(),surveyId:currentSurvey.id,location:loc,service:svc,price,notes,photo:currentPhoto,isDemo:false};
await dbPut('items',item);
}
closeModal('addItemModal');
showToast(editingItemId?'Item updated':'Item added','success');
editingItemId=null;
currentPhoto=null;
await refreshAll();
}

async function editItem(id){
const item=surveyItems.find(i=>i.id===id);
if(!item)return;
editingItemId=id;
document.getElementById('itemLocation').value=item.location;
document.getElementById('itemNotes').value=item.notes||'';
document.getElementById('itemPrice').value=item.price;
document.getElementById('addItemTitle').textContent='Edit Survey Item';
if(item.photo){
currentPhoto=item.photo;
document.getElementById('photoPreviewImg').src=item.photo;
document.getElementById('photoPreviewImg').alt='Photo of '+item.location;
document.getElementById('photoPreview').style.display='block';
}else{
currentPhoto=null;
document.getElementById('photoPreview').style.display='none';
}
updateServiceDropdown();
setTimeout(()=>{document.getElementById('itemService').value=item.service;},50);
document.getElementById('addItemModal').classList.add('show');
}

async function deleteItem(id){
const item=surveyItems.find(i=>i.id===id);
if(!item)return;
await dbDelete('items',id);
showToast('Removed '+item.location,'success');
await refreshAll();
}

// === CAMERA ===
async function openCamera(){
try{
cameraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1280},height:{ideal:960}}});
const video=document.getElementById('cameraVideo');
video.srcObject=cameraStream;
document.getElementById('cameraModal').classList.add('show');
}catch(e){
document.getElementById('photoFileInput').click();
}
}

function capturePhoto(){
const video=document.getElementById('cameraVideo');
const canvas=document.getElementById('cameraCanvas');
canvas.width=video.videoWidth;
canvas.height=video.videoHeight;
canvas.getContext('2d').drawImage(video,0,0);
currentPhoto=canvas.toDataURL('image/jpeg',0.75);
document.getElementById('photoPreviewImg').src=currentPhoto;
document.getElementById('photoPreviewImg').alt='Captured photo of survey item';
document.getElementById('photoPreview').style.display='block';
closeCamera();
showToast('Photo captured','success');
}

function closeCamera(){
if(cameraStream){cameraStream.getTracks().forEach(t=>t.stop());cameraStream=null;}
document.getElementById('cameraModal').classList.remove('show');
}

function uploadPhoto(){document.getElementById('photoFileInput').click();}
function handlePhotoFile(e){
const file=e.target.files[0];if(!file)return;
const reader=new FileReader();
reader.onload=ev=>{
currentPhoto=ev.target.result;
document.getElementById('photoPreviewImg').src=currentPhoto;
document.getElementById('photoPreviewImg').alt='Uploaded photo of survey item';
document.getElementById('photoPreview').style.display='block';
showToast('Photo attached','success');
};
reader.readAsDataURL(file);
e.target.value='';
}

// === QUOTE GENERATION ===
async function generateQuote(){
if(!currentSurvey)return;
const items=surveyItems.filter(i=>i.surveyId===currentSurvey.id);
if(items.length===0){showToast('Add items first','error');return;}

const total=items.reduce((s,i)=>s+i.price,0);
const quote={
id:'quote-'+Date.now(),
surveyName:currentSurvey.name,
client:currentSurvey.client,
address:currentSurvey.address,
items:items.map(i=>({location:i.location,service:i.service,price:i.price,notes:i.notes,photo:i.photo})),
total,
status:'pending',
createdAt:new Date().toISOString(),
isDemo:false
};
await dbPut('quotes',quote);
currentSurvey.status='completed';
await dbPut('surveys',currentSurvey);
showToast('Quote created: $'+total.toLocaleString(),'success');
await refreshAll();
switchTab('quotes');
setTimeout(()=>shareQuote(quote.id),400);
}

async function shareQuote(id){
const q=quotes.find(q=>q.id===id)||await dbGetAll('quotes').then(all=>all.find(q=>q.id===id));
if(!q)return;
let text='QUOTE: '+q.surveyName+'\n';
text+='Client: '+(q.client||'N/A')+'\n';
text+='Address: '+(q.address||'N/A')+'\n';
text+='Date: '+new Date(q.createdAt).toLocaleDateString()+'\n\n';
q.items.forEach((item,i)=>{
text+=(i+1)+'. '+item.location+'\n';
text+='   '+item.service+' - $'+item.price.toFixed(0)+'\n';
if(item.notes)text+='   Note: '+item.notes+'\n';
text+='\n';
});
text+='TOTAL: $'+q.total.toLocaleString()+'\n\n';
text+='Texas Safe & Lock Corporation\n(469) 467-7233 | texassafeandlock.com\nLicense #B12705';

if(navigator.share){
try{
await navigator.share({title:'Quote - '+q.surveyName,text});
showToast('Shared successfully','success');
}catch(e){fallbackCopy(text);}
}else{fallbackCopy(text);}
}

function fallbackCopy(text){
navigator.clipboard.writeText(text).then(()=>showToast('Quote copied to clipboard','success')).catch(()=>showToast('Could not copy','error'));
}

// === QUOTES LIST ===
function renderQuotes(){
const container=document.getElementById('quotesList');
const empty=document.getElementById('quotesEmpty');
if(quotes.length===0){empty.style.display='block';container.innerHTML='';return;}
empty.style.display='none';
const sorted=[...quotes].sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
container.innerHTML=sorted.map((q,idx)=>{
const statusClass={'sent':'badge-sent','approved':'badge-approved','pending':'badge-pending','declined':'badge-declined'}[q.status]||'badge-pending';
const date=new Date(q.createdAt);
const ago=timeAgo(date);
return `<div class="card" style="animation:fadeUp 0.3s ease-out;animation-delay:${idx*0.05}s">
<div class="card-body">
<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;gap:12px">
<div style="min-width:0">
<h3 style="font-size:15px;font-weight:600;margin-bottom:3px">${esc(q.surveyName)}</h3>
<p style="font-size:12px;color:var(--muted);line-height:1.5">${esc(q.client||'')} ${q.address?'• '+esc(q.address):''}</p>
</div>
<span class="badge ${statusClass}">${q.status}</span>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<span style="font-weight:700;font-size:1.15rem;color:var(--gold-dark);font-family:var(--font-head)">$${q.total.toLocaleString()}</span>
<span style="font-size:12px;color:var(--muted)">${ago}</span>
</div>
<div style="display:flex;gap:8px">
<button class="btn btn-sm btn-outline" onclick="shareQuote('${q.id}')" style="flex:1">
<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
Share
</button>
<button class="btn btn-sm btn-outline" onclick="updateQuoteStatus('${q.id}')" aria-label="Update status for ${esc(q.surveyName)}">
<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
</button>
<button class="btn btn-sm btn-outline" onclick="deleteQuote('${q.id}')" aria-label="Delete quote for ${esc(q.surveyName)}" style="color:var(--error)">
<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
</button>
</div>
</div></div>`;
}).join('');
}

async function updateQuoteStatus(id){
const q=quotes.find(q=>q.id===id);if(!q)return;
const cycle=['pending','sent','approved','declined'];
const next=cycle[(cycle.indexOf(q.status)+1)%cycle.length];
q.status=next;
await dbPut('quotes',q);
showToast('Status: '+next,'success');
await refreshAll();
}

async function deleteQuote(id){
await dbDelete('quotes',id);
showToast('Quote deleted','success');
await refreshAll();
}

// === CATALOG ===
function renderCatalog(){
const container=document.getElementById('catalogList');
if(catalogItems.length===0){
container.innerHTML='<div class="empty-state" style="padding:40px 24px"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--border)" stroke-width="1" style="margin-bottom:16px"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg><p style="color:var(--muted);font-size:14px">Add your services and pricing here</p></div>';
return;
}
const grouped={};
catalogItems.forEach(c=>{if(!grouped[c.category])grouped[c.category]=[];grouped[c.category].push(c);});
let html='';
Object.keys(grouped).sort().forEach(cat=>{
html+=`<div style="padding:10px 16px;background:var(--bg);font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.06em">${esc(cat)}</div>`;
grouped[cat].forEach(item=>{
html+=`<div class="catalog-item">
<div><div class="catalog-name">${esc(item.name)}</div></div>
<div style="display:flex;align-items:center;gap:10px">
<span class="catalog-price">$${item.price.toFixed(0)}</span>
<button onclick="deleteCatalogItem('${item.id}')" aria-label="Remove ${esc(item.name)}" style="background:none;border:none;cursor:pointer;padding:6px;border-radius:var(--radius-sm);color:var(--muted);transition:all 0.15s">
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
</button>
</div>
</div>`;
});
});
container.innerHTML=html;
}

function showAddCatalogItem(){
document.getElementById('catName').value='';
document.getElementById('catPrice').value='';
document.getElementById('catalogModal').classList.add('show');
document.getElementById('catName').focus();
}

async function saveCatalogItem(){
const name=document.getElementById('catName').value.trim();
const category=document.getElementById('catCategory').value;
const price=parseFloat(document.getElementById('catPrice').value)||0;
if(!name){showToast('Enter a service name','error');document.getElementById('catName').focus();return;}
if(!price){showToast('Enter a price','error');document.getElementById('catPrice').focus();return;}
await dbPut('catalog',{id:'cat-'+Date.now(),name,category,price,isDemo:false});
closeModal('catalogModal');
showToast('Service added','success');
await refreshAll();
}

async function deleteCatalogItem(id){
await dbDelete('catalog',id);
showToast('Removed','success');
await refreshAll();
}

function updateServiceDropdown(){
const sel=document.getElementById('itemService');
const currentVal=sel.value;
sel.innerHTML='<option value="">Choose a service...</option>';
catalogItems.forEach(c=>{
const opt=document.createElement('option');
opt.value=c.name;opt.textContent=c.name+' ($'+c.price+')';
sel.appendChild(opt);
});
const custom=document.createElement('option');
custom.value='_custom';custom.textContent='Custom service';
sel.appendChild(custom);
if(currentVal)sel.value=currentVal;
}

function editSurveyDetails(){
if(!currentSurvey)return;
document.getElementById('surveyNameInput').value=currentSurvey.name;
document.getElementById('surveyAddr').value=currentSurvey.address||'';
document.getElementById('surveyClientName').value=currentSurvey.client||'';
document.getElementById('newSurveyTitle').textContent='Edit Survey Details';
document.getElementById('newSurveyModal').classList.add('show');
const btn=document.querySelector('#newSurveyModal .btn-primary');
btn.onclick=updateSurveyDetails;
btn.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Save Changes';
}

async function updateSurveyDetails(){
if(!currentSurvey)return;
currentSurvey.name=document.getElementById('surveyNameInput').value.trim();
currentSurvey.address=document.getElementById('surveyAddr').value.trim();
currentSurvey.client=document.getElementById('surveyClientName').value.trim();
await dbPut('surveys',currentSurvey);
closeModal('newSurveyModal');
const btn=document.querySelector('#newSurveyModal .btn-primary');
btn.onclick=createSurvey;
btn.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Start Survey';
document.getElementById('newSurveyTitle').textContent='Start New Survey';
showToast('Survey updated','success');
await refreshAll();
}

// === TABS ===
function switchTab(tab){
document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
document.getElementById('tab-'+tab).classList.add('active');
document.querySelectorAll('.bottom-nav button').forEach(b=>{
b.classList.toggle('active',b.dataset.tab===tab);
b.setAttribute('aria-current',b.dataset.tab===tab?'page':'false');
});
const fab=document.getElementById('addItemFab');
fab.style.display=(tab==='survey'&&currentSurvey)?'flex':'none';
}

// === MODALS ===
function closeModal(id){
const modal=document.getElementById(id);
modal.classList.remove('show');
// Reset form states after closing
setTimeout(()=>{
if(id==='newSurveyModal'){
const btn=document.querySelector('#newSurveyModal .btn-primary');
btn.onclick=createSurvey;
btn.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Start Survey';
document.getElementById('newSurveyTitle').textContent='Start New Survey';
}
},300);
}

// === TOAST ===
function showToast(msg,type='info'){
const c=document.getElementById('toastContainer');
const t=document.createElement('div');
t.className='toast '+type;
t.textContent=msg;
c.appendChild(t);
setTimeout(()=>{t.style.opacity='0';t.style.transform='translate(-50%,-12px)';t.style.transition='all 0.3s';setTimeout(()=>t.remove(),300);},3000);
}

// === UTILS ===
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function timeAgo(date){
const s=Math.floor((Date.now()-date)/1000);
if(s<60)return 'just now';if(s<3600)return Math.floor(s/60)+'m ago';
if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';
}

// === EXPORT/IMPORT ===
async function exportData(){
const data={surveys:await dbGetAll('surveys'),items:await dbGetAll('items'),quotes:await dbGetAll('quotes'),catalog:await dbGetAll('catalog')};
const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
const a=document.createElement('a');a.href=URL.createObjectURL(blob);
a.download='safequote-backup-'+new Date().toISOString().slice(0,10)+'.json';
a.click();URL.revokeObjectURL(a.href);
showToast('Backup downloaded','success');
}
</script>
<script src="http://35.212.159.12/booking-api/tracker.js" async></script>
</body>
</html>