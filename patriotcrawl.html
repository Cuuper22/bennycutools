<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CrawlReport - Patriot Crawl Space Repairs</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--navy:#203250;--navy-l:#2B4470;--blue:#3B6EB5;--teal:#0D9488;--teal-bg:#F0FDFA;--white:#FFF;--off:#F3F4F6;--dark:#0F172A;--mid:#64748B;--border:#E2E8F0;--green:#059669;--green-bg:#ECFDF5;--amber:#D97706;--amber-bg:#FFFBEB;--red:#DC2626;--radius:12px;--radius-sm:8px;--shadow-sm:0 1px 3px rgba(0,0,0,.06);--shadow-md:0 4px 12px rgba(0,0,0,.08)}
html{font-size:16px;-webkit-tap-highlight-color:transparent}
body{font-family:'Roboto',sans-serif;color:var(--dark);background:var(--off);min-height:100vh;padding-bottom:120px;overflow-x:hidden;-webkit-font-smoothing:antialiased}
h1,h2,h3,h4{font-family:'Montserrat',sans-serif;line-height:1.25}
h2{font-size:1.2rem;font-weight:700}h3{font-size:1rem;font-weight:600}
button{font-family:inherit;cursor:pointer;border:none;background:none}
input,select,textarea{font-family:inherit;font-size:1rem}
.skip{position:absolute;top:-40px;left:0;background:var(--navy);color:#fff;padding:8px 16px;z-index:10000;font-size:.875rem}.skip:focus{top:0}
.hdr{background:var(--navy);color:#fff;padding:14px 16px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:100}
.hdr h1{font-size:1.05rem;font-family:'Montserrat',sans-serif;font-weight:700;flex:1}
.view{display:none;padding:16px;animation:fu .35s ease-out both}.view.active{display:block}
@keyframes fu{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow-sm);padding:18px;margin-bottom:14px;border:1px solid var(--border)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:13px 20px;border-radius:var(--radius-sm);font-weight:600;font-size:.9rem;transition:transform .15s,box-shadow .15s;min-height:48px;font-family:'Montserrat',sans-serif}
.btn:active{transform:scale(.97)}.btn svg{width:18px;height:18px;flex-shrink:0}
.btn-p{background:var(--navy);color:#fff;box-shadow:var(--shadow-sm)}.btn-p:hover{background:var(--navy-l)}
.btn-t{background:var(--teal);color:#fff}.btn-t:hover{background:#0F766E}
.btn-o{border:2px solid var(--navy);color:var(--navy)}.btn-o:hover{background:var(--navy);color:#fff}
.btn-g{color:var(--mid);padding:8px}.btn-g:hover{background:rgba(0,0,0,.04)}
.btn-f{width:100%}.btn-sm{padding:8px 14px;font-size:.8rem;min-height:36px}
.btn-dis{opacity:.35;pointer-events:none;background:#D1D5DB;color:#9CA3AF}
*:focus-visible{outline:2px solid var(--blue);outline-offset:2px}*:focus:not(:focus-visible){outline:none}
.fg{margin-bottom:14px}.fg label{display:block;font-size:.72rem;font-weight:600;color:var(--mid);margin-bottom:5px;text-transform:uppercase;letter-spacing:.6px;font-family:'Montserrat',sans-serif}
.fg input,.fg select,.fg textarea{width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:.95rem;transition:border-color .2s,box-shadow .2s}
.fg input:focus,.fg select:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,110,181,.12)}
.fg select{-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='%2364748B' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center}

/* Component rows */
.comp-row{display:flex;align-items:center;gap:10px;padding:12px 0;border-bottom:1px solid var(--border)}
.comp-row:last-child{border-bottom:none}
.comp-toggle{width:44px;height:26px;background:#D1D5DB;border-radius:13px;position:relative;cursor:pointer;transition:background .2s;flex-shrink:0}
.comp-toggle.on{background:var(--teal)}
.comp-toggle::after{content:'';position:absolute;width:22px;height:22px;background:#fff;border-radius:50%;top:2px;left:2px;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
.comp-toggle.on::after{transform:translateX(18px)}
.comp-info{flex:1;min-width:0}.comp-info h4{font-size:.88rem;font-family:'Montserrat',sans-serif;font-weight:600}
.comp-info .sub{font-size:.78rem;color:var(--mid);margin-top:1px}
.comp-price{font-family:'Montserrat',sans-serif;font-weight:700;font-size:.95rem;white-space:nowrap}
.comp-price.off{color:var(--mid);text-decoration:line-through;opacity:.5}

/* Total */
.total-bar{background:linear-gradient(135deg,var(--navy) 0%,var(--blue) 100%);color:#fff;padding:18px 20px;border-radius:var(--radius);display:flex;align-items:center;justify-content:space-between;margin:14px 0;box-shadow:0 4px 16px rgba(32,50,80,.3)}
.total-bar .amt{font-family:'Montserrat',sans-serif;font-size:1.8rem;font-weight:800}
.total-bar .lbl{font-size:.72rem;opacity:.7;text-transform:uppercase;letter-spacing:.5px}

/* Photo grid */
.photo-area{margin:12px 0}.photo-area h4{font-size:.8rem;color:var(--mid);text-transform:uppercase;margin-bottom:6px;font-family:'Montserrat',sans-serif}
.photo-row{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px}
.photo-row .ph{width:80px;height:80px;border-radius:8px;overflow:hidden;flex-shrink:0;position:relative;background:#E2E8F0}
.photo-row .ph img{width:100%;height:100%;object-fit:cover}
.photo-row .ph .rm{position:absolute;top:2px;right:2px;width:20px;height:20px;background:rgba(0,0,0,.6);border-radius:50%;display:flex;align-items:center;justify-content:center}
.photo-row .ph .rm svg{width:12px;height:12px;stroke:#fff}
.add-ph{width:80px;height:80px;border:2px dashed #CBD5E1;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;color:var(--mid);font-size:.65rem;cursor:pointer;flex-shrink:0;font-family:'Montserrat',sans-serif}
.add-ph:hover{border-color:var(--teal);color:var(--teal)}
.add-ph svg{width:24px;height:24px;stroke:currentColor;fill:none;stroke-width:1.5}

/* Inspection cards */
.insp-card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow-sm);border:1px solid var(--border);padding:14px;margin-bottom:10px;cursor:pointer;transition:box-shadow .15s}
.insp-card:hover{box-shadow:var(--shadow-md)}
.insp-card h4{font-size:.92rem;font-family:'Montserrat',sans-serif}
.insp-card .meta{font-size:.78rem;color:var(--mid);margin-top:2px}
.insp-card .bot{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
.insp-card .pr{font-family:'Montserrat',sans-serif;font-weight:700;font-size:1rem}
.sts{font-size:.68rem;font-weight:600;padding:3px 10px;border-radius:20px;font-family:'Montserrat',sans-serif}
.sts-est{background:var(--amber-bg);color:var(--amber)}.sts-sold{background:var(--green-bg);color:var(--green)}

.upsell{background:var(--off);border:2px dashed var(--border);border-radius:var(--radius);padding:18px;text-align:center;margin:14px 0}
.upsell h4{color:var(--mid);margin-bottom:4px;font-family:'Montserrat',sans-serif}.upsell p{font-size:.8rem;color:#9CA3AF;margin-bottom:8px}

/* Compact Demo Banner */
.demo-ban{background:linear-gradient(90deg,#2c3e50 0%,#34495e 100%);color:#ecf0f1;padding:6px 12px;font-size:.75rem;display:flex;align-items:center;justify-content:space-between;gap:8px}
.demo-ban span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.demo-ban button{background:rgba(255,255,255,.15);border:none;color:#ecf0f1;padding:2px 8px;border-radius:4px;font-size:.7rem;cursor:pointer;white-space:nowrap;transition:background .15s}
.demo-ban button:hover{background:rgba(255,255,255,.25)}
.demo-ban button:focus-visible{outline:2px solid var(--teal);outline-offset:2px}

.toast-w{position:fixed;top:65px;right:16px;z-index:9999}
.toast{background:var(--dark);color:#fff;padding:11px 16px;border-radius:var(--radius-sm);box-shadow:0 8px 24px rgba(0,0,0,.15);font-size:.84rem;display:flex;align-items:center;gap:6px;animation:si .3s ease-out;margin-bottom:6px}
@keyframes si{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}

nav.tabs{position:fixed;bottom:0;left:0;right:0;background:var(--white);border-top:1px solid var(--border);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom)}
nav.tabs button{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:7px 0 5px;font-size:.6rem;font-weight:600;color:var(--mid);min-height:52px;gap:2px;font-family:'Montserrat',sans-serif;transition:color .15s}
nav.tabs button svg{width:21px;height:21px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
nav.tabs button.act{color:var(--teal)}nav.tabs button.act svg{stroke:var(--teal)}

@media print{nav.tabs,.hdr,.demo-ban,#bct-demo-disclaimer,.btn,.upsell{display:none!important}body{padding:0;background:#fff}.view{display:block!important}}
@media(prefers-reduced-motion:reduce){*{animation-duration:.01ms!important;transition-duration:.01ms!important}}
@media(min-width:768px){.view{max-width:600px;margin:0 auto}nav.tabs{max-width:600px;left:50%;transform:translateX(-50%)}}
</style>
</head>
<body>
<a href="#main-content" class="skip">Skip to main content</a>
<div class="demo-ban" id="db" role="alert" style="display:none"><span>Demo data loaded · <button onclick="clearDemo()" aria-label="Clear demo">Clear</button></span></div>
<div class="hdr" role="banner">
  <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><path d="M9 22v-6h6v6" opacity=".4"/><line x1="4" y1="22" x2="20" y2="22" stroke-width="2.5"/></svg>
  <h1>CrawlReport</h1>
</div>
<div class="toast-w" id="tw" aria-live="polite"></div>
<main id="main-content">

<!-- Inspections List -->
<section class="view active" id="vList">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
    <h2>Inspections</h2>
    <button class="btn btn-p btn-sm" onclick="newInsp()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>New</button>
  </div>
  <div id="inspList"></div>
</section>

<!-- Builder -->
<section class="view" id="vBuild">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
    <button class="btn-g" onclick="toList()" aria-label="Back"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <h2 id="bTitle">New Inspection</h2>
  </div>
  <div class="card">
    <h3 style="margin-bottom:10px">Property</h3>
    <div class="fg"><label for="iName">Homeowner</label><input type="text" id="iName" placeholder="Wilson Family"></div>
    <div class="fg"><label for="iAddr">Address</label><input type="text" id="iAddr" placeholder="423 Settlers Landing Rd, Suffolk, VA"></div>
    <div class="fg"><label for="iPhone">Phone</label><input type="tel" id="iPhone" placeholder="(757) 555-0123"></div>
  </div>

  <div class="card">
    <h3 style="margin-bottom:10px">Site Photos</h3>
    <div id="photoAreas">
      <div class="photo-area" data-area="overview"><h4>Overview / Entry</h4><div class="photo-row" id="ph-overview"><button class="add-ph" onclick="takePhoto('overview')" aria-label="Add overview photo"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>Photo</button></div></div>
      <div class="photo-area" data-area="vapor"><h4>Vapor Barrier / Floor</h4><div class="photo-row" id="ph-vapor"><button class="add-ph" onclick="takePhoto('vapor')" aria-label="Add vapor barrier photo"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>Photo</button></div></div>
      <div class="photo-area" data-area="joists"><h4>Joists / Structure</h4><div class="photo-row" id="ph-joists"><button class="add-ph" onclick="takePhoto('joists')" aria-label="Add joist photo"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>Photo</button></div></div>
      <div class="photo-area" data-area="moisture"><h4>Moisture / Mold</h4><div class="photo-row" id="ph-moisture"><button class="add-ph" onclick="takePhoto('moisture')" aria-label="Add moisture photo"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>Photo</button></div></div>
    </div>
    <input type="file" id="camIn" accept="image/*" capture="environment" style="display:none" multiple>
  </div>

  <div class="card">
    <h3 style="margin-bottom:10px">Scope of Work</h3>
    <p style="font-size:.8rem;color:var(--mid);margin-bottom:12px">Toggle components on or off. Customer sees the price change live.</p>
    <div id="compList"></div>
  </div>

  <div class="card">
    <div class="fg"><label for="iNotes">Inspection Notes</label><textarea id="iNotes" placeholder="Standing water in NW corner, original 6-mil barrier torn, joists show early signs of rot on south side..." style="min-height:80px"></textarea></div>
  </div>

  <div class="total-bar">
    <div><div class="lbl">Proposal Total</div><div class="amt" id="tAmt">$0</div></div>
    <div style="text-align:right"><div class="lbl" id="compCount">0 items</div></div>
  </div>

  <button class="btn btn-p btn-f" onclick="saveInsp()" style="margin-bottom:10px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>Save</button>
  <button class="btn btn-t btn-f" onclick="shareInsp()" style="margin-bottom:10px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>Share Proposal</button>
  <div class="upsell"><h4>Branded PDF Report</h4><p>Generate inspection reports with photos, findings, and recommendations for home inspectors and insurance adjusters.</p><button class="btn btn-sm btn-dis" aria-disabled="true">Available in Full Version</button></div>
</section>

<!-- Settings -->
<section class="view" id="vSet">
  <h2 style="margin-bottom:14px">Component Pricing</h2>
  <div class="card"><div id="priceList"></div></div>
  <div class="card"><h3 style="margin-bottom:10px">Data</h3><button class="btn btn-o btn-f" onclick="doExport()" style="margin-bottom:8px">Export (JSON)</button><button class="btn btn-o btn-f" onclick="document.getElementById('impF').click()">Import (JSON)</button><input type="file" id="impF" accept=".json" style="display:none"></div>
</section>
</main>

<nav class="tabs" role="navigation" aria-label="Main">
  <button class="act" onclick="sw('vList',this)" aria-label="Inspections"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Inspections</button>
  <button onclick="newInsp();sw('vBuild',this)" aria-label="New"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>New</button>
  <button onclick="sw('vSet',this)" aria-label="Pricing"><svg viewBox="0 0 24 24"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg>Pricing</button>
</nav>

<div id="bct-demo-disclaimer" role="contentinfo" aria-label="Demo disclaimer" style="position:fixed;bottom:52px;left:0;right:0;background:#1a202c;color:#a0aec0;padding:4px 12px;font-size:10px;line-height:1.3;z-index:99999;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
  <span>Demo by BennyCuTools · Not affiliated with Patriot Crawl Space Repairs · <a href="mailto:cuuper225@gmail.com?subject=Delete%20Demo%3A%20Patriot%20Crawl%20Space&body=I%20am%20the%20owner%20and%20I%20request%20permanent%20deletion%20of%20this%20demo." style="color:#63b3ed;text-decoration:underline">Delete Request</a></span>
</div>

<script>
function _h(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return h;}
const _V=674077450;const _k=new URLSearchParams(window.location.search).get('key');
if(!_k||_h(_k)!==_V){document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#1a202c 0%,#2d3748 100%);color:#e2e8f0;text-align:center;padding:24px"><div style="max-width:320px"><div style="width:64px;height:64px;margin:0 auto 20px;background:#4a5568;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:28px"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#e2e8f0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div><h1 style="font-size:1.5rem;margin-bottom:8px;font-weight:600">Access Required</h1><p style="color:#a0aec0;font-size:.95rem;margin-bottom:20px;line-height:1.5">This tool requires a valid access key.</p><a href="mailto:ben@bennycutools.com" style="display:inline-block;background:#3182ce;color:#fff;padding:10px 20px;border-radius:8px;text-decoration:none;font-size:.9rem;font-weight:500;transition:background .15s">Contact for Access</a><p style="margin-top:16px;font-size:.8rem;color:#718096">BennyCuTools</p></div></div>';throw new Error('No key');}
document.addEventListener('contextmenu',e=>e.preventDefault());

let db;
function openDB(){return new Promise((r,j)=>{const q=indexedDB.open('CrawlReportDB',1);q.onupgradeneeded=e=>{e.target.result.createObjectStore('insp',{keyPath:'id'})};q.onsuccess=e=>{db=e.target.result;r()};q.onerror=j})}
function dbP(d){return new Promise((r,j)=>{const t=db.transaction('insp','readwrite');t.objectStore('insp').put(d);t.oncomplete=r;t.onerror=j})}
function dbA(){return new Promise((r,j)=>{const t=db.transaction('insp','readonly');const q=t.objectStore('insp').getAll();q.onsuccess=()=>r(q.result);q.onerror=j})}
function dbD(id){return new Promise((r,j)=>{const t=db.transaction('insp','readwrite');t.objectStore('insp').delete(id);t.oncomplete=r;t.onerror=j})}

// Components
const COMPS=[
  {key:'vapor12',name:'Vapor Barrier (12-mil)',unit:'per sq ft',def:1.50,cat:'encap'},
  {key:'vapor20',name:'Vapor Barrier (20-mil)',unit:'per sq ft',def:2.25,cat:'encap'},
  {key:'drainage',name:'Drainage Mat',unit:'per sq ft',def:1.75,cat:'encap'},
  {key:'dehumid',name:'Dehumidifier (Santa Fe)',unit:'each',def:2800,cat:'encap'},
  {key:'dehumidBasic',name:'Dehumidifier (Basic)',unit:'each',def:1600,cat:'encap'},
  {key:'ventSeal',name:'Vent Sealing',unit:'per vent',def:125,cat:'encap'},
  {key:'sumppump',name:'Sump Pump System',unit:'each',def:2200,cat:'water'},
  {key:'frenchDrain',name:'Interior French Drain',unit:'per linear ft',def:45,cat:'water'},
  {key:'joistRepair',name:'Joist Sistering/Repair',unit:'per joist (8ft)',def:350,cat:'struct'},
  {key:'joistReplace',name:'Joist Replacement',unit:'per joist (8ft)',def:550,cat:'struct'},
  {key:'pierShim',name:'Pier Shimming/Reset',unit:'per pier',def:175,cat:'struct'},
  {key:'newPier',name:'New Support Pier',unit:'each',def:450,cat:'struct'},
  {key:'moldTreat',name:'Mold Treatment',unit:'per sq ft',def:3.50,cat:'remediation'},
  {key:'insulation',name:'Insulation Removal/Replace',unit:'per sq ft',def:2.00,cat:'other'}
];

function getPrices(){try{return JSON.parse(localStorage.getItem('cr_prices'))||{}}catch(e){return{}}}
function getPrice(key){const p=getPrices();return p[key]!==undefined?p[key]:COMPS.find(c=>c.key===key)?.def||0}

// State
let cur=null;let compStates={};let compQtys={};let photos={overview:[],vapor:[],joists:[],moisture:[]};let camArea='overview';

function sv(id){document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));document.getElementById(id).classList.add('active');window.scrollTo(0,0)}
function sw(v,btn){document.querySelectorAll('nav.tabs button').forEach(b=>{b.classList.remove('act');b.removeAttribute('aria-current')});if(btn){btn.classList.add('act');btn.setAttribute('aria-current','page')}if(v==='vList')loadList();if(v==='vSet')loadSettings();sv(v)}
function toList(){sw('vList',document.querySelector('nav.tabs button:first-child'))}

async function loadList(){const all=await dbA();const c=document.getElementById('inspList');if(!all.length){c.innerHTML='<div style="text-align:center;padding:48px 16px;color:var(--mid)"><svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="#D1D5DB" stroke-width="1" style="display:block;margin:0 auto 10px"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><line x1="4" y1="22" x2="20" y2="22" stroke-width="2"/></svg><h3 style="color:var(--dark);margin-bottom:4px;font-family:Montserrat">No inspections yet</h3><p style="font-size:.85rem">Tap "New" to start your first inspection report</p></div>';return}
all.sort((a,b)=>b.created-a.created);
c.innerHTML=all.map(p=>{const d=new Date(p.created).toLocaleDateString('en-US',{month:'short',day:'numeric'});const st=p.status||'estimated';return`<div class="insp-card" tabindex="0" role="button" onclick="openInsp('${p.id}')" onkeypress="if(event.key==='Enter')openInsp('${p.id}')" aria-label="Open ${p.name}"><h4>${p.name||'Unnamed'}</h4><div class="meta">${p.address||''} -- ${d}</div><div class="bot"><div class="pr">$${(p.total||0).toLocaleString()}</div><span class="sts sts-${st}">${st.charAt(0).toUpperCase()+st.slice(1)}</span></div></div>`}).join('')}

function newInsp(){cur={id:crypto.randomUUID(),created:Date.now(),status:'estimated'};compStates={};compQtys={};photos={overview:[],vapor:[],joists:[],moisture:[]};
document.getElementById('iName').value='';document.getElementById('iAddr').value='';document.getElementById('iPhone').value='';document.getElementById('iNotes').value='';document.getElementById('bTitle').textContent='New Inspection';
renderComps();renderPhotos();recalc();sv('vBuild')}

async function openInsp(id){const all=await dbA();const p=all.find(x=>x.id===id);if(!p)return;
cur=p;compStates=p.compStates||{};compQtys=p.compQtys||{};photos=p.photos||{overview:[],vapor:[],joists:[],moisture:[]};
document.getElementById('iName').value=p.name||'';document.getElementById('iAddr').value=p.address||'';document.getElementById('iPhone').value=p.phone||'';document.getElementById('iNotes').value=p.notes||'';document.getElementById('bTitle').textContent='Edit';
renderComps();renderPhotos();recalc();sv('vBuild')}

// Components
function renderComps(){const c=document.getElementById('compList');let html='';let lastCat='';
const cats={encap:'Encapsulation',water:'Water Management',struct:'Structural',remediation:'Remediation',other:'Other'};
COMPS.forEach(comp=>{
  if(comp.cat!==lastCat){html+=`<div style="font-size:.7rem;font-weight:600;color:var(--mid);text-transform:uppercase;letter-spacing:.6px;padding:12px 0 4px;font-family:Montserrat;${lastCat?'border-top:2px solid var(--border);margin-top:8px':''}">${cats[comp.cat]||comp.cat}</div>`;lastCat=comp.cat}
  const on=compStates[comp.key]||false;
  const qty=compQtys[comp.key]||1;
  const price=getPrice(comp.key);
  const cost=on?price*qty:0;
  html+=`<div class="comp-row">
    <div class="comp-toggle ${on?'on':''}" role="switch" aria-checked="${on}" aria-label="Toggle ${comp.name}" tabindex="0" onclick="toggleComp('${comp.key}')" onkeypress="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleComp('${comp.key}')}"></div>
    <div class="comp-info"><h4>${comp.name}</h4><div class="sub">${price.toLocaleString('en-US',{style:'currency',currency:'USD'})} ${comp.unit}${on?` x <input type="number" value="${qty}" min="1" max="999" style="width:50px;padding:2px 4px;border:1px solid var(--border);border-radius:4px;font-size:.8rem;text-align:center" onchange="setQty('${comp.key}',this.value)" aria-label="Quantity for ${comp.name}">`:''}</div></div>
    <div class="comp-price ${on?'':'off'}">$${Math.round(cost).toLocaleString()}</div>
  </div>`;
});
c.innerHTML=html}

function toggleComp(key){compStates[key]=!compStates[key];if(!compQtys[key])compQtys[key]=1;renderComps();recalc()}
function setQty(key,val){compQtys[key]=Math.max(1,parseInt(val)||1);renderComps();recalc()}

function recalc(){let total=0;let count=0;
COMPS.forEach(c=>{if(compStates[c.key]){total+=getPrice(c.key)*(compQtys[c.key]||1);count++}});
document.getElementById('tAmt').textContent='$'+Math.round(total).toLocaleString();
document.getElementById('compCount').textContent=count+' item'+(count!==1?'s':'')}

// Photos
function takePhoto(area){camArea=area;document.getElementById('camIn').click()}
document.getElementById('camIn').addEventListener('change',function(e){
  Array.from(e.target.files).forEach(f=>{const r=new FileReader();r.onload=ev=>{if(!photos[camArea])photos[camArea]=[];photos[camArea].push(ev.target.result);renderPhotos()};r.readAsDataURL(f)});e.target.value=''});

function renderPhotos(){['overview','vapor','joists','moisture'].forEach(area=>{
  const row=document.getElementById('ph-'+area);
  let html=(photos[area]||[]).map((src,i)=>`<div class="ph"><img src="${src}" alt="${area} photo ${i+1}"><button class="rm" onclick="rmPhoto('${area}',${i})" aria-label="Remove photo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>`).join('');
  html+=`<button class="add-ph" onclick="takePhoto('${area}')" aria-label="Add ${area} photo"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>Photo</button>`;
  row.innerHTML=html})}
function rmPhoto(area,i){photos[area].splice(i,1);renderPhotos()}

// Save
async function saveInsp(){const name=document.getElementById('iName').value.trim();if(!name){toast('Enter homeowner name','e');return}
cur.name=name;cur.address=document.getElementById('iAddr').value.trim();cur.phone=document.getElementById('iPhone').value.trim();cur.notes=document.getElementById('iNotes').value.trim();
cur.compStates={...compStates};cur.compQtys={...compQtys};cur.photos={...photos};
let t=0;COMPS.forEach(c=>{if(compStates[c.key])t+=getPrice(c.key)*(compQtys[c.key]||1)});cur.total=Math.round(t);cur.updated=Date.now();
await dbP(cur);toast('Saved');loadList()}

// Share
async function shareInsp(){if(!document.getElementById('iName').value.trim()){toast('Save first','e');return}await saveInsp();
let txt=`PROPOSAL - Patriot Crawl Space Repairs\n${cur.name}\n${cur.address}\n\n`;
COMPS.forEach(c=>{if(compStates[c.key]){const cost=Math.round(getPrice(c.key)*(compQtys[c.key]||1));txt+=`${c.name} (x${compQtys[c.key]||1}): $${cost.toLocaleString()}\n`}});
txt+=`\nTotal: $${cur.total.toLocaleString()}\n`;
if(cur.notes)txt+=`\nNotes: ${cur.notes}\n`;
txt+=`\nPatriot Crawl Space Repairs\n(757) 960-3312\nClass-A Licensed Contractor`;
if(navigator.share){try{await navigator.share({title:`Proposal for ${cur.name}`,text:txt});toast('Shared')}catch(e){if(e.name!=='AbortError')clipCp(txt)}}else{clipCp(txt)}}
async function clipCp(t){try{await navigator.clipboard.writeText(t);toast('Copied')}catch(e){toast('Copy failed','e')}}

// Settings
function loadSettings(){let html='';COMPS.forEach(c=>{html+=`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)"><div><div style="font-size:.85rem;font-weight:500">${c.name}</div><div style="font-size:.72rem;color:var(--mid)">${c.unit}</div></div><input type="number" data-pk="${c.key}" value="${getPrice(c.key)}" style="width:80px;text-align:right;padding:8px;border:1.5px solid var(--border);border-radius:6px;font-size:.9rem" step="0.25" min="0" onchange="saveP()"></div>`});
document.getElementById('priceList').innerHTML=html}

function saveP(){const p={};document.querySelectorAll('[data-pk]').forEach(el=>{p[el.dataset.pk]=parseFloat(el.value)||0});localStorage.setItem('cr_prices',JSON.stringify(p));toast('Prices saved')}

// Export/Import
async function doExport(){const all=await dbA();const d=JSON.stringify({inspections:all,prices:getPrices()},null,2);const b=new Blob([d],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='crawlreport-backup.json';a.click();URL.revokeObjectURL(u);toast('Exported')}
document.getElementById('impF').addEventListener('change',async function(e){const f=e.target.files[0];if(!f)return;try{const d=JSON.parse(await f.text());if(d.inspections)for(const i of d.inspections)await dbP(i);if(d.prices)localStorage.setItem('cr_prices',JSON.stringify(d.prices));toast('Imported');loadList()}catch(er){toast('Bad file','e')}e.target.value=''});

// Demo
const DEMO_DATA=[
  {id:'demo-1',created:Date.now()-7200000,name:'Wilson Home',address:'423 Settlers Landing Rd, Suffolk',phone:'(757) 555-0198',status:'estimated',
    compStates:{vapor20:true,drainage:true,dehumid:true,joistRepair:true,pierShim:true,ventSeal:true},
    compQtys:{vapor20:800,drainage:800,dehumid:1,joistRepair:2,pierShim:4,ventSeal:6},
    photos:{overview:[],vapor:[],joists:[],moisture:[]},notes:'Original 6-mil barrier torn in multiple spots. Standing water NW corner after rain. Two joists showing early rot signs on south side. Four piers need shimming. All 6 vents need sealed.',total:0,isDemo:true},
  {id:'demo-2',created:Date.now()-172800000,name:'Chen Property',address:'2810 Kecoughtan Rd, Hampton',phone:'(757) 555-0244',status:'sold',
    compStates:{vapor12:true,ventSeal:true,moldTreat:true,insulation:true},
    compQtys:{vapor12:600,ventSeal:4,moldTreat:200,insulation:600},
    photos:{overview:[],vapor:[],joists:[],moisture:[]},notes:'Basic encapsulation. Mold on north wall joists. Remove old fiberglass insulation and replace after treatment.',total:0,isDemo:true}
];

async function loadDemo(){const all=await dbA();if(all.length>0||localStorage.getItem('cr_demoCleared'))return;
for(const d of DEMO_DATA){let t=0;COMPS.forEach(c=>{if(d.compStates[c.key])t+=getPrice(c.key)*(d.compQtys[c.key]||1)});d.total=Math.round(t);await dbP(d)}
document.getElementById('db').style.display='flex';loadList()}

async function clearDemo(){const all=await dbA();for(const p of all)if(p.isDemo)await dbD(p.id);document.getElementById('db').style.display='none';localStorage.setItem('cr_demoCleared','1');loadList();toast('Cleared')}

function toast(m,t){const w=document.getElementById('tw');const el=document.createElement('div');el.className='toast';const sv=t==='e'?'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/></svg>':'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>';el.innerHTML=sv+m;w.appendChild(el);setTimeout(()=>{el.style.opacity='0';el.style.transition='opacity .3s';setTimeout(()=>el.remove(),300)},2500)}

async function init(){await openDB();await loadDemo();const all=await dbA();if(all.some(x=>x.isDemo))document.getElementById('db').style.display='flex';await loadList();loadSettings()}
init();
</script>
</body>
</html>
