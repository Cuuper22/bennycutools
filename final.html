<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PoolVault — Equipment & Warranty Tracker | Fowler's Pool Service</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Open+Sans:wght@400;500;600&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%231976d2'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white'%3E<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0L12 2.69z"/></svg>%3C/text%3E%3C/svg%3E">
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<style>
/* ========== CSS RESET & VARIABLES ========== */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
.top-nav,.bottom-bar,.card,.modal-header,.desktop-tabs,.sub-tabs{-webkit-user-select:none;user-select:none}
:root{
  --cobalt:#1976d2;
  --cobalt-light:#42a5f5;
  --cobalt-dark:#1565c0;
  --navy:#0d47a1;
  --navy-deep:#0a3680;
  --orange:#f57c00;
  --orange-light:#ff9800;
  --orange-dark:#e65100;
  --green:#2e7d32;
  --green-light:#4caf50;
  --green-bg:rgba(46,125,50,0.08);
  --yellow:#f9a825;
  --yellow-bg:rgba(249,168,37,0.08);
  --red:#c62828;
  --red-light:#ef5350;
  --red-bg:rgba(198,40,40,0.08);
  --white:#ffffff;
  --off-white:#f5f7fa;
  --gray-50:#fafafa;
  --gray-100:#f0f2f5;
  --gray-200:#e4e7ec;
  --gray-300:#d0d5dd;
  --gray-400:#98a2b3;
  --gray-500:#667085;
  --gray-600:#475467;
  --gray-700:#344054;
  --gray-800:#1d2939;
  --gray-900:#101828;
  --shadow-sm:0 1px 2px rgba(0,0,0,0.05);
  --shadow:0 1px 3px rgba(0,0,0,0.1),0 1px 2px rgba(0,0,0,0.06);
  --shadow-md:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06);
  --shadow-lg:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);
  --radius:8px;
  --radius-lg:12px;
  --radius-xl:16px;
  --nav-height:56px;
  --bottom-bar-height:72px;
  --font-heading:'Inter',sans-serif;
  --font-body:'Open Sans',sans-serif;
  --font-mono:'Fira Code',monospace;
}

html{font-size:16px;-webkit-text-size-adjust:100%;scroll-behavior:smooth}
body{
  font-family:var(--font-body);
  background:var(--off-white);
  color:var(--gray-800);
  line-height:1.5;
  min-height:100dvh;
  overflow-x:hidden;
}

/* ========== TYPOGRAPHY ========== */
h1,h2,h3,h4,h5{font-family:var(--font-heading);font-weight:700;color:var(--gray-900);line-height:1.2}
h1{font-size:1.5rem}
h2{font-size:1.25rem}
h3{font-size:1.1rem}
.mono{font-family:var(--font-mono);font-size:0.85rem;letter-spacing:0.02em;color:var(--gray-600)}

/* ========== TOP NAV ========== */
.top-nav{
  position:fixed;top:0;left:0;right:0;z-index:1000;
  height:var(--nav-height);
  background:linear-gradient(135deg,var(--navy) 0%,var(--cobalt) 100%);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;
  box-shadow:0 2px 8px rgba(13,71,161,0.3);
}
.top-nav .logo{display:flex;align-items:center;gap:10px;color:var(--white);text-decoration:none}
.top-nav .logo-icon{
  width:32px;height:32px;
  background:rgba(255,255,255,0.15);border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  font-size:18px;
}
.top-nav .logo-text{font-family:var(--font-heading);font-weight:800;font-size:1.1rem;letter-spacing:-0.02em}
.top-nav .logo-text span{color:var(--orange-light);font-weight:600;font-size:0.75rem;display:block;margin-top:-2px;letter-spacing:0.05em}
.top-nav-actions{display:flex;gap:8px;align-items:center}
.top-nav-actions button{
  background:rgba(255,255,255,0.15);border:none;color:var(--white);
  width:36px;height:36px;border-radius:8px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:18px;
  transition:background 0.2s;
}
.top-nav-actions button:hover{background:rgba(255,255,255,0.25)}

/* ========== DESKTOP NAV ========== */
@media(min-width:1024px){
  .top-nav{padding:0 24px}
  .desktop-tabs{display:flex;gap:4px;margin-left:32px}
  .desktop-tabs button{
    background:none;border:none;color:rgba(255,255,255,0.7);
    padding:8px 16px;border-radius:8px;cursor:pointer;
    font-family:var(--font-heading);font-weight:600;font-size:0.85rem;
    transition:all 0.2s;display:flex;align-items:center;gap:6px;
    white-space:nowrap;
  }
  .desktop-tabs button:hover{color:var(--white);background:rgba(255,255,255,0.1)}
  .desktop-tabs button.active{color:var(--white);background:rgba(255,255,255,0.2)}
  .bottom-bar{display:none!important}
}
@media(max-width:1023px){
  .desktop-tabs{display:none}
}

/* ========== BOTTOM TAB BAR (mobile) ========== */
.bottom-bar{
  position:fixed;bottom:0;left:0;right:0;z-index:1000;
  height:var(--bottom-bar-height);
  background:var(--white);
  border-top:1px solid var(--gray-200);
  display:flex;align-items:stretch;justify-content:space-around;
  padding:4px 8px env(safe-area-inset-bottom,8px);
  box-shadow:0 -2px 10px rgba(0,0,0,0.06);
}
.bottom-bar button{
  flex:1;border:none;background:none;cursor:pointer;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:2px;color:var(--gray-400);font-size:10px;font-family:var(--font-heading);
  font-weight:600;transition:color 0.2s;
  min-height:44px;min-width:44px;
  padding:4px 2px;
}
.bottom-bar button .tab-icon{font-size:22px;line-height:1}
.bottom-bar button.active{color:var(--cobalt)}
.bottom-bar button:active{transform:scale(0.95)}

/* ========== MAIN CONTENT ========== */
.main-content{
  padding-top:calc(var(--nav-height) + 8px);
  padding-bottom:calc(var(--bottom-bar-height) + 16px);
  min-height:100dvh;
}
@media(min-width:1024px){
  .main-content{
    max-width:960px;margin:0 auto;
    padding-bottom:24px;
  }
}
.page{display:none;padding:12px 16px}
.page.active{display:block}
@media(min-width:1024px){.page{padding:20px 24px}}

/* ========== DEMO BANNER ========== */
.demo-banner{
  background:linear-gradient(135deg,var(--orange) 0%,var(--orange-dark) 100%);
  color:var(--white);padding:12px 16px;
  border-radius:var(--radius-lg);margin-bottom:16px;
  display:flex;align-items:center;gap:12px;
  box-shadow:var(--shadow-md);
  animation:slideDown 0.4s ease-out;
}
.demo-banner .demo-icon{font-size:24px;flex-shrink:0}
.demo-banner .demo-text{flex:1;font-size:0.85rem;line-height:1.4}
.demo-banner .demo-text strong{display:block;font-family:var(--font-heading);font-size:0.95rem}
.demo-banner .demo-dismiss{
  background:rgba(255,255,255,0.2);border:none;color:var(--white);
  width:32px;height:32px;border-radius:50%;cursor:pointer;
  font-size:18px;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;transition:background 0.2s;
}
.demo-banner .demo-dismiss:hover{background:rgba(255,255,255,0.35)}
@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

/* ========== CARDS ========== */
.card{
  background:var(--white);border-radius:var(--radius-lg);
  padding:16px;margin-bottom:12px;
  border:1px solid var(--gray-200);
  box-shadow:var(--shadow-sm);
  transition:box-shadow 0.2s,transform 0.15s;
}
.card:active{transform:scale(0.995)}
.card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px}
.card-title{font-family:var(--font-heading);font-weight:700;font-size:1rem;color:var(--gray-900)}
.card-subtitle{font-size:0.8rem;color:var(--gray-500);margin-top:2px}
.card-badge{
  display:inline-flex;align-items:center;gap:4px;
  padding:4px 10px;border-radius:20px;
  font-family:var(--font-heading);font-weight:600;font-size:0.7rem;
  text-transform:uppercase;letter-spacing:0.05em;
  white-space:nowrap;
}
.badge-green{background:var(--green-bg);color:var(--green)}
.badge-yellow{background:var(--yellow-bg);color:#b8860b}
.badge-red{background:var(--red-bg);color:var(--red)}
.badge-blue{background:rgba(25,118,210,0.08);color:var(--cobalt)}

/* Equipment list inside property */
.equip-row{
  display:flex;align-items:center;gap:12px;
  padding:10px 0;border-bottom:1px solid var(--gray-100);
}
.equip-row:last-child{border-bottom:none}
.equip-icon{
  width:40px;height:40px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;flex-shrink:0;
}
.equip-info{flex:1;min-width:0}
.equip-name{font-family:var(--font-heading);font-weight:600;font-size:0.9rem;color:var(--gray-800)}
.equip-detail{font-size:0.78rem;color:var(--gray-500);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.equip-status{flex-shrink:0}

/* ========== BUTTONS ========== */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:8px;
  padding:12px 20px;border-radius:var(--radius);border:none;cursor:pointer;
  font-family:var(--font-heading);font-weight:600;font-size:0.9rem;
  transition:all 0.2s;min-height:44px;min-width:44px;
  text-decoration:none;line-height:1;
}
.btn-primary{background:var(--cobalt);color:var(--white);box-shadow:var(--shadow-sm)}
.btn-primary:hover{background:var(--cobalt-dark);box-shadow:var(--shadow)}
.btn-primary:active{transform:scale(0.97)}
.btn-secondary{background:var(--gray-100);color:var(--gray-700);border:1px solid var(--gray-200)}
.btn-secondary:hover{background:var(--gray-200)}
.btn-orange{background:var(--orange);color:var(--white);box-shadow:var(--shadow-sm)}
.btn-orange:hover{background:var(--orange-dark)}
.btn-danger{background:var(--red-bg);color:var(--red);border:1px solid rgba(198,40,40,0.2)}
.btn-danger:hover{background:rgba(198,40,40,0.15)}
.btn-sm{padding:8px 14px;font-size:0.8rem;min-height:36px}
.btn-lg{padding:14px 28px;font-size:1rem}
.btn-block{width:100%;justify-content:center}
.btn-icon{
  width:44px;height:44px;padding:0;border-radius:var(--radius);
  background:var(--gray-100);border:1px solid var(--gray-200);
  color:var(--gray-600);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:18px;transition:all 0.2s;
}
.btn-icon:hover{background:var(--gray-200)}

/* ========== FORMS ========== */
.form-group{margin-bottom:14px}
.form-label{
  display:block;font-family:var(--font-heading);font-weight:600;
  font-size:0.8rem;color:var(--gray-600);margin-bottom:6px;
  text-transform:uppercase;letter-spacing:0.04em;
}
.form-input,.form-select,.form-textarea{
  width:100%;padding:12px 14px;
  border:1.5px solid var(--gray-300);border-radius:var(--radius);
  font-family:var(--font-body);font-size:16px;color:var(--gray-800);
  background:var(--white);transition:border-color 0.2s,box-shadow 0.2s;
  -webkit-appearance:none;appearance:none;
}
.form-input:focus,.form-select:focus,.form-textarea:focus{
  outline:none;border-color:var(--cobalt);
  box-shadow:0 0 0 3px rgba(25,118,210,0.15);
}
.form-input.error{border-color:var(--red);box-shadow:0 0 0 3px rgba(198,40,40,0.1)}
.form-select{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667085' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 14px center;
  padding-right:36px;
}
.form-textarea{resize:vertical;min-height:80px}
.form-hint{font-size:0.75rem;color:var(--gray-400);margin-top:4px}
.form-error{font-size:0.75rem;color:var(--red);margin-top:4px;display:none}
.form-row{display:flex;gap:12px}
.form-row .form-group{flex:1}

/* ========== TOAST ========== */
.toast-container{
  position:fixed;top:calc(var(--nav-height) + 8px);left:50%;transform:translateX(-50%);
  z-index:2000;display:flex;flex-direction:column;gap:8px;
  width:calc(100% - 32px);max-width:400px;pointer-events:none;
}
.toast{
  background:var(--gray-900);color:var(--white);
  padding:12px 16px;border-radius:var(--radius-lg);
  display:flex;align-items:center;gap:10px;
  box-shadow:var(--shadow-lg);
  pointer-events:auto;
  animation:toastIn 0.3s ease-out;
  font-size:0.875rem;
}
.toast.toast-out{animation:toastOut 0.3s ease-in forwards}
.toast-icon{font-size:18px;flex-shrink:0}
.toast-msg{flex:1}
.toast-action{
  background:rgba(255,255,255,0.15);border:none;color:var(--white);
  padding:6px 12px;border-radius:6px;cursor:pointer;
  font-family:var(--font-heading);font-weight:600;font-size:0.78rem;
  text-transform:uppercase;flex-shrink:0;
}
.toast-action:hover{background:rgba(255,255,255,0.25)}
@keyframes toastIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
@keyframes toastOut{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-10px)}}

/* ========== MODAL ========== */
.modal-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;z-index:1500;
  background:rgba(0,0,0,0.5);display:none;align-items:flex-end;justify-content:center;
  backdrop-filter:blur(2px);
}
.modal-overlay.open{display:flex}
@media(min-width:1024px){.modal-overlay.open{align-items:center}}
.modal{
  background:var(--white);width:100%;max-width:540px;
  border-radius:var(--radius-xl) var(--radius-xl) 0 0;
  max-height:90dvh;overflow-y:auto;
  animation:modalSlideUp 0.3s ease-out;
  padding:0;
}
@media(min-width:1024px){
  .modal{border-radius:var(--radius-xl);max-height:85dvh}
}
.modal-header{
  position:sticky;top:0;background:var(--white);z-index:1;
  padding:20px 20px 12px;border-bottom:1px solid var(--gray-100);
  display:flex;align-items:center;justify-content:space-between;
}
.modal-header h2{font-size:1.15rem}
.modal-close{
  width:36px;height:36px;border:none;background:var(--gray-100);
  border-radius:50%;cursor:pointer;font-size:20px;
  display:flex;align-items:center;justify-content:center;
  color:var(--gray-500);transition:background 0.2s;
}
.modal-close:hover{background:var(--gray-200)}
.modal-body{padding:16px 20px 24px}
@keyframes modalSlideUp{from{opacity:0;transform:translateY(40px)}to{opacity:1;transform:translateY(0)}}

/* ========== EMPTY STATE ========== */
.empty-state{
  text-align:center;padding:48px 24px;
}
.empty-state .empty-icon{font-size:64px;margin-bottom:16px;opacity:0.6}
.empty-state h2{margin-bottom:8px;color:var(--gray-700)}
.empty-state p{color:var(--gray-500);font-size:0.9rem;margin-bottom:24px;max-width:320px;margin-inline:auto}

/* ========== WARRANTY BAR ========== */
.warranty-bar{
  height:6px;border-radius:3px;background:var(--gray-200);
  overflow:hidden;margin-top:8px;
}
.warranty-bar-fill{height:100%;border-radius:3px;transition:width 0.3s}

/* ========== QR SECTION ========== */
.qr-output{
  display:flex;flex-direction:column;align-items:center;
  padding:24px;background:var(--white);border-radius:var(--radius-lg);
  border:2px dashed var(--gray-300);
}
.qr-output canvas{border-radius:8px}
.qr-label{margin-top:12px;font-family:var(--font-heading);font-weight:600;font-size:0.85rem;color:var(--gray-600)}

/* ========== WATER LOG ========== */
.water-stat{
  display:flex;flex-direction:column;align-items:center;
  padding:16px;background:var(--gray-50);border-radius:var(--radius);
  text-align:center;
}
.water-stat .stat-value{font-family:var(--font-heading);font-weight:800;font-size:1.5rem;color:var(--cobalt)}
.water-stat .stat-label{font-size:0.75rem;color:var(--gray-500);margin-top:2px}
.water-stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}

/* ========== SEARCH BAR ========== */
.search-bar{
  display:flex;align-items:center;gap:8px;
  padding:10px 14px;background:var(--white);
  border:1.5px solid var(--gray-200);border-radius:var(--radius-lg);
  margin-bottom:16px;transition:border-color 0.2s;
}
.search-bar:focus-within{border-color:var(--cobalt)}
.search-bar input{
  flex:1;border:none;outline:none;font-size:16px;
  font-family:var(--font-body);color:var(--gray-800);
  background:transparent;
}
.search-bar input::placeholder{color:var(--gray-400)}
.search-icon{font-size:18px;color:var(--gray-400);flex-shrink:0}

/* ========== SETTINGS ========== */
.settings-section{margin-bottom:24px}
.settings-section h3{margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--gray-200)}
.settings-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 0;border-bottom:1px solid var(--gray-100);
  gap:12px;
}
.settings-row:last-child{border-bottom:none}
.settings-row-info{flex:1}
.settings-row-title{font-family:var(--font-heading);font-weight:600;font-size:0.9rem}
.settings-row-desc{font-size:0.78rem;color:var(--gray-500)}

/* ========== PRINT ========== */
@media print{
  .top-nav,.bottom-bar,.toast-container,.modal-overlay,.no-print{display:none!important}
  .main-content{padding:0!important}
  .page{display:block!important;padding:0!important}
  .card{break-inside:avoid;box-shadow:none;border:1px solid #ccc}
  body{background:white;font-size:11pt}
  .print-header{display:block!important;text-align:center;margin-bottom:20px;padding:10px;border-bottom:2px solid var(--cobalt)}
  .print-header h1{font-size:16pt;color:var(--navy)}
  .print-header p{font-size:9pt;color:var(--gray-500)}
  .warranty-card-print{
    border:2px solid var(--cobalt);border-radius:8px;padding:16px;
    margin-bottom:12px;page-break-inside:avoid;
  }
  .warranty-card-print .wc-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .warranty-card-print .wc-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px 16px;font-size:9pt}
  .warranty-card-print .wc-grid dt{font-weight:bold;color:var(--gray-600)}
  .warranty-card-print .wc-grid dd{color:var(--gray-800)}
}
.print-header{display:none}

/* ========== REPORT PRINT ========== */
.report-preview{
  background:var(--white);border:1px solid var(--gray-200);
  border-radius:var(--radius-lg);padding:24px;margin-top:16px;
}
.report-preview h2{text-align:center;color:var(--navy);margin-bottom:4px}
.report-preview .report-subtitle{text-align:center;color:var(--gray-500);font-size:0.85rem;margin-bottom:20px}
.report-table{width:100%;border-collapse:collapse;font-size:0.85rem}
.report-table th{
  text-align:left;padding:8px 10px;background:var(--gray-100);
  font-family:var(--font-heading);font-weight:600;font-size:0.75rem;
  color:var(--gray-600);text-transform:uppercase;letter-spacing:0.04em;
  border-bottom:2px solid var(--gray-200);
}
.report-table td{padding:8px 10px;border-bottom:1px solid var(--gray-100)}

/* ========== TABS INSIDE PAGE ========== */
.sub-tabs{display:flex;gap:4px;margin-bottom:16px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.sub-tabs button{
  flex-shrink:0;padding:8px 16px;border:1.5px solid var(--gray-200);
  background:var(--white);border-radius:20px;cursor:pointer;
  font-family:var(--font-heading);font-weight:600;font-size:0.78rem;
  color:var(--gray-500);transition:all 0.2s;white-space:nowrap;
  min-height:36px;
}
.sub-tabs button.active{
  background:var(--cobalt);color:var(--white);border-color:var(--cobalt);
}

/* ========== MISC ========== */
.divider{height:1px;background:var(--gray-200);margin:16px 0}
.text-center{text-align:center}
.mt-8{margin-top:8px}.mt-12{margin-top:12px}.mt-16{margin-top:16px}.mt-24{margin-top:24px}
.mb-8{margin-bottom:8px}.mb-12{margin-bottom:12px}.mb-16{margin-bottom:16px}
.gap-8{gap:8px}.gap-12{gap:12px}
.flex{display:flex}.flex-col{flex-direction:column}.items-center{align-items:center}
.justify-between{justify-content:space-between}.flex-wrap{flex-wrap:wrap}
.hidden{display:none!important}

/* ========== ANIMATIONS ========== */
.fade-in{animation:fadeIn 0.3s ease-out}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* ========== UPSELL ALERT ========== */
.upsell-alert{
  background:linear-gradient(135deg,rgba(245,124,0,0.06) 0%,rgba(245,124,0,0.02) 100%);
  border:1px solid rgba(245,124,0,0.2);border-left:4px solid var(--orange);
  border-radius:var(--radius);padding:12px 16px;margin-bottom:12px;
}
.upsell-alert .upsell-title{font-family:var(--font-heading);font-weight:700;font-size:0.85rem;color:var(--orange-dark)}
.upsell-alert .upsell-text{font-size:0.8rem;color:var(--gray-600);margin-top:2px}

/* Water drop animation for logo */
.water-drop{
  display:inline-block;animation:waterPulse 3s ease-in-out infinite;
}
@keyframes waterPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
@media(min-width:1024px){#fabAdd{bottom:24px!important;right:24px!important}}
.skip-link{position:absolute;top:-40px;left:0;background:var(--gold,#c8a96e);color:#fff;padding:8px 16px;z-index:9999;font-weight:600;transition:top .15s}.skip-link:focus{top:0}
</style>
</head>
<body>

<a href="#main-content" class="skip-link">Skip to main content</a>

<!-- ========== TOP NAV ========== -->
<nav class="top-nav">
  <a class="logo" href="#" onclick="return false">
    <div class="logo-icon"><span class="water-drop"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0L12 2.69z"/></svg></span></div>
    <div class="logo-text">PoolVault<span>FOWLER'S POOL SERVICE</span></div>
  </a>
  <div class="desktop-tabs" id="desktopTabs">
    <button class="active" onclick="switchTab('properties')" data-tab="properties"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Properties</button>
    <button onclick="switchTab('water')" data-tab="water"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0L12 2.69z"/></svg> Water Log</button>
    <button onclick="switchTab('alerts')" data-tab="alerts"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0"/></svg> Alerts</button>
    <button onclick="switchTab('settings')" data-tab="settings"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg> Settings</button>
  </div>
  <div class="top-nav-actions no-print">
    <button onclick="openSettingsModal('import')" title="Import/Export"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg></button>
    <button onclick="printReport()" title="Print Report"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>️</button>
  </div>
</nav>

<!-- ========== MAIN CONTENT ========== -->
<main class="main-content" id="main-content">

  <!-- Print Header (hidden on screen) -->
  <div class="print-header">
    <h1><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="4" r="2"/><path d="M4 12c2-2 6-2 8 0s6 2 8 0M4 18c2-2 6-2 8 0s6 2 8 0"/></svg> PoolVault — Equipment & Warranty Report</h1>
    <p>Generated by Fowler's Pool Service | ROC 348053 | (480) 227-5057</p>
  </div>

  <!-- ============ PROPERTIES PAGE ============ -->
  <div class="page active" id="page-properties">
    <!-- Demo Banner -->
    <div class="demo-banner" id="demoBanner">
      <div class="demo-icon"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg></div>
      <div class="demo-text">
        <strong>Welcome to PoolVault!</strong>
        Demo data loaded — 3 sample properties with equipment &amp; warranties. Edit or clear anytime.
      </div>
      <button class="demo-dismiss" onclick="dismissDemo()" title="Dismiss"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>

    <!-- Search -->
    <div class="search-bar no-print">
      <span class="search-icon"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg></span>
      <input type="text" id="searchProperties" placeholder="Search properties, equipment, serial #..." oninput="renderProperties()">
    </div>

    <!-- Property List -->
    <div id="propertyList">
      <!-- Static demo cards (replaced by JS after IndexedDB loads) -->
      <div class="card fade-in" id="static-demo-cards">
        <div class="card-header">
          <div>
            <div class="card-title">Henderson Family</div>
            <div class="card-subtitle">6234 E Doubletree Ranch Rd, Paradise Valley, AZ 85253</div>
          </div>
          <span class="card-badge badge-yellow">3 items</span>
        </div>
        <div>
          <div class="equip-row">
            <div class="equip-icon" style="background:rgba(25,118,210,0.08);color:#1976d2"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg></div>
            <div class="equip-info">
              <div class="equip-name">Pentair IntelliFlo VSF 3HP</div>
              <div class="equip-detail"><span class="mono">S/N: 2205-A3B7C9</span></div>
            </div>
            <div class="equip-status"><span class="card-badge badge-yellow" style="font-size:0.65rem">Expiring</span></div>
          </div>
          <div class="equip-row">
            <div class="equip-icon" style="background:rgba(230,81,0,0.08);color:#e65100"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12 23c6.075 0 11-4.925 11-11S18.075 1 12 1 1 5.925 1 12s4.925 11 11 11z"/></svg></div>
            <div class="equip-info">
              <div class="equip-name">Raypak R406A Digital</div>
              <div class="equip-detail"><span class="mono">S/N: 2403-HT8821</span></div>
            </div>
            <div class="equip-status"><span class="card-badge badge-yellow" style="font-size:0.65rem">Expiring</span></div>
          </div>
          <div class="equip-row">
            <div class="equip-icon" style="background:rgba(106,27,154,0.08);color:#6a1b9a"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12a8 8 0 018-8m0 16a8 8 0 01-8-8m16-4a8 8 0 010 16M12 8v4l3 3"/></svg></div>
            <div class="equip-info">
              <div class="equip-name">Pentair IntelliCenter i10PS</div>
              <div class="equip-detail"><span class="mono">S/N: 2403-IC5502</span></div>
            </div>
            <div class="equip-status"><span class="card-badge badge-green" style="font-size:0.65rem">Active</span></div>
          </div>
        </div>
        <div style="font-size:0.7rem;color:var(--orange);margin-top:4px;font-weight:600"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg> DEMO</div>
      </div>

      <div class="card fade-in">
        <div class="card-header">
          <div>
            <div class="card-title">Martinez Residence</div>
            <div class="card-subtitle">10842 N 78th St, Scottsdale, AZ 85260</div>
          </div>
          <span class="card-badge badge-red">3 items</span>
        </div>
        <div>
          <div class="equip-row">
            <div class="equip-icon" style="background:rgba(25,118,210,0.08);color:#1976d2"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg></div>
            <div class="equip-info">
              <div class="equip-name">Jandy VS FloPro 1.85HP</div>
              <div class="equip-detail"><span class="mono">S/N: JD-2311-VF4420</span></div>
            </div>
            <div class="equip-status"><span class="card-badge badge-red" style="font-size:0.65rem">Expired</span></div>
          </div>
          <div class="equip-row">
            <div class="equip-icon" style="background:rgba(13,71,161,0.08);color:#0d47a1"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg></div>
            <div class="equip-info">
              <div class="equip-name">Pentair Clean &amp; Clear Plus 420</div>
              <div class="equip-detail"><span class="mono">S/N: CC-2311-P420</span></div>
            </div>
            <div class="equip-status"><span class="card-badge badge-red" style="font-size:0.65rem">Expired</span></div>
          </div>
          <div class="equip-row">
            <div class="equip-icon" style="background:rgba(46,125,50,0.08);color:#2e7d32"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 2v4M16 2v4M12 2v10M8 14v8h8v-8"/></svg></div>
            <div class="equip-info">
              <div class="equip-name">Pentair IntelliChlor IC40</div>
              <div class="equip-detail"><span class="mono">S/N: IC40-2311-8834</span></div>
            </div>
            <div class="equip-status"><span class="card-badge badge-green" style="font-size:0.65rem">Active</span></div>
          </div>
        </div>
        <div style="font-size:0.7rem;color:var(--orange);margin-top:4px;font-weight:600"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg> DEMO</div>
      </div>

      <div class="card fade-in">
        <div class="card-header">
          <div>
            <div class="card-title">Cooper Pool &amp; Spa</div>
            <div class="card-subtitle">28410 N 56th St, Cave Creek, AZ 85331</div>
          </div>
          <span class="card-badge badge-green">4 items</span>
        </div>
        <div>
          <div class="equip-row">
            <div class="equip-icon" style="background:rgba(25,118,210,0.08);color:#1976d2"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg></div>
            <div class="equip-info">
              <div class="equip-name">Pentair IntelliFlo 3 VSF</div>
              <div class="equip-detail"><span class="mono">S/N: PIF3-2501-0092</span></div>
            </div>
            <div class="equip-status"><span class="card-badge badge-green" style="font-size:0.65rem">Active</span></div>
          </div>
          <div class="equip-row">
            <div class="equip-icon" style="background:rgba(230,81,0,0.08);color:#e65100"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12 23c6.075 0 11-4.925 11-11S18.075 1 12 1 1 5.925 1 12s4.925 11 11 11z"/></svg></div>
            <div class="equip-info">
              <div class="equip-name">Hayward H400FDN Universal</div>
              <div class="equip-detail"><span class="mono">S/N: HW-2501-H400-1127</span></div>
            </div>
            <div class="equip-status"><span class="card-badge badge-green" style="font-size:0.65rem">Active</span></div>
          </div>
          <div style="text-align:center;padding:8px;font-size:0.8rem;color:var(--gray-400)">+2 more</div>
        </div>
        <div style="font-size:0.7rem;color:var(--orange);margin-top:4px;font-weight:600"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg> DEMO</div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" id="emptyProperties" style="display:none">
      <div class="empty-icon"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="4" r="2"/><path d="M4 12c2-2 6-2 8 0s6 2 8 0M4 18c2-2 6-2 8 0s6 2 8 0"/></svg></div>
      <h2>No Properties Yet</h2>
      <p>Add your first pool property to start tracking equipment, warranties, and water usage.</p>
      <button class="btn btn-primary btn-lg" onclick="openPropertyModal()">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add First Property
      </button>
    </div>

    <!-- FAB - Add Property -->
    <div style="position:fixed;bottom:calc(var(--bottom-bar-height) + 16px);right:16px;z-index:100" class="no-print" id="fabAdd">
      <button class="btn btn-primary" style="width:56px;height:56px;border-radius:50%;font-size:24px;box-shadow:var(--shadow-lg);padding:0" onclick="openPropertyModal()">+</button>
    </div>
  </div>

  <!-- ============ WATER LOG PAGE ============ -->
  <div class="page" id="page-water">
    <h1 class="mb-16"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0L12 2.69z"/></svg> Water Compliance Log</h1>
    
    <!-- Property Selector -->
    <div class="form-group">
      <label class="form-label">Select Property</label>
      <select class="form-select" id="waterPropertySelect" onchange="renderWaterLog()">
        <option value="">— Choose Property —</option>
      </select>
    </div>

    <!-- Water Stats -->
    <div class="water-stats-grid" id="waterStats" style="display:none">
      <div class="water-stat">
        <div class="stat-value" id="waterTotalGal">0</div>
        <div class="stat-label">Gallons Added (YTD)</div>
      </div>
      <div class="water-stat">
        <div class="stat-value" id="waterRefills">0</div>
        <div class="stat-label">Refill Events</div>
      </div>
      <div class="water-stat">
        <div class="stat-value" id="waterAvgGal">0</div>
        <div class="stat-label">Avg/Refill</div>
      </div>
    </div>

    <!-- Add Refill Event -->
    <div class="card" id="waterAddCard" style="display:none">
      <h3 class="mb-12">Log Refill Event</h3>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Date</label>
          <input type="date" class="form-input" id="waterDate">
        </div>
        <div class="form-group">
          <label class="form-label">Inches Added</label>
          <input type="number" class="form-input" id="waterInches" placeholder="e.g. 2" min="0.5" max="24" step="0.5">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <input type="text" class="form-input" id="waterNotes" placeholder="e.g. Post-monsoon refill, haboob cleanup">
      </div>
      <button class="btn btn-primary btn-block mt-8" onclick="addWaterEvent()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0L12 2.69z"/></svg> Log Refill</button>
    </div>

    <!-- Water Log Entries -->
    <div id="waterLogEntries" class="mt-16"></div>

    <!-- HOA Report Button -->
    <div id="hoaReportBtn" style="display:none" class="mt-16">
      <button class="btn btn-secondary btn-block" onclick="generateHOAReport()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> Generate HOA Conservation Report</button>
    </div>

    <!-- HOA Report Preview -->
    <div id="hoaReportPreview" class="mt-16" style="display:none"></div>
  </div>

  <!-- ============ ALERTS PAGE ============ -->
  <div class="page" id="page-alerts">
    <h1 class="mb-16"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0"/></svg> Warranty Alerts & Upsells</h1>
    <div class="sub-tabs mb-16">
      <button class="active" onclick="filterAlerts('all',this)">All</button>
      <button onclick="filterAlerts('expiring',this)"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01"/></svg> Expiring Soon</button>
      <button onclick="filterAlerts('expired',this)"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg> Expired</button>
      <button onclick="filterAlerts('upsell',this)"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v12M9 10h6M9 14h6"/></svg> Upsell Ready</button>
    </div>
    <div id="alertsList"></div>
    <div class="empty-state" id="emptyAlerts" style="display:none">
      <div class="empty-icon"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg></div>
      <h2>All Clear</h2>
      <p>No warranty alerts right now. Equipment data will generate alerts automatically.</p>
    </div>
  </div>

  <!-- ============ SETTINGS PAGE ============ -->
  <div class="page" id="page-settings">
    <h1 class="mb-16"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg> Settings</h1>

    <div class="settings-section">
      <h3>Company Info</h3>
      <div class="form-group">
        <label class="form-label">Company Name</label>
        <input type="text" class="form-input" id="settingsCompany" value="Fowler's Pool Service" onchange="saveSetting('companyName',this.value)">
      </div>
      <div class="form-group">
        <label class="form-label">License # (ROC)</label>
        <input type="text" class="form-input" id="settingsLicense" value="ROC 348053" onchange="saveSetting('license',this.value)">
      </div>
      <div class="form-group">
        <label class="form-label">Phone</label>
        <input type="tel" class="form-input" id="settingsPhone" value="(480) 227-5057" onchange="saveSetting('phone',this.value)">
      </div>
    </div>

    <div class="settings-section">
      <h3>Data Management</h3>
      <div class="settings-row">
        <div class="settings-row-info">
          <div class="settings-row-title">Export JSON Backup</div>
          <div class="settings-row-desc">Download all properties, equipment, and water logs</div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="exportJSON()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg> Export</button>
      </div>
      <div class="settings-row">
        <div class="settings-row-info">
          <div class="settings-row-title">Restore from JSON</div>
          <div class="settings-row-desc">Upload a previous backup file</div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('restoreInput').click()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg> Restore</button>
        <input type="file" id="restoreInput" accept=".json" style="display:none" onchange="restoreJSON(event)">
      </div>
      <div class="settings-row">
        <div class="settings-row-info">
          <div class="settings-row-title">Export CSV</div>
          <div class="settings-row-desc">Equipment list as spreadsheet</div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="exportCSV()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg> CSV</button>
      </div>
      <div class="settings-row">
        <div class="settings-row-info">
          <div class="settings-row-title">Import CSV</div>
          <div class="settings-row-desc">Bulk import properties from spreadsheet</div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('csvImportInput').click()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg> Import</button>
        <input type="file" id="csvImportInput" accept=".csv" style="display:none" onchange="importCSV(event)">
      </div>
      <div class="settings-row">
        <div class="settings-row-info">
          <div class="settings-row-title">Paste from Clipboard</div>
          <div class="settings-row-desc">Paste tab-separated equipment data</div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="openClipboardModal()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg> Paste</button>
      </div>
      <div class="settings-row">
        <div class="settings-row-info">
          <div class="settings-row-title">Load Demo Data</div>
          <div class="settings-row-desc">Add sample Phoenix-area properties</div>
        </div>
        <button class="btn btn-orange btn-sm" onclick="loadDemoData()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg> Load</button>
      </div>
      <div class="settings-row">
        <div class="settings-row-info">
          <div class="settings-row-title">Clear All Data</div>
          <div class="settings-row-desc">Permanently delete everything</div>
        </div>
        <button class="btn btn-danger btn-sm" onclick="clearAllData()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>️ Clear</button>
      </div>
    </div>
  </div>

</main>

<!-- ========== BOTTOM TAB BAR ========== -->
<nav class="bottom-bar no-print" id="bottomBar">
  <button class="active" onclick="switchTab('properties')" data-tab="properties">
    <span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></span>Properties
  </button>
  <button onclick="switchTab('water')" data-tab="water">
    <span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0L12 2.69z"/></svg></span>Water
  </button>
  <button onclick="switchTab('alerts')" data-tab="alerts">
    <span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0"/></svg></span>Alerts
  </button>
  <button onclick="switchTab('settings')" data-tab="settings">
    <span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg></span>Settings
  </button>
</nav>

<!-- ========== TOAST CONTAINER ========== -->
<div class="toast-container" id="toastContainer"></div>

<!-- ========== PROPERTY MODAL ========== -->
<div class="modal-overlay" id="propertyModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="propertyModalTitle">Add Property</h2>
      <button class="modal-close" onclick="closeModal('propertyModal')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="propEditId">
      <div class="form-group">
        <label class="form-label">Customer Name *</label>
        <input type="text" class="form-input" id="propCustomer" placeholder="e.g. Henderson Family">
      </div>
      <div class="form-group">
        <label class="form-label">Property Address *</label>
        <input type="text" class="form-input" id="propAddress" placeholder="e.g. 7841 E Camelback Rd, Scottsdale, AZ">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Pool Type</label>
          <select class="form-select" id="propPoolType">
            <option value="gunite">Gunite/Plaster</option>
            <option value="pebble">Pebble Tec</option>
            <option value="fiberglass">Fiberglass</option>
            <option value="vinyl">Vinyl Liner</option>
            <option value="above-ground">Above Ground</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Surface Area (sq ft)</label>
          <input type="number" class="form-input" id="propSurfaceArea" placeholder="e.g. 450" min="50" max="5000">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Volume (gallons)</label>
          <input type="number" class="form-input" id="propVolume" placeholder="e.g. 18000" min="500" max="100000">
        </div>
        <div class="form-group">
          <label class="form-label">Has Spa?</label>
          <select class="form-select" id="propHasSpa">
            <option value="no">No</option>
            <option value="yes">Yes</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-textarea" id="propNotes" placeholder="Gate code, dog, special instructions..."></textarea>
      </div>
      <button class="btn btn-primary btn-block btn-lg mt-16" onclick="saveProperty()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save Property</button>
    </div>
  </div>
</div>

<!-- ========== EQUIPMENT MODAL ========== -->
<div class="modal-overlay" id="equipModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="equipModalTitle">Add Equipment</h2>
      <button class="modal-close" onclick="closeModal('equipModal')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="equipEditId">
      <input type="hidden" id="equipPropId">
      <div class="form-group">
        <label class="form-label">Equipment Type *</label>
        <select class="form-select" id="equipType" onchange="updateEquipBrands()">
          <option value="pump">Variable Speed Pump</option>
          <option value="filter">Filter</option>
          <option value="heater">Heater</option>
          <option value="salt-cell">Salt Cell / Chlorinator</option>
          <option value="automation">Automation System</option>
          <option value="lights">Pool Lights</option>
          <option value="cleaner">Automatic Cleaner</option>
          <option value="cover">Pool Cover / Solar</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Brand *</label>
          <select class="form-select" id="equipBrand">
            <option value="Pentair">Pentair</option>
            <option value="Jandy">Jandy (Zodiac)</option>
            <option value="Hayward">Hayward</option>
            <option value="Raypak">Raypak</option>
            <option value="Polaris">Polaris</option>
            <option value="Sta-Rite">Sta-Rite</option>
            <option value="Zodiac">Zodiac</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Model</label>
          <input type="text" class="form-input" id="equipModel" placeholder="e.g. IntelliFlo VSF">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Serial Number</label>
        <input type="text" class="form-input" id="equipSerial" placeholder="e.g. 2205-A3B7C9" style="font-family:var(--font-mono)">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Install Date *</label>
          <input type="date" class="form-input" id="equipInstallDate">
        </div>
        <div class="form-group">
          <label class="form-label">Warranty (months)</label>
          <input type="number" class="form-input" id="equipWarrantyMonths" placeholder="e.g. 24" min="0" max="120">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Warranty Registered?</label>
        <select class="form-select" id="equipRegistered">
          <option value="no"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg> Not Registered</option>
          <option value="yes"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Registered</option>
          <option value="pending"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg> Pending</option>
        </select>
        <div class="form-hint">Unregistered Pentair/Hayward = 60-day warranty only!</div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Cost ($)</label>
          <input type="number" class="form-input" id="equipCost" placeholder="e.g. 1500" min="0" step="1">
        </div>
        <div class="form-group">
          <label class="form-label">BTU / HP / Watts</label>
          <input type="text" class="form-input" id="equipSpec" placeholder="e.g. 400K BTU">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-textarea" id="equipNotes" placeholder="Installation notes, part numbers, etc."></textarea>
      </div>
      <button class="btn btn-primary btn-block btn-lg mt-16" onclick="saveEquipment()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save Equipment</button>
    </div>
  </div>
</div>

<!-- ========== PROPERTY DETAIL MODAL ========== -->
<div class="modal-overlay" id="detailModal">
  <div class="modal" style="max-width:640px">
    <div class="modal-header">
      <h2 id="detailTitle">Property</h2>
      <button class="modal-close" onclick="closeModal('detailModal')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="modal-body" id="detailBody"></div>
  </div>
</div>

<!-- ========== QR MODAL ========== -->
<div class="modal-overlay" id="qrModal">
  <div class="modal" style="max-width:400px">
    <div class="modal-header">
      <h2>QR Asset Tag</h2>
      <button class="modal-close" onclick="closeModal('qrModal')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="modal-body text-center">
      <div class="qr-output">
        <canvas id="qrCanvas"></canvas>
        <div class="qr-label" id="qrLabel"></div>
      </div>
      <p class="form-hint mt-12">Print this QR code and attach it to the equipment pad or timer box. Scanning opens the PoolVault for this property.</p>
      <button class="btn btn-primary btn-block mt-16" onclick="printQR()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>️ Print QR Tag</button>
    </div>
  </div>
</div>

<!-- ========== WARRANTY CLAIM MODAL ========== -->
<div class="modal-overlay" id="claimModal">
  <div class="modal" style="max-width:540px">
    <div class="modal-header">
      <h2>Warranty Claim</h2>
      <button class="modal-close" onclick="closeModal('claimModal')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="modal-body" id="claimBody"></div>
  </div>
</div>

<!-- ========== CLIPBOARD IMPORT MODAL ========== -->
<div class="modal-overlay" id="clipboardModal">
  <div class="modal" style="max-width:540px">
    <div class="modal-header">
      <h2>Paste Equipment Data</h2>
      <button class="modal-close" onclick="closeModal('clipboardModal')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="modal-body">
      <p class="form-hint mb-12">Paste tab-separated data (from Excel/Google Sheets). Columns: Customer, Address, Type, Brand, Model, Serial, Install Date, Warranty Months</p>
      <textarea class="form-textarea" id="clipboardData" rows="8" placeholder="Paste data here..."></textarea>
      <button class="btn btn-primary btn-block mt-16" onclick="importClipboard()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg> Import Pasted Data</button>
    </div>
  </div>
</div>

<!-- ========== HOA REPORT MODAL ========== -->
<div class="modal-overlay" id="hoaModal">
  <div class="modal" style="max-width:640px">
    <div class="modal-header">
      <h2>HOA Conservation Report</h2>
      <button class="modal-close" onclick="closeModal('hoaModal')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="modal-body" id="hoaBody"></div>
  </div>
</div>

<script>
/* ==========================================================================
   SECURITY LAYER — Access Control
   ========================================================================== */
function _h(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return h;}
const _V=614835040;
const _k=new URLSearchParams(window.location.search).get('key');
if(!_k||_h(_k)!==_V){
  document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;background:#111;color:#fff;text-align:center;padding:20px"><div><h1 style="font-size:2rem;margin-bottom:1rem">Access Denied</h1><p style="color:#999">This tool requires a valid access key.</p><p style="margin-top:1rem"><a href="mailto:ben@bennycutools.com" style="color:#4da6ff">ben@bennycutools.com</a></p></div></div>';
  throw new Error('Invalid key');
}

/* ==========================================================================
   POOLVAULT — Equipment & Warranty Tracker
   Built for Fowler's Pool Service, Phoenix, AZ
   ========================================================================== */

// ========== PROTECTIONS ==========
document.addEventListener('contextmenu',e=>e.preventDefault());
setInterval(()=>{const t=performance.now();debugger;if(performance.now()-t>100)location.reload()},1000);

// ========== DATABASE LAYER ==========
const DB_NAME = 'PoolVaultDB';
const DB_VERSION = 1;
let db = null;

function openDB() {
  return new Promise((resolve, reject) => {
    if (!window.indexedDB) { resolve(null); return; }
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('properties')) {
        const ps = d.createObjectStore('properties', { keyPath: 'id' });
        ps.createIndex('customer', 'customer', { unique: false });
      }
      if (!d.objectStoreNames.contains('equipment')) {
        const es = d.createObjectStore('equipment', { keyPath: 'id' });
        es.createIndex('propertyId', 'propertyId', { unique: false });
      }
      if (!d.objectStoreNames.contains('waterlog')) {
        const ws = d.createObjectStore('waterlog', { keyPath: 'id' });
        ws.createIndex('propertyId', 'propertyId', { unique: false });
      }
      if (!d.objectStoreNames.contains('settings')) {
        d.createObjectStore('settings', { keyPath: 'key' });
      }
    };
    req.onsuccess = (e) => { db = e.target.result; resolve(db); };
    req.onerror = () => { console.warn('IndexedDB failed, using localStorage'); resolve(null); };
  });
}

// Generic CRUD with localStorage fallback
function dbPut(store, data) {
  return new Promise((resolve) => {
    if (db) {
      const tx = db.transaction(store, 'readwrite');
      tx.objectStore(store).put(data);
      tx.oncomplete = () => resolve();
      tx.onerror = () => { lsPut(store, data); resolve(); };
    } else { lsPut(store, data); resolve(); }
  });
}

function dbGetAll(store) {
  return new Promise((resolve) => {
    if (db) {
      const tx = db.transaction(store, 'readonly');
      const req = tx.objectStore(store).getAll();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => resolve(lsGetAll(store));
    } else { resolve(lsGetAll(store)); }
  });
}

function dbDelete(store, id) {
  return new Promise((resolve) => {
    if (db) {
      const tx = db.transaction(store, 'readwrite');
      tx.objectStore(store).delete(id);
      tx.oncomplete = () => resolve();
      tx.onerror = () => { lsDelete(store, id); resolve(); };
    } else { lsDelete(store, id); resolve(); }
  });
}

function dbClear(store) {
  return new Promise((resolve) => {
    if (db) {
      const tx = db.transaction(store, 'readwrite');
      tx.objectStore(store).clear();
      tx.oncomplete = () => resolve();
      tx.onerror = () => { localStorage.removeItem('pv_' + store); resolve(); };
    } else { localStorage.removeItem('pv_' + store); resolve(); }
  });
}

// localStorage fallback
function lsPut(store, data) {
  const all = lsGetAll(store);
  const idx = all.findIndex(x => x.id === data.id);
  if (idx >= 0) all[idx] = data; else all.push(data);
  localStorage.setItem('pv_' + store, JSON.stringify(all));
}
function lsGetAll(store) {
  try { return JSON.parse(localStorage.getItem('pv_' + store) || '[]'); } catch { return []; }
}
function lsDelete(store, id) {
  const all = lsGetAll(store).filter(x => x.id !== id);
  localStorage.setItem('pv_' + store, JSON.stringify(all));
}

// ========== ID GENERATOR ==========
function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 6); }

// ========== TAB NAVIGATION ==========
let currentTab = 'properties';

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + tab).classList.add('active');
  
  // Update bottom bar
  document.querySelectorAll('.bottom-bar button').forEach(b => {
    b.classList.toggle('active', b.dataset.tab === tab);
  });
  // Update desktop tabs
  document.querySelectorAll('.desktop-tabs button').forEach(b => {
    b.classList.toggle('active', b.dataset.tab === tab);
  });

  // Refresh content
  if (tab === 'properties') renderProperties();
  if (tab === 'water') { populateWaterSelect(); renderWaterLog(); }
  if (tab === 'alerts') renderAlerts();
  if (tab === 'settings') loadSettings();

  // Hide FAB on non-property pages
  const fab = document.getElementById('fabAdd');
  if (fab) fab.style.display = tab === 'properties' ? '' : 'none';
}

// ========== MODAL HELPERS ==========
function openModal(id) {
  document.getElementById(id).classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  document.body.style.overflow = '';
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeModal(overlay.id);
  });
});

// ========== TOAST ==========
function showToast(msg, icon = '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>', action = null, actionLabel = 'Undo', duration = 3000) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.innerHTML = `
    <span class="toast-icon">${icon}</span>
    <span class="toast-msg">${msg}</span>
    ${action ? `<button class="toast-action" onclick="(${action.toString()})();this.closest('.toast').remove()">${actionLabel}</button>` : ''}
  `;
  container.appendChild(toast);
  if (!action) {
    setTimeout(() => {
      toast.classList.add('toast-out');
      setTimeout(() => toast.remove(), 300);
    }, duration);
  } else {
    setTimeout(() => {
      toast.classList.add('toast-out');
      setTimeout(() => toast.remove(), 300);
    }, 5000);
  }
}

// ========== EQUIPMENT TYPE HELPERS ==========
const EQUIP_ICONS = {
  'pump': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>', 'filter': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>', 'heater': '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12 23c6.075 0 11-4.925 11-11S18.075 1 12 1 1 5.925 1 12s4.925 11 11 11z"/></svg>', 'salt-cell': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 2v4M16 2v4M12 2v10M8 14v8h8v-8"/></svg>',
  'automation': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12a8 8 0 018-8m0 16a8 8 0 01-8-8m16-4a8 8 0 010 16M12 8v4l3 3"/></svg>', 'lights': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18h6M10 22h4M12 2v4M12 22a7 7 0 007-7c0-2.38-1.19-4.47-3-5.74V7a4 4 0 00-8 0v2.26C6.19 10.53 5 12.62 5 15a7 7 0 007 7z"/></svg>', 'cleaner': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="8" cy="16" r="1"/><circle cx="16" cy="16" r="1"/><path d="M12 11V7M8 7h8"/></svg>', 'cover': '☀️', 'other': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2v20"/></svg>'
};
const EQUIP_LABELS = {
  'pump': 'Variable Speed Pump', 'filter': 'Filter', 'heater': 'Heater',
  'salt-cell': 'Salt Cell', 'automation': 'Automation', 'lights': 'Lights',
  'cleaner': 'Cleaner', 'cover': 'Cover/Solar', 'other': 'Other'
};
const EQUIP_COLORS = {
  'pump': '#1976d2', 'filter': '#0d47a1', 'heater': '#e65100',
  'salt-cell': '#2e7d32', 'automation': '#6a1b9a', 'lights': '#f9a825',
  'cleaner': '#00838f', 'cover': '#ff8f00', 'other': '#546e7a'
};

function warrantyStatus(installDate, warrantyMonths) {
  if (!installDate || !warrantyMonths) return { status: 'unknown', label: 'No Warranty Info', days: 0, pct: 0 };
  const installed = new Date(installDate);
  const expires = new Date(installed);
  expires.setMonth(expires.getMonth() + parseInt(warrantyMonths));
  const now = new Date();
  const totalDays = (expires - installed) / (1000 * 60 * 60 * 24);
  const daysLeft = Math.ceil((expires - now) / (1000 * 60 * 60 * 24));
  const pct = Math.max(0, Math.min(100, (daysLeft / totalDays) * 100));
  
  if (daysLeft <= 0) return { status: 'expired', label: `Expired ${Math.abs(daysLeft)}d ago`, days: daysLeft, pct: 0, date: expires };
  if (daysLeft <= 60) return { status: 'expiring', label: `${daysLeft}d remaining`, days: daysLeft, pct, date: expires };
  return { status: 'active', label: `${daysLeft}d remaining`, days: daysLeft, pct, date: expires };
}

function warrantyBadgeClass(status) {
  if (status === 'active') return 'badge-green';
  if (status === 'expiring') return 'badge-yellow';
  if (status === 'expired') return 'badge-red';
  return 'badge-blue';
}

function warrantyBarColor(status) {
  if (status === 'active') return 'var(--green)';
  if (status === 'expiring') return 'var(--yellow)';
  return 'var(--red)';
}

// ========== PROPERTY RENDERING ==========
async function renderProperties() {
  const props = await dbGetAll('properties');
  const equips = await dbGetAll('equipment');
  const search = (document.getElementById('searchProperties').value || '').toLowerCase();
  
  const container = document.getElementById('propertyList');
  const emptyState = document.getElementById('emptyProperties');
  const fabBtn = document.getElementById('fabAdd');
  
  // Check if demo banner should show
  const hasDemo = props.some(p => p.isDemo);
  const dismissed = localStorage.getItem('pv_demo_dismissed');
  document.getElementById('demoBanner').style.display = hasDemo && !dismissed ? '' : 'none';

  // Filter
  let filtered = props;
  if (search) {
    const equipMap = {};
    equips.forEach(e => {
      if (!equipMap[e.propertyId]) equipMap[e.propertyId] = [];
      equipMap[e.propertyId].push(e);
    });
    filtered = props.filter(p => {
      const propMatch = (p.customer + ' ' + p.address + ' ' + (p.notes || '')).toLowerCase().includes(search);
      const equipMatch = (equipMap[p.id] || []).some(e =>
        (e.brand + ' ' + e.model + ' ' + (e.serial || '') + ' ' + (e.type || '')).toLowerCase().includes(search)
      );
      return propMatch || equipMatch;
    });
  }

  if (filtered.length === 0 && !search) {
    // Don't clear static demo cards if they exist
    const hasStatic = document.getElementById('static-demo-cards');
    if (hasStatic) return;
    container.innerHTML = '';
    emptyState.style.display = '';
    if (fabBtn) fabBtn.style.display = 'none';
    return;
  }
  
  emptyState.style.display = 'none';
  if (fabBtn) fabBtn.style.display = '';

  let html = '';
  for (const prop of filtered) {
    const propEquip = equips.filter(e => e.propertyId === prop.id);
    let worstStatus = 'active';
    let equipCount = propEquip.length;
    
    propEquip.forEach(e => {
      const ws = warrantyStatus(e.installDate, e.warrantyMonths);
      if (ws.status === 'expired') worstStatus = 'expired';
      else if (ws.status === 'expiring' && worstStatus !== 'expired') worstStatus = 'expiring';
    });

    html += `
      <div class="card fade-in" onclick="openPropertyDetail('${prop.id}')" style="cursor:pointer">
        <div class="card-header">
          <div>
            <div class="card-title">${esc(prop.customer)}</div>
            <div class="card-subtitle">${esc(prop.address)}</div>
          </div>
          ${equipCount > 0 ? `<span class="card-badge ${warrantyBadgeClass(worstStatus)}">${equipCount} item${equipCount !== 1 ? 's' : ''}</span>` : '<span class="card-badge badge-blue">New</span>'}
        </div>
        ${propEquip.length > 0 ? `<div>${propEquip.slice(0, 3).map(e => {
          const ws = warrantyStatus(e.installDate, e.warrantyMonths);
          return `<div class="equip-row">
            <div class="equip-icon" style="background:${EQUIP_COLORS[e.type] || '#546e7a'}15;color:${EQUIP_COLORS[e.type] || '#546e7a'}">${EQUIP_ICONS[e.type] || '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2v20"/></svg>'}</div>
            <div class="equip-info">
              <div class="equip-name">${esc(e.brand)} ${esc(e.model || '')}</div>
              <div class="equip-detail"><span class="mono">${esc(e.serial || 'No S/N')}</span></div>
            </div>
            <div class="equip-status"><span class="card-badge ${warrantyBadgeClass(ws.status)}" style="font-size:0.65rem">${ws.label}</span></div>
          </div>`;
        }).join('')}${propEquip.length > 3 ? `<div style="text-align:center;padding:8px;font-size:0.8rem;color:var(--gray-400)">+${propEquip.length - 3} more</div>` : ''}</div>` : '<div style="padding:8px 0;color:var(--gray-400);font-size:0.85rem">No equipment added yet — tap to add</div>'}
        ${prop.isDemo ? '<div style="font-size:0.7rem;color:var(--orange);margin-top:4px;font-weight:600"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg> DEMO</div>' : ''}
      </div>
    `;
  }
  container.innerHTML = html;
}

function esc(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ========== PROPERTY DETAIL ==========
async function openPropertyDetail(propId) {
  const props = await dbGetAll('properties');
  const prop = props.find(p => p.id === propId);
  if (!prop) return;
  
  const equips = (await dbGetAll('equipment')).filter(e => e.propertyId === propId);
  
  document.getElementById('detailTitle', esc(prop.customer));
  document.getElementById('detailTitle').textContent = prop.customer;
  
  let html = `
    <div style="margin-bottom:16px">
      <div style="font-size:0.85rem;color:var(--gray-500)"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg> ${esc(prop.address)}</div>
      ${prop.poolType ? `<div style="font-size:0.85rem;color:var(--gray-500);margin-top:2px"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="4" r="2"/><path d="M4 12c2-2 6-2 8 0s6 2 8 0M4 18c2-2 6-2 8 0s6 2 8 0"/></svg> ${esc(prop.poolType)} • ${prop.volume ? prop.volume.toLocaleString() + ' gal' : ''} ${prop.surfaceArea ? '• ' + prop.surfaceArea + ' sq ft' : ''} ${prop.hasSpa === 'yes' ? '• <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6v6"/><path d="M12 6v8"/><path d="M16 6v4"/><path d="M8 16c0 2 2 4 4 4s4-2 4-4"/></svg> Spa' : ''}</div>` : ''}
      ${prop.notes ? `<div style="font-size:0.85rem;color:var(--gray-500);margin-top:2px"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> ${esc(prop.notes)}</div>` : ''}
    </div>
    <div class="flex justify-between items-center mb-12" style="gap:8px;flex-wrap:wrap">
      <button class="btn btn-primary btn-sm" onclick="openEquipModal('${propId}')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add Equipment</button>
      <div style="display:flex;gap:6px">
        <button class="btn-icon" onclick="generateQR('${propId}')" title="QR Tag"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><path d="M12 18h.01"/></svg></button>
        <button class="btn-icon" onclick="editProperty('${propId}')" title="Edit"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
        <button class="btn-icon" onclick="deleteProperty('${propId}')" title="Delete" style="color:var(--red)"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>️</button>
      </div>
    </div>
  `;
  
  if (equips.length === 0) {
    html += `<div class="empty-state" style="padding:32px 16px"><div class="empty-icon" style="font-size:48px"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg></div><h3>No Equipment</h3><p style="font-size:0.85rem;color:var(--gray-500)">Add pumps, heaters, filters, and more to track warranties.</p></div>`;
  } else {
    equips.forEach(e => {
      const ws = warrantyStatus(e.installDate, e.warrantyMonths);
      html += `
        <div class="card" style="margin-bottom:10px">
          <div class="flex justify-between items-center">
            <div class="flex items-center" style="gap:12px;flex:1;min-width:0">
              <div class="equip-icon" style="background:${EQUIP_COLORS[e.type] || '#546e7a'}15;color:${EQUIP_COLORS[e.type] || '#546e7a'};flex-shrink:0">${EQUIP_ICONS[e.type] || '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2v20"/></svg>'}</div>
              <div style="min-width:0">
                <div style="font-family:var(--font-heading);font-weight:700;font-size:0.95rem">${esc(e.brand)} ${esc(e.model || '')}</div>
                <div class="mono" style="font-size:0.8rem">${esc(e.type ? EQUIP_LABELS[e.type] : '')} ${e.spec ? '• ' + esc(e.spec) : ''}</div>
              </div>
            </div>
            <span class="card-badge ${warrantyBadgeClass(ws.status)}">${ws.label}</span>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px 16px;margin-top:10px;font-size:0.8rem">
            <div><span style="color:var(--gray-400)">S/N:</span> <span class="mono">${esc(e.serial || 'N/A')}</span></div>
            <div><span style="color:var(--gray-400)">Installed:</span> ${e.installDate || 'N/A'}</div>
            <div><span style="color:var(--gray-400)">Warranty:</span> ${e.warrantyMonths ? e.warrantyMonths + ' mo' : 'N/A'} ${e.registered === 'yes' ? '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>' : e.registered === 'pending' ? '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>' : '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>'}</div>
            <div><span style="color:var(--gray-400)">Cost:</span> ${e.cost ? '$' + Number(e.cost).toLocaleString() : 'N/A'}</div>
          </div>
          ${ws.status !== 'unknown' ? `<div class="warranty-bar"><div class="warranty-bar-fill" style="width:${ws.pct}%;background:${warrantyBarColor(ws.status)}"></div></div>` : ''}
          ${e.notes ? `<div style="font-size:0.8rem;color:var(--gray-500);margin-top:6px"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> ${esc(e.notes)}</div>` : ''}
          <div style="display:flex;gap:6px;margin-top:10px;justify-content:flex-end">
            ${ws.status === 'active' || ws.status === 'expiring' ? `<button class="btn btn-secondary btn-sm" onclick="openWarrantyClaim('${e.id}')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg> Claim</button>` : ''}
            <button class="btn-icon" style="width:36px;height:36px;font-size:14px" onclick="editEquipment('${e.id}')" title="Edit"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
            <button class="btn-icon" style="width:36px;height:36px;font-size:14px;color:var(--red)" onclick="deleteEquipment('${e.id}')" title="Delete"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>️</button>
          </div>
        </div>
      `;
    });
  }
  
  document.getElementById('detailBody').innerHTML = html;
  openModal('detailModal');
}

// ========== PROPERTY CRUD ==========
function openPropertyModal(id) {
  document.getElementById('propEditId').value = '';
  document.getElementById('propCustomer').value = '';
  document.getElementById('propAddress').value = '';
  document.getElementById('propPoolType').value = 'gunite';
  document.getElementById('propSurfaceArea').value = '';
  document.getElementById('propVolume').value = '';
  document.getElementById('propHasSpa').value = 'no';
  document.getElementById('propNotes').value = '';
  document.getElementById('propertyModalTitle').textContent = 'Add Property';
  openModal('propertyModal');
}

async function editProperty(id) {
  const props = await dbGetAll('properties');
  const p = props.find(x => x.id === id);
  if (!p) return;
  document.getElementById('propEditId').value = p.id;
  document.getElementById('propCustomer').value = p.customer || '';
  document.getElementById('propAddress').value = p.address || '';
  document.getElementById('propPoolType').value = p.poolType || 'gunite';
  document.getElementById('propSurfaceArea').value = p.surfaceArea || '';
  document.getElementById('propVolume').value = p.volume || '';
  document.getElementById('propHasSpa').value = p.hasSpa || 'no';
  document.getElementById('propNotes').value = p.notes || '';
  document.getElementById('propertyModalTitle').textContent = 'Edit Property';
  closeModal('detailModal');
  openModal('propertyModal');
}

async function saveProperty() {
  const customer = document.getElementById('propCustomer').value.trim();
  const address = document.getElementById('propAddress').value.trim();
  if (!customer || !address) {
    showToast('Customer name and address required', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01"/></svg>');
    if (!customer) document.getElementById('propCustomer').classList.add('error');
    if (!address) document.getElementById('propAddress').classList.add('error');
    setTimeout(() => { document.querySelectorAll('.error').forEach(el => el.classList.remove('error')); }, 2000);
    return;
  }
  const editId = document.getElementById('propEditId').value;
  const prop = {
    id: editId || genId(),
    customer,
    address,
    poolType: document.getElementById('propPoolType').value,
    surfaceArea: parseInt(document.getElementById('propSurfaceArea').value) || null,
    volume: parseInt(document.getElementById('propVolume').value) || null,
    hasSpa: document.getElementById('propHasSpa').value,
    notes: document.getElementById('propNotes').value.trim(),
    isDemo: false,
    createdAt: editId ? undefined : new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  // Preserve existing fields if editing
  if (editId) {
    const existing = (await dbGetAll('properties')).find(p => p.id === editId);
    if (existing) {
      prop.createdAt = existing.createdAt;
      prop.isDemo = existing.isDemo;
    }
  }
  await dbPut('properties', prop);
  closeModal('propertyModal');
  showToast(editId ? 'Property updated' : 'Property added', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>');
  renderProperties();
}

async function deleteProperty(id) {
  const props = await dbGetAll('properties');
  const prop = props.find(p => p.id === id);
  if (!prop) return;
  
  // Store for undo
  const equips = (await dbGetAll('equipment')).filter(e => e.propertyId === id);
  const waterLogs = (await dbGetAll('waterlog')).filter(w => w.propertyId === id);
  
  // Delete
  await dbDelete('properties', id);
  for (const e of equips) await dbDelete('equipment', e.id);
  for (const w of waterLogs) await dbDelete('waterlog', w.id);
  
  closeModal('detailModal');
  renderProperties();
  
  showToast(`Deleted "${prop.customer}"`, '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>️', async function() {
    await dbPut('properties', prop);
    for (const e of equips) await dbPut('equipment', e);
    for (const w of waterLogs) await dbPut('waterlog', w);
    renderProperties();
    showToast('Restored!', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l6-6v4h12a2 2 0 012 2v8"/></svg>');
  }, 'Undo');
}

// ========== EQUIPMENT CRUD ==========
function openEquipModal(propId) {
  document.getElementById('equipEditId').value = '';
  document.getElementById('equipPropId').value = propId;
  document.getElementById('equipType').value = 'pump';
  document.getElementById('equipBrand').value = 'Pentair';
  document.getElementById('equipModel').value = '';
  document.getElementById('equipSerial').value = '';
  document.getElementById('equipInstallDate').value = '';
  document.getElementById('equipWarrantyMonths').value = '24';
  document.getElementById('equipRegistered').value = 'no';
  document.getElementById('equipCost').value = '';
  document.getElementById('equipSpec').value = '';
  document.getElementById('equipNotes').value = '';
  document.getElementById('equipModalTitle').textContent = 'Add Equipment';
  closeModal('detailModal');
  openModal('equipModal');
}

async function editEquipment(id) {
  const equips = await dbGetAll('equipment');
  const e = equips.find(x => x.id === id);
  if (!e) return;
  document.getElementById('equipEditId').value = e.id;
  document.getElementById('equipPropId').value = e.propertyId;
  document.getElementById('equipType').value = e.type || 'pump';
  document.getElementById('equipBrand').value = e.brand || 'Pentair';
  document.getElementById('equipModel').value = e.model || '';
  document.getElementById('equipSerial').value = e.serial || '';
  document.getElementById('equipInstallDate').value = e.installDate || '';
  document.getElementById('equipWarrantyMonths').value = e.warrantyMonths || '';
  document.getElementById('equipRegistered').value = e.registered || 'no';
  document.getElementById('equipCost').value = e.cost || '';
  document.getElementById('equipSpec').value = e.spec || '';
  document.getElementById('equipNotes').value = e.notes || '';
  document.getElementById('equipModalTitle').textContent = 'Edit Equipment';
  closeModal('detailModal');
  openModal('equipModal');
}

async function saveEquipment() {
  const type = document.getElementById('equipType').value;
  const brand = document.getElementById('equipBrand').value;
  const installDate = document.getElementById('equipInstallDate').value;
  if (!brand || !installDate) {
    showToast('Brand and install date are required', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01"/></svg>');
    return;
  }
  const editId = document.getElementById('equipEditId').value;
  const equip = {
    id: editId || genId(),
    propertyId: document.getElementById('equipPropId').value,
    type,
    brand,
    model: document.getElementById('equipModel').value.trim(),
    serial: document.getElementById('equipSerial').value.trim(),
    installDate,
    warrantyMonths: parseInt(document.getElementById('equipWarrantyMonths').value) || 0,
    registered: document.getElementById('equipRegistered').value,
    cost: parseFloat(document.getElementById('equipCost').value) || null,
    spec: document.getElementById('equipSpec').value.trim(),
    notes: document.getElementById('equipNotes').value.trim(),
    isDemo: false,
    createdAt: editId ? undefined : new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  if (editId) {
    const existing = (await dbGetAll('equipment')).find(e => e.id === editId);
    if (existing) { equip.createdAt = existing.createdAt; equip.isDemo = existing.isDemo; }
  }
  await dbPut('equipment', equip);
  closeModal('equipModal');
  showToast(editId ? 'Equipment updated' : 'Equipment added', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>');
  renderProperties();
  // Reopen detail
  setTimeout(() => openPropertyDetail(equip.propertyId), 300);
}

async function deleteEquipment(id) {
  const equips = await dbGetAll('equipment');
  const equip = equips.find(e => e.id === id);
  if (!equip) return;
  
  await dbDelete('equipment', id);
  closeModal('detailModal');
  renderProperties();
  
  showToast(`Deleted ${equip.brand} ${equip.model || ''}`, '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>️', async function() {
    await dbPut('equipment', equip);
    renderProperties();
    showToast('Restored!', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l6-6v4h12a2 2 0 012 2v8"/></svg>');
  }, 'Undo');
}

function updateEquipBrands() {
  // Adjust default brands based on type
  const type = document.getElementById('equipType').value;
  const brandSelect = document.getElementById('equipBrand');
  // Keep current brands but change default
  const defaults = {
    'pump': 'Pentair', 'filter': 'Pentair', 'heater': 'Raypak',
    'salt-cell': 'Pentair', 'automation': 'Pentair', 'lights': 'Pentair',
    'cleaner': 'Polaris', 'cover': 'other', 'other': 'other'
  };
  if (defaults[type]) brandSelect.value = defaults[type];
}

// ========== QR CODE GENERATION ==========
async function generateQR(propId) {
  const props = await dbGetAll('properties');
  const prop = props.find(p => p.id === propId);
  if (!prop) return;
  
  closeModal('detailModal');
  
  const qrData = JSON.stringify({
    app: 'PoolVault',
    company: 'Fowler\'s Pool Service',
    propertyId: propId,
    customer: prop.customer,
    address: prop.address,
    generated: new Date().toISOString()
  });
  
  const canvas = document.getElementById('qrCanvas');
  try {
    await QRCode.toCanvas(canvas, qrData, { width: 240, margin: 2, color: { dark: '#0d47a1', light: '#ffffff' } });
  } catch (err) {
    // Fallback: just show text
    showToast('QR generation failed', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01"/></svg>');
    return;
  }
  document.getElementById('qrLabel').textContent = `${prop.customer} — ${prop.address}`;
  openModal('qrModal');
}

function printQR() {
  window.print();
}

// ========== WARRANTY CLAIM ==========
async function openWarrantyClaim(equipId) {
  const equips = await dbGetAll('equipment');
  const e = equips.find(x => x.id === equipId);
  if (!e) return;
  const props = await dbGetAll('properties');
  const prop = props.find(p => p.id === e.propertyId);
  const ws = warrantyStatus(e.installDate, e.warrantyMonths);
  const settings = await getSettings();
  
  const html = `
    <div class="card" style="border:2px solid var(--cobalt)">
      <h3 style="color:var(--navy);margin-bottom:12px"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg> Pre-Filled Warranty Claim</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.85rem">
        <div><strong>Equipment:</strong> ${esc(e.brand)} ${esc(e.model || '')}</div>
        <div><strong>Type:</strong> ${esc(EQUIP_LABELS[e.type] || e.type)}</div>
        <div><strong>Serial #:</strong> <span class="mono">${esc(e.serial || 'N/A')}</span></div>
        <div><strong>Installed:</strong> ${e.installDate}</div>
        <div><strong>Warranty Exp:</strong> ${ws.date ? ws.date.toLocaleDateString() : 'N/A'}</div>
        <div><strong>Registered:</strong> ${e.registered === 'yes' ? '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Yes' : '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg> No'}</div>
        <div><strong>Customer:</strong> ${prop ? esc(prop.customer) : 'N/A'}</div>
        <div><strong>Address:</strong> ${prop ? esc(prop.address) : 'N/A'}</div>
        <div><strong>Installer:</strong> ${esc(settings.companyName || "Fowler's Pool Service")}</div>
        <div><strong>License:</strong> ${esc(settings.license || 'ROC 348053')}</div>
      </div>
    </div>
    <div class="form-group mt-16">
      <label class="form-label">Issue Description *</label>
      <textarea class="form-textarea" id="claimIssue" placeholder="Describe the defect or malfunction..." rows="4"></textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Date of Failure</label>
      <input type="date" class="form-input" id="claimDate" value="${new Date().toISOString().split('T')[0]}">
    </div>
    ${e.registered !== 'yes' ? '<div class="upsell-alert"><div class="upsell-title"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01"/></svg> Warranty Not Registered</div><div class="upsell-text">Unregistered ' + esc(e.brand) + ' products may only have 60-day coverage. Register ASAP at the manufacturer portal.</div></div>' : ''}
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-primary flex-1" onclick="downloadClaim('${e.id}')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg> Download Claim PDF</button>
      <button class="btn btn-secondary flex-1" onclick="copyClaim('${e.id}')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg> Copy to Clipboard</button>
    </div>
  `;
  
  closeModal('detailModal');
  document.getElementById('claimBody').innerHTML = html;
  openModal('claimModal');
}

async function downloadClaim(equipId) {
  const equips = await dbGetAll('equipment');
  const e = equips.find(x => x.id === equipId);
  if (!e) return;
  const props = await dbGetAll('properties');
  const prop = props.find(p => p.id === e.propertyId);
  const ws = warrantyStatus(e.installDate, e.warrantyMonths);
  const issue = document.getElementById('claimIssue')?.value || '';
  const failDate = document.getElementById('claimDate')?.value || '';
  const settings = await getSettings();
  
  const text = `WARRANTY CLAIM — ${(settings.companyName || "Fowler's Pool Service").toUpperCase()}
${'='.repeat(60)}
Date: ${new Date().toLocaleDateString()}
License: ${settings.license || 'ROC 348053'}
Phone: ${settings.phone || '(480) 227-5057'}

EQUIPMENT DETAILS
Brand: ${e.brand}
Model: ${e.model || 'N/A'}
Type: ${EQUIP_LABELS[e.type] || e.type}
Serial Number: ${e.serial || 'N/A'}
Install Date: ${e.installDate}
Warranty Expiration: ${ws.date ? ws.date.toLocaleDateString() : 'N/A'}
Registration Status: ${e.registered === 'yes' ? 'Registered' : 'NOT Registered'}

CUSTOMER INFORMATION
Name: ${prop ? prop.customer : 'N/A'}
Address: ${prop ? prop.address : 'N/A'}

CLAIM DETAILS
Date of Failure: ${failDate}
Issue Description: ${issue}
${'='.repeat(60)}
Generated by PoolVault — Fowler's Pool Service`;
  
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `warranty-claim-${e.brand}-${e.serial || 'unknown'}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Claim downloaded', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>');
}

async function copyClaim(equipId) {
  const equips = await dbGetAll('equipment');
  const e = equips.find(x => x.id === equipId);
  if (!e) return;
  const props = await dbGetAll('properties');
  const prop = props.find(p => p.id === e.propertyId);
  const ws = warrantyStatus(e.installDate, e.warrantyMonths);
  const issue = document.getElementById('claimIssue')?.value || '';
  
  const text = `Warranty Claim: ${e.brand} ${e.model || ''}\nS/N: ${e.serial || 'N/A'}\nInstalled: ${e.installDate}\nExpires: ${ws.date ? ws.date.toLocaleDateString() : 'N/A'}\nCustomer: ${prop ? prop.customer : ''}\nAddress: ${prop ? prop.address : ''}\nIssue: ${issue}`;
  
  try {
    await navigator.clipboard.writeText(text);
    showToast('Copied to clipboard', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>');
  } catch {
    showToast('Copy failed — select text manually', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01"/></svg>');
  }
}

// ========== WATER LOG ==========
async function populateWaterSelect() {
  const props = await dbGetAll('properties');
  const sel = document.getElementById('waterPropertySelect');
  const currentVal = sel.value;
  sel.innerHTML = '<option value="">— Choose Property —</option>';
  props.forEach(p => {
    sel.innerHTML += `<option value="${p.id}">${esc(p.customer)} — ${esc(p.address)}</option>`;
  });
  if (currentVal) sel.value = currentVal;
}

async function renderWaterLog() {
  const propId = document.getElementById('waterPropertySelect').value;
  const statsDiv = document.getElementById('waterStats');
  const addCard = document.getElementById('waterAddCard');
  const entriesDiv = document.getElementById('waterLogEntries');
  const hoaBtn = document.getElementById('hoaReportBtn');
  
  if (!propId) {
    statsDiv.style.display = 'none';
    addCard.style.display = 'none';
    entriesDiv.innerHTML = '';
    hoaBtn.style.display = 'none';
    return;
  }
  
  statsDiv.style.display = '';
  addCard.style.display = '';
  hoaBtn.style.display = '';
  
  // Set default date
  document.getElementById('waterDate').value = new Date().toISOString().split('T')[0];
  
  const prop = (await dbGetAll('properties')).find(p => p.id === propId);
  const logs = (await dbGetAll('waterlog')).filter(w => w.propertyId === propId);
  logs.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  // Calculate stats
  const year = new Date().getFullYear();
  const ytdLogs = logs.filter(l => new Date(l.date).getFullYear() === year);
  const totalGal = ytdLogs.reduce((s, l) => s + (l.gallons || 0), 0);
  
  document.getElementById('waterTotalGal').textContent = Math.round(totalGal).toLocaleString();
  document.getElementById('waterRefills').textContent = ytdLogs.length;
  document.getElementById('waterAvgGal').textContent = ytdLogs.length > 0 ? Math.round(totalGal / ytdLogs.length).toLocaleString() : '0';
  
  // Render entries
  if (logs.length === 0) {
    entriesDiv.innerHTML = '<div class="text-center" style="padding:24px;color:var(--gray-400)">No refill events logged yet</div>';
  } else {
    let html = '<h3 class="mb-12">Refill History</h3>';
    logs.forEach(l => {
      html += `
        <div class="card" style="padding:12px 16px">
          <div class="flex justify-between items-center">
            <div>
              <div style="font-family:var(--font-heading);font-weight:600;font-size:0.9rem"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0L12 2.69z"/></svg> ${l.inches}" added — ${Math.round(l.gallons || 0).toLocaleString()} gal</div>
              <div style="font-size:0.78rem;color:var(--gray-500)">${new Date(l.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' })} ${l.notes ? '• ' + esc(l.notes) : ''}</div>
            </div>
            <button class="btn-icon" style="width:32px;height:32px;font-size:14px;color:var(--red)" onclick="deleteWaterEvent('${l.id}')" title="Delete"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
          </div>
        </div>
      `;
    });
    entriesDiv.innerHTML = html;
  }
}

async function addWaterEvent() {
  const propId = document.getElementById('waterPropertySelect').value;
  if (!propId) { showToast('Select a property first', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01"/></svg>'); return; }
  const date = document.getElementById('waterDate').value;
  const inches = parseFloat(document.getElementById('waterInches').value);
  if (!date || !inches || inches <= 0) { showToast('Date and inches are required', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01"/></svg>'); return; }
  
  const prop = (await dbGetAll('properties')).find(p => p.id === propId);
  const surfaceArea = prop?.surfaceArea || 400; // default 400 sq ft
  
  // Gallons = surface_area * inches * 0.6233 (gallons per sq ft per inch)
  const gallons = surfaceArea * inches * 0.6233;
  
  const event = {
    id: genId(),
    propertyId: propId,
    date,
    inches,
    gallons: Math.round(gallons),
    surfaceAreaUsed: surfaceArea,
    notes: document.getElementById('waterNotes').value.trim(),
    createdAt: new Date().toISOString()
  };
  
  await dbPut('waterlog', event);
  document.getElementById('waterInches').value = '';
  document.getElementById('waterNotes').value = '';
  showToast(`Logged ${inches}" — ~${Math.round(gallons).toLocaleString()} gallons`, '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0L12 2.69z"/></svg>');
  renderWaterLog();
}

async function deleteWaterEvent(id) {
  const event = (await dbGetAll('waterlog')).find(w => w.id === id);
  if (!event) return;
  await dbDelete('waterlog', id);
  renderWaterLog();
  showToast('Refill event deleted', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>️', async function() {
    await dbPut('waterlog', event);
    renderWaterLog();
    showToast('Restored!', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l6-6v4h12a2 2 0 012 2v8"/></svg>');
  }, 'Undo');
}

async function generateHOAReport() {
  const propId = document.getElementById('waterPropertySelect').value;
  if (!propId) return;
  
  const prop = (await dbGetAll('properties')).find(p => p.id === propId);
  const logs = (await dbGetAll('waterlog')).filter(w => w.propertyId === propId);
  const settings = await getSettings();
  logs.sort((a, b) => new Date(a.date) - new Date(b.date));
  
  const year = new Date().getFullYear();
  const ytdLogs = logs.filter(l => new Date(l.date).getFullYear() === year);
  const totalGal = ytdLogs.reduce((s, l) => s + (l.gallons || 0), 0);
  
  // Average Phoenix pool evaporation: ~25,000 gal/year
  const avgEvap = 25000;
  const savings = avgEvap - totalGal;
  const savingsPct = Math.max(0, Math.round((savings / avgEvap) * 100));
  
  const html = `
    <div class="report-preview">
      <h2><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="4" r="2"/><path d="M4 12c2-2 6-2 8 0s6 2 8 0M4 18c2-2 6-2 8 0s6 2 8 0"/></svg> Water Conservation Compliance Report</h2>
      <div class="report-subtitle">Prepared by ${esc(settings.companyName || "Fowler's Pool Service")} | ${settings.license || 'ROC 348053'}</div>
      <div class="divider"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.85rem;margin-bottom:16px">
        <div><strong>Property:</strong> ${prop ? esc(prop.customer) : ''}</div>
        <div><strong>Address:</strong> ${prop ? esc(prop.address) : ''}</div>
        <div><strong>Pool Volume:</strong> ${prop?.volume ? prop.volume.toLocaleString() + ' gal' : 'N/A'}</div>
        <div><strong>Surface Area:</strong> ${prop?.surfaceArea ? prop.surfaceArea + ' sq ft' : 'N/A'}</div>
        <div><strong>Report Period:</strong> Jan 1 – Dec 31, ${year}</div>
        <div><strong>Generated:</strong> ${new Date().toLocaleDateString()}</div>
      </div>
      <h3 style="margin-bottom:8px">Water Usage Summary</h3>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">
        <div class="water-stat"><div class="stat-value">${Math.round(totalGal).toLocaleString()}</div><div class="stat-label">Gallons Added YTD</div></div>
        <div class="water-stat"><div class="stat-value">${ytdLogs.length}</div><div class="stat-label">Refill Events</div></div>
        <div class="water-stat"><div class="stat-value" style="color:var(--green)">${savingsPct}%</div><div class="stat-label">Below Avg Evap</div></div>
      </div>
      ${ytdLogs.length > 0 ? `
      <h3 style="margin-bottom:8px">Refill Event Log</h3>
      <table class="report-table">
        <thead><tr><th>Date</th><th>Inches</th><th>Est. Gallons</th><th>Notes</th></tr></thead>
        <tbody>${ytdLogs.map(l => `<tr><td>${new Date(l.date).toLocaleDateString()}</td><td>${l.inches}"</td><td>${Math.round(l.gallons || 0).toLocaleString()}</td><td>${esc(l.notes || '—')}</td></tr>`).join('')}</tbody>
      </table>` : ''}
      <div class="divider"></div>
      <div style="font-size:0.8rem;color:var(--gray-500);text-align:center">
        This report certifies responsible water stewardship for the above property.<br>
        All drainage operations comply with City of Phoenix sanitary sewer requirements.<br>
        <strong>${esc(settings.companyName || "Fowler's Pool Service")}</strong> | ${esc(settings.phone || '(480) 227-5057')} | ROC ${esc(settings.license || '348053')}
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-primary flex-1" onclick="window.print()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>️ Print Report</button>
      <button class="btn btn-secondary flex-1" onclick="downloadHOAReport()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg> Download</button>
    </div>
  `;
  
  document.getElementById('hoaReportPreview').innerHTML = html;
  document.getElementById('hoaReportPreview').style.display = '';
}

function downloadHOAReport() {
  const reportEl = document.querySelector('.report-preview');
  if (!reportEl) return;
  const text = reportEl.innerText;
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `hoa-water-report-${new Date().toISOString().split('T')[0]}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Report downloaded', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>');
}

// ========== ALERTS ==========
async function renderAlerts(filter = 'all') {
  const equips = await dbGetAll('equipment');
  const props = await dbGetAll('properties');
  const propMap = {};
  props.forEach(p => propMap[p.id] = p);
  
  let alerts = [];
  
  equips.forEach(e => {
    const ws = warrantyStatus(e.installDate, e.warrantyMonths);
    const prop = propMap[e.propertyId];
    
    if (ws.status === 'expired') {
      alerts.push({
        type: 'expired',
        priority: 1,
        icon: '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>',
        title: `${e.brand} ${e.model || EQUIP_LABELS[e.type]} — EXPIRED`,
        subtitle: prop ? `${prop.customer} • ${prop.address}` : '',
        detail: `Expired ${Math.abs(ws.days)}d ago. ${e.registered !== 'yes' ? 'Was never registered.' : ''}`,
        equipId: e.id
      });
    }
    
    if (ws.status === 'expiring') {
      alerts.push({
        type: 'expiring',
        priority: 2,
        icon: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01"/></svg>',
        title: `${e.brand} ${e.model || EQUIP_LABELS[e.type]} — ${ws.days}d left`,
        subtitle: prop ? `${prop.customer} • ${prop.address}` : '',
        detail: `Warranty expires ${ws.date ? ws.date.toLocaleDateString() : 'soon'}.`,
        equipId: e.id
      });
      
      // Upsell opportunity
      if (ws.days <= 30) {
        alerts.push({
          type: 'upsell',
          priority: 3,
          icon: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v12M9 10h6M9 14h6"/></svg>',
          title: `Upsell: Pre-Expiration Inspection`,
          subtitle: prop ? `${prop.customer} • ${e.brand} ${e.model || ''}` : '',
          detail: `Offer a $99 Pre-Expiration Inspection. Warranty expires in ${ws.days} days — catch issues before they're out of pocket.`,
          equipId: e.id
        });
      }
    }
    
    // Registration alerts
    if (e.registered === 'no' && ws.status === 'active') {
      alerts.push({
        type: 'expiring',
        priority: 2.5,
        icon: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>',
        title: `Register ${e.brand} ${e.model || ''} Warranty`,
        subtitle: prop ? `${prop.customer}` : '',
        detail: `Unregistered warranty = 60-day coverage. Register now to get full ${e.warrantyMonths}-month coverage.`,
        equipId: e.id
      });
    }
  });
  
  // Filter
  if (filter !== 'all') {
    alerts = alerts.filter(a => a.type === filter);
  }
  
  // Sort by priority
  alerts.sort((a, b) => a.priority - b.priority);
  
  const container = document.getElementById('alertsList');
  const emptyDiv = document.getElementById('emptyAlerts');
  
  if (alerts.length === 0) {
    container.innerHTML = '';
    emptyDiv.style.display = '';
    return;
  }
  
  emptyDiv.style.display = 'none';
  
  let html = '';
  alerts.forEach(a => {
    const isUpsell = a.type === 'upsell';
    html += `
      <div class="${isUpsell ? 'upsell-alert' : 'card'}" style="cursor:pointer" onclick="openPropertyDetail('${(propMap[((equips.find(e=>e.id===a.equipId)||{}).propertyId)] || {}).id || ''}')">
        ${isUpsell ? `
          <div class="upsell-title">${a.icon} ${a.title}</div>
          <div class="upsell-text">${a.subtitle}<br>${a.detail}</div>
        ` : `
          <div class="flex items-center" style="gap:12px">
            <div style="font-size:24px;flex-shrink:0">${a.icon}</div>
            <div style="flex:1">
              <div style="font-family:var(--font-heading);font-weight:700;font-size:0.9rem">${a.title}</div>
              <div style="font-size:0.8rem;color:var(--gray-500)">${a.subtitle}</div>
              <div style="font-size:0.8rem;color:var(--gray-600);margin-top:2px">${a.detail}</div>
            </div>
          </div>
        `}
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function filterAlerts(filter, btn) {
  document.querySelectorAll('#page-alerts .sub-tabs button').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderAlerts(filter);
}

// ========== SETTINGS ==========
async function getSettings() {
  const all = await dbGetAll('settings');
  const map = {};
  all.forEach(s => map[s.key] = s.value);
  return map;
}

async function saveSetting(key, value) {
  await dbPut('settings', { key, value });
  showToast('Setting saved', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>');
}

async function loadSettings() {
  const s = await getSettings();
  document.getElementById('settingsCompany').value = s.companyName || "Fowler's Pool Service";
  document.getElementById('settingsLicense').value = s.license || 'ROC 348053';
  document.getElementById('settingsPhone').value = s.phone || '(480) 227-5057';
}

// ========== EXPORT/IMPORT ==========
async function exportJSON() {
  const data = {
    app: 'PoolVault',
    version: '1.0',
    exportedAt: new Date().toISOString(),
    properties: await dbGetAll('properties'),
    equipment: await dbGetAll('equipment'),
    waterlog: await dbGetAll('waterlog'),
    settings: await dbGetAll('settings')
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `poolvault-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Backup exported', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>');
}

async function restoreJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  try {
    const text = await file.text();
    const data = JSON.parse(text);
    if (data.app !== 'PoolVault') { showToast('Invalid backup file', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01"/></svg>'); return; }
    
    // Clear existing
    await dbClear('properties');
    await dbClear('equipment');
    await dbClear('waterlog');
    await dbClear('settings');
    
    // Restore
    for (const p of (data.properties || [])) await dbPut('properties', p);
    for (const e of (data.equipment || [])) await dbPut('equipment', e);
    for (const w of (data.waterlog || [])) await dbPut('waterlog', w);
    for (const s of (data.settings || [])) await dbPut('settings', s);
    
    showToast(`Restored ${(data.properties||[]).length} properties`, '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>');
    renderProperties();
  } catch (err) {
    showToast('Restore failed: ' + err.message, '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>');
  }
  event.target.value = '';
}

async function exportCSV() {
  const props = await dbGetAll('properties');
  const equips = await dbGetAll('equipment');
  const propMap = {};
  props.forEach(p => propMap[p.id] = p);
  
  let csv = 'Customer,Address,Equipment Type,Brand,Model,Serial Number,Install Date,Warranty Months,Registered,Cost,Status\n';
  equips.forEach(e => {
    const prop = propMap[e.propertyId] || {};
    const ws = warrantyStatus(e.installDate, e.warrantyMonths);
    csv += `"${(prop.customer||'').replace(/"/g,'""')}","${(prop.address||'').replace(/"/g,'""')}","${EQUIP_LABELS[e.type]||e.type}","${e.brand}","${e.model||''}","${e.serial||''}","${e.installDate||''}","${e.warrantyMonths||''}","${e.registered||''}","${e.cost||''}","${ws.label}"\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `poolvault-equipment-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('CSV exported', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>');
}

async function importCSV(event) {
  const file = event.target.files[0];
  if (!file) return;
  try {
    const text = await file.text();
    const lines = text.split('\n').filter(l => l.trim());
    if (lines.length < 2) { showToast('CSV appears empty', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01"/></svg>'); return; }
    
    // Skip header
    let count = 0;
    for (let i = 1; i < lines.length; i++) {
      const cols = parseCSVLine(lines[i]);
      if (cols.length < 4) continue;
      
      const customer = cols[0]?.trim();
      const address = cols[1]?.trim();
      if (!customer || !address) continue;
      
      // Find or create property
      const props = await dbGetAll('properties');
      let prop = props.find(p => p.address === address);
      if (!prop) {
        prop = { id: genId(), customer, address, poolType: 'gunite', createdAt: new Date().toISOString() };
        await dbPut('properties', prop);
      }
      
      // Create equipment if columns exist
      if (cols[2]) {
        const typeMap = { 'pump': 'pump', 'filter': 'filter', 'heater': 'heater', 'salt': 'salt-cell', 'auto': 'automation', 'light': 'lights', 'clean': 'cleaner', 'cover': 'cover' };
        let type = 'other';
        const typeStr = (cols[2] || '').toLowerCase();
        for (const [k, v] of Object.entries(typeMap)) {
          if (typeStr.includes(k)) { type = v; break; }
        }
        
        const equip = {
          id: genId(), propertyId: prop.id, type,
          brand: cols[3]?.trim() || 'Unknown',
          model: cols[4]?.trim() || '',
          serial: cols[5]?.trim() || '',
          installDate: cols[6]?.trim() || '',
          warrantyMonths: parseInt(cols[7]) || 24,
          registered: (cols[8]?.trim()?.toLowerCase() === 'yes') ? 'yes' : 'no',
          cost: parseFloat(cols[9]) || null,
          createdAt: new Date().toISOString()
        };
        await dbPut('equipment', equip);
        count++;
      }
    }
    
    showToast(`Imported ${count} equipment records`, '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>');
    renderProperties();
  } catch (err) {
    showToast('Import failed: ' + err.message, '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>');
  }
  event.target.value = '';
}

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      if (inQuotes && line[i+1] === '"') { current += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if (ch === ',' && !inQuotes) {
      result.push(current); current = '';
    } else {
      current += ch;
    }
  }
  result.push(current);
  return result;
}

function openClipboardModal() {
  document.getElementById('clipboardData').value = '';
  openModal('clipboardModal');
}

async function importClipboard() {
  const text = document.getElementById('clipboardData').value.trim();
  if (!text) { showToast('Paste some data first', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01"/></svg>'); return; }
  
  const lines = text.split('\n').filter(l => l.trim());
  let count = 0;
  
  for (const line of lines) {
    const cols = line.split('\t');
    if (cols.length < 4) continue;
    
    const customer = cols[0]?.trim();
    const address = cols[1]?.trim();
    if (!customer || !address) continue;
    
    const props = await dbGetAll('properties');
    let prop = props.find(p => p.address === address);
    if (!prop) {
      prop = { id: genId(), customer, address, poolType: 'gunite', createdAt: new Date().toISOString() };
      await dbPut('properties', prop);
    }
    
    if (cols[2]) {
      const equip = {
        id: genId(), propertyId: prop.id,
        type: cols[2]?.trim()?.toLowerCase() || 'other',
        brand: cols[3]?.trim() || 'Unknown',
        model: cols[4]?.trim() || '',
        serial: cols[5]?.trim() || '',
        installDate: cols[6]?.trim() || '',
        warrantyMonths: parseInt(cols[7]) || 24,
        registered: 'no',
        createdAt: new Date().toISOString()
      };
      await dbPut('equipment', equip);
      count++;
    }
  }
  
  closeModal('clipboardModal');
  showToast(`Imported ${count} records from clipboard`, '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>');
  renderProperties();
}

// ========== DEMO DATA ==========
async function loadDemoData() {
  const existingProps = await dbGetAll('properties');
  if (existingProps.length > 0) {
    if (!confirm('This will add demo data alongside your existing records. Continue?')) return;
  }
  
  // Property 1: Henderson — Paradise Valley
  const prop1 = {
    id: 'demo_henderson', customer: 'Henderson Family', address: '6234 E Doubletree Ranch Rd, Paradise Valley, AZ 85253',
    poolType: 'pebble', surfaceArea: 520, volume: 22000, hasSpa: 'yes',
    notes: 'Gate code #4491. Two dogs (friendly). Pool/spa combo with waterfall.', isDemo: true,
    createdAt: '2024-03-15T10:00:00Z'
  };
  const equip1a = {
    id: 'demo_h_pump', propertyId: 'demo_henderson', type: 'pump',
    brand: 'Pentair', model: 'IntelliFlo VSF 3HP', serial: '2205-A3B7C9',
    installDate: '2024-03-20', warrantyMonths: 24, registered: 'yes',
    cost: 1850, spec: '3 HP Variable Speed', notes: 'Replaced old single-speed. Energy savings ~$80/mo.',
    isDemo: true, createdAt: '2024-03-20T10:00:00Z'
  };
  const equip1b = {
    id: 'demo_h_heater', propertyId: 'demo_henderson', type: 'heater',
    brand: 'Raypak', model: 'R406A Digital', serial: '2403-HT8821',
    installDate: '2024-03-20', warrantyMonths: 24, registered: 'no',
    cost: 3200, spec: '399K BTU Natural Gas', notes: 'WARRANTY CARD NOT MAILED. Heats pool+spa.',
    isDemo: true, createdAt: '2024-03-20T10:00:00Z'
  };
  const equip1c = {
    id: 'demo_h_auto', propertyId: 'demo_henderson', type: 'automation',
    brand: 'Pentair', model: 'IntelliCenter i10PS', serial: '2403-IC5502',
    installDate: '2024-03-22', warrantyMonths: 36, registered: 'yes',
    cost: 2400, spec: 'Full automation + ScreenLogic', notes: 'Controls pump, heater, lights, waterfall, spa jets.',
    isDemo: true, createdAt: '2024-03-22T10:00:00Z'
  };
  
  // Property 2: Martinez — Scottsdale
  const prop2 = {
    id: 'demo_martinez', customer: 'Martinez Residence', address: '10842 N 78th St, Scottsdale, AZ 85260',
    poolType: 'pebble', surfaceArea: 380, volume: 16000, hasSpa: 'no',
    notes: 'Snowbird — usually here Oct-Apr. Keypad entry on side gate.', isDemo: true,
    createdAt: '2023-11-10T10:00:00Z'
  };
  const equip2a = {
    id: 'demo_m_pump', propertyId: 'demo_martinez', type: 'pump',
    brand: 'Jandy', model: 'VS FloPro 1.85HP', serial: 'JD-2311-VF4420',
    installDate: '2023-11-15', warrantyMonths: 24, registered: 'yes',
    cost: 1400, spec: '1.85 HP Variable Speed', isDemo: true, createdAt: '2023-11-15T10:00:00Z'
  };
  const equip2b = {
    id: 'demo_m_filter', propertyId: 'demo_martinez', type: 'filter',
    brand: 'Pentair', model: 'Clean & Clear Plus 420', serial: 'CC-2311-P420',
    installDate: '2023-11-15', warrantyMonths: 12, registered: 'no',
    cost: 680, spec: '420 sq ft cartridge', notes: 'Filter cartridge replaced June 2024.',
    isDemo: true, createdAt: '2023-11-15T10:00:00Z'
  };
  const equip2c = {
    id: 'demo_m_salt', propertyId: 'demo_martinez', type: 'salt-cell',
    brand: 'Pentair', model: 'IntelliChlor IC40', serial: 'IC40-2311-8834',
    installDate: '2023-11-15', warrantyMonths: 36, registered: 'yes',
    cost: 950, spec: '40,000 gal capacity', isDemo: true, createdAt: '2023-11-15T10:00:00Z'
  };
  
  // Property 3: Cooper — Cave Creek
  const prop3 = {
    id: 'demo_cooper', customer: 'Cooper Pool & Spa', address: '28410 N 56th St, Cave Creek, AZ 85331',
    poolType: 'gunite', surfaceArea: 600, volume: 28000, hasSpa: 'yes',
    notes: 'Large resort-style pool. 3 water features. Rattlesnake area — check equipment pad carefully.', isDemo: true,
    createdAt: '2025-01-10T10:00:00Z'
  };
  const equip3a = {
    id: 'demo_c_pump', propertyId: 'demo_cooper', type: 'pump',
    brand: 'Pentair', model: 'IntelliFlo 3 VSF', serial: 'PIF3-2501-0092',
    installDate: '2025-01-15', warrantyMonths: 36, registered: 'yes',
    cost: 2100, spec: '3.2 HP Variable Speed', notes: 'New install. Premium efficiency model.',
    isDemo: true, createdAt: '2025-01-15T10:00:00Z'
  };
  const equip3b = {
    id: 'demo_c_heater', propertyId: 'demo_cooper', type: 'heater',
    brand: 'Hayward', model: 'H400FDN Universal H-Series', serial: 'HW-2501-H400-1127',
    installDate: '2025-01-15', warrantyMonths: 12, registered: 'pending',
    cost: 3400, spec: '400K BTU Low NOx', notes: 'Heats pool and spa independently. Warranty card submitted — awaiting confirmation.',
    isDemo: true, createdAt: '2025-01-15T10:00:00Z'
  };
  const equip3c = {
    id: 'demo_c_lights', propertyId: 'demo_cooper', type: 'lights',
    brand: 'Pentair', model: 'MicroBrite EC Color LED', serial: 'MB-2501-LED-3344',
    installDate: '2025-01-18', warrantyMonths: 60, registered: 'yes',
    cost: 1200, spec: '14 colors + shows', notes: '4x lights installed — pool perimeter + spa.',
    isDemo: true, createdAt: '2025-01-18T10:00:00Z'
  };
  const equip3d = {
    id: 'demo_c_auto', propertyId: 'demo_cooper', type: 'automation',
    brand: 'Jandy', model: 'iAquaLink 3.0', serial: 'iAQ-2501-JD7701',
    installDate: '2025-01-18', warrantyMonths: 36, registered: 'yes',
    cost: 2800, spec: 'Full home automation + app control', notes: 'Controls pump, heater, lights, 3 water features, spa blower.',
    isDemo: true, createdAt: '2025-01-18T10:00:00Z'
  };
  
  // Water log entries for Henderson
  const water1 = {
    id: 'demo_w1', propertyId: 'demo_henderson', date: '2025-06-15',
    inches: 3, gallons: 972, surfaceAreaUsed: 520, notes: 'Post-monsoon haboob cleanup',
    createdAt: '2025-06-15T10:00:00Z'
  };
  const water2 = {
    id: 'demo_w2', propertyId: 'demo_henderson', date: '2025-07-22',
    inches: 2, gallons: 648, surfaceAreaUsed: 520, notes: 'Regular evaporation top-off',
    createdAt: '2025-07-22T10:00:00Z'
  };
  const water3 = {
    id: 'demo_w3', propertyId: 'demo_henderson', date: '2025-08-10',
    inches: 4, gallons: 1296, surfaceAreaUsed: 520, notes: 'Major haboob — full filter clean + refill',
    createdAt: '2025-08-10T10:00:00Z'
  };
  const water4 = {
    id: 'demo_w4', propertyId: 'demo_cooper', date: '2025-01-28',
    inches: 1.5, gallons: 561, surfaceAreaUsed: 600, notes: 'Initial fill top-off after plaster cure',
    createdAt: '2025-01-28T10:00:00Z'
  };
  
  // Save all
  const allProps = [prop1, prop2, prop3];
  const allEquip = [equip1a, equip1b, equip1c, equip2a, equip2b, equip2c, equip3a, equip3b, equip3c, equip3d];
  const allWater = [water1, water2, water3, water4];
  
  for (const p of allProps) await dbPut('properties', p);
  for (const e of allEquip) await dbPut('equipment', e);
  for (const w of allWater) await dbPut('waterlog', w);
  
  localStorage.removeItem('pv_demo_dismissed');
  // Only show toast if not first load (static cards are showing)
  const staticEl = document.getElementById('static-demo-cards');
  if (!staticEl) {
    showToast('Demo data loaded — 3 properties, 10 equipment items', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>');
    renderProperties();
  }
  // If static cards exist, leave them — they'll be replaced on next user action
}

function dismissDemo() {
  localStorage.setItem('pv_demo_dismissed', 'true');
  document.getElementById('demoBanner').style.display = 'none';
}

async function clearAllData() {
  if (!confirm('This will permanently delete ALL data. Are you sure?')) return;
  if (!confirm('Really? This cannot be undone.')) return;
  await dbClear('properties');
  await dbClear('equipment');
  await dbClear('waterlog');
  localStorage.removeItem('pv_demo_dismissed');
  showToast('All data cleared', '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>️');
  renderProperties();
}

// ========== PRINT ==========
function printReport() {
  window.print();
}

function openSettingsModal(section) {
  switchTab('settings');
}

// ========== INIT ==========
async function init() {
  try {
    await openDB();
    const props = await dbGetAll('properties');
    if (props.length === 0) {
      // First visit — load demo data into IndexedDB
      // Static cards already visible, so don't re-render immediately
      await loadDemoData();
    } else {
      // Has existing data — replace static cards with live DB content
      renderProperties();
    }
  } catch(e) {
    // IndexedDB failed; static cards remain visible as fallback
    console.log('Init with static demo cards');
  }
}

// Start
document.addEventListener('DOMContentLoaded', init);

// Fallback: if IndexedDB fails/slow, render demo from memory after 500ms
setTimeout(async () => {
  const container = document.getElementById('propertyList');
  if (container && container.innerHTML.trim() === '') {
    // Force render check
    try {
      const props = await dbGetAll('properties');
      if (props.length > 0) renderProperties();
    } catch(e) {}
  }
}, 500);
</script>
<script src="http://35.212.159.12/booking-api/tracker.js" async></script>
</body>
</html>