<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ScreenQuote - Daniel's Screen Services</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--red:#D82907;--red-dark:#B82006;--teal:#4DBBC2;--teal-light:#E8F7F8;
--dark:#1A1A1A;--mid:#555;--light:#F5F5F5;--white:#FFF;
--green:#2D8B4E;--orange:#E67E22;--error:#C0392B;
--shadow-sm:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.06);
--shadow-md:0 4px 12px rgba(0,0,0,.1),0 2px 4px rgba(0,0,0,.06);
--shadow-lg:0 12px 40px rgba(0,0,0,.12),0 4px 12px rgba(0,0,0,.08);
--radius:12px;--radius-sm:8px;
}
html{font-size:16px;-webkit-tap-highlight-color:transparent}
body{font-family:'Roboto',sans-serif;color:var(--dark);background:var(--light);min-height:100vh;padding-bottom:120px;overflow-x:hidden;-webkit-font-smoothing:antialiased}
body.noscroll{overflow:hidden}
h1,h2,h3,h4{font-family:'Montserrat',sans-serif;line-height:1.2}
h1{font-size:1.5rem;font-weight:700}
h2{font-size:1.25rem;font-weight:700}
h3{font-size:1.1rem;font-weight:600}
h4{font-size:1rem;font-weight:600}
a{color:var(--teal);text-decoration:none}
button{font-family:inherit;cursor:pointer;border:none;background:none;font-size:inherit}
input,select,textarea{font-family:inherit;font-size:1rem}

/* Skip Link */
.skip-link{position:absolute;top:-40px;left:0;background:var(--red);color:var(--white);padding:8px 16px;z-index:10000;font-size:.875rem;border-radius:0 0 8px 0}
.skip-link:focus{top:0}

/* Top Bar */
.topbar{background:var(--dark);color:var(--white);padding:12px 16px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:100}
.topbar h1{font-size:1.1rem;flex:1}
.topbar .logo-mark{width:32px;height:32px;background:var(--red);border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0}

/* Views */
.view{display:none;padding:16px;animation:fadeUp .4s ease-out both}
.view.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

/* Cards */
.card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow-sm);padding:20px;margin-bottom:16px;transition:box-shadow .2s,transform .15s}
.card:hover{box-shadow:var(--shadow-md)}

/* Buttons */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border-radius:var(--radius-sm);font-weight:500;font-size:.95rem;transition:transform .15s,box-shadow .15s,background .15s;-webkit-user-select:none;user-select:none;min-height:48px}
.btn:active{transform:scale(.97)}
.btn svg{width:20px;height:20px;flex-shrink:0}
.btn-primary{background:var(--red);color:var(--white);box-shadow:var(--shadow-sm)}
.btn-primary:hover{background:var(--red-dark);box-shadow:var(--shadow-md)}
.btn-primary:focus-visible{outline:3px solid var(--teal);outline-offset:2px}
.btn-secondary{background:var(--teal);color:var(--white);box-shadow:var(--shadow-sm)}
.btn-secondary:hover{background:#3AA8B0;box-shadow:var(--shadow-md)}
.btn-secondary:focus-visible{outline:3px solid var(--red);outline-offset:2px}
.btn-outline{border:2px solid var(--dark);color:var(--dark);background:transparent}
.btn-outline:hover{background:var(--dark);color:var(--white)}
.btn-outline:focus-visible{outline:3px solid var(--teal);outline-offset:2px}
.btn-ghost{color:var(--mid);padding:8px 12px}
.btn-ghost:hover{color:var(--dark);background:rgba(0,0,0,.04)}
.btn-ghost:focus-visible{outline:2px solid var(--teal);outline-offset:2px}
.btn-full{width:100%}
.btn-danger{background:var(--error);color:var(--white)}
.btn-sm{padding:8px 16px;font-size:.85rem;min-height:36px}
.btn-disabled{opacity:.4;pointer-events:none;background:#ccc;color:#888}

/* Form Elements */
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:.8rem;font-weight:500;color:var(--mid);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:12px 14px;border:2px solid #E0E0E0;border-radius:var(--radius-sm);font-size:1rem;background:var(--white);color:var(--dark);transition:border-color .2s,box-shadow .2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--teal);box-shadow:0 0 0 3px rgba(77,187,194,.15)}
.form-group input::placeholder{color:#999}
.form-group textarea{resize:vertical;min-height:80px}
.form-group select{-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23555' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center}
.form-group input:invalid{border-color:var(--error)}
.form-group input:invalid:focus{box-shadow:0 0 0 3px rgba(192,57,43,.15)}

/* Panel List */
.panel-row{display:flex;align-items:center;gap:10px;padding:12px 0;border-bottom:1px solid #F0F0F0}
.panel-row:last-child{border-bottom:none}
.panel-info{flex:1;min-width:0}
.panel-info .panel-label{font-weight:500;font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.panel-info .panel-dims{font-size:.8rem;color:var(--mid)}
.panel-price{font-weight:600;font-family:'Montserrat',sans-serif;color:var(--dark);font-size:.95rem;white-space:nowrap}
.panel-actions{display:flex;gap:4px}
.panel-actions button{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;transition:background .15s}
.panel-actions button:hover{background:rgba(0,0,0,.06)}
.panel-actions button:focus-visible{outline:2px solid var(--teal);outline-offset:1px}
.panel-actions svg{width:18px;height:18px;stroke:var(--mid);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

/* Estimate Summary */
.summary-bar{background:var(--dark);color:var(--white);padding:16px 20px;border-radius:var(--radius);display:flex;align-items:center;justify-content:space-between;margin:16px 0}
.summary-bar .total-label{font-size:.8rem;opacity:.7;text-transform:uppercase;letter-spacing:.5px}
.summary-bar .total-amount{font-family:'Montserrat',sans-serif;font-size:1.75rem;font-weight:800}

/* Photo Grid */
.photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin:12px 0}
.photo-thumb{position:relative;border-radius:var(--radius-sm);overflow:hidden;aspect-ratio:1;background:#E0E0E0}
.photo-thumb img{width:100%;height:100%;object-fit:cover}
.photo-thumb .remove-photo{position:absolute;top:4px;right:4px;width:24px;height:24px;background:rgba(0,0,0,.6);border-radius:50%;display:flex;align-items:center;justify-content:center}
.photo-thumb .remove-photo:focus-visible{outline:2px solid var(--white);outline-offset:2px}
.photo-thumb .remove-photo svg{width:14px;height:14px;stroke:var(--white)}
.add-photo-btn{aspect-ratio:1;border:2px dashed #CCC;border-radius:var(--radius-sm);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;color:var(--mid);font-size:.75rem;cursor:pointer;transition:border-color .2s,color .2s}
.add-photo-btn:hover{border-color:var(--teal);color:var(--teal)}
.add-photo-btn:focus-visible{outline:2px solid var(--teal);outline-offset:2px}
.add-photo-btn svg{width:28px;height:28px;stroke:currentColor;fill:none;stroke-width:1.5}

/* Estimate Cards (list view) */
.estimate-card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow-sm);padding:16px;margin-bottom:12px;display:flex;gap:12px;align-items:flex-start;cursor:pointer;transition:box-shadow .2s,transform .15s}
.estimate-card:hover{box-shadow:var(--shadow-md);transform:translateY(-1px)}
.estimate-card:focus-visible{outline:2px solid var(--teal);outline-offset:2px}
.estimate-card .thumb{width:56px;height:56px;border-radius:8px;background:var(--teal-light);flex-shrink:0;display:flex;align-items:center;justify-content:center;overflow:hidden}
.estimate-card .thumb img{width:100%;height:100%;object-fit:cover}
.estimate-card .thumb svg{width:28px;height:28px;stroke:var(--teal);fill:none;stroke-width:1.5}
.estimate-card .info{flex:1;min-width:0}
.estimate-card .info h4{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.estimate-card .info .meta{font-size:.8rem;color:var(--mid);margin-top:2px}
.estimate-card .price{font-family:'Montserrat',sans-serif;font-weight:700;font-size:1rem;color:var(--dark);white-space:nowrap}
.estimate-card .status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}
.status-sent{background:var(--green)}
.status-draft{background:var(--orange)}

/* Tab nav */
nav.tabs{position:fixed;bottom:0;left:0;right:0;background:var(--white);border-top:1px solid #E8E8E8;display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom)}
nav.tabs button{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 0 6px;font-size:.65rem;font-weight:500;color:var(--mid);transition:color .2s;min-height:56px;gap:3px}
nav.tabs button svg{width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;transition:stroke .2s}
nav.tabs button.active{color:var(--red)}
nav.tabs button.active svg{stroke:var(--red)}
nav.tabs button:focus-visible{outline:2px solid var(--teal);outline-offset:-2px}

/* Demo banner */
.demo-banner{background:#FFF3CD;border-bottom:1px solid #FFEAA7;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;font-size:.85rem;color:#856404}
.demo-banner button{background:none;border:none;font-size:1.1rem;color:#856404;padding:4px 8px;cursor:pointer;border-radius:4px}
.demo-banner button:hover{background:rgba(0,0,0,.05)}
.demo-banner button:focus-visible{outline:2px solid var(--teal)}

/* Upsell */
.upsell-card{background:linear-gradient(135deg,#F8F9FA 0%,#E9ECEF 100%);border:2px dashed #CED4DA;border-radius:var(--radius);padding:20px;text-align:center;margin:16px 0}
.upsell-card h4{color:var(--mid);margin-bottom:8px}
.upsell-card p{font-size:.85rem;color:#888;margin-bottom:12px}

/* Toast */
.toast-container{position:fixed;top:80px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--dark);color:var(--white);padding:12px 20px;border-radius:var(--radius-sm);box-shadow:var(--shadow-lg);font-size:.9rem;display:flex;align-items:center;gap:8px;animation:slideIn .3s ease-out;max-width:320px}
.toast svg{width:18px;height:18px;flex-shrink:0}
.toast.success svg{stroke:var(--green)}
.toast.error svg{stroke:var(--error)}
@keyframes slideIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}

/* Undo toast */
.undo-toast{background:var(--dark);color:var(--white);position:fixed;bottom:80px;left:16px;right:16px;padding:12px 16px;border-radius:var(--radius-sm);box-shadow:var(--shadow-lg);display:flex;align-items:center;justify-content:space-between;z-index:9999;animation:fadeUp .3s ease-out}
.undo-toast button{color:var(--teal);font-weight:600;padding:4px 12px;border-radius:4px}
.undo-toast button:hover{background:rgba(255,255,255,.1)}
.undo-toast button:focus-visible{outline:2px solid var(--teal);outline-offset:2px}

/* Settings page */
.price-row{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid #F0F0F0}
.price-row label{flex:1;font-weight:400;font-size:.9rem}
.price-row input{width:100px;text-align:right}

/* Empty state */
.empty-state{text-align:center;padding:48px 16px;color:var(--mid)}
.empty-state svg{display:block;margin:0 auto 16px}
.empty-state h3{margin-bottom:8px;color:var(--dark);font-size:1.1rem}
.empty-state p{font-size:.9rem;line-height:1.5}

/* Modal backdrop */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:none}
.modal-backdrop.active{display:block}

/* Print */
@media print{
  nav.tabs,.topbar,.demo-banner,#bct-demo-disclaimer,.btn,.upsell-card,.toast-container,.undo-toast{display:none!important}
  body{padding:0;background:#fff}
  .view{display:block!important;padding:20px}
  .card{box-shadow:none;border:1px solid #ddd}
}

/* Reduced motion */
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:.01ms!important;transition-duration:.01ms!important}}

/* Focus visible */
*:focus-visible{outline:2px solid var(--teal);outline-offset:2px}
*:focus:not(:focus-visible){outline:none}

/* High contrast mode support */
@media(prefers-contrast:more){
  .btn-primary,.btn-secondary{outline:2px solid currentColor;outline-offset:-4px}
  .form-group input,.form-group select,.form-group textarea{border-width:3px}
}

/* Responsive */
@media(min-width:768px){
  .view{max-width:600px;margin:0 auto;padding:24px 16px}
  .topbar{justify-content:center}
  .topbar h1{flex:none}
  nav.tabs{max-width:600px;left:50%;transform:translateX(-50%);border-radius:12px 12px 0 0;border:1px solid #E8E8E8;border-bottom:none}
}
</style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to main content</a>

<!-- Demo Banner -->
<div class="demo-banner" id="demoBanner" role="alert" style="display:none">
  <span>Sample estimates loaded. Tap X to clear and start fresh.</span>
  <button onclick="clearDemoData()" aria-label="Clear demo data">X</button>
</div>

<!-- Top Bar -->
<div class="topbar" role="banner">
  <div class="logo-mark" aria-hidden="true">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
  </div>
  <h1>ScreenQuote</h1>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>

<!-- Modal Backdrop -->
<div class="modal-backdrop" id="modalBackdrop" onclick="closeAddPanel()" aria-hidden="true"></div>

<!-- Main Content -->
<main id="main-content">

<!-- VIEW: Estimates List -->
<section class="view active" id="viewEstimates" role="region" aria-label="Estimates list">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
    <h2>Estimates</h2>
    <button class="btn btn-primary" onclick="startNewEstimate()" aria-label="Create new estimate">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      New Estimate
    </button>
  </div>
  <div id="estimatesList"></div>
</section>

<!-- VIEW: Estimate Builder -->
<section class="view" id="viewBuilder" role="region" aria-label="Estimate builder">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">
    <button class="btn-ghost" onclick="goBack()" aria-label="Back to estimates">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    </button>
    <h2 id="builderTitle">New Estimate</h2>
  </div>

  <!-- Customer Info -->
  <div class="card">
    <h3 style="margin-bottom:12px">Customer Info</h3>
    <div class="form-group">
      <label for="custName">Customer Name</label>
      <input type="text" id="custName" placeholder="John Smith" autocomplete="name" required aria-required="true">
    </div>
    <div class="form-group">
      <label for="custAddress">Job Address</label>
      <input type="text" id="custAddress" placeholder="1247 SW Pine Island Rd, Cape Coral" autocomplete="street-address">
    </div>
    <div class="form-group">
      <label for="custPhone">Phone</label>
      <input type="tel" id="custPhone" placeholder="(239) 555-0123" autocomplete="tel">
    </div>
  </div>

  <!-- Photos -->
  <div class="card">
    <h3 style="margin-bottom:12px">Site Photos</h3>
    <div class="photo-grid" id="photoGrid">
      <button class="add-photo-btn" onclick="takePhoto()" aria-label="Take or add photo">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
        Add Photo
      </button>
    </div>
    <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none" multiple aria-label="Photo file input">
  </div>

  <!-- Screen Type -->
  <div class="card">
    <h3 style="margin-bottom:12px">Screen Type</h3>
    <div class="form-group">
      <label for="screenType">Mesh Material</label>
      <select id="screenType" onchange="recalcTotal()">
        <option value="fiberglass">Standard Fiberglass (18x14)</option>
        <option value="phifer2020">Phifer 20x20</option>
        <option value="tuffscreen">Tuff Screen</option>
        <option value="superscreen">Super Screen</option>
        <option value="privacy">Privacy Screen</option>
        <option value="petscreen">Pet Screen</option>
        <option value="noSee">No-See-Um (20x20 Fine)</option>
      </select>
    </div>
    <div class="form-group">
      <label for="jobType">Job Type</label>
      <select id="jobType">
        <option value="rescreen">Rescreen (existing frame)</option>
        <option value="newScreen">New Screen Installation</option>
        <option value="repair">Panel Repair</option>
        <option value="rescreenDoor">Screen Door Rescreen</option>
        <option value="fullCage">Full Pool Cage Rescreen</option>
      </select>
    </div>
  </div>

  <!-- Panels -->
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <h3>Panels</h3>
      <button class="btn btn-sm btn-secondary" onclick="openAddPanel()" aria-label="Add panel">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add Panel
      </button>
    </div>
    <div id="panelsList"></div>
    <div id="noPanels" style="text-align:center;padding:32px 24px;color:var(--mid)">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#CCC" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="display:block;margin:0 auto 12px"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
      <p style="font-size:.95rem;margin-bottom:4px">No panels yet</p>
      <p style="font-size:.85rem;opacity:.8">Tap "Add Panel" to start measuring</p>
    </div>
  </div>

  <!-- Extras -->
  <div class="card">
    <h3 style="margin-bottom:12px">Extras</h3>
    <div class="form-group">
      <label for="frameFootage">Frame Replacement (linear feet)</label>
      <input type="number" id="frameFootage" value="0" min="0" step="1" onchange="recalcTotal()" aria-label="Frame replacement in linear feet">
    </div>
    <div class="form-group">
      <label for="doorCount">Screen Doors</label>
      <input type="number" id="doorCount" value="0" min="0" step="1" onchange="recalcTotal()" aria-label="Number of screen doors">
    </div>
    <div class="form-group">
      <label for="notes">Notes</label>
      <textarea id="notes" placeholder="Cross bars removed, lanai faces west, frame in good shape..."></textarea>
    </div>
  </div>

  <!-- Total -->
  <div class="summary-bar">
    <div>
      <div class="total-label">Estimate Total</div>
      <div class="total-amount" id="totalAmount">$0</div>
    </div>
    <div style="text-align:right">
      <div class="total-label" id="panelCount">0 panels</div>
      <div style="font-size:.85rem;opacity:.7" id="sqftTotal">0 sq ft</div>
    </div>
  </div>

  <!-- Actions -->
  <button class="btn btn-primary btn-full" onclick="saveEstimate()" style="margin-bottom:12px">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>
    Save Estimate
  </button>
  <button class="btn btn-secondary btn-full" onclick="shareEstimate()" style="margin-bottom:12px">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
    Share with Customer
  </button>
  <div class="upsell-card">
    <h4>PDF Reports</h4>
    <p>Print-ready estimates with your logo and job photos.</p>
    <button class="btn btn-sm btn-disabled" aria-disabled="true">Available in Full Version</button>
  </div>
</section>

<!-- VIEW: Add Panel Modal -->
<section class="view" id="viewAddPanel" role="dialog" aria-modal="true" aria-labelledby="addPanelTitle" tabindex="-1">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">
    <button class="btn-ghost" onclick="closeAddPanel()" aria-label="Cancel and close">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    </button>
    <h2 id="addPanelTitle">Add Panel</h2>
  </div>
  <div class="card">
    <div class="form-group">
      <label for="panelWidth">Width (inches)</label>
      <input type="number" id="panelWidth" placeholder="48" min="1" max="240" step="0.5" required aria-required="true">
    </div>
    <div class="form-group">
      <label for="panelHeight">Height (inches)</label>
      <input type="number" id="panelHeight" placeholder="72" min="1" max="240" step="0.5" required aria-required="true">
    </div>
    <div class="form-group">
      <label for="panelQty">Quantity</label>
      <input type="number" id="panelQty" value="1" min="1" max="50" aria-label="Panel quantity">
    </div>
    <div class="form-group">
      <label for="panelNote">Note (optional)</label>
      <input type="text" id="panelNote" placeholder="South side, near pool pump">
    </div>

    <h4 style="margin:16px 0 8px;color:var(--mid)">Quick Sizes</h4>
    <div style="display:flex;flex-wrap:wrap;gap:8px">
      <button class="btn btn-sm btn-outline" onclick="setQuickSize(36,72)">36x72</button>
      <button class="btn btn-sm btn-outline" onclick="setQuickSize(48,72)">48x72</button>
      <button class="btn btn-sm btn-outline" onclick="setQuickSize(48,96)">48x96</button>
      <button class="btn btn-sm btn-outline" onclick="setQuickSize(60,96)">60x96</button>
      <button class="btn btn-sm btn-outline" onclick="setQuickSize(72,96)">72x96</button>
      <button class="btn btn-sm btn-outline" onclick="setQuickSize(36,80)">36x80 Door</button>
    </div>
  </div>
  <button class="btn btn-primary btn-full" onclick="addPanel()" style="margin-top:12px">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
    <span id="addPanelBtnText">Add Panel</span>
  </button>
</section>

<!-- VIEW: Estimate Detail -->
<section class="view" id="viewDetail" role="region" aria-label="Estimate detail">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">
    <button class="btn-ghost" onclick="showView('viewEstimates');loadEstimatesList()" aria-label="Back to estimates">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    </button>
    <h2 id="detailTitle">Estimate</h2>
  </div>
  <div id="detailContent"></div>
</section>

<!-- VIEW: Pricing Settings -->
<section class="view" id="viewSettings" role="region" aria-label="Pricing settings">
  <h2 style="margin-bottom:16px">Pricing</h2>
  <div class="card">
    <h3 style="margin-bottom:12px">Screen Material (per sq ft)</h3>
    <div id="materialPrices"></div>
  </div>
  <div class="card">
    <h3 style="margin-bottom:12px">Labor & Extras</h3>
    <div class="price-row">
      <label for="priceLabor">Labor per panel ($)</label>
      <input type="number" id="priceLabor" step="0.5" min="0" onchange="savePricing()" aria-label="Labor cost per panel">
    </div>
    <div class="price-row">
      <label for="priceFrame">Frame per linear ft ($)</label>
      <input type="number" id="priceFrame" step="0.5" min="0" onchange="savePricing()" aria-label="Frame cost per linear foot">
    </div>
    <div class="price-row">
      <label for="priceDoor">Screen door each ($)</label>
      <input type="number" id="priceDoor" step="5" min="0" onchange="savePricing()" aria-label="Screen door cost each">
    </div>
    <div class="price-row">
      <label for="priceSpline">Spline per linear ft ($)</label>
      <input type="number" id="priceSpline" step="0.1" min="0" onchange="savePricing()" aria-label="Spline cost per linear foot">
    </div>
  </div>
  <div class="card">
    <h3 style="margin-bottom:12px">Data</h3>
    <button class="btn btn-outline btn-full" onclick="exportData()" style="margin-bottom:8px">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Export All Data (JSON)
    </button>
    <button class="btn btn-outline btn-full" onclick="document.getElementById('importInput').click()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      Import Data (JSON)
    </button>
    <input type="file" id="importInput" accept=".json" style="display:none" aria-label="Import data file">
  </div>
</section>

</main>

<!-- Bottom Tab Nav -->
<nav class="tabs" role="navigation" aria-label="Main navigation">
  <button class="active" onclick="switchTab('viewEstimates',this)" aria-label="Estimates" aria-current="page">
    <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
    Estimates
  </button>
  <button onclick="startNewEstimate();switchTab('viewBuilder',this)" aria-label="New estimate">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
    New
  </button>
  <button onclick="switchTab('viewSettings',this)" aria-label="Pricing settings">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.32 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
    Pricing
  </button>
</nav>

<!-- Legal Disclaimer -->
<div id="bct-demo-disclaimer" role="contentinfo" aria-label="Demo disclaimer" style="position:fixed;bottom:56px;left:0;right:0;background:#f8f8f8;border-top:1px solid #ddd;padding:8px 16px;font-size:11px;line-height:1.4;color:#666;z-index:99999;display:flex;flex-wrap:wrap;align-items:center;justify-content:center;gap:6px 12px;text-align:center;">
  <p style="margin:0;max-width:600px;"><strong style="color:#333;">DEMO NOTICE:</strong> This tool was created by BennyCuTools as a free demonstration only. It is not affiliated with, endorsed by, or authorized by Daniel's Screen Services. All brand references are used solely for demonstration purposes.</p>
  <a href="mailto:cuuper225@gmail.com?subject=Delete%20Demo%3A%20Daniels%20Screen%20Services&body=I%20am%20the%20owner%20and%20I%20request%20permanent%20deletion%20of%20this%20demo." style="display:inline-flex;align-items:center;gap:4px;background:#dc3545;color:#fff;padding:4px 10px;border-radius:4px;text-decoration:none;font-size:10px;font-weight:500;white-space:nowrap;">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
    Request Permanent Deletion
  </a>
</div>

<script>
// === ACCESS CONTROL ===
function _h(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return h;}
const _V=-892796339;
const _k=new URLSearchParams(window.location.search).get('key');
if(!_k||_h(_k)!==_V){
  document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;background:#111;color:#fff;text-align:center;padding:20px"><div><h1 style="font-size:2rem;margin-bottom:1rem">Access Required</h1><p style="color:#999">This tool needs a valid access key.</p><p style="margin-top:1rem"><a href="mailto:ben@bennycutools.com" style="color:#4da6ff">ben@bennycutools.com</a></p></div></div>';
  throw new Error('No key');
}
document.addEventListener('contextmenu',e=>e.preventDefault());

// === DATABASE ===
let db;
const DB_NAME='ScreenQuoteDB';
const DB_VER=1;

function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,DB_VER);
    req.onupgradeneeded=e=>{
      const d=e.target.result;
      if(!d.objectStoreNames.contains('estimates')){
        const store=d.createObjectStore('estimates',{keyPath:'id'});
        store.createIndex('created','created');
      }
    };
    req.onsuccess=e=>{db=e.target.result;resolve(db)};
    req.onerror=e=>reject(e);
  });
}

function dbPut(data){
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('estimates','readwrite');
    tx.objectStore('estimates').put(data);
    tx.oncomplete=()=>resolve();
    tx.onerror=e=>reject(e);
  });
}

function dbGetAll(){
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('estimates','readonly');
    const req=tx.objectStore('estimates').getAll();
    req.onsuccess=()=>resolve(req.result);
    req.onerror=e=>reject(e);
  });
}

function dbDelete(id){
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('estimates','readwrite');
    tx.objectStore('estimates').delete(id);
    tx.oncomplete=()=>resolve();
    tx.onerror=e=>reject(e);
  });
}

// === DEFAULT PRICING ===
const DEFAULT_PRICING={
  materials:{
    fiberglass:0.35,phifer2020:0.55,tuffscreen:0.85,
    superscreen:1.10,privacy:1.25,petscreen:1.50,noSee:0.65
  },
  labor:15,frame:4.50,door:175,spline:0.25
};

const MATERIAL_NAMES={
  fiberglass:'Standard Fiberglass (18x14)',phifer2020:'Phifer 20x20',
  tuffscreen:'Tuff Screen',superscreen:'Super Screen',
  privacy:'Privacy Screen',petscreen:'Pet Screen',noSee:'No-See-Um (20x20 Fine)'
};

function getPricing(){
  try{const p=JSON.parse(localStorage.getItem('sq_pricing'));return p||{...DEFAULT_PRICING}}
  catch(e){return{...DEFAULT_PRICING}}
}

function savePricing(){
  const p=getPricing();
  p.labor=parseFloat(document.getElementById('priceLabor').value)||0;
  p.frame=parseFloat(document.getElementById('priceFrame').value)||0;
  p.door=parseFloat(document.getElementById('priceDoor').value)||0;
  p.spline=parseFloat(document.getElementById('priceSpline').value)||0;
  document.querySelectorAll('[data-mat-price]').forEach(el=>{
    const key=el.dataset.matPrice;
    p.materials[key]=parseFloat(el.value)||0;
  });
  localStorage.setItem('sq_pricing',JSON.stringify(p));
  showToast('Pricing saved','success');
  recalcTotal();
}

function loadSettingsView(){
  const p=getPricing();
  document.getElementById('priceLabor').value=p.labor;
  document.getElementById('priceFrame').value=p.frame;
  document.getElementById('priceDoor').value=p.door;
  document.getElementById('priceSpline').value=p.spline;
  let html='';
  for(const[key,name]of Object.entries(MATERIAL_NAMES)){
    html+=`<div class="price-row"><label for="mat_${key}">${name}</label><input type="number" id="mat_${key}" data-mat-price="${key}" step="0.05" min="0" value="${p.materials[key]||0}" onchange="savePricing()" aria-label="${name} price per square foot"></div>`;
  }
  document.getElementById('materialPrices').innerHTML=html;
}

// === STATE ===
let currentEstimate=null;
let currentPanels=[];
let currentPhotos=[];
let editingPanelIdx=-1;
let previousFocus=null;

// === VIEW MANAGEMENT ===
function showView(id){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  const view=document.getElementById(id);
  view.classList.add('active');
  // Focus management for modals
  if(id==='viewAddPanel'){
    previousFocus=document.activeElement;
    setTimeout(()=>document.getElementById('panelWidth').focus(),100);
  }
  window.scrollTo(0,0);
}

function switchTab(viewId,btn){
  document.querySelectorAll('nav.tabs button').forEach(b=>{b.classList.remove('active');b.removeAttribute('aria-current')});
  if(btn){btn.classList.add('active');btn.setAttribute('aria-current','page')}
  if(viewId==='viewEstimates')loadEstimatesList();
  if(viewId==='viewSettings')loadSettingsView();
  showView(viewId);
}

function goBack(){
  switchTab('viewEstimates',document.querySelector('nav.tabs button:first-child'));
  loadEstimatesList();
}

// === KEYBOARD NAVIGATION ===
document.addEventListener('keydown',function(e){
  // Close modal on Escape
  if(e.key==='Escape'&&document.getElementById('viewAddPanel').classList.contains('active')){
    closeAddPanel();
  }
});

// === ESTIMATE LIST ===
async function loadEstimatesList(){
  const estimates=await dbGetAll();
  const container=document.getElementById('estimatesList');
  if(!estimates.length){
    container.innerHTML=`<div class="empty-state">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#CCC" stroke-width="1"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
      <h3>You're all caught up</h3>
      <p>No estimates yet. Tap "New Estimate" when you're ready to quote a job.</p>
    </div>`;
    return;
  }
  estimates.sort((a,b)=>b.created-a.created);
  container.innerHTML=estimates.map(est=>{
    const date=new Date(est.created).toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const status=est.shared?'sent':'draft';
    const statusLabel=est.shared?'Sent':'Draft';
    const hasPhoto=est.photos&&est.photos.length>0;
    return`<div class="estimate-card" tabindex="0" role="button" aria-label="View estimate for ${est.customer||'Unknown'}, ${statusLabel}, ${date}, ${est.panels?est.panels.length:0} panels, $${(est.total||0).toLocaleString()}" onclick="openEstimate('${est.id}')" onkeydown="if(event.key==='Enter'||event.key===' ')openEstimate('${est.id}')">
      <div class="thumb">${hasPhoto?`<img src="${est.photos[0]}" alt="">`:`<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="3" x2="9" y2="21"/></svg>`}</div>
      <div class="info"><h4>${est.customer||'No name'}</h4><p class="meta"><span class="status-dot status-${status}" aria-hidden="true"></span>${statusLabel} · ${date} · ${est.panels?est.panels.length:0} panels</p></div>
      <div class="price">$${(est.total||0).toLocaleString()}</div>
    </div>`;
  }).join('');
}

// === NEW ESTIMATE ===
function startNewEstimate(){
  currentEstimate={id:crypto.randomUUID(),created:Date.now(),shared:false};
  currentPanels=[];
  currentPhotos=[];
  document.getElementById('custName').value='';
  document.getElementById('custAddress').value='';
  document.getElementById('custPhone').value='';
  document.getElementById('screenType').value='fiberglass';
  document.getElementById('jobType').value='rescreen';
  document.getElementById('frameFootage').value='0';
  document.getElementById('doorCount').value='0';
  document.getElementById('notes').value='';
  document.getElementById('builderTitle').textContent='New Estimate';
  renderPanels();
  renderPhotos();
  recalcTotal();
  showView('viewBuilder');
}

// === PANELS ===
function openAddPanel(){
  editingPanelIdx=-1;
  document.getElementById('panelWidth').value='';
  document.getElementById('panelHeight').value='';
  document.getElementById('panelQty').value='1';
  document.getElementById('panelNote').value='';
  document.getElementById('addPanelTitle').textContent='Add Panel';
  document.getElementById('addPanelBtnText').textContent='Add Panel';
  document.getElementById('modalBackdrop').classList.add('active');
  showView('viewAddPanel');
}

function closeAddPanel(){
  document.getElementById('modalBackdrop').classList.remove('active');
  showView('viewBuilder');
  // Restore focus
  if(previousFocus){
    previousFocus.focus();
    previousFocus=null;
  }
}

function setQuickSize(w,h){
  document.getElementById('panelWidth').value=w;
  document.getElementById('panelHeight').value=h;
}

function addPanel(){
  const w=parseFloat(document.getElementById('panelWidth').value);
  const h=parseFloat(document.getElementById('panelHeight').value);
  const qty=parseInt(document.getElementById('panelQty').value)||1;
  const note=document.getElementById('panelNote').value.trim();
  if(!w||!h||w<=0||h<=0){
    showToast('Add the width and height first','error');
    document.getElementById('panelWidth').focus();
    return;
  }
  const panel={w,h,qty,note};
  if(editingPanelIdx>=0){currentPanels[editingPanelIdx]=panel}
  else{currentPanels.push(panel)}
  renderPanels();recalcTotal();closeAddPanel();
  showToast(editingPanelIdx>=0?'Panel updated':'Panel added','success');
}

function editPanel(idx){
  editingPanelIdx=idx;
  const p=currentPanels[idx];
  document.getElementById('panelWidth').value=p.w;
  document.getElementById('panelHeight').value=p.h;
  document.getElementById('panelQty').value=p.qty;
  document.getElementById('panelNote').value=p.note||'';
  document.getElementById('addPanelTitle').textContent='Edit Panel';
  document.getElementById('addPanelBtnText').textContent='Update Panel';
  document.getElementById('modalBackdrop').classList.add('active');
  showView('viewAddPanel');
}

function removePanel(idx){
  const removed=currentPanels.splice(idx,1)[0];
  renderPanels();recalcTotal();
  showUndoToast('Panel removed',()=>{currentPanels.splice(idx,0,removed);renderPanels();recalcTotal()});
}

function renderPanels(){
  const container=document.getElementById('panelsList');
  const noPanels=document.getElementById('noPanels');
  if(!currentPanels.length){container.innerHTML='';noPanels.style.display='block';return}
  noPanels.style.display='none';
  const pricing=getPricing();
  const screenType=document.getElementById('screenType').value;
  container.innerHTML=currentPanels.map((p,i)=>{
    const sqft=(p.w*p.h/144)*p.qty;
    const matCost=sqft*(pricing.materials[screenType]||0);
    const laborCost=p.qty*pricing.labor;
    const splineCost=((p.w+p.h)*2/12)*p.qty*pricing.spline;
    const cost=matCost+laborCost+splineCost;
    return`<div class="panel-row">
      <div class="panel-info"><div class="panel-label">${p.w}"×${p.h}" ${p.qty>1?'×'+p.qty:''}</div><div class="panel-dims">${sqft.toFixed(1)} sq ft${p.note?' · '+p.note:''}</div></div>
      <div class="panel-price">$${cost.toFixed(0)}</div>
      <div class="panel-actions">
        <button onclick="editPanel(${i})" aria-label="Edit panel ${i+1}"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
        <button onclick="removePanel(${i})" aria-label="Remove panel ${i+1}"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button>
      </div>
    </div>`;
  }).join('');
}

function recalcTotal(){
  const pricing=getPricing();
  const screenType=document.getElementById('screenType')?document.getElementById('screenType').value:'fiberglass';
  let totalSqft=0;let totalPanels=0;let total=0;
  currentPanels.forEach(p=>{
    const sqft=(p.w*p.h/144)*p.qty;
    totalSqft+=sqft;totalPanels+=p.qty;
    total+=sqft*(pricing.materials[screenType]||0);
    total+=p.qty*pricing.labor;
    total+=((p.w+p.h)*2/12)*p.qty*pricing.spline;
  });
  const frameFt=parseFloat(document.getElementById('frameFootage')?document.getElementById('frameFootage').value:0)||0;
  const doors=parseInt(document.getElementById('doorCount')?document.getElementById('doorCount').value:0)||0;
  total+=frameFt*pricing.frame;
  total+=doors*pricing.door;
  if(document.getElementById('totalAmount'))document.getElementById('totalAmount').textContent='$'+Math.round(total).toLocaleString();
  if(document.getElementById('panelCount'))document.getElementById('panelCount').textContent=totalPanels+' panel'+(totalPanels!==1?'s':'');
  if(document.getElementById('sqftTotal'))document.getElementById('sqftTotal').textContent=totalSqft.toFixed(0)+' sq ft';
  renderPanels();
  return total;
}

// === PHOTOS ===
function takePhoto(){document.getElementById('photoInput').click()}

document.getElementById('photoInput').addEventListener('change',function(e){
  Array.from(e.target.files).forEach(file=>{
    const reader=new FileReader();
    reader.onload=ev=>{currentPhotos.push(ev.target.result);renderPhotos()};
    reader.readAsDataURL(file);
  });
  e.target.value='';
});

function renderPhotos(){
  const grid=document.getElementById('photoGrid');
  let html=currentPhotos.map((src,i)=>`<div class="photo-thumb"><img src="${src}" alt="Site photo ${i+1}"><button class="remove-photo" onclick="removePhoto(${i})" aria-label="Remove photo ${i+1}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>`).join('');
  html+=`<button class="add-photo-btn" onclick="takePhoto()" aria-label="Take or add photo"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>Add Photo</button>`;
  grid.innerHTML=html;
}

function removePhoto(i){currentPhotos.splice(i,1);renderPhotos()}

// === SAVE ESTIMATE ===
async function saveEstimate(){
  const name=document.getElementById('custName').value.trim();
  const address=document.getElementById('custAddress').value.trim();
  if(!name){showToast('Add a customer name first','error');document.getElementById('custName').focus();return}
  currentEstimate.customer=name;
  currentEstimate.address=address;
  currentEstimate.phone=document.getElementById('custPhone').value.trim();
  currentEstimate.screenType=document.getElementById('screenType').value;
  currentEstimate.jobType=document.getElementById('jobType').value;
  currentEstimate.panels=[...currentPanels];
  currentEstimate.photos=[...currentPhotos];
  currentEstimate.frameFootage=parseFloat(document.getElementById('frameFootage').value)||0;
  currentEstimate.doorCount=parseInt(document.getElementById('doorCount').value)||0;
  currentEstimate.notes=document.getElementById('notes').value.trim();
  currentEstimate.total=recalcTotal();
  currentEstimate.updated=Date.now();
  await dbPut(currentEstimate);
  showToast('Estimate saved','success');
  loadEstimatesList();
}

// === SHARE ESTIMATE ===
async function shareEstimate(){
  const name=document.getElementById('custName').value.trim();
  if(!name){showToast('Save the estimate first','error');return}
  await saveEstimate();
  const est=currentEstimate;
  const screenName=MATERIAL_NAMES[est.screenType]||est.screenType;
  let text=`ESTIMATE - Daniel's Screen Services\n`;
  text+=`${est.customer}\n${est.address}\n\n`;
  text+=`Screen: ${screenName}\n`;
  text+=`Panels: ${est.panels.length}\n`;
  est.panels.forEach((p,i)=>{text+=`  ${i+1}. ${p.w}"×${p.h}" ${p.qty>1?'×'+p.qty:''}\n`});
  if(est.frameFootage>0)text+=`Frame: ${est.frameFootage} ft\n`;
  if(est.doorCount>0)text+=`Doors: ${est.doorCount}\n`;
  text+=`\nTotal: $${Math.round(est.total).toLocaleString()}\n`;
  text+=`\nDaniel's Screen Services\n(239) 560-6594`;

  if(navigator.share){
    try{
      await navigator.share({title:`Estimate for ${est.customer}`,text});
      est.shared=true;await dbPut(est);
      showToast('Estimate shared','success');
    }catch(e){if(e.name!=='AbortError')copyToClipboard(text)}
  }else{copyToClipboard(text)}
}

async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    showToast('Copied to clipboard','success');
  }catch(e){showToast('Could not copy','error')}
}

// === OPEN EXISTING ESTIMATE ===
async function openEstimate(id){
  const all=await dbGetAll();
  const est=all.find(e=>e.id===id);
  if(!est)return;
  currentEstimate=est;
  currentPanels=est.panels||[];
  currentPhotos=est.photos||[];
  document.getElementById('custName').value=est.customer||'';
  document.getElementById('custAddress').value=est.address||'';
  document.getElementById('custPhone').value=est.phone||'';
  document.getElementById('screenType').value=est.screenType||'fiberglass';
  document.getElementById('jobType').value=est.jobType||'rescreen';
  document.getElementById('frameFootage').value=est.frameFootage||0;
  document.getElementById('doorCount').value=est.doorCount||0;
  document.getElementById('notes').value=est.notes||'';
  document.getElementById('builderTitle').textContent='Edit Estimate';
  renderPanels();renderPhotos();recalcTotal();
  showView('viewBuilder');
}

// === EXPORT/IMPORT ===
async function exportData(){
  const all=await dbGetAll();
  const pricing=getPricing();
  const data=JSON.stringify({estimates:all,pricing},null,2);
  const blob=new Blob([data],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`screenquote-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();URL.revokeObjectURL(url);
  showToast('Data exported','success');
}

document.getElementById('importInput').addEventListener('change',async function(e){
  const file=e.target.files[0];if(!file)return;
  const text=await file.text();
  try{
    const data=JSON.parse(text);
    if(data.estimates){for(const est of data.estimates)await dbPut(est)}
    if(data.pricing)localStorage.setItem('sq_pricing',JSON.stringify(data.pricing));
    showToast('Data imported','success');
    loadEstimatesList();loadSettingsView();
  }catch(er){showToast('Invalid file','error')}
  e.target.value='';
});

// === DEMO DATA ===
const DEMO_ESTIMATES=[
  {id:'demo-1',created:Date.now()-7200000,updated:Date.now()-7200000,customer:'Maria Gonzalez',address:'1247 SW Pine Island Rd, Cape Coral',phone:'(239) 555-0142',screenType:'phifer2020',jobType:'rescreen',panels:[{w:48,h:96,qty:4,note:'Lanai south side'},{w:60,h:96,qty:3,note:'Pool facing'},{w:36,h:72,qty:1,note:'Side entry'}],photos:[],frameFootage:0,doorCount:1,notes:'Full lanai rescreen. Existing frame in good shape. Customer wants 20x20 mesh.',total:0,shared:false,isDemo:true},
  {id:'demo-2',created:Date.now()-86400000,updated:Date.now()-86400000,customer:'Bob Patterson',address:'4820 Pelican Blvd, Cape Coral',phone:'(239) 555-0287',screenType:'tuffscreen',jobType:'repair',panels:[{w:72,h:96,qty:2,note:'Pool cage panels, storm damage'}],photos:[],frameFootage:12,doorCount:0,notes:'Hurricane damage. Two panels torn, small frame section bent. Need Tuff Screen for wind resistance.',total:0,shared:true,isDemo:true},
  {id:'demo-3',created:Date.now()-172800000,updated:Date.now()-172800000,customer:'The Hendersons',address:'918 Cape Coral Pkwy E',phone:'(239) 555-0391',screenType:'noSee',jobType:'fullCage',panels:[{w:48,h:96,qty:6,note:'West wall'},{w:60,h:96,qty:4,note:'South wall'},{w:72,h:96,qty:4,note:'East wall'},{w:48,h:72,qty:2,note:'Short panels, north'}],photos:[],frameFootage:24,doorCount:2,notes:'Full pool cage rescreen. Upgrading to No-See-Um mesh. Customer has bad mosquito problem near canal.',total:0,shared:false,isDemo:true}
];

function calcEstimateTotal(est){
  const pricing=getPricing();
  let total=0;
  est.panels.forEach(p=>{
    const sqft=(p.w*p.h/144)*p.qty;
    total+=sqft*(pricing.materials[est.screenType]||0);
    total+=p.qty*pricing.labor;
    total+=((p.w+p.h)*2/12)*p.qty*pricing.spline;
  });
  total+=(est.frameFootage||0)*pricing.frame;
  total+=(est.doorCount||0)*pricing.door;
  return Math.round(total);
}

async function loadDemoData(){
  const existing=await dbGetAll();
  if(existing.length>0)return;
  if(localStorage.getItem('sq_demoCleared'))return;
  for(const est of DEMO_ESTIMATES){
    est.total=calcEstimateTotal(est);
    await dbPut(est);
  }
  document.getElementById('demoBanner').style.display='flex';
  loadEstimatesList();
}

async function clearDemoData(){
  const all=await dbGetAll();
  for(const est of all){if(est.isDemo)await dbDelete(est.id)}
  document.getElementById('demoBanner').style.display='none';
  localStorage.setItem('sq_demoCleared','1');
  loadEstimatesList();
  showToast('Demo data cleared','success');
}

// === TOASTS ===
function showToast(msg,type='success'){
  const container=document.getElementById('toastContainer');
  const toast=document.createElement('div');
  toast.className=`toast ${type}`;
  const icon=type==='success'?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
  toast.innerHTML=icon+msg;
  container.appendChild(toast);
  setTimeout(()=>{toast.style.opacity='0';toast.style.transform='translateX(40px)';toast.style.transition='all .3s';setTimeout(()=>toast.remove(),300)},3000);
}

function showUndoToast(msg,undoFn){
  const existing=document.querySelector('.undo-toast');
  if(existing)existing.remove();
  const toast=document.createElement('div');
  toast.className='undo-toast';
  toast.setAttribute('role','status');
  toast.setAttribute('aria-live','polite');
  toast.innerHTML=`<span>${msg}</span><button onclick="this.parentElement.remove();(${undoFn.toString()})()">Undo</button>`;
  document.body.appendChild(toast);
  setTimeout(()=>{if(toast.parentElement)toast.remove()},5000);
}

// === INIT ===
async function init(){
  await openDB();
  await loadDemoData();
  await loadEstimatesList();
  loadSettingsView();
  const all=await dbGetAll();
  if(all.some(e=>e.isDemo))document.getElementById('demoBanner').style.display='flex';
}

init();
</script>
<script src="https://book.bennycutools.com/tracker.js" async></script>
</body>
</html>