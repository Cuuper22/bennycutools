<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#1B5E20">
<meta name="description" content="Professional energy audit tool for home performance assessments">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="AuditSnap">
<title>AuditSnap - Efficiency Revolution</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --grn:#1B5E20;--grn-l:#2E7D32;--grn-d:#0D3D10;--grn-p:#E8F5E9;
  --org:#FF6F00;--org-l:#FF8F00;--org-d:#E65100;--org-p:#FFF3E0;
  --blu:#0D47A1;--blu-l:#1565C0;--blu-p:#E3F2FD;
  --red:#C62828;--red-p:#FFEBEE;
  --bg:#F5F5F5;--wh:#FFFFFF;--surf:#FAFAFA;
  --tx:#1A1A1A;--tx2:#444;--tx3:#757575;
  --bdr:#E0E0E0;--bdr-f:#BDBDBD;
  --sh-xs:0 1px 2px rgba(0,0,0,.04);--sh-s:0 1px 3px rgba(0,0,0,.06);--sh-m:0 4px 12px rgba(0,0,0,.08);--sh-l:0 8px 24px rgba(0,0,0,.12);
  --r-sm:6px;--r:8px;--rm:12px;--rl:16px;
  --ease-out:cubic-bezier(.34,1.56,.64,1);
  --ease-smooth:cubic-bezier(.4,0,.2,1);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
*:focus{outline:none}
*:focus-visible{outline:2.5px solid var(--blu);outline-offset:3px;border-radius:var(--r-sm)}
button:focus-visible,input:focus-visible,select:focus-visible,textarea:focus-visible,.photo-thumb:focus-visible{outline:2.5px solid var(--blu);outline-offset:2px}
html{scroll-behavior:smooth;-webkit-text-size-adjust:100%}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;padding-bottom:140px;line-height:1.5;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;touch-action:manipulation}
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important;scroll-behavior:auto!important}}
@media print{body{background:#fff;padding:0}.hdr,.bnav,.fab,.demo-bar,.tc,.summary-strip,#bct-demo-disclaimer{display:none!important}.wrap{max-width:100%;padding:0}.vw.on{display:block!important}.bsec{break-inside:avoid;box-shadow:none;border:1px solid #ddd;margin:12px 0}}

.hdr{background:linear-gradient(135deg,var(--grn),var(--grn-l));color:#fff;padding:16px 20px;position:sticky;top:0;z-index:100;box-shadow:var(--sh-m);backdrop-filter:blur(8px)}
.hdr h1{font-family:'Barlow',sans-serif;font-size:22px;font-weight:700;letter-spacing:-0.5px;line-height:1.2}
.hdr .sub{font-size:13px;opacity:.85;margin-top:3px;font-weight:400}

.demo-bar{background:var(--org-p);border-bottom:1px solid rgba(255,143,0,.3);padding:12px 20px;font-size:13px;color:var(--org-d);display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
.demo-bar button{background:var(--wh);border:1.5px solid var(--org);color:var(--org-d);padding:6px 14px;border-radius:var(--r);cursor:pointer;font-size:12px;font-weight:500;font-family:inherit;white-space:nowrap;transition:all .15s var(--ease-smooth)}
.demo-bar button:hover{background:var(--org);color:#fff}
.demo-bar button:active{transform:scale(.96)}

.wrap{padding:0 16px;max-width:520px;margin:0 auto}
.vw{display:none;opacity:0;transform:translateY(8px);transition:opacity .25s var(--ease-smooth),transform .25s var(--ease-smooth)}
.vw.on{display:block;opacity:1;transform:translateY(0)}

.acard{background:var(--wh);border-radius:var(--rl);padding:20px;margin:16px 0;box-shadow:var(--sh-s);border:1px solid var(--bdr);cursor:pointer;transition:all .18s var(--ease-smooth);animation:sUp .4s var(--ease-out) both;position:relative;overflow:hidden}
.acard::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--grn);opacity:0;transition:opacity .2s}
.acard:hover{transform:translateY(-2px);box-shadow:var(--sh-m)}
.acard:hover::before{opacity:1}
.acard:active{transform:scale(.99)}
.acard:nth-child(1){animation-delay:.05s}.acard:nth-child(2){animation-delay:.1s}.acard:nth-child(3){animation-delay:.15s}
.ac-addr{font-family:'Barlow',sans-serif;font-size:17px;font-weight:600;margin-bottom:4px;color:var(--tx);line-height:1.3}
.ac-meta{font-size:13px;color:var(--tx2);margin-bottom:12px}
.ac-metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
.ac-metric{background:var(--surf);border-radius:var(--r);padding:10px 6px;text-align:center;border:1px solid var(--bdr);transition:border-color .15s}
.acard:hover .ac-metric{border-color:var(--bdr-f)}
.ac-metric .val{font-family:'Barlow',sans-serif;font-size:19px;font-weight:700;line-height:1.2}
.ac-metric .lbl{font-size:10px;color:var(--tx3);text-transform:uppercase;letter-spacing:.6px;margin-top:4px;font-weight:500}
.ac-metric.good .val{color:var(--grn-l)}.ac-metric.warn .val{color:var(--org)}.ac-metric.bad .val{color:var(--red)}
.ac-foot{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--tx3)}
.ac-status{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.4px}
.ac-status.complete{background:var(--grn-p);color:var(--grn-d)}
.ac-status.progress{background:var(--org-p);color:var(--org-d)}
.ac-status.draft{background:var(--surf);color:var(--tx3);border:1px solid var(--bdr)}

.fab{position:fixed;bottom:130px;right:20px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--grn-l),var(--grn));color:#fff;border:none;box-shadow:var(--sh-l);cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:90;transition:all .2s var(--ease-smooth);animation:pulse 2.5s ease-in-out infinite}
.fab:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(27,94,32,.35)}
.fab:active{transform:scale(.92)}
.fab svg{width:26px;height:26px}
@keyframes pulse{0%,100%{box-shadow:var(--sh-l),0 0 0 0 rgba(27,94,32,.35)}50%{box-shadow:var(--sh-l),0 0 0 12px rgba(27,94,32,0)}}

.bsec{background:var(--wh);border-radius:var(--rl);padding:20px;margin:16px 0;box-shadow:var(--sh-xs);border:1px solid var(--bdr);animation:sUp .35s var(--ease-out) both;transition:box-shadow .2s}
.bsec:hover{box-shadow:var(--sh-s)}
.bsec h2{font-family:'Barlow',sans-serif;font-size:15px;font-weight:600;color:var(--grn-d);margin-bottom:16px;display:flex;align-items:center;gap:10px;text-transform:uppercase;letter-spacing:.3px}
.bsec h2 svg{width:20px;height:20px;stroke-width:2.2px}
.fg{margin-bottom:16px}
.fg label{display:block;font-size:12px;font-weight:500;color:var(--tx2);margin-bottom:6px}
.fg input,.fg select,.fg textarea{width:100%;padding:12px 14px;border:1.5px solid var(--bdr);border-radius:var(--r);font-size:16px;font-family:inherit;background:var(--wh);color:var(--tx);transition:all .15s var(--ease-smooth);-webkit-appearance:none;appearance:none}
.fg input:hover,.fg select:hover,.fg textarea:hover{border-color:var(--bdr-f)}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--blu);box-shadow:0 0 0 4px rgba(13,71,161,.1)}
.fg textarea{resize:vertical;min-height:80px}
.fg select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23757575' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:36px}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:12px}

.gauge-wrap{text-align:center;padding:24px 16px;background:var(--surf);border-radius:var(--rm);margin:16px 0;border:1px solid var(--bdr)}
.gauge-val{font-family:'Barlow',sans-serif;font-size:52px;font-weight:700;transition:color .3s;line-height:1.1}
.gauge-val.good{color:var(--grn-l)}.gauge-val.warn{color:var(--org)}.gauge-val.bad{color:var(--red)}
.gauge-label{font-size:13px;color:var(--tx2);margin-top:8px;font-weight:500}
.gauge-bar{height:10px;background:var(--bdr);border-radius:5px;margin:16px auto 0;max-width:300px;overflow:hidden;position:relative}
.gauge-bar::before{content:'';position:absolute;height:100%;border-radius:5px;transition:width .6s var(--ease-smooth),background .3s}
.gauge-bar.good::before{width:30%;background:linear-gradient(90deg,var(--grn),var(--grn-l))}
.gauge-bar.warn::before{width:60%;background:linear-gradient(90deg,var(--org),var(--org-l))}
.gauge-bar.bad::before{width:90%;background:linear-gradient(90deg,var(--red),#E53935)}
.gauge-scale{display:flex;justify-content:space-between;font-size:11px;color:var(--tx3);max-width:300px;margin:6px auto 0;font-weight:500}

.ins-row{display:grid;grid-template-columns:90px 1fr 70px 44px;gap:10px;align-items:center;margin-bottom:10px;font-size:14px;padding:8px;background:var(--surf);border-radius:var(--r);border:1px solid transparent;transition:border-color .15s}
.ins-row:hover{border-color:var(--bdr-f)}
.ins-row.hdr{background:transparent;padding:4px 8px;font-weight:600;font-size:11px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px}
.ins-row input{padding:10px 12px;font-size:15px;border-radius:var(--r);border:1.5px solid var(--bdr);transition:border-color .15s,box-shadow .15s}
.ins-row input:focus{border-color:var(--blu);box-shadow:0 0 0 3px rgba(13,71,161,.1)}
.ins-row .zone{font-weight:500;color:var(--tx)}
.ins-row .target{font-size:12px;color:var(--tx3);text-align:center;font-weight:500}
.ins-status{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto}
.ins-status.pass{background:var(--grn-p);color:var(--grn-d)}.ins-status.fail{background:var(--red-p);color:var(--red)}

.rec-toggle{background:var(--surf);border:2px solid var(--bdr);border-radius:var(--rm);padding:14px 16px;cursor:pointer;display:flex;align-items:center;gap:14px;margin-bottom:10px;transition:all .15s var(--ease-smooth);user-select:none;touch-action:manipulation}
.rec-toggle:hover{border-color:var(--bdr-f);background:var(--wh)}
.rec-toggle:active{transform:scale(.99)}
.rec-toggle.on{background:var(--grn-p);border-color:var(--grn-l)}
.rec-check{width:24px;height:24px;border-radius:6px;border:2.5px solid var(--bdr);display:flex;align-items:center;justify-content:center;transition:all .15s var(--ease-smooth);flex-shrink:0;background:var(--wh)}
.rec-toggle.on .rec-check{background:var(--grn);border-color:var(--grn)}
.rec-toggle.on .rec-check svg{display:block}.rec-check svg{display:none;width:14px;height:14px;color:#fff}
.rec-info{flex:1}.rec-title{font-size:15px;font-weight:600;color:var(--tx);margin-bottom:2px}
.rec-cost{font-size:12px;color:var(--tx3);font-weight:500}

.photo-row{display:flex;gap:10px;overflow-x:auto;padding:12px 0;-webkit-overflow-scrolling:touch;scroll-snap-type:x mandatory;scrollbar-width:none}
.photo-row::-webkit-scrollbar{display:none}
.photo-thumb{width:88px;height:88px;border-radius:var(--r);overflow:hidden;background:var(--surf);flex-shrink:0;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px dashed var(--bdr-f);transition:all .15s var(--ease-smooth);scroll-snap-align:start;position:relative}
.photo-thumb:hover{border-color:var(--blu);background:var(--blu-p)}
.photo-thumb:active{transform:scale(.95)}
.photo-thumb:focus-visible{border-color:var(--blu);background:var(--blu-p)}
.photo-thumb.has{border-style:solid;border-color:transparent;box-shadow:var(--sh-s)}
.photo-thumb.has:hover{transform:translateY(-2px);box-shadow:var(--sh-m)}
.photo-thumb img{width:100%;height:100%;object-fit:cover}
.photo-thumb .remove{position:absolute;top:4px;right:4px;width:22px;height:22px;background:rgba(0,0,0,.6);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;opacity:0;transition:opacity .15s}
.photo-thumb.has:hover .remove{opacity:1}

.summary-strip{background:linear-gradient(135deg,var(--grn),var(--grn-l));border-radius:var(--rl);padding:20px;margin:20px 0;color:#fff;box-shadow:var(--sh-l);position:sticky;bottom:125px;z-index:50}
.sum-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;text-align:center}
.sum-val{font-family:'Barlow',sans-serif;font-size:30px;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,.2)}.sum-lbl{font-size:11px;opacity:.9;margin-top:4px;text-transform:uppercase;letter-spacing:.6px;font-weight:500}

.abr{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:20px 0}
.btn{padding:14px 20px;border-radius:var(--rm);font-family:'Barlow',sans-serif;font-size:15px;font-weight:600;cursor:pointer;transition:all .15s var(--ease-smooth);border:none;display:flex;align-items:center;justify-content:center;gap:8px;touch-action:manipulation}
.btn:hover{transform:translateY(-1px);box-shadow:var(--sh-m)}
.btn:active{transform:scale(.98)}
.btn svg{width:18px;height:18px}
.bp{background:linear-gradient(135deg,var(--grn-l),var(--grn));color:#fff;box-shadow:0 4px 12px rgba(27,94,32,.3)}
.bp:hover{background:linear-gradient(135deg,var(--grn),var(--grn-d));box-shadow:0 6px 16px rgba(27,94,32,.4)}
.bs{background:var(--wh);color:var(--grn-d);border:2px solid var(--grn-l)}
.bs:hover{background:var(--grn-p);border-color:var(--grn)}
.bf{grid-column:1/-1}.bd{background:var(--surf);color:var(--tx3);border:1.5px solid var(--bdr)}
.bd:hover{background:var(--bg);border-color:var(--bdr-f)}

.bnav{position:fixed;bottom:60px;left:0;right:0;background:var(--wh);border-top:1px solid var(--bdr);display:flex;justify-content:space-around;padding:8px 0 14px;z-index:100;box-shadow:0 -2px 12px rgba(0,0,0,.06)}
.nb{background:none;border:none;display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;padding:6px 20px;color:var(--tx3);transition:all .15s var(--ease-smooth);font-family:inherit;border-radius:var(--r-sm);min-width:64px}
.nb:hover{color:var(--tx2);background:var(--surf)}
.nb.on{color:var(--grn);background:var(--grn-p)}
.nb.on:hover{background:var(--grn-p)}
.nb svg{width:24px;height:24px;transition:transform .15s}.nb:hover svg{transform:translateY(-1px)}
.nb span{font-size:11px;font-weight:600;letter-spacing:.3px}

.tc{position:fixed;top:80px;left:50%;transform:translateX(-50%);z-index:9999;pointer-events:none;display:flex;flex-direction:column;gap:8px}
.tst{background:var(--tx);color:#fff;padding:14px 22px;border-radius:var(--rm);font-size:14px;font-weight:500;box-shadow:var(--sh-l);animation:tIn .3s var(--ease-out);display:flex;align-items:center;gap:10px}
.tst.ok{background:var(--grn)}.tst.err{background:var(--red)}
.tst svg{width:18px;height:18px}

.empty{text-align:center;padding:56px 24px}
.empty svg{width:88px;height:88px;color:var(--tx3);opacity:.35;margin-bottom:20px}
.empty h3{font-family:'Barlow',sans-serif;font-size:20px;font-weight:600;margin-bottom:10px;color:var(--tx)}
.empty p{font-size:15px;color:var(--tx3);max-width:280px;margin:0 auto 24px;line-height:1.5}

.sg{background:var(--wh);border-radius:var(--rl);padding:20px;margin:16px 0;box-shadow:var(--sh-xs);border:1px solid var(--bdr)}
.sg h3{font-family:'Barlow',sans-serif;font-size:16px;font-weight:600;margin-bottom:14px;color:var(--grn-d)}

.locked{position:relative;min-height:140px;background:linear-gradient(135deg,var(--surf),var(--wh))}
.lock-ov{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(255,255,255,.92);border-radius:var(--rl);z-index:10;padding:20px;text-align:center;backdrop-filter:blur(2px)}
.lock-lbl{font-family:'Barlow',sans-serif;font-size:15px;font-weight:700;color:var(--tx);margin-top:12px}
.lock-desc{font-size:13px;color:var(--tx3);margin-top:6px;max-width:280px;line-height:1.4}
.lock-cta{margin-top:14px;padding:10px 20px;background:var(--grn);color:#fff;border:none;border-radius:var(--r);font-weight:600;font-size:13px;cursor:pointer;transition:all .15s}
.lock-cta:hover{background:var(--grn-l);transform:translateY(-1px)}

@keyframes sUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes tIn{from{opacity:0;transform:translateY(-12px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}

@media(min-width:768px){.bnav{display:none}body{padding-bottom:100px}.wrap{max-width:600px}.fab{bottom:100px;right:28px}.summary-strip{bottom:95px}}
body{padding-bottom:60px!important}
</style>
</head>
<body>
<header class="hdr" role="banner">
  <h1>AuditSnap</h1>
  <div class="sub">Efficiency Revolution — Golden, CO</div>
</header>

<div class="demo-bar" id="demoBanner" style="display:none" role="status" aria-live="polite">
  <span>Sample Denver-area audits loaded. Clear to start fresh.</span>
  <button onclick="clearDemo()" aria-label="Clear sample audit data">Clear Samples</button>
</div>

<div class="tc" id="toasts" role="region" aria-live="polite" aria-atomic="true"></div>

<main class="wrap" role="main" id="main-content">
  <section class="vw on" id="listView" aria-label="Your audits">
    <div id="auditList"></div>
    <div class="empty" id="emptyState" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/><path d="M12 15v6M9 18h6"/></svg>
      <h3>No audits yet</h3>
      <p>Start your first energy audit report right from the job site. All data saves to your device.</p>
      <button class="btn bp" onclick="switchVw('build')">Start New Audit</button>
    </div>
  </section>

  <section class="vw" id="buildView" aria-label="Audit builder">
    <div class="bsec" style="animation-delay:.05s">
      <h2><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Home Info</h2>
      <div class="fg">
        <label for="hAddr">Property Address <span aria-label="required">*</span></label>
        <input type="text" id="hAddr" placeholder="1234 Pine St, Lakewood, CO" autocomplete="street-address" required aria-required="true">
      </div>
      <div class="frow">
        <div class="fg">
          <label for="hSqft">Square Feet</label>
          <input type="number" id="hSqft" placeholder="1850" inputmode="numeric" min="0">
        </div>
        <div class="fg">
          <label for="hYear">Year Built</label>
          <input type="number" id="hYear" placeholder="1972" inputmode="numeric" min="1800" max="2099">
        </div>
      </div>
      <div class="frow">
        <div class="fg">
          <label for="hHeat">Heating Type</label>
          <select id="hHeat" aria-label="Heating system type">
            <option value="gas">Gas Furnace</option>
            <option value="electric">Electric</option>
            <option value="heatpump">Heat Pump</option>
            <option value="boiler">Boiler</option>
          </select>
        </div>
        <div class="fg">
          <label for="hStatus">Audit Status</label>
          <select id="hStatus" aria-label="Current audit status">
            <option value="draft">Draft</option>
            <option value="progress">In Progress</option>
            <option value="complete">Complete</option>
          </select>
        </div>
      </div>
    </div>

    <div class="bsec" style="animation-delay:.1s">
      <h2><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> Blower Door Test</h2>
      <div class="frow">
        <div class="fg">
          <label for="cfm50">CFM50 Reading</label>
          <input type="number" id="cfm50" placeholder="3200" inputmode="numeric" oninput="calcACH()" aria-describedby="cfm50-help">
        </div>
        <div class="fg">
          <label for="ceilHt">Ceiling Height (ft)</label>
          <input type="number" id="ceilHt" placeholder="8" value="8" step="0.5" oninput="calcACH()">
        </div>
      </div>
      <p id="cfm50-help" style="font-size:12px;color:var(--tx3);margin:-8px 0 12px">Cubic feet per minute at 50 Pascals pressure</p>
      <div class="gauge-wrap">
        <div class="gauge-val" id="achVal" aria-live="polite">--</div>
        <div class="gauge-label">Air Changes per Hour at 50 Pa (ACH50)</div>
        <div class="gauge-bar" id="achBar" role="img" aria-label="ACH50 rating indicator"></div>
        <div class="gauge-scale"><span>Tight (3)</span><span>Average (5)</span><span>Leaky (10+)</span></div>
      </div>
      <div class="fg">
        <label for="achNote">Leak Notes</label>
        <input type="text" id="achNote" placeholder="Major leaks at attic hatch, recessed lights, rim joists">
      </div>
    </div>

    <div class="bsec" style="animation-delay:.15s">
      <h2><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg> Insulation Check</h2>
      <div class="ins-row hdr">
        <span>Zone</span><span>Your R-Value</span><span>Target</span><span>Status</span>
      </div>
      <div class="ins-row">
        <span class="zone">Attic</span>
        <input type="number" id="rAttic" placeholder="19" oninput="checkIns()" aria-label="Attic insulation R-value">
        <span class="target">R-49</span>
        <span class="ins-status" id="sAttic" aria-live="polite" aria-label="Attic insulation status"></span>
      </div>
      <div class="ins-row">
        <span class="zone">Walls</span>
        <input type="number" id="rWalls" placeholder="11" oninput="checkIns()" aria-label="Wall insulation R-value">
        <span class="target">R-13</span>
        <span class="ins-status" id="sWalls" aria-live="polite" aria-label="Wall insulation status"></span>
      </div>
      <div class="ins-row">
        <span class="zone">Floor</span>
        <input type="number" id="rFloor" placeholder="0" oninput="checkIns()" aria-label="Floor insulation R-value">
        <span class="target">R-25</span>
        <span class="ins-status" id="sFloor" aria-live="polite" aria-label="Floor insulation status"></span>
      </div>
      <div class="ins-row">
        <span class="zone">Rim Joist</span>
        <input type="number" id="rRim" placeholder="0" oninput="checkIns()" aria-label="Rim joist insulation R-value">
        <span class="target">R-15</span>
        <span class="ins-status" id="sRim" aria-live="polite" aria-label="Rim joist insulation status"></span>
      </div>
    </div>

    <div class="bsec" style="animation-delay:.2s">
      <h2><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg> Thermal Photos</h2>
      <div class="photo-row" id="photoRow" role="list" aria-label="Thermal image thumbnails">
        <button class="photo-thumb" onclick="addImg(0)" aria-label="Add thermal image 1" type="button">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
        <button class="photo-thumb" onclick="addImg(1)" aria-label="Add thermal image 2" type="button">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
        <button class="photo-thumb" onclick="addImg(2)" aria-label="Add thermal image 3" type="button">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
        <button class="photo-thumb" onclick="addImg(3)" aria-label="Add thermal image 4" type="button">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
      </div>
      <button class="btn bs bf" onclick="document.getElementById('imgIn').click()" style="margin-top:10px" type="button">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="3"/><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/></svg>
        Take Thermal Photo
      </button>
    </div>

    <div class="bsec" style="animation-delay:.25s">
      <h2><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg> Recommendations</h2>
      <div id="recList" role="group" aria-label="Upgrade recommendations"></div>
    </div>

    <div class="summary-strip" id="sumStrip" role="region" aria-label="Cost summary">
      <div class="sum-grid">
        <div>
          <div class="sum-val" id="sumCost">$0</div>
          <div class="sum-lbl">Total Investment</div>
        </div>
        <div>
          <div class="sum-val" id="sumSave">$0</div>
          <div class="sum-lbl">Yearly Savings</div>
        </div>
      </div>
    </div>

    <div class="abr">
      <button class="btn bs" onclick="saveAudit()" type="button">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>
        Save Audit
      </button>
      <button class="btn bp" onclick="shareReport()" type="button">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
        Share Report
      </button>
    </div>
    <button class="btn bd bf" onclick="resetBuild()" style="margin-bottom:28px" type="button">Discard & Start Over</button>
  </section>

  <section class="vw" id="settingsView" aria-label="Settings and tools">
    <div class="sg">
      <h3>Data Management</h3>
      <p style="font-size:13px;color:var(--tx3);margin-bottom:16px;line-height:1.5">All your audits are stored locally on this device. Back up regularly.</p>
      <div style="display:flex;flex-direction:column;gap:10px">
        <button class="btn bs" onclick="exportAll()" type="button" aria-label="Export all audits as JSON backup">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Export Backup (JSON)
        </button>
        <button class="btn bs" onclick="document.getElementById('fileIn').click()" type="button" aria-label="Import audits from JSON backup">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          Import Backup (JSON)
        </button>
      </div>
    </div>
    <div class="sg locked" style="margin-top:24px">
      <div class="lock-ov">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="var(--grn)" stroke-width="1.5" aria-hidden="true"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        <span class="lock-lbl">Rebate Calculator</span>
        <span class="lock-desc">Auto-lookup Xcel Energy rebates, city programs, and federal IRA tax credits</span>
        <button class="lock-cta" onclick="showUpgradeMsg()">Upgrade to Full Version</button>
      </div>
      <h3>Rebate Calculator</h3>
      <p style="height:80px"></p>
    </div>
  </section>
</main>

<button class="fab" id="fab" onclick="switchVw('build')" aria-label="Create new audit" type="button">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
</button>

<nav class="bnav" aria-label="Main navigation">
  <button class="nb on" onclick="switchVw('list')" data-v="list" aria-label="View your audits" type="button">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
    <span>Audits</span>
  </button>
  <button class="nb" onclick="switchVw('build')" data-v="build" aria-label="Create new audit" type="button">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    <span>New</span>
  </button>
  <button class="nb" onclick="switchVw('settings')" data-v="settings" aria-label="Open settings" type="button">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    <span>Settings</span>
  </button>
</nav>

<div id="bct-demo-disclaimer" role="contentinfo" aria-label="Demo disclaimer" style="position:fixed;bottom:0;left:0;right:0;background:#f8f8f8;border-top:1px solid #ddd;padding:12px 16px;font-size:12px;line-height:1.5;color:#666;z-index:99999;display:flex;flex-wrap:wrap;align-items:center;justify-content:center;gap:8px 16px;text-align:center;">
  <p style="margin:0;max-width:700px;"><strong style="color:#333;">DEMO NOTICE:</strong> This tool was created by BennyCuTools as a free demonstration only. It is not affiliated with, endorsed by, or authorized by Efficiency Revolution LLC. All brand references are used solely for demonstration purposes.</p>
  <a href="mailto:cuuper225@gmail.com?subject=Delete%20Demo%3A%20Efficiency%20Revolution&body=I%20am%20the%20owner%20and%20I%20request%20permanent%20deletion%20of%20this%20demo." style="display:inline-flex;align-items:center;gap:4px;background:#dc3545;color:#fff;padding:6px 14px;border-radius:4px;text-decoration:none;font-size:11px;font-weight:500;white-space:nowrap;transition:background .15s" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
    Request Permanent Deletion
  </a>
</div>

<input type="file" id="imgIn" accept="image/*" capture="environment" style="display:none" onchange="handleImg(event)" aria-label="Capture thermal image">
<input type="file" id="fileIn" accept=".json" style="display:none" onchange="handleImport(event)" aria-label="Import backup file">

<script>
function _h(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return h;}
const _V=-265042532;
const _k=new URLSearchParams(window.location.search).get('key');
if(!_k||_h(_k)!==_V){
  document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;background:#111;color:#fff;text-align:center;padding:20px"><div><h1 style="font-size:2rem;margin-bottom:1rem">Access Required</h1><p style="color:#999">This tool needs a valid access key.</p><p style="margin-top:1rem"><a href="mailto:ben@bennycutools.com" style="color:#4da6ff">ben@bennycutools.com</a></p></div></div><div id="bct-demo-disclaimer" role="contentinfo" style="position:fixed;bottom:0;left:0;right:0;background:#f8f8f8;border-top:1px solid #ddd;padding:10px 16px;font-size:12px;color:#666;z-index:99999;text-align:center;"><p style="margin:0"><strong style="color:#333;">DEMO NOTICE:</strong> Not affiliated with Efficiency Revolution LLC.</p></div>';throw new Error('x');
}
document.addEventListener('contextmenu',e=>e.preventDefault());

let audits=[],editId=null,photos=[null,null,null,null],imgTarget=0,DB;
const RECS=[
  {id:'airseal',name:'Air Sealing Package',cost:2500,save:320,desc:'Seal attic bypasses, rim joists, penetrations'},
  {id:'attic',name:'Attic Insulation to R-49',cost:4500,save:280,desc:'Blown cellulose or fiberglass to code'},
  {id:'rim',name:'Rim Joist Insulation',cost:1800,save:120,desc:'Spray foam rim joists'},
  {id:'crawl',name:'Crawl Space Encapsulation',cost:5500,save:180,desc:'Vapor barrier, insulation, dehumidifier'},
  {id:'duct',name:'Duct Sealing',cost:1200,save:150,desc:'Seal supply and return duct connections'},
  {id:'whfan',name:'Whole House Fan',cost:3500,save:200,desc:'Quiet Cool or similar whole-house ventilation'},
  {id:'windows',name:'Window Upgrades',cost:8000,save:160,desc:'Replace single-pane with double-pane low-E'},
  {id:'furnace',name:'High-Efficiency Furnace',cost:6000,save:280,desc:'95%+ AFUE replacement'}
];

function initDB(){return new Promise((res,rej)=>{const r=indexedDB.open('AuditSnapDB',1);r.onupgradeneeded=e=>{if(!e.target.result.objectStoreNames.contains('audits'))e.target.result.createObjectStore('audits',{keyPath:'id'})};r.onsuccess=e=>{DB=e.target.result;res()};r.onerror=rej})}
function dbPut(a){return new Promise((r,j)=>{const t=DB.transaction('audits','readwrite');t.objectStore('audits').put(a);t.oncomplete=r;t.onerror=j})}
function dbAll(){return new Promise((r,j)=>{const t=DB.transaction('audits','readonly');const q=t.objectStore('audits').getAll();q.onsuccess=()=>r(q.result);q.onerror=j})}
function dbDel(id){return new Promise((r,j)=>{const t=DB.transaction('audits','readwrite');t.objectStore('audits').delete(id);t.oncomplete=r;t.onerror=j})}

function getDemos(){const n=Date.now();return[
  {id:'d1',isDemo:true,addr:'2847 Carr St, Lakewood, CO',sqft:1850,year:1972,heat:'gas',cfm50:3200,ceilHt:8,ach:14.1,achNote:'Major leaks at attic hatch and recessed lights',rAttic:19,rWalls:11,rFloor:0,rRim:0,recs:['airseal','attic','rim'],photos:[],status:'complete',total:8800,savings:720,created:n-86400000*3},
  {id:'d2',isDemo:true,addr:'14 Table Mountain Dr, Golden, CO',sqft:2400,year:2023,heat:'heatpump',cfm50:980,ceilHt:9,ach:2.7,achNote:'Tight new construction, good air barrier',rAttic:49,rWalls:15,rFloor:30,rRim:15,recs:[],photos:[],status:'complete',total:0,savings:0,created:n-86400000},
  {id:'d3',isDemo:true,addr:'508 Garrison St, Arvada, CO',sqft:1620,year:1965,heat:'gas',cfm50:4100,ceilHt:8,ach:20.5,achNote:'Original windows, no weatherstripping, balloon framing',rAttic:11,rWalls:0,rFloor:0,rRim:0,recs:['airseal','attic','rim','crawl','duct','windows'],photos:[],status:'progress',total:23500,savings:1210,created:n-7200000}
]}

async function loadDemos(){const ex=await dbAll();if(!ex.length&&!localStorage.getItem('as_cleared')){for(const d of getDemos())await dbPut(d);document.getElementById('demoBanner').style.display='flex';await loadAudits()}}
async function clearDemo(){const all=await dbAll();for(const a of all)if(a.isDemo)await dbDel(a.id);localStorage.setItem('as_cleared','1');document.getElementById('demoBanner').style.display='none';toast('Sample data cleared');await loadAudits()}

function switchVw(v){document.querySelectorAll('.vw').forEach(x=>{x.classList.remove('on');setTimeout(()=>{if(!x.classList.contains('on'))x.style.display='none'},250)});const target=document.getElementById(v+'View');target.style.display='block';requestAnimationFrame(()=>target.classList.add('on'));document.querySelectorAll('.nb').forEach(b=>b.classList.toggle('on',b.dataset.v===v));document.getElementById('fab').style.display=v==='build'?'none':'flex';if(v==='list')loadAudits();if(v==='build'&&!editId){resetBuild();renderRecs()}}

async function loadAudits(){
  audits=await dbAll();audits.sort((a,b)=>(b.created||0)-(a.created||0));
  document.getElementById('demoBanner').style.display=audits.some(a=>a.isDemo)?'flex':'none';
  const list=document.getElementById('auditList'),empty=document.getElementById('emptyState');
  if(!audits.length){list.innerHTML='';empty.style.display='block';return}
  empty.style.display='none';
  list.innerHTML=audits.map(a=>{
    const achClass=a.ach<=5?'good':a.ach<=10?'warn':'bad';
    const recCount=(a.recs||[]).length;
    return`<article class="acard" onclick="openAudit('${a.id}')" tabindex="0" role="button" aria-label="Open audit for ${esc(a.addr||'Untitled property')}">
      <div class="ac-addr">${esc(a.addr||'Untitled')}</div>
      <div class="ac-meta">${a.year||'?'} | ${(a.sqft||0).toLocaleString()} sqft | ${a.heat?a.heat.charAt(0).toUpperCase()+a.heat.slice(1):'?'}</div>
      <div class="ac-metrics">
        <div class="ac-metric ${achClass}"><div class="val">${a.ach||'--'}</div><div class="lbl">ACH50</div></div>
        <div class="ac-metric"><div class="val">${recCount}</div><div class="lbl">Findings</div></div>
        <div class="ac-metric"><div class="val">$${((a.savings||0)/1000).toFixed(1)}k</div><div class="lbl">Savings/yr</div></div>
      </div>
      <div class="ac-foot"><span>${timeAgo(a.created)}</span><span class="ac-status ${a.status}">${a.status}</span></div>
    </article>`}).join('');
  document.querySelectorAll('.acard').forEach(card=>{card.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' ')e.preventDefault();card.click()})});
}

function openAudit(id){
  const a=audits.find(x=>x.id===id);if(!a)return;editId=id;
  document.getElementById('hAddr').value=a.addr||'';
  document.getElementById('hSqft').value=a.sqft||'';
  document.getElementById('hYear').value=a.year||'';
  document.getElementById('hHeat').value=a.heat||'gas';
  document.getElementById('hStatus').value=a.status||'draft';
  document.getElementById('cfm50').value=a.cfm50||'';
  document.getElementById('ceilHt').value=a.ceilHt||8;
  document.getElementById('achNote').value=a.achNote||'';
  document.getElementById('rAttic').value=a.rAttic||'';
  document.getElementById('rWalls').value=a.rWalls||'';
  document.getElementById('rFloor').value=a.rFloor||'';
  document.getElementById('rRim').value=a.rRim||'';
  photos=a.photos?[...a.photos]:new Array(4).fill(null);while(photos.length<4)photos.push(null);
  renderPhotos();renderRecs(a.recs||[]);calcACH();checkIns();
  switchVw('build');
}

function resetBuild(){
  editId=null;
  ['hAddr','hSqft','hYear','cfm50','achNote','rAttic','rWalls','rFloor','rRim'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('hHeat').value='gas';document.getElementById('hStatus').value='draft';document.getElementById('ceilHt').value='8';
  photos=new Array(4).fill(null);renderPhotos();
  document.getElementById('achVal').textContent='--';document.getElementById('achVal').className='gauge-val';
  document.getElementById('achBar').className='gauge-bar';
  ['sAttic','sWalls','sFloor','sRim'].forEach(id=>document.getElementById(id).innerHTML='');
  document.getElementById('sumCost').textContent='$0';document.getElementById('sumSave').textContent='$0';
}

function calcACH(){
  const cfm=parseFloat(document.getElementById('cfm50').value)||0;
  const sqft=parseFloat(document.getElementById('hSqft').value)||0;
  const ht=parseFloat(document.getElementById('ceilHt').value)||8;
  if(!cfm||!sqft){document.getElementById('achVal').textContent='--';document.getElementById('achVal').className='gauge-val';document.getElementById('achBar').className='gauge-bar';return}
  const vol=sqft*ht;const ach=Math.round((cfm*60/vol)*10)/10;
  const el=document.getElementById('achVal');
  el.textContent=ach.toFixed(1);
  const cls=ach<=5?'good':ach<=10?'warn':'bad';
  el.className='gauge-val '+cls;
  document.getElementById('achBar').className='gauge-bar '+cls;
}

function checkIns(){
  const zones=[{id:'rAttic',s:'sAttic',t:49},{id:'rWalls',s:'sWalls',t:13},{id:'rFloor',s:'sFloor',t:25},{id:'rRim',s:'sRim',t:15}];
  zones.forEach(z=>{
    const v=parseFloat(document.getElementById(z.id).value);
    const el=document.getElementById(z.s);
    if(isNaN(v)||v===0){el.innerHTML='';el.className='ins-status';return}
    const pass=v>=z.t;
    el.className='ins-status '+(pass?'pass':'fail');
    el.innerHTML=pass?'<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="3" aria-hidden="true"><polyline points="20 6 9 17 4 12"/></svg>':'<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="3" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
  });
}

function renderRecs(selected=[]){
  document.getElementById('recList').innerHTML=RECS.map(r=>{
    const on=selected.includes(r.id);
    return`<button class="rec-toggle${on?' on':''}" onclick="toggleRec(this,'${r.id}')" role="checkbox" aria-checked="${on}" type="button">
      <span class="rec-check"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" aria-hidden="true"><polyline points="20 6 9 17 4 12"/></svg></span>
      <div class="rec-info"><div class="rec-title">${r.name}</div><div class="rec-cost">$${r.cost.toLocaleString()} · saves ~$${r.save}/yr</div></div>
    </button>`}).join('');
  calcSums();
  document.querySelectorAll('.rec-toggle').forEach(el=>{el.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();el.click()}})});
}

function toggleRec(el,id){el.classList.toggle('on');el.setAttribute('aria-checked',el.classList.contains('on'));calcSums()}

function calcSums(){
  let cost=0,save=0;
  document.querySelectorAll('.rec-toggle.on').forEach(el=>{
    const match=el.onclick.toString().match(/'(\w+)'/);
    const id=match?match[1]:null;
    const r=RECS.find(x=>x.id===id);
    if(r){cost+=r.cost;save+=r.save}
  });
  document.getElementById('sumCost').textContent='$'+cost.toLocaleString();
  document.getElementById('sumSave').textContent='$'+save.toLocaleString();
}

function renderPhotos(){
  document.getElementById('photoRow').innerHTML=photos.map((p,i)=>
    `<button class="photo-thumb${p?' has':''}" onclick="addImg(${i})" type="button" aria-label="${p?'Change':'Add'} thermal image ${i+1}">
      ${p?`<img src="${p}" alt="Thermal image ${i+1} showing temperature differential" loading="lazy">`:`<svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`}
    </button>`).join('');
}
function addImg(i){imgTarget=i;document.getElementById('imgIn').click()}
function handleImg(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{const img=new Image();img.onload=()=>{const c=document.createElement('canvas');let w=img.width,h=img.height;if(w>800){h=h*(800/w);w=800}c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);photos[imgTarget]=c.toDataURL('image/jpeg',.8);renderPhotos();toast('Photo added','ok')};img.src=ev.target.result};r.readAsDataURL(f);e.target.value=''}

async function saveAudit(){
  const addr=document.getElementById('hAddr').value.trim();
  if(!addr){toast('Enter a property address','err');document.getElementById('hAddr').focus();return}
  const selRecs=[];document.querySelectorAll('.rec-toggle.on').forEach(el=>{const match=el.onclick.toString().match(/'(\w+)'/);const id=match?match[1]:null;if(id)selRecs.push(id)});
  const cfm=parseFloat(document.getElementById('cfm50').value)||0;
  const sqft=parseFloat(document.getElementById('hSqft').value)||0;
  const ht=parseFloat(document.getElementById('ceilHt').value)||8;
  const ach=sqft&&cfm?Math.round((cfm*60/(sqft*ht))*10)/10:0;
  let totalCost=0,totalSave=0;selRecs.forEach(id=>{const r=RECS.find(x=>x.id===id);if(r){totalCost+=r.cost;totalSave+=r.save}});
  const audit={
    id:editId||'a-'+Date.now(),addr,sqft,year:parseInt(document.getElementById('hYear').value)||0,
    heat:document.getElementById('hHeat').value,cfm50:cfm,ceilHt:ht,ach,
    achNote:document.getElementById('achNote').value,
    rAttic:parseFloat(document.getElementById('rAttic').value)||0,
    rWalls:parseFloat(document.getElementById('rWalls').value)||0,
    rFloor:parseFloat(document.getElementById('rFloor').value)||0,
    rRim:parseFloat(document.getElementById('rRim').value)||0,
    recs:selRecs,photos:photos.filter(Boolean),
    status:document.getElementById('hStatus').value,total:totalCost,savings:totalSave,
    created:editId?(audits.find(a=>a.id===editId)||{}).created||Date.now():Date.now()
  };
  await dbPut(audit);toast(editId?'Audit updated':'Audit saved','ok');editId=null;switchVw('list');
}

async function shareReport(){
  if(editId)await saveAudit();
  const addr=document.getElementById('hAddr').value||'Property';
  const ach=document.getElementById('achVal').textContent;
  const selRecs=[];document.querySelectorAll('.rec-toggle.on').forEach(el=>{const match=el.onclick.toString().match(/'(\w+)'/);const id=match?match[1]:null;if(id)selRecs.push(id)});
  const recNames=selRecs.map(id=>{const r=RECS.find(x=>x.id===id);return r?r.name:id}).join(', ')||'None selected';
  const text=`Energy Audit Summary — Efficiency Revolution\n\nProperty: ${addr}\nACH50: ${ach==='--'?'Not measured':ach+' air changes/hour'}\n\nRecommendations: ${recNames}\nInvestment: ${document.getElementById('sumCost').textContent}\nYearly Savings: ${document.getElementById('sumSave').textContent}\n\nMark Rogers · (303) 868-6653\nmark@efficiencyrevolution.com`;
  if(navigator.share){try{await navigator.share({title:`Audit: ${addr}`,text});toast('Report shared','ok')}catch(e){if(e.name!=='AbortError')fallbackShare(text)}}else{fallbackShare(text)}
}
function fallbackShare(text){if(navigator.clipboard){navigator.clipboard.writeText(text).then(()=>toast('Report copied — paste to send','ok'),()=>toast('Could not copy report','err'))}else{toast('Sharing not available on this device','err')}}

async function exportAll(){const all=await dbAll();const b=new Blob([JSON.stringify({audits:all,exported:new Date().toISOString(),app:'AuditSnap'},null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`auditsnap-backup-${new Date().toISOString().split('T')[0]}.json`;a.click();toast('Backup file downloaded','ok')}
async function handleImport(e){const f=e.target.files[0];if(!f)return;try{const d=JSON.parse(await f.text());if(!d.audits||!Array.isArray(d.audits))throw new Error('Invalid backup format');let count=0;for(const a of d.audits){await dbPut(a);count++}toast(`Imported ${count} audit${count!==1?'s':''}`,'ok');await loadAudits()}catch(err){toast(err.message.includes('Invalid')?'Invalid backup file':'Could not read file','err')}e.target.value=''}

function showUpgradeMsg(){toast('Contact ben@bennycutools.com to upgrade','ok')}

function toast(m,t){const el=document.createElement('div');el.className='tst'+(t?' '+t:'');el.setAttribute('role','status');el.innerHTML=(t==='ok'?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true"><polyline points="20 6 9 17 4 12"/></svg>':t==='err'?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>':'')+'<span>'+m+'</span>';document.getElementById('toasts').appendChild(el);setTimeout(()=>{el.style.opacity='0';el.style.transform='translateY(-8px)';setTimeout(()=>el.remove(),200)},3800)}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function timeAgo(ts){const d=Date.now()-ts,m=Math.floor(d/60000);if(m<1)return'Just now';if(m<60)return m+'m ago';const h=Math.floor(m/60);if(h<24)return h+'h ago';const dy=Math.floor(h/24);if(dy<7)return dy+'d ago';return new Date(ts).toLocaleDateString()}

(async function(){await initDB();await loadDemos();await loadAudits();renderRecs()})();
</script>
</body>
</html>