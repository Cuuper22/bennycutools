<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>The 1884 Index | Blake Brothers Huntsville Lifespan Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Caslon+Text:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --blake-red: #d22630;
            --blake-red-dark: #b01e27;
            --blake-red-light: rgba(210, 38, 48, 0.1);
            --blake-grey: #1c1b1a;
            --blake-grey-light: #3a3836;
            --text-primary: #1c1b1a;
            --text-secondary: #5a5856;
            --text-muted: #8a8886;
            --bg-white: #ffffff;
            --bg-cream: #fafaf8;
            --bg-warm: #f5f4f2;
            --border-light: #e8e6e4;
            --border-medium: #d0cecc;
            --success: #1a7d45;
            --warning: #c67b12;
            --font-heading: 'Libre Caslon Text', Georgia, serif;
            --font-body: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(28, 27, 26, 0.08);
            --shadow-md: 0 4px 12px rgba(28, 27, 26, 0.1);
            --shadow-lg: 0 8px 24px rgba(28, 27, 26, 0.12);
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: var(--font-body);
            background: var(--bg-cream);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            min-height: 100dvh;
            padding-bottom: 80px;
            -webkit-font-smoothing: antialiased;
        }

        @media (min-width: 1024px) {
            body {
                padding-bottom: 0;
            }
        }

        /* ===== HEADER ===== */
        .app-header {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-light);
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-mark {
            width: 36px;
            height: 36px;
            background: var(--blake-red);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: var(--font-heading);
            font-weight: 700;
            font-size: 14px;
            letter-spacing: -0.5px;
        }

        .brand-text {
            display: flex;
            flex-direction: column;
        }

        .brand-name {
            font-family: var(--font-heading);
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .brand-tagline {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 400;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            background: var(--bg-white);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .header-btn:hover {
            border-color: var(--blake-red);
            color: var(--blake-red);
        }

        .header-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Desktop Navigation */
        .desktop-nav {
            display: none;
        }

        @media (min-width: 1024px) {
            .desktop-nav {
                display: flex;
                gap: 4px;
            }

            .desktop-nav-btn {
                padding: 10px 20px;
                border-radius: var(--radius-md);
                border: none;
                background: transparent;
                color: var(--text-secondary);
                font-family: var(--font-body);
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all var(--transition-fast);
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .desktop-nav-btn:hover {
                background: var(--bg-warm);
                color: var(--text-primary);
            }

            .desktop-nav-btn.active {
                background: var(--blake-red-light);
                color: var(--blake-red);
            }

            .desktop-nav-btn svg {
                width: 18px;
                height: 18px;
            }
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        @media (min-width: 1024px) {
            .main-content {
                padding: 32px 20px;
            }
        }

        /* ===== VIEWS ===== */
        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== DEMO BANNER ===== */
        .demo-banner {
            background: linear-gradient(135deg, var(--blake-grey) 0%, var(--blake-grey-light) 100%);
            color: white;
            padding: 14px 20px;
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .demo-banner:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .demo-banner-text {
            font-size: 14px;
            line-height: 1.5;
        }

        .demo-banner-text strong {
            display: block;
            font-size: 13px;
            opacity: 0.8;
            margin-top: 4px;
            font-weight: 400;
        }

        .demo-banner-close {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .demo-banner-close:hover {
            background: rgba(255,255,255,0.25);
        }

        .demo-banner.hidden {
            display: none;
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background: var(--bg-warm);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }

        .empty-state-icon svg {
            width: 36px;
            height: 36px;
        }

        .empty-state h2 {
            font-family: var(--font-heading);
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .empty-state p {
            color: var(--text-secondary);
            font-size: 15px;
            max-width: 380px;
            margin: 0 auto 32px;
        }

        .empty-state-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        /* ===== PAGE TITLES ===== */
        .page-title {
            margin-bottom: 24px;
        }

        .page-title h1 {
            font-family: var(--font-heading);
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .page-title p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: none;
            text-decoration: none;
            min-height: 48px;
        }

        .btn svg {
            width: 18px;
            height: 18px;
        }

        .btn-primary {
            background: var(--blake-red);
            color: white;
        }

        .btn-primary:hover {
            background: var(--blake-red-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--bg-white);
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
        }

        .btn-secondary:hover {
            background: var(--bg-warm);
            border-color: var(--text-muted);
        }

        .btn-ghost {
            background: transparent;
            color: var(--blake-red);
            padding: 8px 16px;
            min-height: auto;
        }

        .btn-ghost:hover {
            background: var(--blake-red-light);
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            min-height: 44px;
        }

        /* ===== CALCULATOR FORM ===== */
        .calc-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        .calc-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .calc-header h2 {
            font-family: var(--font-heading);
            font-size: 18px;
            font-weight: 700;
        }

        .calc-header-badge {
            background: var(--blake-red-light);
            color: var(--blake-red);
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calc-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-hint {
            display: block;
            font-size: 12px;
            font-weight: 400;
            color: var(--text-muted);
            margin-top: 2px;
            text-transform: none;
            letter-spacing: 0;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-size: 16px;
            color: var(--text-primary);
            background: var(--bg-white);
            transition: all var(--transition-fast);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--blake-red);
            box-shadow: 0 0 0 3px var(--blake-red-light);
        }

        .form-input.error, .form-select.error {
            border-color: var(--blake-red);
            background: rgba(210, 38, 48, 0.03);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%235a5856' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 48px;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 480px) {
            .input-row {
                grid-template-columns: 1fr;
            }
        }

        .input-prefix {
            position: relative;
        }

        .input-prefix .form-input {
            padding-left: 36px;
        }

        .input-prefix::before {
            content: '$';
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 16px;
        }

        .form-error {
            color: var(--blake-red);
            font-size: 12px;
            margin-top: 6px;
            display: none;
        }

        .form-error.visible {
            display: block;
        }

        .calc-footer {
            padding: 20px 24px;
            background: var(--bg-warm);
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: 12px;
        }

        .calc-footer .btn {
            flex: 1;
        }

        /* ===== HUNTSVILLE FACTOR PANEL ===== */
        .factor-panel {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            margin-top: 20px;
            overflow: hidden;
        }

        .factor-header {
            padding: 16px 24px;
            background: var(--blake-grey);
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .factor-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .factor-icon svg {
            width: 20px;
            height: 20px;
        }

        .factor-title {
            font-family: var(--font-heading);
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .factor-subtitle {
            font-size: 12px;
            opacity: 0.7;
        }

        .factor-body {
            padding: 20px 24px;
        }

        .factor-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .factor-row:last-child {
            border-bottom: none;
        }

        .factor-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .factor-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .factor-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .factor-badge.high {
            background: rgba(210, 38, 48, 0.1);
            color: var(--blake-red);
        }

        .factor-badge.moderate {
            background: rgba(198, 123, 18, 0.1);
            color: var(--warning);
        }

        /* ===== RESULT CARD ===== */
        .result-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
            margin-top: 24px;
            overflow: hidden;
            display: none;
        }

        .result-card.visible {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-header {
            padding: 24px;
            text-align: center;
            border-bottom: 1px solid var(--border-light);
        }

        .result-verdict {
            font-family: var(--font-heading);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .result-verdict.replace {
            color: var(--blake-red);
        }

        .result-verdict.repair {
            color: var(--success);
        }

        .result-verdict.consider {
            color: var(--warning);
        }

        .result-confidence {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .result-body {
            padding: 24px;
        }

        .result-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .result-stat {
            background: var(--bg-warm);
            border-radius: var(--radius-md);
            padding: 16px;
            text-align: center;
        }

        .result-stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .result-stat-value {
            font-family: var(--font-heading);
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .result-stat-unit {
            font-size: 14px;
            font-weight: 400;
            color: var(--text-secondary);
        }

        .result-chart {
            margin: 24px 0;
        }

        .result-chart-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .chart-container {
            height: 200px;
            position: relative;
        }

        .result-explanation {
            background: var(--bg-warm);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-top: 24px;
        }

        .result-explanation h4 {
            font-family: var(--font-heading);
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .result-explanation p {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .result-footer {
            padding: 20px 24px;
            background: var(--bg-warm);
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: 12px;
        }

        .result-footer .btn {
            flex: 1;
        }

        /* ===== HISTORY LIST ===== */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-item {
            background: var(--bg-white);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .history-item:hover {
            border-color: var(--blake-red);
            box-shadow: var(--shadow-sm);
        }

        .history-item.demo {
            border-style: dashed;
        }

        .history-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            background: var(--bg-warm);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .history-icon svg {
            width: 22px;
            height: 22px;
            color: var(--text-secondary);
        }

        .history-icon.replace {
            background: var(--blake-red-light);
        }

        .history-icon.replace svg {
            color: var(--blake-red);
        }

        .history-icon.repair {
            background: rgba(26, 125, 69, 0.1);
        }

        .history-icon.repair svg {
            color: var(--success);
        }

        .history-content {
            flex: 1;
            min-width: 0;
        }

        .history-title {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-meta {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .history-verdict {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
            flex-shrink: 0;
        }

        .history-verdict.replace {
            background: var(--blake-red-light);
            color: var(--blake-red);
        }

        .history-verdict.repair {
            background: rgba(26, 125, 69, 0.1);
            color: var(--success);
        }

        .history-verdict.consider {
            background: rgba(198, 123, 18, 0.1);
            color: var(--warning);
        }

        .history-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .history-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .history-btn:hover {
            background: var(--bg-warm);
            color: var(--text-primary);
        }

        .history-btn.delete:hover {
            background: var(--blake-red-light);
            color: var(--blake-red);
        }

        .history-btn svg {
            width: 16px;
            height: 16px;
        }

        /* ===== SETTINGS VIEW ===== */
        .settings-section {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .settings-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
        }

        .settings-header h3 {
            font-family: var(--font-heading);
            font-size: 16px;
            font-weight: 700;
        }

        .settings-body {
            padding: 20px;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-info h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .settings-info p {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .settings-action .btn {
            padding: 10px 20px;
            min-height: 40px;
        }

        /* ===== BOTTOM NAV (Mobile) ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-white);
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: space-around;
            padding: 8px 0 max(8px, env(safe-area-inset-bottom));
            z-index: 100;
        }

        @media (min-width: 1024px) {
            .bottom-nav {
                display: none;
            }
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: color var(--transition-fast);
            min-width: 64px;
        }

        .nav-btn svg {
            width: 22px;
            height: 22px;
        }

        .nav-btn.active {
            color: var(--blake-red);
        }

        /* ===== TOAST ===== */
        .toast-container {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 90%;
            width: 400px;
        }

        .toast {
            background: var(--blake-grey);
            color: white;
            padding: 14px 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            animation: toastIn 0.3s ease;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(-16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .toast.toast-out {
            animation: toastOut 0.2s ease forwards;
        }

        @keyframes toastOut {
            to { opacity: 0; transform: translateY(-16px); }
        }

        .toast-message {
            font-size: 14px;
        }

        .toast-action {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .toast-action:hover {
            background: rgba(255,255,255,0.3);
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(28, 27, 26, 0.5);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.visible {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .modal {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow: auto;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-family: var(--font-heading);
            font-size: 18px;
            font-weight: 700;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--bg-warm);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            background: var(--bg-warm);
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* ===== LOADING SPINNER ===== */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-light);
            border-top-color: var(--blake-red);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body {
                background: white;
                padding: 0;
                user-select: text !important;
            }

            .app-header,
            .bottom-nav,
            .demo-banner,
            .toast-container,
            .modal-overlay,
            .calc-footer,
            .result-footer,
            .header-actions,
            .detail-back,
            .access-denied {
                display: none !important;
            }

            .main-content {
                max-width: 100%;
                padding: 20px;
            }

            .calc-card,
            .factor-panel,
            .result-card,
            .settings-section {
                box-shadow: none !important;
                border: 1px solid #ddd;
                break-inside: avoid;
                page-break-inside: avoid;
            }

            .result-card {
                display: block !important;
                margin-top: 20px;
            }
            
            .view {
                display: none !important;
                opacity: 1 !important;
            }
            
            .view.active,
            #detailView.active,
            #calculatorView.active {
                display: block !important;
            }

            .page-title::after {
                content: "Blake Brothers | Serving Huntsville Since 1884";
                display: block;
                font-size: 12px;
                color: #666;
                margin-top: 4px;
            }
            
            .result-verdict {
                color: var(--blake-red) !important;
            }
            
            .chart-container {
                height: 160px;
            }
            
            .result-stat {
                border: 1px solid #eee;
            }

            .print-only {
                display: block !important;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 30px;
                padding-bottom: 20px;
                border-bottom: 2px solid var(--blake-red);
            }
            
            .print-header h1 {
                font-family: var(--font-heading);
                font-size: 24px;
                color: var(--blake-red);
                margin: 0;
            }
            
            .print-header p {
                font-size: 12px;
                color: #666;
                margin-top: 8px;
            }
        }

        .print-only {
            display: none;
        }

        /* ===== FILE INPUT ===== */
        .file-input {
            display: none;
        }

        .file-drop {
            border: 2px dashed var(--border-medium);
            border-radius: var(--radius-md);
            padding: 32px;
            text-align: center;
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .file-drop:hover,
        .file-drop.dragover {
            border-color: var(--blake-red);
            background: var(--blake-red-light);
        }

        .file-drop-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            color: var(--text-muted);
        }

        .file-drop-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .file-drop-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* ===== TEXTAREA FOR PASTE ===== */
        .paste-area {
            width: 100%;
            min-height: 120px;
            padding: 14px 16px;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-size: 14px;
            resize: vertical;
        }

        .paste-area:focus {
            outline: none;
            border-color: var(--blake-red);
            box-shadow: 0 0 0 3px var(--blake-red-light);
        }

        /* ===== DETAIL VIEW ===== */
        .detail-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .detail-back {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            background: var(--bg-white);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .detail-back:hover {
            border-color: var(--blake-red);
            color: var(--blake-red);
        }

        .detail-back svg {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <div class="brand">
                <div class="brand-mark">1884</div>
                <div class="brand-text">
                    <span class="brand-name">The 1884 Index</span>
                    <span class="brand-tagline">Blake Brothers</span>
                </div>
            </div>

            <nav class="desktop-nav">
                <button class="desktop-nav-btn active" data-view="calculator">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="10" y2="10"/><line x1="14" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="10" y2="14"/><line x1="14" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="10" y2="18"/><line x1="14" y1="18" x2="16" y2="18"/></svg>
                    Calculator
                </button>
                <button class="desktop-nav-btn" data-view="history">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>
                    History
                </button>
                <button class="desktop-nav-btn" data-view="settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M4.22 4.22l4.24 4.24m7.08 7.08l4.24 4.24M1 12h6m6 0h6M4.22 19.78l4.24-4.24m7.08-7.08l4.24-4.24"/></svg>
                    Settings
                </button>
            </nav>

            <div class="header-actions">
                <button class="header-btn" id="printBtn" title="Print Report">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6,9 6,2 18,2 18,9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Calculator View -->
        <div class="view active" id="calculatorView">
            <!-- Demo Banner -->
            <div class="demo-banner" id="demoBanner">
                <div class="demo-banner-text">
                    Showing sample calculations.
                    <strong>Tap anywhere to clear demo data</strong>
                </div>
                <button class="demo-banner-close" id="demoBannerClose" aria-label="Clear demo data">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>

            <div class="page-title">
                <h1>Huntsville Lifespan Calculator</h1>
                <p>Calculate the true age of equipment adjusted for local conditions</p>
            </div>

            <!-- Calculator Form -->
            <div class="calc-card">
                <div class="calc-header">
                    <h2>Equipment Assessment</h2>
                    <span class="calc-header-badge">The Science of Service</span>
                </div>
                <div class="calc-body">
                    <div class="form-group">
                        <label class="form-label" for="equipmentType">Equipment Type</label>
                        <select class="form-select" id="equipmentType" required>
                            <option value="">Select equipment type...</option>
                            <option value="water_heater_tank">Water Heater (Tank)</option>
                            <option value="water_heater_tankless">Water Heater (Tankless)</option>
                            <option value="hvac_ac">Central Air Conditioner</option>
                            <option value="hvac_heat_pump">Heat Pump</option>
                            <option value="hvac_furnace">Gas Furnace</option>
                            <option value="hvac_package">Package Unit</option>
                            <option value="plumbing_sewer">Sewer Line</option>
                            <option value="plumbing_water">Water Line (Copper)</option>
                            <option value="plumbing_water_pex">Water Line (PEX)</option>
                        </select>
                        <div class="form-error" id="equipmentTypeError">Please select an equipment type</div>
                    </div>

                    <div class="input-row">
                        <div class="form-group">
                            <label class="form-label" for="equipmentAge">
                                Current Age
                                <span class="form-hint">Years since installation</span>
                            </label>
                            <input type="number" class="form-input" id="equipmentAge" placeholder="e.g., 8" min="0" max="50" required>
                            <div class="form-error" id="equipmentAgeError">Enter a valid age (0-50 years)</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="repairCost">
                                Repair Cost
                                <span class="form-hint">Proposed repair amount</span>
                            </label>
                            <div class="input-prefix">
                                <input type="number" class="form-input" id="repairCost" placeholder="e.g., 850" min="0" max="25000" required>
                            </div>
                            <div class="form-error" id="repairCostError">Enter a valid repair cost</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="replaceCost">
                            Replacement Cost
                            <span class="form-hint">Full replacement estimate</span>
                        </label>
                        <div class="input-prefix">
                            <input type="number" class="form-input" id="replaceCost" placeholder="e.g., 4500" min="0" max="50000" required>
                        </div>
                        <div class="form-error" id="replaceCostError">Enter a valid replacement cost</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="customerAddress">
                            Customer Address
                            <span class="form-hint">Optional — for record keeping</span>
                        </label>
                        <input type="text" class="form-input" id="customerAddress" placeholder="e.g., 123 Research Park Blvd">
                    </div>
                </div>
                <div class="calc-footer">
                    <button class="btn btn-secondary" type="button" id="clearFormBtn">Clear</button>
                    <button class="btn btn-primary" type="button" id="calculateBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/></svg>
                        Calculate
                    </button>
                </div>
            </div>

            <!-- Huntsville Factor Panel -->
            <div class="factor-panel">
                <div class="factor-header">
                    <div class="factor-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v6m0 8v6M4.93 4.93l4.24 4.24m5.66 5.66l4.24 4.24M2 12h6m8 0h6M4.93 19.07l4.24-4.24m5.66-5.66l4.24-4.24"/></svg>
                    </div>
                    <div>
                        <div class="factor-title">The Huntsville Factor</div>
                        <div class="factor-subtitle">Local conditions that affect equipment lifespan</div>
                    </div>
                </div>
                <div class="factor-body">
                    <div class="factor-row">
                        <span class="factor-label">Water Hardness (Madison County)</span>
                        <span class="factor-badge high">7-9 GPG • Hard</span>
                    </div>
                    <div class="factor-row">
                        <span class="factor-label">Average Summer Humidity</span>
                        <span class="factor-badge high">72% RH</span>
                    </div>
                    <div class="factor-row">
                        <span class="factor-label">Limestone Mineral Content</span>
                        <span class="factor-badge moderate">Elevated</span>
                    </div>
                    <div class="factor-row">
                        <span class="factor-label">Impact on Equipment</span>
                        <span class="factor-value">+25-40% accelerated wear</span>
                    </div>
                </div>
            </div>

            <!-- Result Card (Hidden until calculation) -->
            <div class="result-card" id="resultCard">
                <div class="result-header">
                    <div class="result-verdict" id="resultVerdict">Replace Recommended</div>
                    <div class="result-confidence" id="resultConfidence">Based on 140 years of Huntsville service data</div>
                </div>
                <div class="result-body">
                    <div class="result-stats">
                        <div class="result-stat">
                            <div class="result-stat-label">Calendar Age</div>
                            <div class="result-stat-value" id="calendarAge">10 <span class="result-stat-unit">years</span></div>
                        </div>
                        <div class="result-stat">
                            <div class="result-stat-label">Huntsville Adjusted Age</div>
                            <div class="result-stat-value" id="adjustedAge">14 <span class="result-stat-unit">years</span></div>
                        </div>
                        <div class="result-stat">
                            <div class="result-stat-label">Typical Lifespan</div>
                            <div class="result-stat-value" id="typicalLifespan">12 <span class="result-stat-unit">years</span></div>
                        </div>
                        <div class="result-stat">
                            <div class="result-stat-label">Repair/Replace Ratio</div>
                            <div class="result-stat-value" id="costRatio">42<span class="result-stat-unit">%</span></div>
                        </div>
                    </div>

                    <div class="result-chart">
                        <div class="result-chart-title">Lifespan Comparison</div>
                        <div class="chart-container">
                            <canvas id="lifespanChart"></canvas>
                        </div>
                    </div>

                    <div class="result-explanation selectable" id="resultExplanation">
                        <h4>The Blake Brothers Analysis</h4>
                        <p id="explanationText" class="selectable">
                            Your water heater has a calendar age of 10 years, but due to Huntsville's hard water (7-9 GPG) and high humidity, 
                            its effective "Huntsville Adjusted Age" is 14 years. With a typical lifespan of 12 years for this equipment type 
                            in our area, and a repair cost that's 42% of replacement, we recommend replacement for long-term value.
                        </p>
                    </div>
                </div>
                <div class="result-footer">
                    <button class="btn btn-secondary" id="saveResultBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        Save to History
                    </button>
                    <button class="btn btn-primary" id="printResultBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6,9 6,2 18,2 18,9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                        Print Report
                    </button>
                </div>
            </div>
        </div>

        <!-- History View -->
        <div class="view" id="historyView">
            <div class="page-title">
                <h1>Calculation History</h1>
                <p>Past assessments and saved reports</p>
            </div>

            <div class="history-list" id="historyList">
                <!-- Populated dynamically -->
            </div>

            <div class="empty-state" id="historyEmptyState" style="display: none;">
                <div class="empty-state-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>
                </div>
                <h2>No History Yet</h2>
                <p>Your saved calculations will appear here. Start by running a lifespan assessment.</p>
                <div class="empty-state-actions">
                    <button class="btn btn-primary" data-view="calculator">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/></svg>
                        New Calculation
                    </button>
                </div>
            </div>
        </div>

        <!-- Detail View -->
        <div class="view" id="detailView">
            <div class="detail-header">
                <button class="detail-back" id="detailBackBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                </button>
                <div class="page-title" style="margin-bottom: 0;">
                    <h1 id="detailTitle">Assessment Details</h1>
                    <p id="detailSubtitle">Saved on January 15, 2026</p>
                </div>
            </div>

            <div id="detailContent">
                <!-- Populated dynamically -->
            </div>
        </div>

        <!-- Settings View -->
        <div class="view" id="settingsView">
            <div class="page-title">
                <h1>Settings</h1>
                <p>Data management and preferences</p>
            </div>

            <div class="settings-section">
                <div class="settings-header">
                    <h3>Data Import</h3>
                </div>
                <div class="settings-body">
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Import CSV</h4>
                            <p>Upload equipment records from a spreadsheet</p>
                        </div>
                        <div class="settings-action">
                            <button class="btn btn-secondary" id="importCsvBtn">Upload CSV</button>
                            <input type="file" class="file-input" id="csvFileInput" accept=".csv">
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Paste from Clipboard</h4>
                            <p>Paste CSV data directly</p>
                        </div>
                        <div class="settings-action">
                            <button class="btn btn-secondary" id="pasteDataBtn">Paste Data</button>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Restore Backup</h4>
                            <p>Restore from a JSON backup file</p>
                        </div>
                        <div class="settings-action">
                            <button class="btn btn-secondary" id="restoreBtn">Restore</button>
                            <input type="file" class="file-input" id="jsonFileInput" accept=".json">
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-header">
                    <h3>Data Export</h3>
                </div>
                <div class="settings-body">
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Export CSV</h4>
                            <p>Download history as spreadsheet</p>
                        </div>
                        <div class="settings-action">
                            <button class="btn btn-secondary" id="exportCsvBtn">Download CSV</button>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Full Backup</h4>
                            <p>Download complete data backup (JSON)</p>
                        </div>
                        <div class="settings-action">
                            <button class="btn btn-secondary" id="exportJsonBtn">Download JSON</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-header">
                    <h3>Data Management</h3>
                </div>
                <div class="settings-body">
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Clear All Data</h4>
                            <p>Remove all saved calculations (cannot be undone)</p>
                        </div>
                        <div class="settings-action">
                            <button class="btn btn-secondary" id="clearAllBtn" style="color: var(--blake-red);">Clear All</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-header">
                    <h3>About</h3>
                </div>
                <div class="settings-body">
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>The 1884 Index</h4>
                            <p>Built for Blake Brothers • Serving Huntsville Since 1884</p>
                        </div>
                        <div class="settings-action">
                            <span style="font-size: 13px; color: var(--text-muted);">v1.0.0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav">
        <button class="nav-btn active" data-view="calculator">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="10" y2="10"/><line x1="14" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="10" y2="14"/><line x1="14" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="10" y2="18"/><line x1="14" y1="18" x2="16" y2="18"/></svg>
            Calculator
        </button>
        <button class="nav-btn" data-view="history">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>
            History
        </button>
        <button class="nav-btn" data-view="settings">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M4.22 4.22l4.24 4.24m7.08 7.08l4.24 4.24M1 12h6m6 0h6M4.22 19.78l4.24-4.24m7.08-7.08l4.24-4.24"/></svg>
            Settings
        </button>
    </nav>

    <!-- Paste Modal -->
    <div class="modal-overlay" id="pasteModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Paste CSV Data</h3>
                <button class="modal-close" data-modal-close>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; font-size: 14px; color: var(--text-secondary);">
                    Paste CSV data with columns: equipment_type, age, repair_cost, replace_cost, address
                </p>
                <textarea class="paste-area" id="pasteArea" placeholder="Paste CSV data here..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-modal-close>Cancel</button>
                <button class="btn btn-primary" id="processPasteBtn">Import Data</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="confirmTitle">Confirm Action</h3>
                <button class="modal-close" data-modal-close>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" style="font-size: 15px; color: var(--text-secondary);"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-modal-close>Cancel</button>
                <button class="btn btn-primary" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23d22630' rx='12' width='100' height='100'/%3E%3Ctext x='50' y='65' font-family='Georgia,serif' font-size='45' font-weight='bold' fill='white' text-anchor='middle'%3E1884%3C/text%3E%3C/svg%3E">
    <meta name="description" content="The 1884 Index - Huntsville Lifespan Calculator by Blake Brothers. Calculate equipment lifespan adjusted for local water hardness and humidity.">
    <meta name="theme-color" content="#d22630">
    <style>
        /* Security & Anti-Scrape */
        body {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        input, textarea, .form-input, .paste-area, .form-select {
            user-select: text !important;
            -webkit-user-select: text !important;
        }
        .selectable {
            user-select: text !important;
            -webkit-user-select: text !important;
        }
        
        /* Access Denied Screen */
        .access-denied {
            position: fixed;
            inset: 0;
            background: var(--blake-grey);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 40px;
            text-align: center;
        }
        .access-denied.hidden {
            display: none !important;
        }
        .access-denied-logo {
            width: 80px;
            height: 80px;
            background: var(--blake-red);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: var(--font-heading);
            font-weight: 700;
            font-size: 28px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-lg);
        }
        .access-denied h1 {
            font-family: var(--font-heading);
            font-size: 32px;
            color: white;
            margin-bottom: 12px;
        }
        .access-denied p {
            font-size: 16px;
            color: rgba(255,255,255,0.7);
            max-width: 400px;
            margin-bottom: 8px;
        }
        .access-denied .email {
            color: var(--blake-red);
            font-weight: 600;
        }
        
        /* Enhanced Micro-interactions */
        .btn, .nav-btn, .header-btn, .desktop-nav-btn, .history-item, .history-btn, .detail-back, .modal-close {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn:active, .nav-btn:active, .header-btn:active, .history-btn:active {
            transform: scale(0.96);
        }
        
        .history-item {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .form-input, .form-select, .paste-area {
            transition: all 0.2s ease;
        }
        
        /* Enhanced Focus States */
        .form-input:focus, .form-select:focus, .paste-area:focus, .btn:focus, .nav-btn:focus, .header-btn:focus, .desktop-nav-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(210, 38, 48, 0.25);
        }
        
        /* Smooth View Transitions */
        .view {
            opacity: 0;
            transform: translateY(12px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .view.active {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Enhanced Shadows */
        .calc-card, .factor-panel, .result-card, .settings-section {
            box-shadow: 
                0 1px 2px rgba(28, 27, 26, 0.04),
                0 4px 8px rgba(28, 27, 26, 0.06),
                0 8px 16px rgba(28, 27, 26, 0.04);
            transition: box-shadow 0.3s ease, transform 0.2s ease;
        }
        
        .calc-card:hover, .factor-panel:hover, .result-card:hover {
            box-shadow: 
                0 2px 4px rgba(28, 27, 26, 0.04),
                0 8px 16px rgba(28, 27, 26, 0.08),
                0 16px 32px rgba(28, 27, 26, 0.06);
        }
        
        /* Toast Animation Enhancement */
        @keyframes toastIn {
            from { opacity: 0; transform: translate(-50%, -20px) scale(0.95); }
            to { opacity: 1; transform: translate(-50%, 0) scale(1); }
        }
        @keyframes toastOut {
            from { opacity: 1; transform: translate(-50%, 0) scale(1); }
            to { opacity: 0; transform: translate(-50%, -10px) scale(0.95); }
        }
        
        /* Modal Enhancement */
        .modal-overlay {
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        /* Factor Panel Enhancement */
        .factor-panel {
            position: relative;
            overflow: hidden;
        }
        .factor-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--blake-red) 0%, var(--blake-red-dark) 100%);
        }
        
        /* Result Stats Enhancement */
        .result-stat {
            transition: transform 0.2s ease;
        }
        .result-stat:hover {
            transform: translateY(-2px);
        }
        
        /* Empty State Animation */
        .empty-state-icon {
            animation: pulse 3s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        /* Loading Spinner Enhancement */
        .spinner {
            animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }
        
        /* Chart Container Enhancement */
        .chart-container {
            position: relative;
        }
        .chart-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(to top, var(--bg-white), transparent);
            pointer-events: none;
        }
        
        /* Settings Item Hover */
        .settings-item {
            transition: background-color 0.15s ease;
        }
        .settings-item:hover {
            background-color: var(--bg-warm);
            margin: 0 -20px;
            padding-left: 20px;
            padding-right: 20px;
        }
    </style>
</head>
<body>
    <!-- Access Control Gate -->
    <div class="access-denied" id="accessDenied">
        <div class="access-denied-logo">1884</div>
        <h1>Access Denied</h1>
        <p>This tool requires an access key to view.</p>
        <p style="margin-top: 24px;">Contact <span class="email">ben@bennycutools.com</span> for access.</p>
    </div>

    <script>
        // ===== SECURITY LAYER =====
        (function() {
            // Hash function
            function _h(s) {
                let h = 0;
                for (let i = 0; i < s.length; i++) {
                    h = ((h << 5) - h) + s.charCodeAt(i);
                    h |= 0;
                }
                return h;
            }
            
            // Precomputed hash of "blke2026"
            const _V = -778997210;
            
            // Check access key from URL
            const params = new URLSearchParams(window.location.search);
            const key = params.get('key');
            
            if (!key || _h(key) !== _V) {
                // Access denied - keep the screen visible
                document.getElementById('accessDenied').classList.remove('hidden');
                // Stop loading the rest of the app
                throw new Error('Access denied: Invalid or missing key');
            } else {
                // Access granted - hide the denied screen
                document.getElementById('accessDenied').classList.add('hidden');
            }
            
            // Anti-scrape: Disable right-click
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            }, true);
            
            // Anti-scrape: Block keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl+S (Save)
                if (e.ctrlKey && (e.key === 's' || e.keyCode === 83)) {
                    e.preventDefault();
                    return false;
                }
                // Ctrl+U (View Source)
                if (e.ctrlKey && (e.key === 'u' || e.keyCode === 85)) {
                    e.preventDefault();
                    return false;
                }
                // Ctrl+Shift+I (Dev Tools)
                if (e.ctrlKey && e.shiftKey && (e.key === 'i' || e.keyCode === 73)) {
                    e.preventDefault();
                    return false;
                }
                // F12 (Dev Tools)
                if (e.key === 'F12' || e.keyCode === 123) {
                    e.preventDefault();
                    return false;
                }
            }, true);
        })();
        
        // ===== DATABASE LAYER =====
        const DB_NAME = 'BlakeBrothers1884Index';
        const DB_VERSION = 1;
        const STORE_NAME = 'calculations';

        class DataStore {
            constructor() {
                this.db = null;
                this.useLocalStorage = false;
            }

            async init() {
                try {
                    this.db = await this.openDB();
                } catch (e) {
                    console.warn('IndexedDB not available, falling back to localStorage');
                    this.useLocalStorage = true;
                }
            }

            openDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                            store.createIndex('createdAt', 'createdAt');
                            store.createIndex('isDemo', 'isDemo');
                        }
                    };
                });
            }

            async getAll() {
                if (this.useLocalStorage) {
                    const data = localStorage.getItem(DB_NAME);
                    return data ? JSON.parse(data) : [];
                }

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(STORE_NAME, 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)));
                    request.onerror = () => reject(request.error);
                });
            }

            async get(id) {
                if (this.useLocalStorage) {
                    const all = await this.getAll();
                    return all.find(item => item.id === id);
                }

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(STORE_NAME, 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.get(id);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async save(item) {
                if (this.useLocalStorage) {
                    const all = await this.getAll();
                    const index = all.findIndex(i => i.id === item.id);
                    if (index >= 0) all[index] = item;
                    else all.unshift(item);
                    localStorage.setItem(DB_NAME, JSON.stringify(all));
                    return item;
                }

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.put(item);
                    request.onsuccess = () => resolve(item);
                    request.onerror = () => reject(request.error);
                });
            }

            async delete(id) {
                if (this.useLocalStorage) {
                    const all = await this.getAll();
                    const filtered = all.filter(i => i.id !== id);
                    localStorage.setItem(DB_NAME, JSON.stringify(filtered));
                    return;
                }

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async clearAll() {
                if (this.useLocalStorage) {
                    localStorage.removeItem(DB_NAME);
                    return;
                }

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async clearDemo() {
                const all = await this.getAll();
                const nonDemo = all.filter(item => !item.isDemo);
                if (this.useLocalStorage) {
                    localStorage.setItem(DB_NAME, JSON.stringify(nonDemo));
                    return;
                }

                const tx = this.db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                for (const item of all) {
                    if (item.isDemo) {
                        store.delete(item.id);
                    }
                }
            }

            async hasDemo() {
                const all = await this.getAll();
                return all.some(item => item.isDemo);
            }
        }

        // ===== EQUIPMENT DATA =====
        const EQUIPMENT_DATA = {
            water_heater_tank: {
                name: 'Water Heater (Tank)',
                icon: 'droplet',
                nationalLifespan: 12,
                huntsvilleMultiplier: 1.35, // Hard water accelerates wear
                category: 'plumbing'
            },
            water_heater_tankless: {
                name: 'Water Heater (Tankless)',
                icon: 'droplet',
                nationalLifespan: 20,
                huntsvilleMultiplier: 1.25,
                category: 'plumbing'
            },
            hvac_ac: {
                name: 'Central Air Conditioner',
                icon: 'thermometer',
                nationalLifespan: 15,
                huntsvilleMultiplier: 1.30, // High humidity and heat
                category: 'hvac'
            },
            hvac_heat_pump: {
                name: 'Heat Pump',
                icon: 'thermometer',
                nationalLifespan: 15,
                huntsvilleMultiplier: 1.28,
                category: 'hvac'
            },
            hvac_furnace: {
                name: 'Gas Furnace',
                icon: 'flame',
                nationalLifespan: 20,
                huntsvilleMultiplier: 1.15, // Less humidity impact
                category: 'hvac'
            },
            hvac_package: {
                name: 'Package Unit',
                icon: 'thermometer',
                nationalLifespan: 15,
                huntsvilleMultiplier: 1.32,
                category: 'hvac'
            },
            plumbing_sewer: {
                name: 'Sewer Line',
                icon: 'pipe',
                nationalLifespan: 50,
                huntsvilleMultiplier: 1.20, // Root intrusion, clay soil
                category: 'plumbing'
            },
            plumbing_water: {
                name: 'Water Line (Copper)',
                icon: 'pipe',
                nationalLifespan: 50,
                huntsvilleMultiplier: 1.40, // Mineral deposits
                category: 'plumbing'
            },
            plumbing_water_pex: {
                name: 'Water Line (PEX)',
                icon: 'pipe',
                nationalLifespan: 40,
                huntsvilleMultiplier: 1.10,
                category: 'plumbing'
            }
        };

        // ===== DEMO DATA =====
        const DEMO_DATA = [
            {
                id: 'demo-1',
                equipmentType: 'water_heater_tank',
                age: 9,
                repairCost: 650,
                replaceCost: 2800,
                address: '2847 Research Park Blvd, Huntsville',
                calendarAge: 9,
                adjustedAge: 12.15,
                typicalLifespan: 8.89,
                costRatio: 23.21,
                verdict: 'replace',
                explanation: 'This 9-year-old tank water heater has a Huntsville Adjusted Age of 12 years due to our area\'s hard water (7-9 GPG). The limestone mineral buildup has likely reduced efficiency by 20-30%. At $650 repair (23% of replacement), replacement provides better long-term value.',
                createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                isDemo: true
            },
            {
                id: 'demo-2',
                equipmentType: 'hvac_ac',
                age: 6,
                repairCost: 450,
                replaceCost: 5500,
                address: '1205 Monte Sano Blvd, Huntsville',
                calendarAge: 6,
                adjustedAge: 7.8,
                typicalLifespan: 11.54,
                costRatio: 8.18,
                verdict: 'repair',
                explanation: 'At 6 calendar years (7.8 adjusted), this AC unit has significant life remaining. The $450 repair is only 8% of replacement cost — well within the repair range. The high humidity accelerates condenser wear, but regular maintenance extends life.',
                createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                isDemo: true
            },
            {
                id: 'demo-3',
                equipmentType: 'hvac_heat_pump',
                age: 12,
                repairCost: 1800,
                replaceCost: 7200,
                address: '509 Holmes Ave, Huntsville',
                calendarAge: 12,
                adjustedAge: 15.36,
                typicalLifespan: 11.72,
                costRatio: 25.00,
                verdict: 'replace',
                explanation: 'This 12-year heat pump is operating at 131% of its Huntsville-adjusted lifespan. The $1,800 repair (25% of replacement) would go into equipment statistically past its expected service life. Modern units are 20-30% more efficient.',
                createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                isDemo: true
            },
            {
                id: 'demo-4',
                equipmentType: 'plumbing_water',
                age: 25,
                repairCost: 850,
                replaceCost: 4500,
                address: '315 Jefferson St, Huntsville',
                calendarAge: 25,
                adjustedAge: 35,
                typicalLifespan: 35.71,
                costRatio: 18.89,
                verdict: 'consider',
                explanation: 'At 25 calendar years (35 adjusted), this copper water line is approaching but not past its expected Huntsville lifespan. The $850 repair (19% of replacement) is borderline. Consider the repair if isolated, but monitor for additional issues.',
                createdAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
                isDemo: true
            }
        ];

        // ===== GLOBAL STATE =====
        const store = new DataStore();
        let currentChart = null;
        let currentCalculation = null;
        let confirmCallback = null;
        let deletedItem = null;

        // ===== UTILITY FUNCTIONS =====
        function $(selector) {
            return document.querySelector(selector);
        }

        function $$(selector) {
            return document.querySelectorAll(selector);
        }

        function generateId() {
            return 'calc-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function showToast(message, action = null, actionLabel = 'Undo') {
            const container = $('#toastContainer');
            
            // Remove existing toasts to prevent stacking
            const existingToasts = container.querySelectorAll('.toast');
            existingToasts.forEach(t => {
                t.classList.add('toast-out');
                setTimeout(() => t.remove(), 200);
            });
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <span class="toast-message">${message}</span>
                ${action ? `<button class="toast-action">${actionLabel}</button>` : ''}
            `;
            container.appendChild(toast);

            if (action) {
                toast.querySelector('.toast-action').addEventListener('click', () => {
                    action();
                    toast.classList.add('toast-out');
                    setTimeout(() => toast.remove(), 200);
                });
            }

            setTimeout(() => {
                toast.classList.add('toast-out');
                setTimeout(() => toast.remove(), 200);
            }, 4000);
        }

        function showModal(modalId) {
            $(`#${modalId}`).classList.add('visible');
        }

        function hideModal(modalId) {
            $(`#${modalId}`).classList.remove('visible');
        }

        function showConfirm(title, message, callback) {
            $('#confirmTitle').textContent = title;
            $('#confirmMessage').textContent = message;
            confirmCallback = callback;
            showModal('confirmModal');
        }

        // ===== CALCULATION ENGINE =====
        function calculate(equipmentType, age, repairCost, replaceCost) {
            const equipment = EQUIPMENT_DATA[equipmentType];
            if (!equipment) return null;

            const adjustedAge = age * equipment.huntsvilleMultiplier;
            const huntsvilleLifespan = equipment.nationalLifespan / equipment.huntsvilleMultiplier;
            const costRatio = (repairCost / replaceCost) * 100;
            const lifespanPercentage = (adjustedAge / huntsvilleLifespan) * 100;

            // Decision logic
            let verdict, explanation;
            
            if (lifespanPercentage >= 100 || (costRatio >= 30 && lifespanPercentage >= 75)) {
                verdict = 'replace';
                explanation = generateExplanation('replace', equipment, age, adjustedAge, huntsvilleLifespan, repairCost, replaceCost, costRatio);
            } else if (costRatio < 15 && lifespanPercentage < 60) {
                verdict = 'repair';
                explanation = generateExplanation('repair', equipment, age, adjustedAge, huntsvilleLifespan, repairCost, replaceCost, costRatio);
            } else {
                verdict = 'consider';
                explanation = generateExplanation('consider', equipment, age, adjustedAge, huntsvilleLifespan, repairCost, replaceCost, costRatio);
            }

            return {
                calendarAge: age,
                adjustedAge: adjustedAge,
                typicalLifespan: huntsvilleLifespan,
                costRatio: costRatio,
                verdict: verdict,
                explanation: explanation,
                equipment: equipment
            };
        }

        function generateExplanation(verdict, equipment, calendarAge, adjustedAge, lifespan, repairCost, replaceCost, costRatio) {
            const percentOfLife = ((adjustedAge / lifespan) * 100).toFixed(0);
            
            if (verdict === 'replace') {
                return `This ${calendarAge}-year-old ${equipment.name.toLowerCase()} has a Huntsville Adjusted Age of ${adjustedAge.toFixed(1)} years—${percentOfLife}% of its expected local lifespan. ${equipment.category === 'plumbing' ? 'Our hard water (7-9 GPG) accelerates mineral buildup and corrosion.' : 'Alabama\'s high humidity and heat load accelerate wear on these systems.'} At $${repairCost.toLocaleString()} (${costRatio.toFixed(0)}% of replacement), investing in new equipment provides better long-term value and reliability.`;
            } else if (verdict === 'repair') {
                return `At ${calendarAge} calendar years (${adjustedAge.toFixed(1)} adjusted), this ${equipment.name.toLowerCase()} has significant service life remaining. The $${repairCost.toLocaleString()} repair represents only ${costRatio.toFixed(0)}% of replacement cost—well within the economical repair range. ${equipment.category === 'plumbing' ? 'Regular descaling can help offset hard water wear.' : 'Continued maintenance will maximize remaining lifespan.'}`;
            } else {
                return `This ${equipment.name.toLowerCase()} falls in a gray zone: at ${adjustedAge.toFixed(1)} Huntsville-adjusted years (${percentOfLife}% of typical lifespan) with a repair cost of ${costRatio.toFixed(0)}% of replacement. The repair may be worthwhile if the issue is isolated, but consider replacement if additional problems emerge. ${equipment.category === 'plumbing' ? 'Hard water wear is cumulative.' : 'System efficiency declines with age.'}`;
            }
        }

        // ===== VIEW NAVIGATION =====
        function switchView(viewName) {
            $$('.view').forEach(v => v.classList.remove('active'));
            $$('.nav-btn, .desktop-nav-btn').forEach(b => b.classList.remove('active'));
            
            const view = $(`#${viewName}View`);
            if (view) {
                view.classList.add('active');
                $$(`[data-view="${viewName}"]`).forEach(b => b.classList.add('active'));
            }

            // Scroll to top on view switch
            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (viewName === 'history') {
                renderHistory();
            }
        }

        // ===== RENDER FUNCTIONS =====
        async function renderHistory() {
            const list = $('#historyList');
            const empty = $('#historyEmptyState');
            const items = await store.getAll();

            if (items.length === 0) {
                list.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            list.style.display = 'flex';
            empty.style.display = 'none';

            list.innerHTML = items.map(item => {
                const equipment = EQUIPMENT_DATA[item.equipmentType];
                return `
                    <div class="history-item ${item.isDemo ? 'demo' : ''}" data-id="${item.id}">
                        <div class="history-icon ${item.verdict}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                ${item.verdict === 'replace' ? '<path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>' : item.verdict === 'repair' ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>' : '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>'}
                            </svg>
                        </div>
                        <div class="history-content">
                            <div class="history-title">${equipment ? equipment.name : item.equipmentType}</div>
                            <div class="history-meta">${item.address || 'No address'} • ${formatDate(item.createdAt)}</div>
                        </div>
                        <span class="history-verdict ${item.verdict}">${item.verdict === 'replace' ? 'Replace' : item.verdict === 'repair' ? 'Repair' : 'Consider'}</span>
                        <div class="history-actions">
                            <button class="history-btn view-btn" title="View details">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            </button>
                            <button class="history-btn delete" title="Delete">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Event listeners for history items
            list.querySelectorAll('.history-item').forEach(item => {
                const id = item.dataset.id;
                
                item.querySelector('.view-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    showDetail(id);
                });

                item.querySelector('.delete').addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await deleteItem(id);
                });

                item.addEventListener('click', () => showDetail(id));
            });
        }

        async function showDetail(id) {
            const item = await store.get(id);
            if (!item) return;

            const equipment = EQUIPMENT_DATA[item.equipmentType];
            
            $('#detailTitle').textContent = equipment ? equipment.name : 'Assessment Details';
            $('#detailSubtitle').textContent = `Saved on ${formatDate(item.createdAt)}`;

            $('#detailContent').innerHTML = `
                <div class="result-card visible">
                    <div class="result-header">
                        <div class="result-verdict ${item.verdict}">${item.verdict === 'replace' ? 'Replace Recommended' : item.verdict === 'repair' ? 'Repair Recommended' : 'Consider Both Options'}</div>
                        <div class="result-confidence">Based on 140 years of Huntsville service data</div>
                    </div>
                    <div class="result-body">
                        ${item.address ? `<p class="selectable" style="margin-bottom: 20px; font-size: 14px; color: var(--text-secondary);"><strong>Address:</strong> ${item.address}</p>` : ''}
                        <div class="result-stats">
                            <div class="result-stat">
                                <div class="result-stat-label">Calendar Age</div>
                                <div class="result-stat-value">${item.calendarAge} <span class="result-stat-unit">years</span></div>
                            </div>
                            <div class="result-stat">
                                <div class="result-stat-label">Huntsville Adjusted Age</div>
                                <div class="result-stat-value">${item.adjustedAge.toFixed(1)} <span class="result-stat-unit">years</span></div>
                            </div>
                            <div class="result-stat">
                                <div class="result-stat-label">Typical Lifespan</div>
                                <div class="result-stat-value">${item.typicalLifespan.toFixed(1)} <span class="result-stat-unit">years</span></div>
                            </div>
                            <div class="result-stat">
                                <div class="result-stat-label">Repair/Replace Ratio</div>
                                <div class="result-stat-value">${item.costRatio.toFixed(0)}<span class="result-stat-unit">%</span></div>
                            </div>
                        </div>
                        <div class="result-chart">
                            <div class="result-chart-title">Lifespan Comparison</div>
                            <div class="chart-container">
                                <canvas id="detailChart"></canvas>
                            </div>
                        </div>
                        <div class="result-explanation selectable">
                            <h4>The Blake Brothers Analysis</h4>
                            <p class="selectable">${item.explanation}</p>
                        </div>
                    </div>
                    <div class="result-footer">
                        <button class="btn btn-secondary" id="detailPrintBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6,9 6,2 18,2 18,9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                            Print Report
                        </button>
                    </div>
                </div>
            `;
            
            // Add print handler for detail view
            setTimeout(() => {
                const printBtn = document.getElementById('detailPrintBtn');
                if (printBtn) {
                    printBtn.addEventListener('click', () => window.print());
                }
            }, 0);

            // Render chart
            setTimeout(() => {
                renderChart('detailChart', item.calendarAge, item.adjustedAge, item.typicalLifespan, equipment);
            }, 100);

            switchView('detail');
        }

        function renderChart(canvasId, calendarAge, adjustedAge, lifespan, equipment) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            if (currentChart) {
                currentChart.destroy();
            }

            const maxVal = Math.max(calendarAge, adjustedAge, lifespan) * 1.2;
            
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Calendar Age', 'Huntsville Adjusted', 'Typical Lifespan (Huntsville)'],
                    datasets: [{
                        data: [calendarAge, adjustedAge, lifespan],
                        backgroundColor: [
                            'rgba(28, 27, 26, 0.7)',
                            '#d22630',
                            'rgba(28, 27, 26, 0.15)'
                        ],
                        borderColor: [
                            '#1c1b1a',
                            '#d22630',
                            'rgba(28, 27, 26, 0.3)'
                        ],
                        borderWidth: [1, 2, 1],
                        borderRadius: 6,
                        borderSkipped: false,
                        barThickness: 32
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    animation: {
                        duration: 800,
                        easing: 'easeOutQuart'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1c1b1a',
                            titleFont: { family: 'Poppins', size: 13 },
                            bodyFont: { family: 'Poppins', size: 13 },
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: (ctx) => `${ctx.parsed.x.toFixed(1)} years`
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: maxVal,
                            grid: {
                                color: 'rgba(28, 27, 26, 0.06)',
                                drawBorder: false
                            },
                            ticks: {
                                font: { family: 'Poppins', size: 11 },
                                callback: (val) => val + ' yrs',
                                color: '#8a8886'
                            },
                            border: { display: false }
                        },
                        y: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                font: { family: 'Poppins', size: 12, weight: '500' },
                                color: '#1c1b1a'
                            },
                            border: { display: false }
                        }
                    }
                }
            });
        }

        function displayResult(result, equipmentType) {
            const resultCard = $('#resultCard');
            resultCard.classList.add('visible');

            $('#resultVerdict').textContent = result.verdict === 'replace' ? 'Replace Recommended' : result.verdict === 'repair' ? 'Repair Recommended' : 'Consider Both Options';
            $('#resultVerdict').className = `result-verdict ${result.verdict}`;
            
            $('#calendarAge').innerHTML = `${result.calendarAge} <span class="result-stat-unit">years</span>`;
            $('#adjustedAge').innerHTML = `${result.adjustedAge.toFixed(1)} <span class="result-stat-unit">years</span>`;
            $('#typicalLifespan').innerHTML = `${result.typicalLifespan.toFixed(1)} <span class="result-stat-unit">years</span>`;
            $('#costRatio').innerHTML = `${result.costRatio.toFixed(0)}<span class="result-stat-unit">%</span>`;
            $('#explanationText').textContent = result.explanation;

            renderChart('lifespanChart', result.calendarAge, result.adjustedAge, result.typicalLifespan, result.equipment);

            currentCalculation = {
                ...result,
                equipmentType: equipmentType,
                address: $('#customerAddress').value
            };

            resultCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ===== DELETE WITH UNDO =====
        async function deleteItem(id) {
            const item = await store.get(id);
            await store.delete(id);
            deletedItem = item;
            renderHistory();
            
            showToast('Calculation deleted', async () => {
                if (deletedItem) {
                    await store.save(deletedItem);
                    deletedItem = null;
                    renderHistory();
                    showToast('Calculation restored');
                }
            });
        }

        // ===== IMPORT/EXPORT =====
        function exportCSV() {
            store.getAll().then(items => {
                if (items.length === 0) {
                    showToast('No data to export');
                    return;
                }

                const headers = ['equipment_type', 'age', 'repair_cost', 'replace_cost', 'address', 'verdict', 'adjusted_age', 'typical_lifespan', 'cost_ratio', 'created_at'];
                const rows = items.map(item => [
                    item.equipmentType,
                    item.age,
                    item.repairCost,
                    item.replaceCost,
                    `"${(item.address || '').replace(/"/g, '""')}"`,
                    item.verdict,
                    item.adjustedAge?.toFixed(2) || '',
                    item.typicalLifespan?.toFixed(2) || '',
                    item.costRatio?.toFixed(2) || '',
                    item.createdAt
                ]);

                const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                downloadFile(csv, 'blake-brothers-1884-index.csv', 'text/csv');
                showToast(`Exported ${items.length} record${items.length !== 1 ? 's' : ''} to CSV`);
            });
        }

        function exportJSON() {
            store.getAll().then(items => {
                if (items.length === 0) {
                    showToast('No data to export');
                    return;
                }
                
                const data = {
                    exportedAt: new Date().toISOString(),
                    version: '1.0.0',
                    source: 'Blake Brothers 1884 Index',
                    calculations: items
                };
                downloadFile(JSON.stringify(data, null, 2), 'blake-brothers-1884-backup.json', 'application/json');
                showToast(`Backup created with ${items.length} record${items.length !== 1 ? 's' : ''}`);
            });
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) {
                showToast('Invalid CSV: no data rows found');
                return 0;
            }

            const headers = lines[0].toLowerCase().split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            let imported = 0;
            let skipped = 0;

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length < 4) {
                    skipped++;
                    continue;
                }

                const record = {};
                headers.forEach((h, idx) => {
                    const val = values[idx] ? values[idx].trim().replace(/^"|"$/g, '') : '';
                    if (h.includes('type')) record.equipmentType = val;
                    else if (h.includes('age') && !h.includes('adjusted')) record.age = parseFloat(val);
                    else if (h.includes('repair')) record.repairCost = parseFloat(val);
                    else if (h.includes('replace')) record.replaceCost = parseFloat(val);
                    else if (h.includes('address')) record.address = val;
                });

                if (record.equipmentType && !isNaN(record.age) && !isNaN(record.repairCost) && !isNaN(record.replaceCost)) {
                    const result = calculate(record.equipmentType, record.age, record.repairCost, record.replaceCost);
                    if (result) {
                        store.save({
                            id: generateId(),
                            equipmentType: record.equipmentType,
                            age: record.age,
                            repairCost: record.repairCost,
                            replaceCost: record.replaceCost,
                            address: record.address || '',
                            ...result,
                            createdAt: new Date().toISOString(),
                            isDemo: false
                        });
                        imported++;
                    } else {
                        skipped++;
                    }
                } else {
                    skipped++;
                }
            }

            if (skipped > 0) {
                showToast(`Imported ${imported} records (${skipped} skipped)`);
            } else {
                showToast(`Imported ${imported} records`);
            }
            
            return imported;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let char of line) {
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        async function restoreJSON(text) {
            try {
                const data = JSON.parse(text);
                const items = data.calculations || data;
                
                if (!Array.isArray(items)) {
                    showToast('Invalid backup format');
                    return;
                }

                let imported = 0;
                let skipped = 0;
                for (const item of items) {
                    if (item.id && item.equipmentType) {
                        item.isDemo = false;
                        await store.save(item);
                        imported++;
                    } else {
                        skipped++;
                    }
                }

                if (imported > 0) {
                    showToast(`Restored ${imported} calculation${imported !== 1 ? 's' : ''}${skipped > 0 ? ` (${skipped} skipped)` : ''}`);
                    renderHistory();
                } else {
                    showToast('No valid records found in backup');
                }
            } catch (e) {
                showToast('Failed to parse backup file');
            }
        }

        // ===== DEMO DATA =====
        async function loadDemoData() {
            const hasDemo = await store.hasDemo();
            if (hasDemo) {
                $('#demoBanner').classList.remove('hidden');
                return;
            }

            const items = await store.getAll();
            if (items.length === 0) {
                for (const demo of DEMO_DATA) {
                    await store.save(demo);
                }
                $('#demoBanner').classList.remove('hidden');
            } else {
                $('#demoBanner').classList.add('hidden');
            }
        }

        async function clearDemoData(e) {
            if (e) e.stopPropagation();
            await store.clearDemo();
            $('#demoBanner').classList.add('hidden');
            showToast('Demo data cleared — start adding your own calculations');
            renderHistory();
        }

        // ===== FORM VALIDATION =====
        function validateForm() {
            let isValid = true;
            let firstError = null;

            const equipmentType = $('#equipmentType');
            const age = $('#equipmentAge');
            const repairCost = $('#repairCost');
            const replaceCost = $('#replaceCost');

            // Reset errors
            $$('.form-error').forEach(e => e.classList.remove('visible'));
            $$('.form-input, .form-select').forEach(i => i.classList.remove('error'));

            if (!equipmentType.value) {
                equipmentType.classList.add('error');
                $('#equipmentTypeError').classList.add('visible');
                isValid = false;
                if (!firstError) firstError = equipmentType;
            }

            const ageVal = parseFloat(age.value);
            if (isNaN(ageVal) || ageVal < 0 || ageVal > 50) {
                age.classList.add('error');
                $('#equipmentAgeError').classList.add('visible');
                isValid = false;
                if (!firstError) firstError = age;
            }

            const repairVal = parseFloat(repairCost.value);
            if (isNaN(repairVal) || repairVal < 0) {
                repairCost.classList.add('error');
                $('#repairCostError').classList.add('visible');
                isValid = false;
                if (!firstError) firstError = repairCost;
            }

            const replaceVal = parseFloat(replaceCost.value);
            if (isNaN(replaceVal) || replaceVal <= 0) {
                replaceCost.classList.add('error');
                $('#replaceCostError').classList.add('visible');
                isValid = false;
                if (!firstError) firstError = replaceCost;
            }
            
            // Check that repair cost is less than replace cost (warn if not)
            if (!isNaN(repairVal) && !isNaN(replaceVal) && repairVal > replaceVal) {
                repairCost.classList.add('error');
                $('#repairCostError').textContent = 'Repair cost should not exceed replacement cost';
                $('#repairCostError').classList.add('visible');
                isValid = false;
                if (!firstError) firstError = repairCost;
            } else {
                $('#repairCostError').textContent = 'Enter a valid repair cost';
            }

            // Focus first error field
            if (firstError) {
                firstError.focus();
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            return isValid ? { equipmentType: equipmentType.value, age: ageVal, repairCost: repairVal, replaceCost: replaceVal } : null;
        }

        function clearForm() {
            $('#equipmentType').value = '';
            $('#equipmentAge').value = '';
            $('#repairCost').value = '';
            $('#replaceCost').value = '';
            $('#customerAddress').value = '';
            $('#resultCard').classList.remove('visible');
            currentCalculation = null;
            $$('.form-error').forEach(e => e.classList.remove('visible'));
            $$('.form-input, .form-select').forEach(i => i.classList.remove('error'));
        }

        // ===== INITIALIZATION =====
        async function init() {
            await store.init();
            await loadDemoData();

            // Navigation
            $$('[data-view]').forEach(btn => {
                btn.addEventListener('click', () => switchView(btn.dataset.view));
            });

            // Calculator
            $('#calculateBtn').addEventListener('click', () => {
                const values = validateForm();
                if (values) {
                    const result = calculate(values.equipmentType, values.age, values.repairCost, values.replaceCost);
                    if (result) {
                        displayResult(result, values.equipmentType);
                    }
                }
            });

            $('#clearFormBtn').addEventListener('click', clearForm);

            $('#saveResultBtn').addEventListener('click', async () => {
                if (!currentCalculation) return;
                
                const item = {
                    id: generateId(),
                    equipmentType: currentCalculation.equipmentType,
                    age: currentCalculation.calendarAge,
                    repairCost: parseFloat($('#repairCost').value),
                    replaceCost: parseFloat($('#replaceCost').value),
                    address: currentCalculation.address,
                    calendarAge: currentCalculation.calendarAge,
                    adjustedAge: currentCalculation.adjustedAge,
                    typicalLifespan: currentCalculation.typicalLifespan,
                    costRatio: currentCalculation.costRatio,
                    verdict: currentCalculation.verdict,
                    explanation: currentCalculation.explanation,
                    createdAt: new Date().toISOString(),
                    isDemo: false
                };

                await store.save(item);
                showToast('Calculation saved to history');
            });

            $('#printResultBtn').addEventListener('click', () => window.print());
            $('#printBtn').addEventListener('click', () => window.print());

            // Demo banner - close button only, not entire banner
            $('#demoBannerClose').addEventListener('click', (e) => {
                e.stopPropagation();
                clearDemoData(e);
            });

            // Detail view back
            $('#detailBackBtn').addEventListener('click', () => switchView('history'));

            // Settings - Import/Export
            $('#exportCsvBtn').addEventListener('click', exportCSV);
            $('#exportJsonBtn').addEventListener('click', exportJSON);

            $('#importCsvBtn').addEventListener('click', () => $('#csvFileInput').click());
            $('#csvFileInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        importCSV(ev.target.result);
                        renderHistory();
                    };
                    reader.onerror = () => {
                        showToast('Error reading file');
                    };
                    reader.readAsText(file);
                }
                e.target.value = '';
            });

            $('#pasteDataBtn').addEventListener('click', () => showModal('pasteModal'));
            $('#processPasteBtn').addEventListener('click', () => {
                const text = $('#pasteArea').value;
                if (text.trim()) {
                    importCSV(text);
                    renderHistory();
                    $('#pasteArea').value = '';
                    hideModal('pasteModal');
                } else {
                    showToast('Please paste CSV data first');
                }
            });

            $('#restoreBtn').addEventListener('click', () => $('#jsonFileInput').click());
            $('#jsonFileInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => restoreJSON(ev.target.result);
                    reader.readAsText(file);
                }
                e.target.value = '';
            });

            $('#clearAllBtn').addEventListener('click', () => {
                showConfirm('Clear All Data', 'This will permanently delete all saved calculations. This action cannot be undone.', async () => {
                    await store.clearAll();
                    renderHistory();
                    showToast('All data cleared');
                });
            });

            // Confirm modal
            $('#confirmActionBtn').addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                    confirmCallback = null;
                }
                hideModal('confirmModal');
            });

            // Modal close buttons
            $$('[data-modal-close]').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.modal-overlay').classList.remove('visible');
                });
            });

            // Close modals on overlay click
            $$('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.classList.remove('visible');
                    }
                });
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Escape to close modals
                if (e.key === 'Escape') {
                    $$('.modal-overlay.visible').forEach(m => m.classList.remove('visible'));
                }
                
                // Enter to calculate when in form inputs
                if (e.key === 'Enter' && (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT')) {
                    const calcBtn = $('#calculateBtn');
                    if (calcBtn && !calcBtn.disabled) {
                        calcBtn.click();
                    }
                }
            });
        }

        // Start app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
