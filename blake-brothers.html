<!--
=============================================================
SELF-REVIEW RATINGS (1-10):
- Functionality: 9
- Mobile UX: 9
- Visual polish: 8
- Business fit: 9
- Offline capability: 10
=============================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Legacy Ledger | Blake Brothers Service Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Caslon+Text:wght@400;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --trust-red: #BF2424;
            --trust-red-dark: #8B1A1A;
            --heritage-gold: #BDB07E;
            --heritage-gold-dark: #9A8F65;
            --obsidian: #1C1B1A;
            --obsidian-light: #2D2C2B;
            --clean-white: #FFFFFF;
            --light-gray: #F5F5F4;
            --medium-gray: #E8E7E5;
            --text-muted: #6B6B6B;
            --text-dark: #1C1B1A;
            --success-green: #2E7D32;
            --warning-orange: #F57C00;
            --error-red: #C62828;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--light-gray);
            color: var(--obsidian);
            min-height: 100vh;
            font-size: 16px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Prevent text selection on structural elements */
        .header, .tab-bar, .card-header, .section-header, .settings-list, 
        .demo-banner, .stat-card, .filter-pills, .timeline-dot,
        .customer-avatar, .health-gauge, .empty-state-icon,
        .modal-header, .modal-footer, .btn, .tab-btn, .header-btn,
        .filter-pill, .settings-item, .card-actions {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* Allow selection on inputs and textareas */
        input, textarea, .form-input, .form-textarea, .form-select {
            user-select: text;
            -webkit-user-select: text;
        }

        h1, h2, h3, h4 {
            font-family: 'Libre Caslon Text', Georgia, serif;
            font-weight: 700;
            line-height: 1.3;
            color: var(--text-dark);
        }

        /* Access Denied Overlay */
        #accessDenied {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--obsidian);
            z-index: 10000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
            color: var(--clean-white);
        }

        #accessDenied .lock-icon {
            width: 80px;
            height: 80px;
            background: var(--trust-red);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        #accessDenied .lock-icon svg {
            width: 40px;
            height: 40px;
        }

        #accessDenied h1 {
            color: var(--clean-white);
            font-size: 28px;
            margin-bottom: 12px;
        }

        #accessDenied p {
            color: var(--medium-gray);
            font-size: 16px;
            max-width: 400px;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        #accessDenied .contact-link {
            color: var(--heritage-gold);
            text-decoration: none;
            font-weight: 500;
            padding: 12px 24px;
            border: 2px solid var(--heritage-gold);
            border-radius: 8px;
            transition: all 0.2s;
        }

        #accessDenied .contact-link:hover {
            background: var(--heritage-gold);
            color: var(--obsidian);
        }

        /* Header */
        .header {
            background: var(--obsidian);
            color: var(--clean-white);
            padding: 12px 16px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 64px;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            background: var(--trust-red);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Libre Caslon Text', Georgia, serif;
            font-weight: 700;
            font-size: 20px;
            flex-shrink: 0;
        }

        .header-title {
            font-family: 'Libre Caslon Text', Georgia, serif;
            font-size: 18px;
            font-weight: 700;
            line-height: 1.2;
        }

        .header-since {
            font-size: 11px;
            color: var(--heritage-gold);
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            background: none;
            border: none;
            color: var(--clean-white);
            width: 44px;
            height: 44px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s, transform 0.1s;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.12);
        }

        .header-btn:active {
            transform: scale(0.95);
        }

        /* Main Content */
        .main {
            padding-top: 76px;
            padding-bottom: 90px;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.2s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--clean-white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(28, 27, 26, 0.06);
            border: 1px solid rgba(0,0,0,0.04);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            gap: 12px;
        }

        .card-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--obsidian);
            line-height: 1.3;
        }

        .card-subtitle {
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .card-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .badge-priority {
            background: var(--heritage-gold);
            color: var(--obsidian);
        }

        .badge-standard {
            background: var(--medium-gray);
            color: var(--text-muted);
        }

        .badge-hvac { background: #E3F2FD; color: #1565C0; }
        .badge-plumbing { background: #E8F5E9; color: #2E7D32; }
        .badge-electrical { background: #FFF8E1; color: #F57C00; }
        .badge-duct { background: #F3E5F5; color: #7B1FA2; }
        .badge-generator { background: #E8F5E9; color: #2E7D32; }
        .badge-crawlspace { background: #EFEBE9; color: #5D4037; }

        .card-meta {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: var(--text-muted);
            flex-wrap: wrap;
        }

        .card-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--medium-gray);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            border: none;
            min-height: 48px;
            min-width: 48px;
            transition: transform 0.1s, box-shadow 0.2s, background 0.2s;
            line-height: 1.2;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-primary {
            background: var(--trust-red);
            color: var(--clean-white);
        }

        .btn-primary:hover {
            background: var(--trust-red-dark);
            box-shadow: 0 4px 16px rgba(191, 36, 36, 0.35);
        }

        .btn-secondary {
            background: var(--medium-gray);
            color: var(--obsidian);
        }

        .btn-secondary:hover {
            background: #DCD9D6;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--trust-red);
            color: var(--trust-red);
        }

        .btn-outline:hover {
            background: rgba(191, 36, 36, 0.06);
        }

        .btn-sm {
            padding: 10px 16px;
            font-size: 14px;
            min-height: 40px;
        }

        .btn-block {
            width: 100%;
        }

        .btn-gold {
            background: var(--heritage-gold);
            color: var(--obsidian);
        }

        .btn-gold:hover {
            background: var(--heritage-gold-dark);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--obsidian);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            font-family: 'Poppins', sans-serif;
            border: 2px solid var(--medium-gray);
            border-radius: 10px;
            background: var(--clean-white);
            color: var(--obsidian);
            transition: border-color 0.2s, box-shadow 0.2s;
            min-height: 48px;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--trust-red);
            box-shadow: 0 0 0 3px rgba(191, 36, 36, 0.1);
        }

        .form-input.error, .form-select.error, .form-textarea.error {
            border-color: var(--trust-red);
            animation: shake 0.4s ease;
            box-shadow: 0 0 0 3px rgba(191, 36, 36, 0.1);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.5;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 400px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 0;
            min-height: 44px;
        }

        .form-checkbox input {
            width: 24px;
            height: 24px;
            accent-color: var(--trust-red);
            cursor: pointer;
            flex-shrink: 0;
        }

        .form-checkbox span {
            font-size: 15px;
            user-select: none;
        }

        /* Bottom Tab Bar */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--clean-white);
            display: flex;
            justify-content: space-around;
            padding: 8px 4px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            box-shadow: 0 -2px 20px rgba(0,0,0,0.08);
            z-index: 100;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .tab-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 8px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 11px;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            min-width: 56px;
            min-height: 52px;
            border-radius: 12px;
            transition: all 0.15s;
        }

        .tab-btn.active {
            color: var(--trust-red);
            background: rgba(191, 36, 36, 0.08);
        }

        .tab-btn:active {
            transform: scale(0.95);
        }

        .tab-btn svg {
            width: 24px;
            height: 24px;
            transition: transform 0.15s;
        }

        .tab-btn:active svg {
            transform: scale(0.9);
        }

        /* Desktop Navigation */
        @media (min-width: 1024px) {
            .tab-bar {
                position: fixed;
                top: 64px;
                left: 0;
                right: auto;
                bottom: 0;
                width: 220px;
                flex-direction: column;
                justify-content: flex-start;
                padding: 20px 16px;
                gap: 8px;
                box-shadow: 2px 0 20px rgba(0,0,0,0.06);
                border-top: none;
                border-right: 1px solid rgba(0,0,0,0.05);
            }

            .tab-btn {
                flex-direction: row;
                justify-content: flex-start;
                gap: 14px;
                padding: 14px 18px;
                border-radius: 12px;
                font-size: 15px;
                width: 100%;
                min-height: 48px;
            }

            .tab-btn.active {
                background: rgba(191, 36, 36, 0.1);
            }

            .main {
                padding-left: 236px;
                padding-bottom: 24px;
            }

            .container {
                max-width: 800px;
                padding: 24px;
            }

            .header {
                padding: 14px 24px;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 56px 24px;
            animation: fadeIn 0.3s ease;
        }

        .empty-state-icon {
            width: 88px;
            height: 88px;
            background: var(--medium-gray);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .empty-state-icon svg {
            width: 44px;
            height: 44px;
            color: var(--text-muted);
        }

        .empty-state h2 {
            font-size: 24px;
            margin-bottom: 12px;
            color: var(--obsidian);
        }

        .empty-state p {
            color: var(--text-muted);
            margin-bottom: 28px;
            font-size: 15px;
            line-height: 1.5;
        }

        .empty-state-links {
            margin-top: 20px;
        }

        .empty-state-links a {
            color: var(--trust-red);
            text-decoration: underline;
            font-size: 15px;
            font-weight: 500;
        }

        /* Demo Banner */
        .demo-banner {
            background: var(--heritage-gold);
            color: var(--obsidian);
            padding: 14px 16px;
            text-align: center;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 500;
            transition: background 0.2s;
            position: relative;
            z-index: 50;
        }

        .demo-banner:hover {
            background: var(--heritage-gold-dark);
        }

        .demo-banner:active {
            transform: scale(0.995);
        }

        .demo-banner-close {
            font-weight: 600;
            text-decoration: underline;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--obsidian);
            color: var(--clean-white);
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 16px;
            opacity: 0;
            transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 200;
            max-width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            min-height: 56px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast-undo {
            background: var(--trust-red);
            color: var(--clean-white);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            transition: transform 0.1s;
            min-height: 36px;
        }

        .toast-undo:active {
            transform: scale(0.95);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(28, 27, 26, 0.75);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 300;
            padding: 0;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        .modal-overlay.show {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        @media (min-width: 640px) {
            .modal-overlay {
                align-items: center;
                padding: 24px;
            }
        }

        .modal {
            background: var(--clean-white);
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @media (min-width: 640px) {
            .modal {
                border-radius: 20px;
                max-height: 90vh;
            }
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--clean-white);
            z-index: 10;
        }

        .modal-header h3 {
            font-size: 20px;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--light-gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.15s, transform 0.1s;
        }

        .modal-close:hover {
            background: var(--medium-gray);
        }

        .modal-close:active {
            transform: scale(0.95);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px 24px;
            border-top: 1px solid var(--medium-gray);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            position: sticky;
            bottom: 0;
            background: var(--clean-white);
        }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        @media (max-width: 360px) {
            .stats-row {
                gap: 8px;
            }
        }

        .stat-card {
            background: var(--clean-white);
            border-radius: 16px;
            padding: 20px 12px;
            text-align: center;
            box-shadow: 0 2px 12px rgba(28, 27, 26, 0.06);
            border: 1px solid rgba(0,0,0,0.04);
            transition: transform 0.15s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(28, 27, 26, 0.1);
        }

        .stat-number {
            font-family: 'Libre Caslon Text', Georgia, serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--trust-red);
            line-height: 1.2;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Section Header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 12px;
        }

        .section-title {
            font-size: 22px;
            color: var(--obsidian);
        }

        /* Health Score */
        .health-score {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .health-gauge {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
            border: 3px solid;
        }

        .health-good { background: #E8F5E9; color: var(--success-green); border-color: #A5D6A7; }
        .health-fair { background: #FFF8E1; color: var(--warning-orange); border-color: #FFCC80; }
        .health-poor { background: #FFEBEE; color: var(--error-red); border-color: #EF9A9A; }

        /* Service History Timeline */
        .timeline {
            position: relative;
            padding-left: 28px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 9px;
            top: 8px;
            bottom: 8px;
            width: 2px;
            background: linear-gradient(to bottom, var(--medium-gray), transparent);
        }

        .timeline-item {
            position: relative;
            padding-bottom: 24px;
        }

        .timeline-item:last-child {
            padding-bottom: 0;
        }

        .timeline-dot {
            position: absolute;
            left: -28px;
            top: 4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--trust-red);
            border: 4px solid var(--clean-white);
            box-shadow: 0 0 0 2px var(--trust-red);
        }

        .timeline-date {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .timeline-title {
            font-weight: 600;
            font-size: 16px;
            line-height: 1.4;
        }

        .timeline-desc {
            font-size: 15px;
            color: var(--text-muted);
            margin-top: 6px;
            line-height: 1.5;
        }

        /* Customer List */
        .customer-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: var(--clean-white);
            border-radius: 14px;
            margin-bottom: 12px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid rgba(0,0,0,0.04);
            transition: all 0.15s;
            min-height: 80px;
        }

        .customer-item:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            transform: translateY(-2px);
            border-color: rgba(191, 36, 36, 0.15);
        }

        .customer-item:active {
            transform: scale(0.995);
        }

        .customer-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--heritage-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--obsidian);
            font-size: 16px;
            flex-shrink: 0;
        }

        .customer-info {
            flex: 1;
            min-width: 0;
        }

        .customer-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .customer-name .card-badge {
            margin-left: 8px;
            font-size: 9px;
            padding: 3px 8px;
            vertical-align: middle;
        }

        .customer-address {
            font-size: 14px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Search */
        .search-bar {
            position: relative;
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 14px 16px 14px 48px;
            font-size: 16px;
            border: 2px solid var(--medium-gray);
            border-radius: 12px;
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
            min-height: 52px;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--trust-red);
            box-shadow: 0 0 0 3px rgba(191, 36, 36, 0.1);
        }

        .search-bar svg {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        /* Filter Pills */
        .filter-pills {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 16px;
            margin-bottom: 16px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .filter-pills::-webkit-scrollbar {
            display: none;
        }

        .filter-pill {
            padding: 10px 18px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            border: 2px solid var(--medium-gray);
            background: var(--clean-white);
            color: var(--text-muted);
            cursor: pointer;
            white-space: nowrap;
            font-family: 'Poppins', sans-serif;
            transition: all 0.15s;
            min-height: 44px;
        }

        .filter-pill.active {
            background: var(--trust-red);
            border-color: var(--trust-red);
            color: var(--clean-white);
        }

        .filter-pill:active {
            transform: scale(0.95);
        }

        /* Follow-up item */
        .followup-item {
            background: var(--clean-white);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 12px;
            border-left: 4px solid var(--trust-red);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            cursor: pointer;
            transition: all 0.15s;
        }

        .followup-item:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            transform: translateX(4px);
        }

        .followup-overdue {
            border-left-color: var(--error-red);
            background: #FFF8F8;
        }

        .followup-soon {
            border-left-color: var(--warning-orange);
            background: #FFFBF0;
        }

        .followup-item h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            font-family: 'Poppins', sans-serif;
        }

        .followup-meta {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .followup-due {
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 6px;
        }

        .due-overdue { color: var(--error-red); background: #FFEBEE; }
        .due-soon { color: var(--warning-orange); background: #FFF8E1; }
        .due-later { color: var(--success-green); background: #E8F5E9; }

        /* Print Report Styles */
        .print-report {
            display: none;
        }

        @media print {
            body {
                background: white !important;
            }

            .header, .tab-bar, .demo-banner, .toast, .modal-overlay, #accessDenied {
                display: none !important;
            }

            .main {
                padding: 0 !important;
            }

            .tab-content {
                display: none !important;
            }

            .print-report {
                display: block !important;
                padding: 24px;
                font-size: 12pt;
                color: black;
            }

            .print-report h1 {
                font-size: 28pt;
                margin-bottom: 8px;
                font-family: 'Libre Caslon Text', Georgia, serif;
            }

            .print-report h2 {
                font-size: 18pt;
                margin: 28px 0 14px;
                border-bottom: 2px solid #333;
                padding-bottom: 8px;
                font-family: 'Libre Caslon Text', Georgia, serif;
            }

            .print-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 32px;
                padding-bottom: 20px;
                border-bottom: 3px solid var(--trust-red);
            }

            .print-health-box {
                border: 3px solid var(--trust-red);
                padding: 16px 28px;
                text-align: center;
                border-radius: 8px;
            }

            .print-health-box .score {
                font-size: 36pt;
                font-weight: bold;
                color: var(--trust-red);
                font-family: 'Libre Caslon Text', Georgia, serif;
            }

            .print-service-item {
                padding: 14px 0;
                border-bottom: 1px solid #ddd;
            }

            .card, .stat-card, .customer-item, .followup-item {
                box-shadow: none !important;
                break-inside: avoid;
            }
        }

        /* Settings List */
        .settings-list {
            background: var(--clean-white);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(28, 27, 26, 0.06);
            border: 1px solid rgba(0,0,0,0.04);
        }

        .settings-item {
            padding: 18px 20px;
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.15s;
            min-height: 60px;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item:hover {
            background: var(--light-gray);
        }

        .settings-item:active {
            background: var(--medium-gray);
        }

        .settings-label {
            font-weight: 500;
            font-size: 15px;
        }

        .settings-value {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Hidden file inputs */
        .hidden-input {
            display: none;
        }

        /* Required field indicator */
        .form-label .required {
            color: var(--trust-red);
            margin-left: 4px;
        }

        /* Keyboard focus improvements */
        .btn:focus-visible,
        .form-input:focus-visible,
        .form-select:focus-visible,
        .form-textarea:focus-visible,
        .header-btn:focus-visible,
        .tab-btn:focus-visible,
        .filter-pill:focus-visible,
        .settings-item:focus-visible,
        .customer-item:focus-visible {
            outline: 2px solid var(--trust-red);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- Access Denied Overlay -->
    <div id="accessDenied">
        <div class="lock-icon">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
        </div>
        <h1>Access Denied</h1>
        <p>This tool requires a valid access key. Please contact the tool administrator for access.</p>
        <a href="mailto:ben@bennycutools.com" class="contact-link">Contact ben@bennycutools.com</a>
    </div>

    <!-- Demo Banner -->
    <div class="demo-banner" id="demoBanner" style="display: none;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <span>Sample data loaded — tap to clear and start fresh</span>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="5" y1="12" x2="19" y2="12"></line>
            <polyline points="12 5 19 12 12 19"></polyline>
        </svg>
    </div>

    <!-- Header -->
    <header class="header" id="appHeader">
        <div class="header-brand">
            <div class="header-logo">B</div>
            <div>
                <div class="header-title">Legacy Ledger</div>
                <div class="header-since">Blake Brothers • Since 1884</div>
            </div>
        </div>
        <div class="header-actions">
            <button class="header-btn" onclick="showModal('settingsModal')" aria-label="Settings" title="Settings">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main" id="appContainer">
        <div class="container">
            <!-- Tab: Log Visit (Primary Workflow) -->
            <div class="tab-content active" id="tab-log">
                <div class="section-header">
                    <h2 class="section-title">Log Service Visit</h2>
                </div>
                <form id="visitForm" class="card">
                    <div class="form-group">
                        <label class="form-label">Customer Name <span class="required">*</span></label>
                        <input type="text" class="form-input" id="customerName" placeholder="e.g. Johnson Family" required autocomplete="name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Property Address <span class="required">*</span></label>
                        <input type="text" class="form-input" id="propertyAddress" placeholder="e.g. 123 Maple St, Huntsville AL" required autocomplete="street-address">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="customerPhone" placeholder="(256) 555-0123" autocomplete="tel">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Service Type <span class="required">*</span></label>
                            <select class="form-select" id="serviceType" required>
                                <option value="">Select service...</option>
                                <option value="HVAC">HVAC</option>
                                <option value="Plumbing">Plumbing</option>
                                <option value="Electrical">Electrical</option>
                                <option value="Duct & Air Quality">Duct & Air Quality</option>
                                <option value="Generators">Generators</option>
                                <option value="Crawl Space">Crawl Space</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Visit Date <span class="required">*</span></label>
                            <input type="date" class="form-input" id="visitDate" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Work Performed <span class="required">*</span></label>
                        <textarea class="form-textarea" id="workPerformed" placeholder="Describe the service performed, parts replaced, findings, recommendations..." required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Invoice Amount ($)</label>
                            <input type="number" class="form-input" id="invoiceAmount" placeholder="0.00" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Technician</label>
                            <input type="text" class="form-input" id="technicianName" placeholder="Tech name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Follow-up Needed?</label>
                        <select class="form-select" id="followupType">
                            <option value="none">No follow-up needed</option>
                            <option value="30">Schedule maintenance in 30 days</option>
                            <option value="90">Schedule check-up in 90 days</option>
                            <option value="180">Semi-annual maintenance</option>
                            <option value="365">Annual maintenance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-checkbox">
                            <input type="checkbox" id="isPriorityMember">
                            <span>Priority Maintenance Member</span>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg>
                        Save Service Visit
                    </button>
                </form>
            </div>

            <!-- Tab: Customers -->
            <div class="tab-content" id="tab-customers">
                <div class="section-header">
                    <h2 class="section-title">Customers</h2>
                    <button class="btn btn-sm btn-outline" onclick="showTab('log')">+ New Visit</button>
                </div>
                <div class="search-bar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <input type="text" id="customerSearch" placeholder="Search customers by name or address...">
                </div>
                <div class="filter-pills">
                    <button class="filter-pill active" data-filter="all">All Customers</button>
                    <button class="filter-pill" data-filter="priority">Priority Members</button>
                    <button class="filter-pill" data-filter="recent">Recent (30 days)</button>
                </div>
                <div id="customerList"></div>
            </div>

            <!-- Tab: Follow-ups -->
            <div class="tab-content" id="tab-followups">
                <div class="section-header">
                    <h2 class="section-title">Follow-ups Due</h2>
                </div>
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-number" id="statOverdue">0</div>
                        <div class="stat-label">Overdue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statThisWeek">0</div>
                        <div class="stat-label">This Week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statThisMonth">0</div>
                        <div class="stat-label">This Month</div>
                    </div>
                </div>
                <div id="followupList"></div>
            </div>

            <!-- Tab: Reports -->
            <div class="tab-content" id="tab-reports">
                <h2 class="section-title" style="margin-bottom: 20px;">Generate Home Health Report</h2>
                <div class="card">
                    <p style="color: var(--text-muted); margin-bottom: 20px; line-height: 1.6;">Select a customer to generate a printable Home Health Report showing their complete service history with Blake Brothers.</p>
                    <div class="form-group">
                        <label class="form-label">Select Customer</label>
                        <select class="form-select" id="reportCustomer">
                            <option value="">Choose a customer...</option>
                        </select>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="generateReport()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                        Generate & Print Report
                    </button>
                </div>
                <div style="margin-top: 28px;">
                    <h3 class="section-title" style="margin-bottom: 16px; font-size: 18px;">Quick Stats</h3>
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-number" id="statTotalCustomers">0</div>
                            <div class="stat-label">Customers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="statTotalVisits">0</div>
                            <div class="stat-label">Visits</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="statPriorityMembers">0</div>
                            <div class="stat-label">Priority</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Data -->
            <div class="tab-content" id="tab-data">
                <h2 class="section-title" style="margin-bottom: 20px;">Data Management</h2>
                <div class="settings-list">
                    <div class="settings-item" onclick="exportCSV()">
                        <span class="settings-label">Export to CSV</span>
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    </div>
                    <div class="settings-item" onclick="exportJSON()">
                        <span class="settings-label">Full Backup (JSON)</span>
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    </div>
                    <div class="settings-item" onclick="document.getElementById('csvImport').click()">
                        <span class="settings-label">Import CSV</span>
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    </div>
                    <div class="settings-item" onclick="document.getElementById('jsonImport').click()">
                        <span class="settings-label">Restore from Backup</span>
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    </div>
                    <div class="settings-item" onclick="showPasteModal()">
                        <span class="settings-label">Paste from Clipboard</span>
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
                    </div>
                </div>
                <input type="file" id="csvImport" class="hidden-input" accept=".csv" onchange="importCSV(event)">
                <input type="file" id="jsonImport" class="hidden-input" accept=".json" onchange="importJSON(event)">
            </div>
        </div>
    </main>

    <!-- Print Report (hidden, shown only on print) -->
    <div class="print-report" id="printReport"></div>

    <!-- Bottom Tab Bar -->
    <nav class="tab-bar" id="appTabBar">
        <button class="tab-btn active" data-tab="log" aria-label="Log Visit">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
            Log Visit
        </button>
        <button class="tab-btn" data-tab="customers" aria-label="Customers">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Customers
        </button>
        <button class="tab-btn" data-tab="followups" aria-label="Follow-ups">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            Follow-ups
        </button>
        <button class="tab-btn" data-tab="reports" aria-label="Reports">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
            Reports
        </button>
        <button class="tab-btn" data-tab="data" aria-label="Data">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
            Data
        </button>
    </nav>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="modal-close" onclick="hideModal('settingsModal')" aria-label="Close">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Business Name</label>
                    <input type="text" class="form-input" id="settingsBusinessName" value="Blake Brothers">
                </div>
                <div class="form-group">
                    <label class="form-label">Established Year</label>
                    <input type="text" class="form-input" id="settingsEstYear" value="1884">
                </div>
                <div class="form-group">
                    <label class="form-label">Service Area</label>
                    <input type="text" class="form-input" id="settingsArea" value="Huntsville, Decatur, Meridianville, Athens, Madison AL">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('settingsModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Customer Detail Modal -->
    <div class="modal-overlay" id="customerModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="customerModalTitle">Customer Details</h3>
                <button class="modal-close" onclick="hideModal('customerModal')" aria-label="Close">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="modal-body" id="customerModalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('customerModal')">Close</button>
                <button class="btn btn-primary" onclick="printCustomerReport()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                    Print Report
                </button>
            </div>
        </div>
    </div>

    <!-- Paste Modal -->
    <div class="modal-overlay" id="pasteModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Paste Data</h3>
                <button class="modal-close" onclick="hideModal('pasteModal')" aria-label="Close">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 14px; line-height: 1.6;">Paste tab-delimited data. Expected columns: Name, Address, Phone, ServiceType, Date, WorkPerformed, Amount, Technician, IsPriority</p>
                <textarea class="form-textarea" id="pasteData" style="min-height: 240px;" placeholder="Paste your data here..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('pasteModal')">Cancel</button>
                <button class="btn btn-primary" onclick="processPastedData()">Import Data</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toastMessage">Saved successfully!</span>
        <button class="toast-undo" id="toastUndo" style="display: none;" onclick="undoDelete()">Undo</button>
    </div>

    <script>
        // ===== ACCESS CONTROL - Hash function =====
        function _h(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return h;}
        
        // Store key as character codes — NEVER hardcode the hash number
        // Access key: "blke2026" → char codes: [98,108,107,101,50,48,50,54]
        const _E = [98,108,107,101,50,48,50,54];
        const _K = _E.map(c => String.fromCharCode(c)).join('');
        const _V = _h(_K); // computed at runtime — NEVER precomputed
        
        function checkAccess() {
            const params = new URLSearchParams(window.location.search);
            const key = params.get('key');
            if (!key || _h(key) !== _V) {
                document.getElementById('accessDenied').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('appHeader').style.display = 'none';
                document.getElementById('appTabBar').style.display = 'none';
                document.getElementById('demoBanner').style.display = 'none';
                return false;
            }
            document.getElementById('accessDenied').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('appHeader').style.display = 'flex';
            document.getElementById('appTabBar').style.display = 'flex';
            return true;
        }

        // ===== SECURITY MEASURES =====
        // Disable right-click
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        // Block keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Block Ctrl+S (Save)
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                return false;
            }
            // Block Ctrl+U (View Source)
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
                return false;
            }
            // Block Ctrl+Shift+I (Dev Tools)
            if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                e.preventDefault();
                return false;
            }
            // Block F12 (Dev Tools)
            if (e.key === 'F12') {
                e.preventDefault();
                return false;
            }
        });

        // ===== DATABASE =====
        const DB_NAME = 'BlakeBrothersLedger';
        const DB_VERSION = 1;
        let db = null;
        let currentCustomerId = null;
        let lastDeletedVisit = null;
        let undoTimeout = null;

        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    
                    // Visits store
                    if (!database.objectStoreNames.contains('visits')) {
                        const visitStore = database.createObjectStore('visits', { keyPath: 'id', autoIncrement: true });
                        visitStore.createIndex('customerId', 'customerId', { unique: false });
                        visitStore.createIndex('date', 'date', { unique: false });
                        visitStore.createIndex('followupDate', 'followupDate', { unique: false });
                    }
                    
                    // Customers store
                    if (!database.objectStoreNames.contains('customers')) {
                        const customerStore = database.createObjectStore('customers', { keyPath: 'id', autoIncrement: true });
                        customerStore.createIndex('name', 'name', { unique: false });
                        customerStore.createIndex('address', 'address', { unique: false });
                    }
                    
                    // Settings store
                    if (!database.objectStoreNames.contains('settings')) {
                        database.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
            });
        }

        // Generic DB operations
        function dbAdd(storeName, data) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                const request = store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function dbPut(storeName, data) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function dbGet(storeName, id) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function dbGetAll(storeName) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function dbDelete(storeName, id) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function dbClear(storeName) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // ===== DEMO DATA =====
        const demoData = {
            customers: [
                { id: 1, name: 'Thompson Family', address: '2847 Whitesburg Dr, Huntsville AL 35801', phone: '(256) 555-0187', isPriority: true, isDemo: true },
                { id: 2, name: 'Martinez Residence', address: '1205 Jordan Ln NW, Huntsville AL 35816', phone: '(256) 555-0234', isPriority: false, isDemo: true },
                { id: 3, name: 'Dr. Rebecca Chen', address: '509 Pratt Ave NE, Huntsville AL 35801', phone: '(256) 555-0312', isPriority: true, isDemo: true },
                { id: 4, name: 'Williams Estate', address: '7823 Bailey Cove Rd, Huntsville AL 35802', phone: '(256) 555-0456', isPriority: false, isDemo: true },
                { id: 5, name: 'NASA Relocate - Patel', address: '156 Research Park Blvd, Madison AL 35758', phone: '(256) 555-0589', isPriority: true, isDemo: true }
            ],
            visits: [
                { id: 1, customerId: 1, serviceType: 'HVAC', date: '2025-12-15', workPerformed: 'Annual furnace inspection and filter replacement. System running efficiently at 94% AFUE.', amount: 189.00, technician: 'Mike B.', followupDate: '2026-06-15', isDemo: true },
                { id: 2, customerId: 1, serviceType: 'Plumbing', date: '2025-08-22', workPerformed: 'Replaced corroded water heater anode rod. Flushed sediment. Extended tank life by 3-5 years.', amount: 275.00, technician: 'James T.', followupDate: null, isDemo: true },
                { id: 3, customerId: 2, serviceType: 'Electrical', date: '2026-01-08', workPerformed: 'Upgraded main panel from 100A to 200A for home addition. Installed surge protection.', amount: 2850.00, technician: 'Carlos R.', followupDate: '2026-07-08', isDemo: true },
                { id: 4, customerId: 3, serviceType: 'HVAC', date: '2026-01-20', workPerformed: 'Emergency call - heat pump frozen. Defrosted coils, recharged refrigerant, installed low-temp kit.', amount: 425.00, technician: 'Mike B.', followupDate: '2026-02-20', isDemo: true },
                { id: 5, customerId: 4, serviceType: 'Crawl Space', date: '2025-11-05', workPerformed: 'Installed vapor barrier and dehumidifier. Moisture levels reduced from 78% to 45%.', amount: 3200.00, technician: 'David K.', followupDate: '2026-05-05', isDemo: true },
                { id: 6, customerId: 5, serviceType: 'Generators', date: '2026-01-28', workPerformed: 'Installed 22kW Generac whole-home generator with automatic transfer switch.', amount: 8500.00, technician: 'Carlos R.', followupDate: '2026-07-28', isDemo: true },
                { id: 7, customerId: 3, serviceType: 'Duct & Air Quality', date: '2025-09-12', workPerformed: 'Full duct cleaning and sanitization. Installed UV air purifier in main supply plenum.', amount: 650.00, technician: 'James T.', followupDate: null, isDemo: true }
            ]
        };

        async function loadDemoData() {
            const customers = await dbGetAll('customers');
            if (customers.length === 0) {
                for (const customer of demoData.customers) {
                    await dbAdd('customers', customer);
                }
                for (const visit of demoData.visits) {
                    await dbAdd('visits', visit);
                }
                document.getElementById('demoBanner').style.display = 'flex';
                showToast('Sample data loaded. Tap banner to clear.', false);
            }
        }

        async function clearDemoData() {
            const customers = await dbGetAll('customers');
            const visits = await dbGetAll('visits');
            
            for (const c of customers.filter(c => c.isDemo)) {
                await dbDelete('customers', c.id);
            }
            for (const v of visits.filter(v => v.isDemo)) {
                await dbDelete('visits', v.id);
            }
            
            document.getElementById('demoBanner').style.display = 'none';
            showToast('Demo data cleared. Ready for your data!', false);
            refreshAll();
        }

        // ===== UI FUNCTIONS =====
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById('tab-' + tabId).classList.add('active');
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            if (tabId === 'customers') refreshCustomerList();
            if (tabId === 'followups') refreshFollowups();
            if (tabId === 'reports') refreshReportsTab();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            document.body.style.overflow = '';
        }

        function showToast(message, showUndo = false) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            document.getElementById('toastUndo').style.display = showUndo ? 'inline-block' : 'none';
            toast.classList.add('show');
            
            if (undoTimeout) clearTimeout(undoTimeout);
            
            undoTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, showUndo ? 5000 : 3500);
        }

        function showPasteModal() {
            document.getElementById('pasteData').value = '';
            showModal('pasteModal');
        }

        // ===== FORM HANDLING =====
        document.getElementById('visitForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const customerName = document.getElementById('customerName').value.trim();
            const address = document.getElementById('propertyAddress').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const serviceType = document.getElementById('serviceType').value;
            const visitDate = document.getElementById('visitDate').value;
            const workPerformed = document.getElementById('workPerformed').value.trim();
            const amount = parseFloat(document.getElementById('invoiceAmount').value) || 0;
            const technician = document.getElementById('technicianName').value.trim();
            const followupDays = document.getElementById('followupType').value;
            const isPriority = document.getElementById('isPriorityMember').checked;
            
            // Validation with visual feedback
            let hasError = false;
            const requiredFields = ['customerName', 'propertyAddress', 'serviceType', 'visitDate', 'workPerformed'];
            
            requiredFields.forEach(id => {
                const el = document.getElementById(id);
                if (!el.value.trim()) {
                    el.classList.add('error');
                    hasError = true;
                    setTimeout(() => el.classList.remove('error'), 600);
                }
            });
            
            if (hasError) {
                showToast('Please fill in all required fields', false);
                return;
            }
            
            // Find or create customer
            const customers = await dbGetAll('customers');
            let customer = customers.find(c => 
                c.name.toLowerCase() === customerName.toLowerCase() && 
                c.address.toLowerCase() === address.toLowerCase()
            );
            
            if (!customer) {
                const newId = await dbAdd('customers', {
                    name: customerName,
                    address: address,
                    phone: phone,
                    isPriority: isPriority,
                    isDemo: false
                });
                customer = { id: newId, name: customerName, address: address };
            } else if (isPriority && !customer.isPriority) {
                customer.isPriority = true;
                customer.phone = phone || customer.phone;
                await dbPut('customers', customer);
            }
            
            // Calculate follow-up date
            let followupDate = null;
            if (followupDays !== 'none') {
                const d = new Date(visitDate);
                d.setDate(d.getDate() + parseInt(followupDays));
                followupDate = d.toISOString().split('T')[0];
            }
            
            // Save visit
            await dbAdd('visits', {
                customerId: customer.id,
                serviceType: serviceType,
                date: visitDate,
                workPerformed: workPerformed,
                amount: amount,
                technician: technician,
                followupDate: followupDate,
                isDemo: false
            });
            
            showToast('Service visit saved successfully!', false);
            e.target.reset();
            document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
            refreshAll();
        });

        // ===== CUSTOMER LIST =====
        async function refreshCustomerList(filter = 'all') {
            const customers = await dbGetAll('customers');
            const visits = await dbGetAll('visits');
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            
            let filtered = customers;
            
            if (searchTerm) {
                filtered = filtered.filter(c => 
                    c.name.toLowerCase().includes(searchTerm) || 
                    c.address.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filter === 'priority') {
                filtered = filtered.filter(c => c.isPriority);
            } else if (filter === 'recent') {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const recentCustomerIds = visits
                    .filter(v => new Date(v.date) >= thirtyDaysAgo)
                    .map(v => v.customerId);
                filtered = filtered.filter(c => recentCustomerIds.includes(c.id));
            }
            
            const container = document.getElementById('customerList');
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                        </div>
                        <h2>No Customers Yet</h2>
                        <p>Log your first service visit to start building your customer database.</p>
                        <button class="btn btn-primary" onclick="showTab('log')" style="margin-top: 8px;">Log a Visit</button>
                        <div class="empty-state-links">
                            <a href="#" onclick="showTab('data'); return false;">Or import existing data</a>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(customer => {
                const customerVisits = visits.filter(v => v.customerId === customer.id);
                const lastVisit = customerVisits.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                const initials = customer.name.split(' ').map(n => n[0]).join('').substring(0, 2);
                
                return `
                    <div class="customer-item" onclick="showCustomerDetail(${customer.id})" role="button" tabindex="0">
                        <div class="customer-avatar">${initials}</div>
                        <div class="customer-info">
                            <div class="customer-name">${escapeHtml(customer.name)} ${customer.isPriority ? '<span class="card-badge badge-priority">Priority</span>' : ''}</div>
                            <div class="customer-address">${escapeHtml(customer.address)}</div>
                            <div class="customer-address">${customerVisits.length} visit${customerVisits.length !== 1 ? 's' : ''}${lastVisit ? ' • Last: ' + formatDate(lastVisit.date) : ''}</div>
                        </div>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0; color: var(--text-muted);"><polyline points="9 18 15 12 9 6"/></svg>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Filter pills
        document.querySelectorAll('.filter-pill').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                refreshCustomerList(pill.dataset.filter);
            });
        });

        document.getElementById('customerSearch').addEventListener('input', () => {
            const activeFilter = document.querySelector('.filter-pill.active').dataset.filter;
            refreshCustomerList(activeFilter);
        });

        // ===== CUSTOMER DETAIL =====
        async function showCustomerDetail(customerId) {
            currentCustomerId = customerId;
            const customer = await dbGet('customers', customerId);
            const visits = await dbGetAll('visits');
            const customerVisits = visits.filter(v => v.customerId === customerId).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            document.getElementById('customerModalTitle').textContent = customer.name;
            
            const healthScore = calculateHealthScore(customerVisits);
            const healthClass = healthScore >= 80 ? 'health-good' : healthScore >= 50 ? 'health-fair' : 'health-poor';
            const healthLabel = healthScore >= 80 ? 'Good' : healthScore >= 50 ? 'Fair' : 'Needs Attention';
            
            const totalSpent = customerVisits.reduce((sum, v) => sum + (v.amount || 0), 0);
            
            let html = `
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding: 16px; background: var(--light-gray); border-radius: 14px;">
                    <div class="health-gauge ${healthClass}">${healthScore}</div>
                    <div>
                        <div style="font-weight: 600; font-size: 16px;">Home Health Score: ${healthLabel}</div>
                        <div style="font-size: 14px; color: var(--text-muted);">Based on ${customerVisits.length} service record${customerVisits.length !== 1 ? 's' : ''}</div>
                    </div>
                </div>
                <div style="margin-bottom: 24px;">
                    <p style="font-size: 15px; color: var(--text-muted); margin-bottom: 8px;"><strong>Address:</strong> ${escapeHtml(customer.address)}</p>
                    ${customer.phone ? `<p style="font-size: 15px; color: var(--text-muted); margin-bottom: 8px;"><strong>Phone:</strong> ${escapeHtml(customer.phone)}</p>` : ''}
                    <p style="font-size: 15px; color: var(--text-muted); margin-bottom: 8px;"><strong>Status:</strong> ${customer.isPriority ? '<span style="color: var(--heritage-gold-dark); font-weight: 600;">Priority Member</span>' : 'Standard'}</p>
                    <p style="font-size: 15px; color: var(--text-muted);"><strong>Total invested:</strong> <span style="font-weight: 600;">$${totalSpent.toLocaleString()}</span></p>
                </div>
                <h4 style="margin-bottom: 16px; font-size: 18px; font-family: 'Libre Caslon Text', Georgia, serif;">Service History</h4>
            `;
            
            if (customerVisits.length === 0) {
                html += '<p style="color: var(--text-muted); padding: 20px; text-align: center; background: var(--light-gray); border-radius: 12px;">No service records yet.</p>';
            } else {
                html += '<div class="timeline">';
                customerVisits.forEach(visit => {
                    html += `
                        <div class="timeline-item">
                            <div class="timeline-dot"></div>
                            <div class="timeline-date">${formatDate(visit.date)}</div>
                            <div class="timeline-title">${visit.serviceType} ${visit.amount ? '• $' + visit.amount.toFixed(2) : ''}</div>
                            <div class="timeline-desc">${escapeHtml(visit.workPerformed)}</div>
                            ${visit.technician ? `<div class="timeline-desc" style="font-size: 13px; margin-top: 6px;"><strong>Technician:</strong> ${escapeHtml(visit.technician)}</div>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            document.getElementById('customerModalBody').innerHTML = html;
            showModal('customerModal');
        }

        function calculateHealthScore(visits) {
            if (visits.length === 0) return 50;
            
            let score = 60;
            const now = new Date();
            const lastVisit = visits[0];
            const daysSinceVisit = Math.floor((now - new Date(lastVisit.date)) / (1000 * 60 * 60 * 24));
            
            // Recent service bonus
            if (daysSinceVisit < 90) score += 20;
            else if (daysSinceVisit < 180) score += 10;
            else if (daysSinceVisit > 365) score -= 20;
            
            // Multiple services bonus
            if (visits.length >= 3) score += 10;
            if (visits.length >= 5) score += 10;
            
            return Math.max(0, Math.min(100, score));
        }

        // ===== FOLLOW-UPS =====
        async function refreshFollowups() {
            const visits = await dbGetAll('visits');
            const customers = await dbGetAll('customers');
            
            const now = new Date();
            const oneWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            const oneMonth = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
            
            const followups = visits
                .filter(v => v.followupDate)
                .map(v => ({
                    ...v,
                    customer: customers.find(c => c.id === v.customerId),
                    followupDateObj: new Date(v.followupDate)
                }))
                .sort((a, b) => a.followupDateObj - b.followupDateObj);
            
            const overdue = followups.filter(f => f.followupDateObj < now);
            const thisWeek = followups.filter(f => f.followupDateObj >= now && f.followupDateObj <= oneWeek);
            const thisMonth = followups.filter(f => f.followupDateObj > oneWeek && f.followupDateObj <= oneMonth);
            
            document.getElementById('statOverdue').textContent = overdue.length;
            document.getElementById('statThisWeek').textContent = thisWeek.length;
            document.getElementById('statThisMonth').textContent = thisMonth.length;
            
            const container = document.getElementById('followupList');
            
            if (followups.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        </div>
                        <h2>No Follow-ups Scheduled</h2>
                        <p>When you log visits with maintenance schedules, they'll appear here.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            if (overdue.length > 0) {
                html += '<h4 style="color: var(--error-red); margin-bottom: 16px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">⚠️ Overdue</h4>';
                overdue.forEach(f => {
                    html += renderFollowupItem(f, 'overdue');
                });
            }
            
            if (thisWeek.length > 0) {
                html += '<h4 style="color: var(--warning-orange); margin: 24px 0 16px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">This Week</h4>';
                thisWeek.forEach(f => {
                    html += renderFollowupItem(f, 'soon');
                });
            }
            
            if (thisMonth.length > 0) {
                html += '<h4 style="color: var(--success-green); margin: 24px 0 16px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">This Month</h4>';
                thisMonth.forEach(f => {
                    html += renderFollowupItem(f, 'later');
                });
            }
            
            const later = followups.filter(f => f.followupDateObj > oneMonth);
            if (later.length > 0) {
                html += '<h4 style="color: var(--text-muted); margin: 24px 0 16px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Later</h4>';
                later.forEach(f => {
                    html += renderFollowupItem(f, 'later');
                });
            }
            
            container.innerHTML = html;
        }

        function renderFollowupItem(f, urgency) {
            const urgencyClass = urgency === 'overdue' ? 'followup-overdue' : urgency === 'soon' ? 'followup-soon' : '';
            const dueClass = urgency === 'overdue' ? 'due-overdue' : urgency === 'soon' ? 'due-soon' : 'due-later';
            const urgencyIcon = urgency === 'overdue' ? '⚠️' : urgency === 'soon' ? '⏰' : '📅';
            
            return `
                <div class="followup-item ${urgencyClass}" onclick="showCustomerDetail(${f.customerId})" role="button">
                    <h4>${escapeHtml(f.customer?.name || 'Unknown')}</h4>
                    <div class="followup-meta">${f.serviceType} • ${escapeHtml(f.customer?.address || '')}</div>
                    <div class="followup-due ${dueClass}">${urgencyIcon} Due: ${formatDate(f.followupDate)}</div>
                </div>
            `;
        }

        // ===== REPORTS =====
        async function refreshReportsTab() {
            const customers = await dbGetAll('customers');
            const visits = await dbGetAll('visits');
            
            document.getElementById('statTotalCustomers').textContent = customers.filter(c => !c.isDemo).length || customers.length;
            document.getElementById('statTotalVisits').textContent = visits.filter(v => !v.isDemo).length || visits.length;
            document.getElementById('statPriorityMembers').textContent = customers.filter(c => c.isPriority).length;
            
            const select = document.getElementById('reportCustomer');
            select.innerHTML = '<option value="">Choose a customer...</option>' + 
                customers.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
        }

        async function generateReport() {
            const customerId = parseInt(document.getElementById('reportCustomer').value);
            if (!customerId) {
                showToast('Please select a customer');
                return;
            }
            
            const customer = await dbGet('customers', customerId);
            const visits = await dbGetAll('visits');
            const customerVisits = visits.filter(v => v.customerId === customerId).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const healthScore = calculateHealthScore(customerVisits);
            const totalSpent = customerVisits.reduce((sum, v) => sum + (v.amount || 0), 0);
            
            const settings = await dbGet('settings', 'business') || { value: { name: 'Blake Brothers', since: '1884' } };
            
            let html = `
                <div class="print-header">
                    <div>
                        <h1>${escapeHtml(settings.value.name)}</h1>
                        <p style="font-size: 14pt; color: #666;">Serving Huntsville Since ${settings.value.since}</p>
                        <p style="font-size: 11pt; color: #999; margin-top: 8px;">Selling Trust Since 1884</p>
                    </div>
                    <div class="print-health-box">
                        <div class="score">${healthScore}</div>
                        <div style="font-size: 11pt;">Home Health Score</div>
                    </div>
                </div>
                
                <h2>Property Report</h2>
                <p><strong>Customer:</strong> ${escapeHtml(customer.name)}</p>
                <p><strong>Address:</strong> ${escapeHtml(customer.address)}</p>
                ${customer.phone ? `<p><strong>Phone:</strong> ${escapeHtml(customer.phone)}</p>` : ''}
                <p><strong>Membership:</strong> ${customer.isPriority ? 'Priority Maintenance Member ⭐' : 'Standard'}</p>
                <p><strong>Total Investment:</strong> $${totalSpent.toLocaleString()}</p>
                <p><strong>Report Generated:</strong> ${new Date().toLocaleDateString()}</p>
                
                <h2>Service History</h2>
            `;
            
            if (customerVisits.length === 0) {
                html += '<p>No service records on file.</p>';
            } else {
                customerVisits.forEach(visit => {
                    html += `
                        <div class="print-service-item">
                            <strong>${formatDate(visit.date)} — ${visit.serviceType}</strong>
                            ${visit.amount ? ` ($${visit.amount.toFixed(2)})` : ''}
                            <br>
                            ${escapeHtml(visit.workPerformed)}
                            ${visit.technician ? `<br><em>Technician: ${escapeHtml(visit.technician)}</em>` : ''}
                        </div>
                    `;
                });
            }
            
            html += `
                <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #333; text-align: center;">
                    <p style="font-size: 12pt;"><strong>${escapeHtml(settings.value.name)}</strong> — Selling Trust Since ${settings.value.since}</p>
                    <p style="font-size: 11pt; color: #666; margin-top: 8px;">Thank you for trusting us with your home.</p>
                    <p style="font-size: 10pt; color: #999; margin-top: 16px;">This report was generated using Legacy Ledger — a custom tool built for Blake Brothers.</p>
                </div>
            `;
            
            document.getElementById('printReport').innerHTML = html;
            window.print();
            showToast('Report sent to printer', false);
        }

        function printCustomerReport() {
            hideModal('customerModal');
            document.getElementById('reportCustomer').value = currentCustomerId;
            generateReport();
        }

        // ===== DATA IMPORT/EXPORT =====
        async function exportCSV() {
            const customers = await dbGetAll('customers');
            const visits = await dbGetAll('visits');
            
            let csv = 'CustomerName,Address,Phone,IsPriority,ServiceType,Date,WorkPerformed,Amount,Technician,FollowupDate\n';
            
            visits.forEach(v => {
                const c = customers.find(c => c.id === v.customerId) || {};
                csv += `"${(c.name || '').replace(/"/g, '""')}","${(c.address || '').replace(/"/g, '""')}","${c.phone || ''}","${c.isPriority || false}","${v.serviceType}","${v.date}","${(v.workPerformed || '').replace(/"/g, '""')}","${v.amount || 0}","${v.technician || ''}","${v.followupDate || ''}"\n`;
            });
            
            downloadFile(csv, 'blake-brothers-ledger.csv', 'text/csv');
            showToast('CSV exported successfully!', false);
        }

        async function exportJSON() {
            const customers = await dbGetAll('customers');
            const visits = await dbGetAll('visits');
            const settings = await dbGetAll('settings');
            
            const backup = {
                version: 1,
                exportDate: new Date().toISOString(),
                customers: customers,
                visits: visits,
                settings: settings
            };
            
            downloadFile(JSON.stringify(backup, null, 2), 'blake-brothers-backup.json', 'application/json');
            showToast('Full backup exported!', false);
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const lines = text.split('\n').slice(1); // Skip header
                
                let imported = 0;
                for (const line of lines) {
                    if (!line.trim()) continue;
                    const cols = parseCSVLine(line);
                    if (cols.length < 6) continue;
                    
                    await importRow(cols);
                    imported++;
                }
                
                showToast(`Imported ${imported} records successfully!`, false);
                document.getElementById('demoBanner').style.display = 'none';
            } catch (e) {
                showToast('Error importing CSV: ' + e.message, false);
            }
            
            event.target.value = '';
            refreshAll();
        }

        async function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const backup = JSON.parse(text);
                
                await dbClear('customers');
                await dbClear('visits');
                
                for (const c of backup.customers) {
                    await dbAdd('customers', c);
                }
                for (const v of backup.visits) {
                    await dbAdd('visits', v);
                }
                
                showToast('Backup restored successfully!', false);
                document.getElementById('demoBanner').style.display = 'none';
                refreshAll();
            } catch (e) {
                showToast('Error reading backup file: ' + e.message, false);
            }
            
            event.target.value = '';
        }

        async function processPastedData() {
            const text = document.getElementById('pasteData').value;
            const lines = text.split('\n');
            
            let imported = 0;
            for (const line of lines) {
                if (!line.trim()) continue;
                const cols = line.split('\t');
                if (cols.length < 5) continue;
                
                await importRow(cols);
                imported++;
            }
            
            hideModal('pasteModal');
            showToast(`Imported ${imported} records successfully!`, false);
            document.getElementById('demoBanner').style.display = 'none';
            refreshAll();
        }

        async function importRow(cols) {
            // cols: Name, Address, Phone, ServiceType, Date, WorkPerformed, Amount, Technician, IsPriority
            const [name, address, phone, serviceType, date, workPerformed, amount, technician, isPriority] = cols;
            
            const customers = await dbGetAll('customers');
            let customer = customers.find(c => c.name === name && c.address === address);
            
            if (!customer) {
                const id = await dbAdd('customers', {
                    name: (name || '').trim(),
                    address: (address || '').trim(),
                    phone: (phone || '').trim(),
                    isPriority: isPriority === 'true' || isPriority === 'TRUE',
                    isDemo: false
                });
                customer = { id };
            }
            
            if (serviceType && date) {
                await dbAdd('visits', {
                    customerId: customer.id,
                    serviceType: (serviceType || '').trim(),
                    date: (date || '').trim(),
                    workPerformed: (workPerformed || '').trim(),
                    amount: parseFloat(amount) || 0,
                    technician: (technician || '').trim(),
                    followupDate: null,
                    isDemo: false
                });
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            
            return result;
        }

        // ===== SETTINGS =====
        async function saveSettings() {
            const settings = {
                key: 'business',
                value: {
                    name: document.getElementById('settingsBusinessName').value,
                    since: document.getElementById('settingsEstYear').value,
                    area: document.getElementById('settingsArea').value
                }
            };
            
            await dbPut('settings', settings);
            hideModal('settingsModal');
            showToast('Settings saved!', false);
        }

        async function loadSettings() {
            const settings = await dbGet('settings', 'business');
            if (settings) {
                document.getElementById('settingsBusinessName').value = settings.value.name || 'Blake Brothers';
                document.getElementById('settingsEstYear').value = settings.value.since || '1884';
                document.getElementById('settingsArea').value = settings.value.area || '';
            }
        }

        // ===== UNDO =====
        async function undoDelete() {
            if (lastDeletedVisit) {
                await dbAdd('visits', lastDeletedVisit);
                lastDeletedVisit = null;
                if (undoTimeout) clearTimeout(undoTimeout);
                showToast('Visit restored!', false);
                refreshAll();
            }
        }

        // ===== UTILITIES =====
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function refreshAll() {
            const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
            if (activeTab === 'customers') refreshCustomerList();
            if (activeTab === 'followups') refreshFollowups();
            if (activeTab === 'reports') refreshReportsTab();
        }

        // ===== INITIALIZATION =====
        async function init() {
            // Check access first
            if (!checkAccess()) {
                return; // Don't initialize if access denied
            }
            
            try {
                await initDB();
                await loadDemoData();
                await loadSettings();
                
                // Set today's date as default
                document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
                
                // Tab navigation
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => showTab(btn.dataset.tab));
                });
                
                // Demo banner
                document.getElementById('demoBanner').addEventListener('click', clearDemoData);
                
                // Check if demo data exists
                const customers = await dbGetAll('customers');
                if (customers.some(c => c.isDemo)) {
                    document.getElementById('demoBanner').style.display = 'flex';
                }
                
                refreshAll();
            } catch (e) {
                console.error('Init error:', e);
                showToast('Error initializing app. Please refresh.', false);
            }
        }

        // Start the app
        init();
    </script>
</body>
</html>