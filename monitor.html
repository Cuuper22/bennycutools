<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BennyCu Tools — Build Monitor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: oklch(0.13 0 0);
            --surface: oklch(0.18 0 0);
            --surface-hover: oklch(0.22 0 0);
            --border: oklch(0.25 0 0);
            --text: oklch(0.93 0 0);
            --text-muted: oklch(0.55 0 0);
            --accent: oklch(0.65 0.15 145);
            --accent-dim: oklch(0.35 0.08 145);
            --warn: oklch(0.75 0.15 75);
            --danger: oklch(0.65 0.2 25);
            --blue: oklch(0.65 0.15 250);
            --purple: oklch(0.65 0.15 300);
            --radius: 0.75rem;
            --font: 'Inter', system-ui, -apple-system, sans-serif;
            --mono: 'JetBrains Mono', 'Fira Code', monospace;
        }
        body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.6; }
        
        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }
        .header h1 { font-size: 1.1rem; font-weight: 600; letter-spacing: -0.02em; }
        .header h1 span { color: var(--accent); }
        .header-meta { display: flex; gap: 1.5rem; align-items: center; font-size: 0.8rem; color: var(--text-muted); }
        .pulse { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); display: inline-block; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem 2rem; }
        
        .overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem 1.25rem;
            transition: border-color 0.2s;
        }
        .stat:hover { border-color: var(--accent-dim); }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 0.25rem; }
        .stat-value { font-size: 1.6rem; font-weight: 700; font-family: var(--mono); }
        .stat-value.green { color: var(--accent); }
        .stat-value.blue { color: var(--blue); }
        .stat-value.warn { color: var(--warn); }
        
        .projects { display: flex; flex-direction: column; gap: 1rem; }
        
        .project {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            transition: border-color 0.2s;
        }
        .project:hover { border-color: var(--accent-dim); }
        .project.active { border-color: var(--accent); }
        
        .project-header {
            padding: 1.25rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .project-header:hover { background: var(--surface-hover); }
        
        .project-title { display: flex; align-items: center; gap: 0.75rem; }
        .project-title h3 { font-size: 1rem; font-weight: 600; }
        .project-title .industry { font-size: 0.75rem; color: var(--text-muted); background: var(--bg); padding: 0.2rem 0.6rem; border-radius: 99px; }
        
        .project-status { display: flex; align-items: center; gap: 1rem; }
        
        .phase-tag {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            font-family: var(--mono);
        }
        .phase-tag.research { background: oklch(0.3 0.08 250); color: var(--blue); }
        .phase-tag.diagnosis { background: oklch(0.3 0.08 300); color: var(--purple); }
        .phase-tag.design { background: oklch(0.3 0.08 75); color: var(--warn); }
        .phase-tag.building { background: oklch(0.3 0.08 145); color: var(--accent); }
        .phase-tag.complete { background: oklch(0.25 0.06 145); color: var(--accent); }
        .phase-tag.queued { background: var(--bg); color: var(--text-muted); }
        
        .round-indicator {
            font-size: 0.8rem;
            font-family: var(--mono);
            color: var(--text-muted);
        }
        .round-indicator strong { color: var(--text); }
        
        .progress-bar-container {
            width: 120px;
            height: 4px;
            background: var(--bg);
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        
        .project-body {
            display: none;
            border-top: 1px solid var(--border);
        }
        .project.expanded .project-body { display: block; }
        
        .project-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }
        
        .project-section {
            padding: 1.25rem 1.5rem;
        }
        .project-section + .project-section { border-left: 1px solid var(--border); }
        .project-section h4 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 0.75rem; }
        
        .log-entry {
            font-size: 0.85rem;
            padding: 0.4rem 0;
            border-bottom: 1px solid oklch(0.2 0 0);
            display: flex;
            gap: 0.75rem;
        }
        .log-entry:last-child { border-bottom: none; }
        .log-time { color: var(--text-muted); font-family: var(--mono); font-size: 0.75rem; white-space: nowrap; min-width: 50px; }
        .log-agent { font-weight: 600; font-size: 0.75rem; padding: 0.1rem 0.4rem; border-radius: 4px; white-space: nowrap; }
        .log-agent.opus { background: oklch(0.3 0.08 25); color: oklch(0.75 0.15 25); }
        .log-agent.gemini { background: oklch(0.3 0.08 250); color: oklch(0.75 0.15 250); }
        .log-agent.merged { background: oklch(0.3 0.08 145); color: var(--accent); }
        .log-text { flex: 1; }
        
        .research-findings {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .research-findings li {
            padding: 0.3rem 0;
            list-style: none;
        }
        .research-findings li::before {
            content: "→ ";
            color: var(--accent);
        }
        
        .comments-section {
            border-top: 1px solid var(--border);
            padding: 1.25rem 1.5rem;
        }
        .comments-section h4 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 0.75rem; }
        
        .comment {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        .comment-meta {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            font-family: var(--mono);
        }
        .comment.from-cuper { border-left: 3px solid var(--warn); }
        .comment.from-ben { border-left: 3px solid var(--accent); }
        
        .comment-input-row {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        .comment-input {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.6rem 0.9rem;
            color: var(--text);
            font-family: var(--font);
            font-size: 0.85rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .comment-input:focus { border-color: var(--accent); }
        .comment-input::placeholder { color: oklch(0.35 0 0); }
        
        .btn-send {
            background: var(--accent);
            color: oklch(0.1 0 0);
            border: none;
            border-radius: 0.5rem;
            padding: 0.6rem 1.2rem;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: opacity 0.2s;
            white-space: nowrap;
        }
        .btn-send:hover { opacity: 0.85; }
        
        .demo-link {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.8rem;
            color: var(--accent);
            text-decoration: none;
            padding: 0.3rem 0.6rem;
            border: 1px solid var(--accent-dim);
            border-radius: 0.4rem;
            transition: all 0.2s;
        }
        .demo-link:hover { background: var(--accent-dim); }
        
        .chevron { transition: transform 0.2s; font-size: 0.8rem; color: var(--text-muted); }
        .project.expanded .chevron { transform: rotate(90deg); }
        
        .refresh-note { font-size: 0.7rem; color: var(--text-muted); font-family: var(--mono); }
        
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .project-grid { grid-template-columns: 1fr; }
            .project-section + .project-section { border-left: none; border-top: 1px solid var(--border); }
            .overview { grid-template-columns: repeat(2, 1fr); }
        }
    </style>

    <style>
    /* Kimi UI/UX Improvements */
    .fade-in-up { animation: fadeInUp 0.4s ease-out forwards; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    .radio-option, [class*="option"], [class*="choice"] { 
        min-height: 52px; transition: all 0.15s ease !important; 
    }
    .radio-option:active, [class*="option"]:active { transform: scale(0.98); }
    .btn-primary:active, [class*="btn"]:active { transform: translateY(1px); }
    /* Better progress bar */
    [class*="progress"] { height: 6px !important; border-radius: 3px; }
    </style>
    
</head>
<body>
    <div class="header">
        <h1><span>●</span> BennyCu Build Monitor</h1>
        <div class="header-meta">
            <span class="refresh-note">Auto-refreshes every 10s</span>
            <span><span class="pulse"></span> Live</span>
            <span id="lastUpdate"></span>
        </div>
    </div>
    
    <div class="container">
        <div class="overview" id="overview"></div>
        <div class="projects" id="projects"></div>
    </div>

    <script>
        const STATE_FILE = 'monitor-state.json';
        const COMMENTS_FILE = 'monitor-comments.json';

        // Load state from localStorage (written by build agents via JSON file)
        function loadState() {
            const saved = localStorage.getItem('bennycuMonitorState');
            if (saved) {
                try { return JSON.parse(saved); } catch(e) {}
            }
            return getDefaultState();
        }

        function getDefaultState() {
            return {
                lastUpdate: new Date().toISOString(),
                projects: [
                    {
                        id: "baker-brothers",
                        name: "Baker Brothers Plumbing",
                        location: "Dallas, TX",
                        industry: "Plumbing",
                        phase: "queued",
                        round: 0,
                        maxRounds: 10,
                        tool: "TBD — awaiting research",
                        demoUrl: "",
                        research: [],
                        log: [],
                        comments: []
                    },
                    {
                        id: "butler-alignment",
                        name: "Butler Alignment & Brake",
                        location: "Tyler, TX",
                        industry: "Auto Repair",
                        phase: "queued",
                        round: 0,
                        maxRounds: 10,
                        tool: "TBD — awaiting research",
                        demoUrl: "",
                        research: [],
                        log: [],
                        comments: []
                    },
                    {
                        id: "aprils-pet-grooming",
                        name: "April's House Call Pet Grooming",
                        location: "Longview, TX",
                        industry: "Pet Care",
                        phase: "queued",
                        round: 0,
                        maxRounds: 10,
                        tool: "TBD — awaiting research",
                        demoUrl: "",
                        research: [],
                        log: [],
                        comments: []
                    },
                    {
                        id: "countryside-service",
                        name: "Countryside Service",
                        location: "Grand Junction, CO",
                        industry: "Plumbing/Drain",
                        phase: "queued",
                        round: 0,
                        maxRounds: 10,
                        tool: "TBD — awaiting research",
                        demoUrl: "",
                        research: [],
                        log: [],
                        comments: []
                    },
                    {
                        id: "lightning-electric",
                        name: "Lightning Electric",
                        location: "Shreveport, LA",
                        industry: "Electrical",
                        phase: "queued",
                        round: 0,
                        maxRounds: 10,
                        tool: "TBD — awaiting research",
                        demoUrl: "",
                        research: [],
                        log: [],
                        comments: []
                    }
                ]
            };
        }

        function saveState(state) {
            localStorage.setItem('bennycuMonitorState', JSON.stringify(state));
        }

        function saveComments(projectId, comments) {
            const all = JSON.parse(localStorage.getItem('bennycuComments') || '{}');
            all[projectId] = comments;
            localStorage.setItem('bennycuComments', JSON.stringify(all));
        }

        function loadComments(projectId) {
            const all = JSON.parse(localStorage.getItem('bennycuComments') || '{}');
            return all[projectId] || [];
        }

        function render() {
            const state = loadState();
            
            // Overview stats
            const total = state.projects.length;
            const active = state.projects.filter(p => p.phase === 'building' || p.phase === 'design').length;
            const complete = state.projects.filter(p => p.phase === 'complete').length;
            const totalRounds = state.projects.reduce((s, p) => s + p.round, 0);
            const maxTotalRounds = state.projects.reduce((s, p) => s + p.maxRounds, 0);
            const totalComments = state.projects.reduce((s, p) => s + loadComments(p.id).length, 0);
            
            document.getElementById('overview').innerHTML = `
                <div class="stat"><div class="stat-label">Projects</div><div class="stat-value">${total}</div></div>
                <div class="stat"><div class="stat-label">Active Now</div><div class="stat-value blue">${active}</div></div>
                <div class="stat"><div class="stat-label">Complete</div><div class="stat-value green">${complete}</div></div>
                <div class="stat"><div class="stat-label">Rounds Done</div><div class="stat-value">${totalRounds}<span style="color:var(--text-muted);font-size:0.9rem">/${maxTotalRounds}</span></div></div>
                <div class="stat"><div class="stat-label">Your Notes</div><div class="stat-value warn">${totalComments}</div></div>
            `;
            
            // Projects
            document.getElementById('projects').innerHTML = state.projects.map(p => {
                const comments = loadComments(p.id);
                const pct = p.maxRounds > 0 ? Math.round((p.round / p.maxRounds) * 100) : 0;
                const isExpanded = localStorage.getItem('expand_' + p.id) === '1';
                
                return `
                <div class="project ${p.phase === 'building' ? 'active' : ''} ${isExpanded ? 'expanded' : ''}" id="proj-${p.id}">
                    <div class="project-header" onclick="toggleProject('${p.id}')">
                        <div class="project-title">
                            <span class="chevron">▶</span>
                            <div>
                                <h3>${p.name}</h3>
                                <span style="font-size:0.8rem;color:var(--text-muted)">${p.location}</span>
                            </div>
                            <span class="industry">${p.industry}</span>
                        </div>
                        <div class="project-status">
                            <span class="phase-tag ${p.phase}">${p.phase.toUpperCase()}</span>
                            <div class="round-indicator">Round <strong>${p.round}</strong>/${p.maxRounds}</div>
                            <div class="progress-bar-container"><div class="progress-bar" style="width:${pct}%"></div></div>
                            ${p.demoUrl ? `<a class="demo-link" href="${p.demoUrl}" target="_blank" onclick="event.stopPropagation()">↗ Preview</a>` : ''}
                        </div>
                    </div>
                    <div class="project-body">
                        <div class="project-grid">
                            <div class="project-section">
                                <h4>Research & Diagnosis</h4>
                                <div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:0.5rem">
                                    <strong style="color:var(--text)">Tool:</strong> ${p.tool}
                                </div>
                                <ul class="research-findings">
                                    ${p.research.length ? p.research.map(r => `<li>${r}</li>`).join('') : '<li style="color:var(--text-muted)">Awaiting research phase...</li>'}
                                </ul>
                            </div>
                            <div class="project-section">
                                <h4>Build Log</h4>
                                <div style="max-height:300px;overflow-y:auto">
                                    ${p.log.length ? p.log.map(l => `
                                        <div class="log-entry">
                                            <span class="log-time">${l.time || ''}</span>
                                            <span class="log-agent ${l.agent || ''}">${(l.agent || '').toUpperCase()}</span>
                                            <span class="log-text">${l.text}</span>
                                        </div>
                                    `).join('') : '<div style="color:var(--text-muted);font-size:0.85rem;padding:0.5rem 0">No activity yet</div>'}
                                </div>
                            </div>
                        </div>
                        <div class="comments-section">
                            <h4>Your Notes & Feedback (${comments.length})</h4>
                            ${comments.map(c => `
                                <div class="comment from-cuper">
                                    <div class="comment-meta">${c.time}</div>
                                    <div>${c.text}</div>
                                </div>
                            `).join('')}
                            <div class="comment-input-row">
                                <input class="comment-input" id="input-${p.id}" placeholder="Add a note for Ben & Gemini..." onkeydown="if(event.key==='Enter')addComment('${p.id}')" />
                                <button class="btn-send" onclick="addComment('${p.id}')">Send</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        function toggleProject(id) {
            const key = 'expand_' + id;
            localStorage.setItem(key, localStorage.getItem(key) === '1' ? '0' : '1');
            render();
        }

        function addComment(projectId) {
            const input = document.getElementById('input-' + projectId);
            const text = input.value.trim();
            if (!text) return;
            
            const comments = loadComments(projectId);
            comments.push({
                time: new Date().toLocaleString(),
                text: text,
                from: 'cuper'
            });
            saveComments(projectId, comments);
            input.value = '';
            render();
        }

        // Poll for state file updates
        async function pollState() {
            try {
                const res = await fetch(STATE_FILE + '?t=' + Date.now());
                if (res.ok) {
                    const newState = await res.json();
                    saveState(newState);
                    render();
                }
            } catch(e) {}
        }

        // Export comments for agents to read
        function exportComments() {
            return JSON.parse(localStorage.getItem('bennycuComments') || '{}');
        }

        // Make it accessible globally for agents
        window.getComments = exportComments;

        // Save comments to file via PUT (so agents can read them)
        async function syncCommentsToFile() {
            const comments = exportComments();
            try {
                // Write to a hidden iframe or just save — agents read localStorage via the JSON
                // Since we can't PUT to a static server, we write to a hidden textarea
                // that agents can scrape, AND we save to a downloadable blob
                const el = document.getElementById('commentsExport');
                if (el) el.textContent = JSON.stringify(comments, null, 2);
            } catch(e) {}
        }

        // Sync all comments to server file (so agents can read)
        async function pushCommentsToServer() {
            const all = JSON.parse(localStorage.getItem('bennycuComments') || '{}');
            try {
                await fetch('/save-comments', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(all, null, 2)
                });
            } catch(e) {}
        }

        // Override addComment to also sync to server
        function addCommentAndSync(projectId) {
            const input = document.getElementById('input-' + projectId);
            const text = input.value.trim();
            if (!text) return;
            
            const comments = loadComments(projectId);
            comments.push({
                time: new Date().toLocaleString(),
                text: text,
                from: 'cuper'
            });
            saveComments(projectId, comments);
            input.value = '';
            pushCommentsToServer();
            render();
        }

        // Patch all send buttons to use synced version
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-send')) {
                const input = e.target.previousElementSibling;
                if (input && input.id) {
                    const pid = input.id.replace('input-', '');
                    addCommentAndSync(pid);
                    e.stopPropagation();
                }
            }
        }, true);

        // Poll for comments file written by agents
        async function pollComments() {
            try {
                const res = await fetch('monitor-comments.json?t=' + Date.now());
                if (res.ok) {
                    const agentComments = await res.json();
                    // Merge agent comments into localStorage (don't overwrite user's)
                    const local = JSON.parse(localStorage.getItem('bennycuComments') || '{}');
                    let changed = false;
                    for (const [pid, clist] of Object.entries(agentComments)) {
                        if (!local[pid]) local[pid] = [];
                        for (const c of clist) {
                            // Check if this comment already exists (by time+text)
                            const exists = local[pid].some(lc => lc.time === c.time && lc.text === c.text);
                            if (!exists) {
                                local[pid].push(c);
                                changed = true;
                            }
                        }
                    }
                    if (changed) {
                        localStorage.setItem('bennycuComments', JSON.stringify(local));
                        render();
                    }
                }
            } catch(e) {}
        }

        // Initial render + auto-refresh
        render();
        setInterval(() => { pollState(); pollComments(); render(); }, 10000);
    </script>
</body>
</html>
