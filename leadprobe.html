<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LeadLog - XRF Reading Logger for LeadProbe</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--bg:#f5f7f9;--surface:#ffffff;--card:#f8f9fa;--border:#e1e4e8;
--text:#1a202c;--muted:#6b7280;--slate:#2d3748;--orange:#dd6b20;
--danger:#c53030;--danger-bg:#fed7d7;--danger-border:#fc8181;
--warn:#d69e2e;--warn-bg:#fefcbf;--warn-border:#f6e05e;
--safe:#38a169;--safe-bg:#c6f6d5;--safe-border:#9ae6b4;
--info:#3182ce;--info-bg:#bee3f8;--info-border:#90cdf4;
--focus-ring:#3182ce;
}
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:.01ms!important;transition-duration:.01ms!important}}
html{font-size:16px;background:var(--bg);color:var(--text)}
body{padding-bottom:80px;font-family:'Roboto',sans-serif;min-height:100vh;padding-bottom:140px!important;background:var(--bg);overflow-x:hidden;line-height:1.5}
a{color:var(--slate)}
h1,h2,h3{font-family:'Roboto Slab',serif;color:var(--text);font-weight:600}

/* Skip link for accessibility */
.skip-link{position:absolute;top:-50px;left:8px;background:var(--orange);color:#fff;padding:12px 20px;z-index:10000;border-radius:6px;font-weight:600;text-decoration:none;box-shadow:0 4px 12px rgba(0,0,0,.15)}
.skip-link:focus{top:8px;outline:3px solid #fff;outline-offset:2px}

/* Header */
.app-header{background:linear-gradient(135deg,#2d3748 0%,#4a5568 100%);padding:18px 16px;text-align:center;position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.app-header h1{font-size:1.5rem;color:#fff;margin-bottom:4px;font-weight:700}
.app-header p{font-size:.75rem;color:rgba(255,255,255,.75);letter-spacing:.08em;text-transform:uppercase;font-family:'Roboto',sans-serif;font-weight:500}

/* Demo banner */
.demo-banner{background:var(--warn-bg);border:1px solid var(--warn-border);padding:14px 16px;margin:12px 12px 0;border-radius:10px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.demo-banner p{font-size:.85rem;color:#744210;line-height:1.4}
.demo-banner button{background:#fff;border:1px solid var(--warn);color:#744210;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:500;white-space:nowrap;transition:all .15s}
.demo-banner button:hover{background:var(--warn);color:#fff}
.demo-banner button:focus-visible{outline:3px solid var(--orange);outline-offset:2px}

main{padding:16px 12px 24px;max-width:100%}
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
.card h2{font-size:1.2rem;margin-bottom:16px;color:var(--text)}
.card h3{font-size:1rem;margin-bottom:12px;color:var(--slate)}

.section-title{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.section-title h2{margin-bottom:0}
.badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:20px;font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em}
.badge-safe{background:var(--safe-bg);color:var(--safe);border:1px solid var(--safe-border)}
.badge-warn{background:var(--warn-bg);color:#744210;border:1px solid var(--warn-border)}
.badge-danger{background:var(--danger-bg);color:var(--danger);border:1px solid var(--danger-border)}

/* Form improvements */
.form-row{display:flex;gap:12px;margin-bottom:16px}
.form-row:last-child{margin-bottom:0}
.form-group{flex:1;min-width:0}
.form-group label{display:block;font-size:.75rem;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.04em;font-weight:600}
.form-group label .required{color:var(--danger);margin-left:2px}
.form-group select,.form-group input{width:100%;padding:12px 14px;background:var(--card);border:2px solid var(--border);color:var(--text);border-radius:8px;font-size:.95rem;font-family:inherit;-webkit-appearance:none;appearance:none;transition:border-color .15s,box-shadow .15s}
.form-group select:focus,.form-group input:focus{border-color:var(--focus-ring);outline:none;box-shadow:0 0 0 3px rgba(49,130,206,.15)}
.form-group select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' fill='none' stroke='%236b7280' stroke-width='2'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px}
.form-group input:invalid:not(:placeholder-shown){border-color:var(--danger)}
.form-group .error-msg{display:none;font-size:.75rem;color:var(--danger);margin-top:4px}
.form-group input:invalid:not(:placeholder-shown)~.error-msg{display:block}

/* Helper text */
.help-text{font-size:.8rem;color:var(--muted);margin-bottom:14px;line-height:1.5}
.help-text strong{color:var(--text)}

/* Room list */
.room-list{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.room-chip{display:flex;align-items:center;justify-content:space-between;background:var(--card);border:2px solid var(--border);border-radius:10px;padding:14px 16px;cursor:pointer;transition:all .15s;position:relative}
.room-chip:hover{border-color:#cbd5e0;background:#fff}
.room-chip.active{border-color:var(--slate);background:rgba(45,55,72,.04);box-shadow:0 2px 4px rgba(0,0,0,.05)}
.room-chip:focus-visible{outline:3px solid var(--focus-ring);outline-offset:2px}
.room-chip .rc-info{display:flex;flex-direction:column;gap:2px;flex:1;min-width:0}
.room-chip .rc-name{font-weight:600;font-size:.95rem;color:var(--text)}
.room-chip .rc-count{font-size:.78rem;color:var(--muted)}
.room-chip .rc-status{width:12px;height:12px;border-radius:50%;flex-shrink:0;margin-left:8px;position:relative}
.room-chip .rc-status::after{content:attr(aria-label);position:absolute;left:20px;top:50%;transform:translateY(-50%);background:var(--slate);color:#fff;padding:4px 8px;border-radius:4px;font-size:.7rem;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .15s;z-index:10}
.room-chip:hover .rc-status::after{opacity:1}
.rc-status.pass{background:var(--safe)}
.rc-status.fail{background:var(--danger)}
.rc-status.empty{background:#e2e8f0}

.add-room-btn{background:var(--card);border:2px dashed #cbd5e0;border-radius:10px;padding:14px;text-align:center;color:var(--muted);cursor:pointer;font-family:inherit;font-size:.9rem;font-weight:500;width:100%;transition:all .15s}
.add-room-btn:hover{border-color:var(--slate);color:var(--slate);background:#fff}
.add-room-btn:focus-visible{outline:3px solid var(--focus-ring);outline-offset:2px}
.add-room-btn svg{display:inline-block;vertical-align:middle;margin-right:6px;width:18px;height:18px}

/* Reading entry improvements */
.reading-entry{background:var(--card);border:2px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px;transition:border-color .15s,box-shadow .15s}
.reading-entry:focus-within{border-color:var(--focus-ring);box-shadow:0 2px 8px rgba(49,130,206,.1)}
.reading-entry-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.reading-entry-header span{font-size:.8rem;color:var(--muted);font-weight:500}
.reading-entry-fields{display:flex;gap:12px;align-items:flex-end}
.reading-entry .re-component{flex:1}
.reading-entry .re-component select{font-size:.9rem;padding:10px 12px}
.reading-entry .re-value{width:100px}
.reading-entry .re-value input{font-size:1rem;padding:10px 12px;text-align:center;font-weight:700}
.reading-entry .re-value input.pass{color:var(--safe);border-color:var(--safe);background:var(--safe-bg)}
.reading-entry .re-value input.fail{color:var(--danger);border-color:var(--danger);background:var(--danger-bg)}
.reading-entry .re-value .value-label{display:block;text-align:center;font-size:.65rem;color:var(--muted);margin-top:4px;text-transform:uppercase;letter-spacing:.05em}
.reading-entry .re-photo{width:44px;height:44px;background:var(--surface);border:2px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;flex-shrink:0;position:relative;transition:border-color .15s}
.reading-entry .re-photo:hover{border-color:var(--focus-ring)}
.reading-entry .re-photo:focus-visible{outline:3px solid var(--focus-ring);outline-offset:2px}
.reading-entry .re-photo svg{width:20px;height:20px;color:var(--muted)}
.reading-entry .re-photo img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.reading-entry .re-photo.has-photo{border-color:var(--safe)}
.reading-entry .re-remove{width:36px;height:36px;border:none;background:var(--danger-bg);color:var(--danger);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;transition:all .15s;flex-shrink:0}
.reading-entry .re-remove:hover{background:var(--danger);color:#fff}
.reading-entry .re-remove:focus-visible{outline:3px solid var(--danger);outline-offset:2px}

.add-reading-btn{background:var(--slate);color:#fff;border:none;border-radius:10px;padding:14px;text-align:center;font-family:inherit;font-size:.9rem;font-weight:600;width:100%;cursor:pointer;margin-top:8px;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .15s;box-shadow:0 2px 4px rgba(0,0,0,.1)}
.add-reading-btn:hover{background:#1a202c;transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
.add-reading-btn:active{transform:translateY(0)}
.add-reading-btn:focus-visible{outline:3px solid var(--focus-ring);outline-offset:2px}
.add-reading-btn svg{width:18px;height:18px}

/* Heat map improvements */
.heat-map{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-bottom:16px}
.hm-room{border-radius:12px;padding:18px 14px;text-align:center;cursor:pointer;transition:all .15s;border-width:2px;border-style:solid;position:relative}
.hm-room:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
.hm-room:focus-visible{outline:3px solid var(--focus-ring);outline-offset:2px}
.hm-room.hm-safe{background:var(--safe-bg);border-color:var(--safe);color:var(--safe)}
.hm-room.hm-warn{background:var(--warn-bg);border-color:var(--warn);color:#744210}
.hm-room.hm-danger{background:var(--danger-bg);border-color:var(--danger);color:var(--danger)}
.hm-room.hm-empty{background:var(--card);border-color:var(--border);color:var(--muted)}
.hm-room .hm-name{font-weight:600;font-size:.9rem;margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hm-room .hm-readings{font-size:.75rem;margin-bottom:8px;opacity:.9}
.hm-room .hm-max{font-size:1.6rem;font-weight:700;font-family:'Roboto Slab',serif}
.hm-room .hm-max-label{font-size:.65rem;text-transform:uppercase;letter-spacing:.05em;opacity:.8}

/* Report card improvements */
.report-card{background:linear-gradient(135deg,#2d3748 0%,#4a5568 100%);border:none;border-radius:16px;padding:24px;color:#fff;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,.15)}
.report-card h2{color:#fff;margin-bottom:20px;font-size:1.25rem}
.rpt-line{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.12);font-size:.92rem}
.rpt-line:last-of-type{border-bottom:none}
.rpt-line span:first-child{color:rgba(255,255,255,.7)}
.rpt-line span:last-child{font-weight:500}
.rpt-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:20px}
.rpt-stat{background:rgba(255,255,255,.1);border-radius:12px;padding:16px 10px;text-align:center;backdrop-filter:blur(4px)}
.rpt-stat .val{font-size:1.6rem;font-weight:700;font-family:'Roboto Slab',serif}
.rpt-stat .lbl{font-size:.65rem;color:rgba(255,255,255,.65);text-transform:uppercase;letter-spacing:.06em;margin-top:4px;font-weight:500}

/* Buttons */
.actions{display:flex;gap:12px;margin-bottom:16px}
.btn{flex:1;padding:16px;border:none;border-radius:12px;font-weight:600;font-size:.95rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all .15s;font-family:'Roboto',sans-serif}
.btn svg{width:20px;height:20px}
.btn:active{transform:scale(.97)}
.btn:focus-visible{outline:3px solid var(--focus-ring);outline-offset:2px}
.btn-primary{background:var(--orange);color:#fff;box-shadow:0 2px 8px rgba(221,107,32,.3)}
.btn-primary:hover{background:#c05621;transform:translateY(-1px);box-shadow:0 4px 12px rgba(221,107,32,.4)}
.btn-secondary{background:var(--surface);color:var(--text);border:2px solid var(--border);box-shadow:0 1px 3px rgba(0,0,0,.05)}
.btn-secondary:hover{border-color:var(--slate);background:#fff;transform:translateY(-1px);box-shadow:0 2px 6px rgba(0,0,0,.1)}

/* History */
.history-empty{text-align:center;padding:32px 20px;color:var(--muted)}
.history-empty svg{width:48px;height:48px;margin-bottom:16px;opacity:.5}
.history-empty p{font-size:.9rem;line-height:1.5}
.insp-item{background:var(--card);border:2px solid var(--border);border-radius:10px;padding:16px;margin-bottom:10px;cursor:pointer;transition:all .15s}
.insp-item:hover{border-color:var(--slate);background:#fff;transform:translateY(-1px);box-shadow:0 2px 6px rgba(0,0,0,.05)}
.insp-item:focus-visible{outline:3px solid var(--focus-ring);outline-offset:2px}
.insp-item .ii-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;gap:12px}
.insp-item .ii-name{font-weight:600;font-size:.95rem;color:var(--text);line-height:1.3}
.insp-item .ii-status{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.04em;padding:4px 10px;border-radius:20px;white-space:nowrap}
.insp-item .ii-status.pass{background:var(--safe-bg);color:var(--safe);border:1px solid var(--safe-border)}
.insp-item .ii-status.fail{background:var(--danger-bg);color:var(--danger);border:1px solid var(--danger-border)}
.insp-item .ii-detail{font-size:.8rem;color:var(--muted);display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.insp-item .ii-detail span{display:flex;align-items:center;gap:4px}

/* Upsell */
.upsell-tab{background:var(--surface);border:2px dashed #cbd5e0;border-radius:12px;padding:24px;margin-bottom:16px;opacity:.75}
.upsell-tab h2{font-size:1.1rem;color:var(--muted);margin-bottom:10px;display:flex;align-items:center;gap:10px}
.upsell-tab p{font-size:.88rem;color:var(--muted);line-height:1.6}
.coming-soon-badge{display:inline-block;background:var(--orange);color:#fff;padding:3px 12px;border-radius:20px;font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em}

/* Toast improvements */
.toast-container{position:fixed;top:80px;right:16px;left:16px;z-index:9000;max-width:400px;margin:0 auto}
@media(min-width:480px){.toast-container{left:auto;margin:0}}
.toast{background:var(--slate);color:#fff;padding:16px 20px;border-radius:10px;font-size:.9rem;opacity:0;transform:translateY(-10px);transition:opacity .3s,transform .3s;box-shadow:0 8px 24px rgba(0,0,0,.2);display:flex;align-items:center;gap:12px}
.toast.show{opacity:1;transform:translateY(0)}
.toast.success{background:var(--safe)}
.toast.error{background:var(--danger)}
.toast.warning{background:var(--warn);color:#744210}
.toast svg{width:20px;height:20px;flex-shrink:0}

/* Loading states */
.loading-overlay{position:fixed;inset:0;background:rgba(255,255,255,.9);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;pointer-events:none;transition:opacity .2s}
.loading-overlay.active{opacity:1;pointer-events:all}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--orange);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Empty states */
.empty-state{text-align:center;padding:32px 20px;color:var(--muted)}
.empty-state svg{width:56px;height:56px;margin-bottom:16px;opacity:.4}
.empty-state h4{font-size:1rem;color:var(--text);margin-bottom:6px;font-weight:600}
.empty-state p{font-size:.85rem;line-height:1.5;max-width:280px;margin:0 auto}

/* Confirmation dialog */
.dialog-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:10001;padding:20px;opacity:0;pointer-events:none;transition:opacity .2s}
.dialog-overlay.active{opacity:1;pointer-events:all}
.dialog{background:#fff;border-radius:16px;padding:24px;max-width:360px;width:100%;box-shadow:0 20px 48px rgba(0,0,0,.3);transform:scale(.95);transition:transform .2s}
.dialog-overlay.active .dialog{transform:scale(1)}
.dialog h3{font-size:1.1rem;margin-bottom:10px;color:var(--text)}
.dialog p{font-size:.9rem;color:var(--muted);margin-bottom:20px;line-height:1.5}
.dialog-actions{display:flex;gap:12px}
.dialog-actions button{flex:1;padding:12px 16px;border:none;border-radius:10px;font-size:.9rem;font-weight:600;cursor:pointer;transition:all .15s}
.dialog-actions .btn-cancel{background:var(--card);color:var(--text);border:2px solid var(--border)}
.dialog-actions .btn-cancel:hover{border-color:var(--slate)}
.dialog-actions .btn-confirm{background:var(--danger);color:#fff}
.dialog-actions .btn-confirm:hover{background:#9b2c2c}
.dialog-actions button:focus-visible{outline:3px solid var(--focus-ring);outline-offset:2px}

/* Bottom nav improvements */
.bottom-nav{position:fixed;bottom:60px;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);display:flex;z-index:100;padding:6px 0;box-shadow:0 -2px 10px rgba(0,0,0,.06)}
.bottom-nav button{flex:1;background:none;border:none;color:var(--muted);padding:10px 4px;font-size:.65rem;text-transform:uppercase;letter-spacing:.06em;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;font-family:'Roboto',sans-serif;font-weight:500;transition:all .15s}
.bottom-nav button.active{color:var(--slate)}
.bottom-nav button svg{width:24px;height:24px;transition:transform .15s}
.bottom-nav button:active svg{transform:scale(.9)}
.bottom-nav button:focus-visible{outline:3px solid var(--focus-ring);outline-offset:-2px}

.section{display:none}.section.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.animate-in{animation:fadeUp .4s ease-out both}
.animate-in:nth-child(2){animation-delay:60ms}
.animate-in:nth-child(3){animation-delay:120ms}

/* Print styles */
@media print{
.bottom-nav,.app-header,.demo-banner,.actions,.upsell-tab,.toast-container,#bct-demo-disclaimer,.dialog-overlay,.loading-overlay{display:none!important}
body{padding-bottom:80px;background:#fff;padding:20px;padding-bottom:20px!important}
.report-card{background:#2d3748!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
.hm-room{-webkit-print-color-adjust:exact;print-color-adjust:exact}
.card{border:1px solid #ddd;box-shadow:none}
.reading-entry{border:1px solid #ddd}
}

/* Desktop improvements */
@media(min-width:768px){
main{max-width:680px;margin:0 auto;padding:24px}
.bottom-nav{display:none}
body{padding-bottom:80px;padding-bottom:24px!important}
}

/* Focus visible polyfill style */
.js-focus-visible :focus:not(.focus-visible){outline:none}
</style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to main content</a>

<header class="app-header">
<h1>LeadLog</h1>
<p>LeadProbe | Ellicott City, MD</p>
</header>

<div class="demo-banner" id="demoBanner" role="status" aria-live="polite">
<p><strong>Demo:</strong> Sample inspection loaded. This shows how the tool works with real data.</p>
<button onclick="confirmClearDemo()" aria-label="Clear demo data and start fresh">Clear Demo</button>
</div>

<main id="main-content">

<!-- INSPECT TAB -->
<section class="section active" id="sec-inspect" aria-label="New Inspection">

<div class="card animate-in">
<div class="section-title">
<h2>Property Details</h2>
<span class="badge badge-safe" id="statusBadge">Ready</span>
</div>
<p class="help-text">Enter the property information for this inspection. All fields with <span class="required">*</span> are required.</p>

<div class="form-row">
<div class="form-group" style="flex:2">
<label for="propAddr">Property Address <span class="required">*</span></label>
<input type="text" id="propAddr" placeholder="e.g., 123 Main St, Ellicott City, MD" required aria-required="true">
<div class="error-msg">Please enter a property address</div>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="propOwner">Landlord / Owner</label>
<input type="text" id="propOwner" placeholder="Owner or property manager name">
</div>
<div class="form-group">
<label for="propYear">Year Built</label>
<input type="number" id="propYear" min="1800" max="2026" placeholder="e.g., 1942">
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="inspType">Inspection Type</label>
<select id="inspType" aria-label="Inspection type">
<option value="risk-reduction">Lead Risk Reduction</option>
<option value="clearance">Post-Remediation Clearance</option>
<option value="presale">Pre-Sale Inspection</option>
<option value="full">Full Lead Inspection</option>
</select>
</div>
<div class="form-group">
<label for="inspDate">Inspection Date <span class="required">*</span></label>
<input type="date" id="inspDate" required aria-required="true">
<div class="error-msg">Please select a date</div>
</div>
</div>
</div>

<div class="card animate-in">
<div class="section-title">
<h2>Rooms</h2>
</div>
<p class="help-text">Select a room to add XRF readings. The color shows the pass/fail status based on your action level (1.0 mg/cm²).</p>
<div class="room-list" id="roomList" role="list" aria-label="Room list"></div>
<button class="add-room-btn" onclick="addRoom()" aria-label="Add a new room">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
Add Room
</button>
</div>

<div class="card animate-in" id="readingPanel" style="display:none">
<div class="section-title">
<h2 id="readingRoomTitle">Room Name</h2>
</div>
<p class="help-text">Action level is <strong id="actionLevelDisplay">1.0 mg/cm²</strong>. Readings above this trigger a positive flag.</p>
<div id="readingsList" role="list" aria-label="XRF readings"></div>
<button class="add-reading-btn" onclick="addReading()">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
Add Reading
</button>
</div>

<div class="card animate-in">
<div class="section-title">
<h2>Room Overview</h2>
</div>
<p class="help-text">Quick visual summary. <strong>Green</strong> = all clear. <strong>Yellow</strong> = elevated. <strong>Red</strong> = positive readings found.</p>
<div class="heat-map" id="heatMap" role="list" aria-label="Room status overview"></div>
</div>

<div class="report-card animate-in" id="reportCard" role="region" aria-label="Inspection summary">
<h2>Inspection Summary</h2>
<div class="rpt-line"><span>Property</span><span id="rptAddr">--</span></div>
<div class="rpt-line"><span>Year Built</span><span id="rptYear">--</span></div>
<div class="rpt-line"><span>Type</span><span id="rptType">--</span></div>
<div class="rpt-line"><span>Inspector</span><span id="rptInspector">--</span></div>
<div class="rpt-stats">
<div class="rpt-stat"><div class="val" id="rptTotal">0</div><div class="lbl">Total Readings</div></div>
<div class="rpt-stat"><div class="val" id="rptPositive">0</div><div class="lbl">Positive</div></div>
<div class="rpt-stat"><div class="val" id="rptHighest">0.0</div><div class="lbl">Highest (mg/cm²)</div></div>
</div>
</div>

<div class="actions animate-in">
<button class="btn btn-primary" onclick="shareReport()" aria-label="Share inspection report">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
Share Report
</button>
<button class="btn btn-secondary" onclick="copyReport()" aria-label="Copy report to clipboard">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
Copy
</button>
</div>

<button class="btn btn-secondary" onclick="saveInspection()" style="width:100%;margin-bottom:16px" aria-label="Save this inspection to history">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
Save Inspection
</button>
</section>

<!-- HISTORY TAB -->
<section class="section" id="sec-history" aria-label="Inspection History">
<div class="card">
<div class="section-title">
<h2>Saved Inspections</h2>
</div>
<div id="historyList" role="list" aria-label="Saved inspections"></div>
</div>
<div class="upsell-tab" aria-disabled="true">
<h2>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity:.6"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
Multi-Property Dashboard
<span class="coming-soon-badge">Coming Soon</span>
</h2>
<p>Track compliance status across all your landlord properties. See which ones need re-inspection this quarter. Flag properties nearing their certification expiration. Available in the full version.</p>
</div>
</section>

<!-- SETTINGS TAB -->
<section class="section" id="sec-settings" aria-label="Settings">
<div class="card">
<div class="section-title">
<h2>Inspector Information</h2>
</div>
<div class="form-row">
<div class="form-group">
<label for="inspectorName">Inspector Name</label>
<input type="text" id="inspectorName" value="Neil Roseman" placeholder="Your full name">
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="certNumber">MDE Cert Number</label>
<input type="text" id="certNumber" placeholder="e.g., MDE-12345">
</div>
<div class="form-group">
<label for="actionLevel">Action Level (mg/cm²)</label>
<input type="number" id="actionLevel" value="1.0" min="0" step="0.1" aria-describedby="actionLevelHelp">
</div>
</div>
<p id="actionLevelHelp" style="font-size:.75rem;color:var(--muted);margin-top:-8px;margin-bottom:16px">The EPA action level for lead paint is typically 1.0 mg/cm²</p>
<button class="btn btn-primary" onclick="saveSettings()" style="width:100%">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
Save Settings
</button>
</div>
<div class="card" style="margin-top:16px">
<div class="section-title">
<h2>Data Management</h2>
</div>
<p class="help-text">Export your inspection data for backup or transfer to another device. Import previously exported data.</p>
<div class="actions" style="margin-bottom:0">
<button class="btn btn-secondary" onclick="exportData()">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
Export JSON
</button>
<button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
Import JSON
</button>
<input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)" aria-label="Import inspection data from JSON file">
</div>
</div>
</section>

</main>

<nav class="bottom-nav" aria-label="Main navigation">
<button class="active" data-tab="sec-inspect" onclick="switchTab(this)" aria-label="New inspection" aria-current="page">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14l2 2 4-4"/></svg>
Inspect
</button>
<button data-tab="sec-history" onclick="switchTab(this)" aria-label="Inspection history">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
History
</button>
<button data-tab="sec-settings" onclick="switchTab(this)" aria-label="Settings">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
Settings
</button>
</nav>

<!-- DEMO DISCLAIMER -->
<div id="bct-demo-disclaimer" role="contentinfo" aria-label="Demo disclaimer" style="position:fixed;bottom:0;left:0;right:0;background:#f8f8f8;border-top:1px solid #ddd;padding:12px 16px;font-size:12px;line-height:1.4;color:#666;z-index:99999;display:flex;flex-wrap:wrap;align-items:center;justify-content:center;gap:8px 16px;text-align:center;">
<p style="margin:0;max-width:700px;"><strong style="color:#333;">Demo:</strong> Not affiliated with LeadProbe, Inc.</p>
<a href="mailto:cuuper225@gmail.com?subject=Delete%20Demo%3A%20LeadProbe&body=I%20am%20the%20owner%20and%20I%20request%20permanent%20deletion%20of%20this%20demo." style="display:inline-flex;align-items:center;gap:4px;background:#dc3545;color:#fff;padding:6px 14px;border-radius:4px;text-decoration:none;font-size:11px;font-weight:500;white-space:nowrap;">
<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
Request Permanent Deletion
</a>
</div>

<!-- Loading overlay -->
<div class="loading-overlay" id="loadingOverlay" aria-hidden="true">
<div class="spinner" role="status" aria-label="Loading"></div>
</div>

<!-- Confirmation dialog -->
<div class="dialog-overlay" id="confirmDialog" role="dialog" aria-modal="true" aria-labelledby="confirmTitle" aria-describedby="confirmDesc">
<div class="dialog">
<h3 id="confirmTitle">Clear Demo Data?</h3>
<p id="confirmDesc">This will remove all demo inspections and reset the form. Your saved inspections will not be affected.</p>
<div class="dialog-actions">
<button class="btn-cancel" onclick="closeConfirmDialog()">Cancel</button>
<button class="btn-confirm" onclick="executeClearDemo()">Clear Data</button>
</div>
</div>
</div>

<!-- Toast container -->
<div class="toast-container" aria-live="polite" aria-atomic="true"><div class="toast" id="toast" role="status"></div></div>

<input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none" aria-label="Take photo of component">

<script>
// Access gate
function _h(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return h;}
const _V=1017171158;
const _k=new URLSearchParams(window.location.search).get('key');
if(!_k||_h(_k)!==_V){
document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;background:#f5f7f9;color:#2d3748;text-align:center;padding:20px"><div style="max-width:400px"><h1 style="font-size:2rem;margin-bottom:1rem;font-family:Roboto Slab,serif">Access Required</h1><p style="color:#6b7280;margin-bottom:1.5rem">This tool requires a valid access key to view.</p><p><a href="mailto:ben@bennycutools.com" style="color:#dd6b20;font-weight:600;text-decoration:none">ben@bennycutools.com</a></p></div></div><div id="bct-demo-disclaimer" role="contentinfo" style="position:fixed;bottom:0;left:0;right:0;background:#f8f8f8;border-top:1px solid #ddd;padding:10px 16px;font-size:12px;color:#666;z-index:99999;text-align:center"><p style="margin:0"><strong style="color:#333;">Demo:</strong> Not affiliated with LeadProbe, Inc.</p></div>';
throw new Error('Invalid key');
}

// DB with error handling
let db;const DB_NAME='LeadLogDB';const DB_VER=1;const STORE='inspections';const SETTINGS_STORE='settings';
function openDB(){return new Promise((res,rej)=>{
try{
const r=indexedDB.open(DB_NAME,DB_VER);
r.onupgradeneeded=e=>{
const d=e.target.result;
if(!d.objectStoreNames.contains(STORE))d.createObjectStore(STORE,{keyPath:'id',autoIncrement:true});
if(!d.objectStoreNames.contains(SETTINGS_STORE))d.createObjectStore(SETTINGS_STORE,{keyPath:'key'});
};
r.onsuccess=e=>{db=e.target.result;res(db)};
r.onerror=e=>{console.error('DB open error:',e);rej(new Error('Could not open database'))};
r.onblocked=()=>{showToast('Database blocked. Close other tabs.','error');rej(new Error('Database blocked'))};
}catch(err){console.error('DB init error:',err);rej(err)}
})}
function dbPut(store,data){return new Promise((res,rej)=>{
if(!db){rej(new Error('Database not available'));return}
try{
const tx=db.transaction(store,'readwrite');tx.objectStore(store).put(data);tx.oncomplete=()=>res();tx.onerror=e=>{console.error('DB put error:',e);rej(e)}
}catch(err){console.error('DB put error:',err);rej(err)}
})}
function dbGetAll(store){return new Promise((res,rej)=>{
if(!db){rej(new Error('Database not available'));return}
try{
const tx=db.transaction(store,'readonly');const r=tx.objectStore(store).getAll();r.onsuccess=()=>res(r.result);r.onerror=e=>{console.error('DB getAll error:',e);rej(e)}
}catch(err){console.error('DB getAll error:',err);rej(err)}
})}
function dbClear(store){return new Promise((res,rej)=>{
if(!db){rej(new Error('Database not available'));return}
try{
const tx=db.transaction(store,'readwrite');tx.objectStore(store).clear();tx.oncomplete=()=>res();tx.onerror=e=>{console.error('DB clear error:',e);rej(e)}
}catch(err){console.error('DB clear error:',err);rej(err)}
})}

// Component presets
const COMPONENTS=['Wall','Door','Door Frame','Window Sill','Window Frame','Baseboard','Trim','Ceiling','Cabinet','Closet','Railing','Other'];
let ACTION_LEVEL=1.0;

// State
let rooms=[];
let activeRoomIdx=0;
let currentPhotoReading=null;
let pendingAction=null;

// Loading state
function showLoading(){document.getElementById('loadingOverlay').classList.add('active');}
function hideLoading(){document.getElementById('loadingOverlay').classList.remove('active');}

// Confirmation dialog
function confirmClearDemo(){pendingAction='clearDemo';document.getElementById('confirmDialog').classList.add('active');document.querySelector('.btn-confirm').focus();}
function closeConfirmDialog(){document.getElementById('confirmDialog').classList.remove('active');pendingAction=null;}
function executeClearDemo(){closeConfirmDialog();if(pendingAction==='clearDemo'){clearDemo();}pendingAction=null;}

// Escape key for dialog
document.addEventListener('keydown',e=>{
if(e.key==='Escape'){closeConfirmDialog();}
});

// Init
(async function(){
try{
await openDB();
document.getElementById('inspDate').value=new Date().toISOString().split('T')[0];

// Load settings
const settings=await dbGetAll(SETTINGS_STORE);
const inspectorSetting=settings.find(s=>s.key==='inspector');
if(inspectorSetting){
document.getElementById('inspectorName').value=inspectorSetting.data.name||'Neil Roseman';
document.getElementById('certNumber').value=inspectorSetting.data.cert||'';
ACTION_LEVEL=inspectorSetting.data.actionLevel||1.0;
document.getElementById('actionLevel').value=ACTION_LEVEL;
document.getElementById('actionLevelDisplay').textContent=ACTION_LEVEL.toFixed(1)+' mg/cm²';
}

const isFirst=!localStorage.getItem('leadlog_visited');
if(isFirst){loadDemoData();localStorage.setItem('leadlog_visited','1')}
else if(!rooms.length){rooms=[{name:'Living Room',readings:[]}];activeRoomIdx=0}
renderRooms();renderHeatMap();updateReport();loadHistory();

// Try to get location silently
if(navigator.geolocation){
navigator.geolocation.getCurrentPosition(()=>{},()=>{},{timeout:5000,maximumAge:60000});
}
}catch(err){
console.error('Init error:',err);
showToast('Error loading app. Please refresh.','error');
}
})();

// Photo handler
document.getElementById('photoInput').addEventListener('change',function(e){
const file=e.target.files[0];if(!file||currentPhotoReading===null)return;
if(!file.type.startsWith('image/')){showToast('Please select an image file','error');e.target.value='';return;}
if(file.size>10*1024*1024){showToast('Image too large (max 10MB)','error');e.target.value='';return;}
const reader=new FileReader();
reader.onload=function(ev){
const room=rooms[activeRoomIdx];
if(room&&room.readings[currentPhotoReading]){
room.readings[currentPhotoReading].photo=ev.target.result;
renderReadings();
showToast('Photo added');
}
};
reader.onerror=()=>{showToast('Failed to load photo','error');};
reader.readAsDataURL(file);e.target.value='';
});

function renderRooms(){
const el=document.getElementById('roomList');
if(rooms.length===0){
el.innerHTML='<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/></svg><h4>No rooms yet</h4><p>Add your first room to start logging XRF readings</p></div>';
renderReadings();
return;
}
el.innerHTML=rooms.map((r,i)=>{
const positives=r.readings.filter(rd=>rd.value>ACTION_LEVEL).length;
const total=r.readings.length;
const statusCls=total===0?'empty':positives>0?'fail':'pass';
const activeCls=i===activeRoomIdx?'active':'';
const statusLabel=total===0?'No readings':positives>0?positives+' positive':'All clear';
return`<div class="room-chip ${activeCls}" tabindex="0" role="listitem" onclick="selectRoom(${i})" onkeypress="if(event.key==='Enter'||event.key===' ')selectRoom(${i})" aria-label="${r.name}: ${total} readings, ${statusLabel}" aria-current="${i===activeRoomIdx?'true':'false'}"><div class="rc-info"><span class="rc-name">${esc(r.name)}</span><span class="rc-count">${total} reading${total!==1?'s':''}${positives>0?', '+positives+' positive':''}</span></div><span class="rc-status ${statusCls}" aria-label="${statusLabel}"></span></div>`;
}).join('');
renderReadings();
}

function selectRoom(i){
activeRoomIdx=i;
renderRooms();
// Scroll to reading panel on mobile
if(window.innerWidth<768){
setTimeout(()=>{const panel=document.getElementById('readingPanel');if(panel&&panel.style.display!=='none'){panel.scrollIntoView({behavior:'smooth',block:'start'});}},50);
}
}

function addRoom(){
const name=prompt('Room name (examples: Bedroom 2, Kitchen, Hallway):');
if(!name||!name.trim())return;
const trimmedName=name.trim();
// Check for duplicate
if(rooms.some(r=>r.name.toLowerCase()===trimmedName.toLowerCase())){
showToast('Room already exists','warning');
return;
}
rooms.push({name:trimmedName,readings:[]});
activeRoomIdx=rooms.length-1;
renderRooms();renderHeatMap();updateReport();
showToast('Room added: '+trimmedName);
}

function renderReadings(){
const panel=document.getElementById('readingPanel');
const room=rooms[activeRoomIdx];
if(!room){panel.style.display='none';return}
panel.style.display='block';
document.getElementById('readingRoomTitle').textContent=room.name;
const list=document.getElementById('readingsList');
if(room.readings.length===0){
list.innerHTML='<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg><h4>No readings yet</h4><p>Add your first XRF reading for this room</p></div>';
return;
}
list.innerHTML=room.readings.map((rd,i)=>{
const passFail=rd.value>ACTION_LEVEL?'fail':'pass';
const passFailLabel=rd.value>ACTION_LEVEL?'Above action level':'Below action level';
return`<div class="reading-entry" role="listitem"><div class="reading-entry-header"><span>Reading #${i+1}</span></div><div class="reading-entry-fields"><div class="re-component"><select onchange="updateReading(${i},'component',this.value)" aria-label="Component type for reading ${i+1}">${COMPONENTS.map(c=>`<option${c===rd.component?' selected':''}>${c}</option>`).join('')}</select></div><div class="re-value"><input type="number" step="0.1" min="0" max="100" value="${rd.value}" class="${passFail}" onchange="updateReading(${i},'value',+this.value)" aria-label="XRF value in mg per square centimeter" aria-describedby="reading-status-${i}"><span class="value-label" id="reading-status-${i}">${passFailLabel}</span></div><div class="re-photo ${rd.photo?'has-photo':''}" tabindex="0" role="button" aria-label="${rd.photo?'View or replace':'Add'} photo for ${rd.component}" onclick="takeReadingPhoto(${i})" onkeypress="if(event.key==='Enter'||event.key===' ')takeReadingPhoto(${i})">${rd.photo?`<img src="${rd.photo}" alt="Photo of ${rd.component}">`:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>'}</div><button class="re-remove" onclick="confirmRemoveReading(${i})" aria-label="Remove reading ${i+1}">×</button></div></div>`;
}).join('');
}

function addReading(){
const room=rooms[activeRoomIdx];if(!room)return;
room.readings.push({component:'Wall',value:0,condition:'intact',photo:null});
renderReadings();renderHeatMap();updateReport();
// Focus the new reading's value input
setTimeout(()=>{
const inputs=document.querySelectorAll('.reading-entry .re-value input');
if(inputs.length>0){inputs[inputs.length-1].focus();inputs[inputs.length-1].select();}
},50);
}

function updateReading(i,field,val){
const room=rooms[activeRoomIdx];if(!room)return;
if(field==='value'){
// Validate value
if(val<0||val>100){showToast('Value must be between 0 and 100','error');return;}
}
room.readings[i][field]=val;
renderReadings();renderHeatMap();updateReport();
updateStatusBadge();
}

function confirmRemoveReading(i){
if(confirm('Remove this reading?')){
const room=rooms[activeRoomIdx];if(!room)return;
room.readings.splice(i,1);
renderReadings();renderHeatMap();updateReport();
updateStatusBadge();
}
}

function takeReadingPhoto(i){
currentPhotoReading=i;
document.getElementById('photoInput').click();
}

// Heat map
function renderHeatMap(){
const el=document.getElementById('heatMap');
if(rooms.length===0){
el.innerHTML='<div class="empty-state" style="grid-column:1/-1"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/></svg><h4>No rooms to display</h4><p>Add rooms to see the overview</p></div>';
return;
}
el.innerHTML=rooms.map((r,i)=>{
const total=r.readings.length;
const positives=r.readings.filter(rd=>rd.value>ACTION_LEVEL).length;
const maxVal=total?Math.max(...r.readings.map(rd=>rd.value)):0;
let cls='hm-empty';let label='No readings';
if(total>0){if(positives>0){cls='hm-danger';label=positives+' positive';}else if(maxVal>ACTION_LEVEL*0.5){cls='hm-warn';label='Elevated';}else{cls='hm-safe';label='All clear';}}
return`<div class="hm-room ${cls}" tabindex="0" role="listitem" onclick="selectRoom(${i})" onkeypress="if(event.key==='Enter'||event.key===' ')selectRoom(${i})" aria-label="${r.name}: ${label}, max ${maxVal.toFixed(1)} mg per cm squared"><div class="hm-name">${esc(r.name)}</div><div class="hm-max">${total?maxVal.toFixed(1):'-'}</div><div class="hm-max-label">Max mg/cm²</div><div class="hm-readings">${total} reading${total!==1?'s':''}${positives>0?', '+positives+' pos':''}</div></div>`;
}).join('');
}

function updateStatusBadge(){
const badge=document.getElementById('statusBadge');
let totalP=0;
rooms.forEach(r=>r.readings.forEach(rd=>{if(rd.value>ACTION_LEVEL)totalP++;}));
if(totalP>0){badge.className='badge badge-danger';badge.textContent=totalP+' Positive';}
else if(rooms.some(r=>r.readings.length>0)){badge.className='badge badge-safe';badge.textContent='All Clear';}
else{badge.className='badge badge-safe';badge.textContent='Ready';}
}

function updateReport(){
const addr=document.getElementById('propAddr').value||'--';
const year=document.getElementById('propYear').value||'--';
const inspectorName=document.getElementById('inspectorName').value||'LeadProbe';
const types={['risk-reduction']:'Lead Risk Reduction',clearance:'Post-Remediation Clearance',presale:'Pre-Sale Inspection',full:'Full Lead Inspection'};
document.getElementById('rptAddr').textContent=addr;
document.getElementById('rptYear').textContent=year;
document.getElementById('rptType').textContent=types[document.getElementById('inspType').value]||'Inspection';
document.getElementById('rptInspector').textContent=inspectorName;
let totalR=0,totalP=0,highest=0;
rooms.forEach(r=>{r.readings.forEach(rd=>{totalR++;if(rd.value>ACTION_LEVEL)totalP++;if(rd.value>highest)highest=rd.value})});
document.getElementById('rptTotal').textContent=totalR;
document.getElementById('rptPositive').textContent=totalP;
document.getElementById('rptPositive').style.color=totalP>0?'#e74c3c':'#38a169';
document.getElementById('rptHighest').textContent=highest.toFixed(1);
document.getElementById('rptHighest').style.color=highest>ACTION_LEVEL?'#e74c3c':highest>ACTION_LEVEL*0.5?'#d69e2e':'#38a169';
updateStatusBadge();
}

['propAddr','propOwner','propYear','inspType','inspDate'].forEach(id=>{
const el=document.getElementById(id);
if(el){el.addEventListener('change',updateReport);el.addEventListener('input',updateReport)}
});

// Share with error handling
async function shareReport(){
showLoading();
try{
const text=buildReportText();
if(navigator.share){try{await navigator.share({title:'Lead Inspection Report - LeadProbe',text});showToast('Report shared successfully','success');}catch(e){if(e.name!=='AbortError'){showToast('Could not share report','error');}}}
else{try{await navigator.clipboard.writeText(text);showToast('Report copied to clipboard','success');}catch(e){showToast('Could not copy report','error');}}
}catch(err){showToast('Error generating report','error');console.error(err);}
finally{hideLoading();}
}

async function copyReport(){
try{await navigator.clipboard.writeText(buildReportText());showToast('Report copied to clipboard','success');}catch(e){showToast('Could not copy to clipboard','error');}
}

function buildReportText(){
const addr=document.getElementById('propAddr').value||'--';
const owner=document.getElementById('propOwner').value||'--';
const year=document.getElementById('propYear').value||'--';
const date=document.getElementById('inspDate').value;
const inspectorName=document.getElementById('inspectorName').value||'LeadProbe';
let totalR=0,totalP=0,highest=0;
let roomLines='';
rooms.forEach(r=>{
if(!r.readings.length)return;
roomLines+=`\n${r.name}:\n`;
r.readings.forEach(rd=>{
totalR++;
const pf=rd.value>ACTION_LEVEL?'POSITIVE':'clear';
if(rd.value>ACTION_LEVEL)totalP++;
if(rd.value>highest)highest=rd.value;
roomLines+=`  ${rd.component}: ${rd.value} mg/cm2 [${pf}]\n`;
});
});
return`LEAD PAINT INSPECTION REPORT
LeadProbe, Inc. | Ellicott City, MD
Inspector: ${inspectorName}

Property: ${addr}
Owner: ${owner}
Year Built: ${year}
Date: ${date}
Action Level: ${ACTION_LEVEL} mg/cm2

RESULTS SUMMARY:
Total Readings: ${totalR}
Positive (above action level): ${totalP}
Highest Reading: ${highest.toFixed(1)} mg/cm2
${roomLines}
${totalP>0?'RESULT: Positive findings detected. Remediation may be required per Maryland Lead Law.':'RESULT: No positive findings at or above action level.'}

---
LeadProbe, Inc.
(410) 591-4597
leadprobe.com`;
}

// Save with error handling
async function saveInspection(){
const addr=document.getElementById('propAddr').value.trim();
if(!addr){showToast('Please enter a property address','error');document.getElementById('propAddr').focus();return;}
showLoading();
try{
const insp={
address:addr,
owner:document.getElementById('propOwner').value||'',
yearBuilt:document.getElementById('propYear').value||'',
inspType:document.getElementById('inspType').value,
date:document.getElementById('inspDate').value,
rooms:JSON.parse(JSON.stringify(rooms.map(r=>({name:r.name,readings:r.readings.map(rd=>({component:rd.component,value:rd.value,condition:rd.condition}))})))),
totalReadings:0,positives:0,isDemo:false
};
rooms.forEach(r=>r.readings.forEach(rd=>{insp.totalReadings++;if(rd.value>ACTION_LEVEL)insp.positives++}));
await dbPut(STORE,insp);
showToast('Inspection saved to history','success');
loadHistory();
}catch(err){
console.error('Save error:',err);
showToast('Failed to save inspection','error');
}finally{hideLoading();}
}

async function loadHistory(){
try{
const insps=await dbGetAll(STORE);
const el=document.getElementById('historyList');
if(!insps.length){
el.innerHTML='<div class="history-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><p>No saved inspections yet.<br>Complete an inspection and tap "Save Inspection" to store it here.</p></div>';
return;
}
insps.sort((a,b)=>new Date(b.date)-new Date(a.date));
el.innerHTML=insps.map(ins=>{
const statusCls=ins.positives>0?'fail':'pass';
const statusText=ins.positives>0?ins.positives+' Positive':'Clear';
return`<div class="insp-item" tabindex="0" role="listitem" aria-label="${ins.address||'No address'}, ${ins.totalReadings} readings, ${statusText}"><div class="ii-top"><span class="ii-name">${esc(ins.address||'No address')}</span><span class="ii-status ${statusCls}">${statusText}</span></div><div class="ii-detail"><span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>${ins.date||'--'}</span><span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>${ins.totalReadings} readings</span>${ins.owner?'<span>'+esc(ins.owner)+'</span>':''}</div></div>`;
}).join('');
}catch(err){
console.error('Load history error:',err);
document.getElementById('historyList').innerHTML='<p style="color:var(--muted);text-align:center;padding:20px">Error loading history. Try refreshing.</p>';
}
}

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

// Demo data - now with Ellicott City focus
function loadDemoData(){
document.getElementById('propAddr').value='1234 Main Street, Ellicott City, MD 21043';
document.getElementById('propOwner').value='Patricia Chen';
document.getElementById('propYear').value='1925';
document.getElementById('inspType').value='risk-reduction';

rooms=[
{name:'Living Room',readings:[
{component:'Wall',value:0.4,condition:'intact',photo:null},
{component:'Door Frame',value:1.8,condition:'fair',photo:null},
{component:'Window Sill',value:3.2,condition:'poor',photo:null},
{component:'Baseboard',value:0.6,condition:'intact',photo:null},
{component:'Window Frame',value:2.1,condition:'fair',photo:null},
{component:'Trim',value:0.3,condition:'intact',photo:null}
]},
{name:'Kitchen',readings:[
{component:'Wall',value:0.3,condition:'intact',photo:null},
{component:'Cabinet',value:1.2,condition:'fair',photo:null},
{component:'Window Sill',value:0.8,condition:'intact',photo:null},
{component:'Door Frame',value:0.5,condition:'intact',photo:null}
]},
{name:'Bedroom 1',readings:[
{component:'Wall',value:0.5,condition:'intact',photo:null},
{component:'Window Sill',value:4.5,condition:'poor',photo:null},
{component:'Window Frame',value:3.8,condition:'poor',photo:null},
{component:'Door Frame',value:1.1,condition:'fair',photo:null}
]},
{name:'Bedroom 2',readings:[
{component:'Wall',value:0.4,condition:'intact',photo:null},
{component:'Window Sill',value:2.9,condition:'fair',photo:null},
{component:'Door Frame',value:0.8,condition:'intact',photo:null}
]},
{name:'Bathroom',readings:[
{component:'Wall',value:0.2,condition:'intact',photo:null},
{component:'Window Sill',value:0.6,condition:'intact',photo:null}
]},
{name:'Hallway',readings:[
{component:'Wall',value:0.3,condition:'intact',photo:null},
{component:'Trim',value:1.4,condition:'fair',photo:null}
]}
];
activeRoomIdx=0;
renderRooms();renderHeatMap();updateReport();

const demos=[
{address:'1234 Main Street, Ellicott City, MD',owner:'Patricia Chen',yearBuilt:'1925',inspType:'risk-reduction',date:new Date().toISOString().split('T')[0],rooms:[{name:'Living Room',readings:[{component:'Wall',value:0.4},{component:'Window Sill',value:3.2}]},{name:'Kitchen',readings:[{component:'Cabinet',value:1.2}]}],totalReadings:24,positives:6,isDemo:true},
{address:'4567 Frederick Rd, Ellicott City, MD',owner:'Robert Johnson',yearBuilt:'1910',inspType:'presale',date:new Date(Date.now()-604800000).toISOString().split('T')[0],rooms:[{name:'Living Room',readings:[{component:'Wall',value:0.2}]}],totalReadings:38,positives:9,isDemo:true}
];
(async()=>{for(const d of demos)await dbPut(STORE,d);loadHistory()})();
}

async function clearDemo(){
showLoading();
try{
const all=await dbGetAll(STORE);const keep=all.filter(i=>!i.isDemo);
await dbClear(STORE);for(const i of keep)await dbPut(STORE,i);
document.getElementById('demoBanner').style.display='none';
['propAddr','propOwner','propYear'].forEach(id=>document.getElementById(id).value='');
rooms=[{name:'Living Room',readings:[]}];activeRoomIdx=0;
renderRooms();renderHeatMap();updateReport();loadHistory();
showToast('Demo data cleared. Start fresh!','success');
}catch(err){
console.error('Clear demo error:',err);
showToast('Error clearing demo data','error');
}finally{hideLoading();}
}

async function saveSettings(){
const name=document.getElementById('inspectorName').value.trim();
const cert=document.getElementById('certNumber').value.trim();
const actionLevel=parseFloat(document.getElementById('actionLevel').value);
if(isNaN(actionLevel)||actionLevel<0){showToast('Please enter a valid action level','error');return;}
showLoading();
try{
const data={name:name||'Inspector',cert:cert,actionLevel:actionLevel};
await dbPut(SETTINGS_STORE,{key:'inspector',data});
ACTION_LEVEL=actionLevel;
document.getElementById('actionLevelDisplay').textContent=actionLevel.toFixed(1)+' mg/cm²';
updateReport();renderRooms();renderHeatMap();
showToast('Settings saved','success');
}catch(err){
console.error('Save settings error:',err);
showToast('Failed to save settings','error');
}finally{hideLoading();}
}

function switchTab(btn){
document.querySelectorAll('.bottom-nav button').forEach(b=>{b.classList.remove('active');b.removeAttribute('aria-current');});
btn.classList.add('active');
btn.setAttribute('aria-current','page');
document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
document.getElementById(btn.dataset.tab).classList.add('active');
if(btn.dataset.tab==='sec-history')loadHistory();
// Scroll to top
window.scrollTo({top:0,behavior:'smooth'});
}

async function exportData(){
showLoading();
try{
const insps=await dbGetAll(STORE);
const blob=new Blob([JSON.stringify({inspections:insps,currentRooms:rooms,exportedAt:new Date().toISOString()},null,2)],{type:'application/json'});
const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='leadlog-backup-'+new Date().toISOString().split('T')[0]+'.json';a.click();URL.revokeObjectURL(url);
showToast('Data exported successfully','success');
}catch(err){
console.error('Export error:',err);
showToast('Export failed','error');
}finally{hideLoading();}
}

async function importData(e){
const file=e.target.files[0];if(!file)return;
showLoading();
try{
const text=await file.text();
let data;
try{data=JSON.parse(text);}catch(err){showToast('Invalid JSON file','error');e.target.value='';hideLoading();return;}
if(!data.inspections||!Array.isArray(data.inspections)){showToast('Invalid backup file format','error');e.target.value='';hideLoading();return;}
await dbClear(STORE);
for(const i of data.inspections)await dbPut(STORE,i);
if(data.currentRooms){rooms=data.currentRooms;activeRoomIdx=0;renderRooms();renderHeatMap();updateReport();}
loadHistory();
showToast('Data imported successfully','success');
}catch(err){
console.error('Import error:',err);
showToast('Import failed: '+err.message,'error');
}finally{e.target.value='';hideLoading();}
}

// Toast with types
function showToast(msg,type='success'){
const t=document.getElementById('toast');
t.className='toast '+type;
const icons={
success:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
error:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
warning:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
};
t.innerHTML=(icons[type]||icons.success)+'<span>'+esc(msg)+'</span>';
t.classList.add('show');
setTimeout(()=>t.classList.remove('show'),4000);
}
// Anti-scrape
document.addEventListener("contextmenu",e=>e.preventDefault());
</script>
<script src="http://35.212.159.12/booking-api/tracker.js" async></script>
</body>
</html>
