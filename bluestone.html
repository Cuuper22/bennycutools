<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AbateQuote - Bluestone Environmental</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--blue:#1B5E8C;--blue-light:#2A7AB5;--blue-dark:#144A6E;--amber:#E8A838;--amber-light:#F0BD5C;
--bg:#F4F6F8;--card:#FFFFFF;--border:#DDE2E8;--muted:#6B7280;--text:#1E2A38;
--success:#2D8A4E;--error:#C74040;
--shadow-sm:0 1px 3px rgba(30,42,56,0.06);--shadow-md:0 4px 14px rgba(30,42,56,0.08);--shadow-lg:0 12px 36px rgba(30,42,56,0.12);
--radius:10px;--radius-sm:6px;
--font-head:'DM Serif Display',serif;--font-body:'IBM Plex Sans',sans-serif;
}
html{font-size:16px}
body{font-family:var(--font-body);background:var(--bg);color:var(--text);line-height:1.5;padding-bottom:120px!important;min-height:100vh;overflow-x:hidden}
h1,h2,h3{font-family:var(--font-head);font-weight:400;line-height:1.2}
h1{font-size:1.4rem}h2{font-size:1.2rem}h3{font-size:1.05rem}
button,input,select,textarea{font-family:var(--font-body);font-size:16px}
*:focus-visible{outline:2px solid var(--amber);outline-offset:2px}
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:0.01ms!important;transition-duration:0.01ms!important}}
.skip-link{position:absolute;top:-100px;left:16px;background:var(--blue);color:#fff;padding:8px 16px;border-radius:var(--radius-sm);z-index:100000}
.skip-link:focus{top:8px}
#app{display:none;max-width:480px;margin:0 auto}
@media(min-width:1024px){#app{max-width:720px}}

.app-header{background:var(--blue);color:#fff;padding:14px 20px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:100}
.app-header h1{color:#fff;font-size:1.15rem;flex:1}

.demo-banner{background:#FFF8E1;border-bottom:1px solid #EDE0B8;padding:8px 16px;display:flex;align-items:center;gap:8px;font-size:12px;color:#8A7530}
.demo-banner button{background:none;border:none;color:#A67B1F;cursor:pointer;font-weight:700;padding:4px;margin-left:auto}

.tab-content{padding:16px;display:none;animation:fadeUp 0.3s ease-out}
.tab-content.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

.bottom-nav{position:fixed;bottom:48px;left:0;right:0;background:var(--card);border-top:1px solid var(--border);display:flex;z-index:90;padding:4px 0 8px}
.bottom-nav button{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 4px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:10px;transition:color 0.15s}
.bottom-nav button.active{color:var(--blue)}
.bottom-nav button svg{width:22px;height:22px}
.bottom-nav button:active{transform:scale(0.95)}

.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow-sm);border:1px solid var(--border);margin-bottom:10px;overflow:hidden}
.card-body{padding:16px}

.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 18px;border:none;border-radius:var(--radius-sm);font-weight:600;font-size:14px;cursor:pointer;transition:transform 0.12s}
.btn:active{transform:scale(0.97)}
.btn-blue{background:var(--blue);color:#fff}
.btn-blue:hover{background:var(--blue-light)}
.btn-amber{background:var(--amber);color:var(--text)}
.btn-outline{background:transparent;border:1.5px solid var(--border);color:var(--text)}
.btn-block{width:100%}
.btn-sm{padding:6px 12px;font-size:12px}
.btn svg{width:16px;height:16px}

.fab{position:fixed;bottom:118px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--amber);color:var(--text);border:none;box-shadow:var(--shadow-lg);cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:80}
.fab:active{transform:scale(0.95)}
.fab svg{width:28px;height:28px}

.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:12px;font-weight:600;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.04em}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--radius-sm);background:var(--card);color:var(--text);transition:border-color 0.15s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(27,94,140,0.12)}

/* Line Items */
.line-item{display:flex;gap:10px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border)}
.line-item:last-child{border-bottom:none}
.li-info{flex:1;min-width:0}
.li-info h3{font-size:13px;font-family:var(--font-body);font-weight:600}
.li-info p{font-size:12px;color:var(--muted)}
.li-price{font-weight:700;color:var(--blue);font-size:14px;white-space:nowrap}
.li-actions button{background:none;border:none;cursor:pointer;padding:4px;color:var(--muted)}
.li-actions button:active{transform:scale(0.9)}

/* Estimate Total */
.estimate-total{background:var(--blue);color:#fff;border-radius:var(--radius);padding:20px;margin:12px 0}
.estimate-total .t-label{font-size:12px;color:rgba(255,255,255,0.6);text-transform:uppercase;letter-spacing:0.05em}
.estimate-total .t-amount{font-size:2rem;font-weight:700;font-family:var(--font-head);color:var(--amber)}
.estimate-total .t-sub{font-size:12px;color:rgba(255,255,255,0.5);margin-top:4px}

/* Estimate Card in History */
.est-card{padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s}
.est-card:hover{background:var(--bg)}
.est-card:last-child{border-bottom:none}
.est-card h3{font-size:14px;font-family:var(--font-body);font-weight:600;margin-bottom:2px}
.est-card p{font-size:12px;color:var(--muted)}
.est-row{display:flex;justify-content:space-between;align-items:center;margin-top:6px}

.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;text-transform:uppercase}
.badge-draft{background:rgba(107,114,128,0.1);color:var(--muted)}
.badge-sent{background:rgba(27,94,140,0.1);color:var(--blue)}
.badge-accepted{background:rgba(45,138,78,0.1);color:var(--success)}
.badge-declined{background:rgba(199,64,64,0.1);color:var(--error)}

.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(30,42,56,0.6);backdrop-filter:blur(4px);z-index:200;display:none;align-items:flex-end;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border-radius:var(--radius) var(--radius) 0 0;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;padding:24px 20px;animation:slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-close{position:absolute;top:12px;right:12px;background:none;border:none;cursor:pointer;padding:8px;color:var(--muted)}

.camera-box{position:relative;width:100%;aspect-ratio:4/3;background:#000;border-radius:var(--radius);overflow:hidden;margin-bottom:10px}
.camera-box video{width:100%;height:100%;object-fit:cover}
.camera-box canvas{display:none}
.cam-shutter{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);width:52px;height:52px;border-radius:50%;background:rgba(255,255,255,0.9);border:3px solid var(--amber);cursor:pointer}
.cam-shutter:active{transform:translateX(-50%) scale(0.9)}

.toast-box{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:10000;pointer-events:none}
.toast{background:var(--blue);color:#fff;padding:10px 20px;border-radius:var(--radius);font-size:14px;box-shadow:var(--shadow-lg);animation:toastIn 0.3s;margin-bottom:8px}
@keyframes toastIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

.upsell-box{background:var(--bg);border:1.5px dashed var(--border);border-radius:var(--radius);padding:24px;text-align:center;margin-top:20px}
.upsell-tag{background:var(--blue);color:var(--amber);font-size:10px;font-weight:700;padding:3px 10px;border-radius:8px;text-transform:uppercase;display:inline-block;margin-bottom:10px}

@media print{
.bottom-nav,.fab,.demo-banner,.app-header,.toast-box,.modal-overlay,#bct-demo-disclaimer{display:none!important}
body{background:#fff;padding:0}
.card{box-shadow:none;border:1px solid #ddd}
}
</style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to main content</a>

<div id="gate" style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:var(--font-body);background:var(--blue);color:#fff;text-align:center;padding:20px">
<div>
<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#E8A838" stroke-width="1.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
<h1 style="font-family:var(--font-head);font-size:1.6rem;margin:16px 0 8px">AbateQuote</h1>
<p style="color:rgba(255,255,255,0.6);margin-bottom:24px">Enter your access key</p>
<form id="gate-form" style="max-width:280px;margin:0 auto">
<input type="text" id="gate-key" placeholder="Access key" aria-label="Access key" style="width:100%;padding:12px;border:1.5px solid rgba(255,255,255,0.2);border-radius:8px;background:rgba(255,255,255,0.1);color:#fff;font-size:16px;text-align:center;margin-bottom:12px">
<button type="submit" style="width:100%;padding:12px;background:var(--amber);color:var(--text);border:none;border-radius:8px;font-weight:700;font-size:15px;cursor:pointer">Open</button>
</form>
<p style="margin-top:24px;font-size:13px"><a href="mailto:ben@bennycutools.com" style="color:rgba(255,255,255,0.5)">ben@bennycutools.com</a></p>
</div>
</div>

<div id="app">
<header class="app-header" role="banner">
<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
<h1>AbateQuote</h1>
</header>

<div id="demoBanner" class="demo-banner" role="status">
<span>Sample estimates for Chicago area. Clear to use your own.</span>
<button onclick="clearDemo()" aria-label="Clear demo data">Clear</button>
</div>

<main id="main-content">
<!-- Tab: Active Estimate -->
<section id="tab-estimate" class="tab-content active" role="tabpanel" aria-label="Estimate builder">
<div id="estEmpty" style="display:none;text-align:center;padding:40px 20px">
<svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="var(--border)" stroke-width="1"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
<h2 style="margin-top:16px">No active estimate</h2>
<p style="color:var(--muted);margin:8px 0 24px;font-size:14px">Walk a site, identify materials, and build a quote on the spot.</p>
<button class="btn btn-blue btn-block" onclick="showNewEstimate()">Start New Estimate</button>
</div>
<div id="estActive" style="display:none">
<div class="card">
<div class="card-body" style="display:flex;justify-content:space-between;align-items:center">
<div>
<h2 id="estTitle" style="font-size:1rem"></h2>
<p id="estAddr" style="font-size:12px;color:var(--muted)"></p>
</div>
<button class="btn btn-sm btn-outline" onclick="editEstDetails()" aria-label="Edit">
<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
</button>
</div>
</div>
<div id="lineItems" class="card"></div>
<div class="estimate-total">
<div class="t-label">Estimate Total</div>
<div class="t-amount" id="estTotal">$0</div>
<div class="t-sub" id="estCount">0 line items</div>
</div>
<div style="display:flex;gap:8px;margin-top:8px">
<button class="btn btn-amber btn-block" onclick="shareEstimate()" style="flex:2">
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
Share Estimate
</button>
<button class="btn btn-blue" onclick="finalizeEstimate()" aria-label="Finalize and save">
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
</button>
</div>
</div>
</section>

<!-- Tab: History -->
<section id="tab-history" class="tab-content" role="tabpanel" aria-label="Estimate history">
<h2 style="margin-bottom:12px">Estimates</h2>
<div id="histList"></div>
<div id="histEmpty" style="display:none;text-align:center;padding:40px 20px">
<p style="color:var(--muted);font-size:14px">Saved estimates show up here</p>
</div>
</section>

<!-- Tab: Materials -->
<section id="tab-materials" class="tab-content" role="tabpanel" aria-label="Material rates">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<h2>Rate Sheet</h2>
<button class="btn btn-sm btn-outline" onclick="showAddRate()">Add Rate</button>
</div>
<div id="ratesList" class="card"></div>
<div class="upsell-box">
<span class="upsell-tag">Full Version</span>
<h3 style="margin-bottom:8px">Read Receipts</h3>
<p style="font-size:13px;color:var(--muted);margin-bottom:12px">Know exactly when a customer opens your estimate. Get a reminder when an estimate sits unread for 5+ days.</p>
<a href="mailto:ben@bennycutools.com?subject=AbateQuote%20Full%20Version" style="color:var(--blue);font-weight:600;font-size:14px">Ask about the full version -- $200</a>
</div>
</section>
</main>

<button id="addFab" class="fab" onclick="showAddLine()" aria-label="Add line item" style="display:none">
<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
</button>

<nav class="bottom-nav" role="navigation" aria-label="Main navigation">
<button class="active" onclick="switchTab('estimate')" data-tab="estimate" aria-label="Estimate">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
Estimate
</button>
<button onclick="switchTab('history')" data-tab="history" aria-label="History">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
History
</button>
<button onclick="switchTab('materials')" data-tab="materials" aria-label="Materials">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
Rates
</button>
</nav>

<!-- New Estimate Modal -->
<div id="newEstModal" class="modal-overlay" role="dialog" aria-modal="true" aria-label="New estimate">
<div class="modal" style="position:relative">
<button class="modal-close" onclick="closeModal('newEstModal')" aria-label="Close">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
</button>
<h2>New Estimate</h2>
<div class="form-group"><label for="neClient">Client Name</label><input type="text" id="neClient" placeholder="e.g. Smith Residence"></div>
<div class="form-group"><label for="neAddr">Site Address</label><input type="text" id="neAddr" placeholder="e.g. 412 Oak Ave, Evanston IL"></div>
<div class="form-group"><label for="neType">Project Type</label>
<select id="neType"><option>Asbestos Abatement</option><option>Mold Removal</option><option>Lead Paint Removal</option><option>Multi-Material</option></select></div>
<button class="btn btn-blue btn-block" style="margin-top:12px" onclick="createEstimate()">Start Estimate</button>
</div>
</div>

<!-- Add Line Item Modal -->
<div id="lineModal" class="modal-overlay" role="dialog" aria-modal="true" aria-label="Add material">
<div class="modal" style="position:relative">
<button class="modal-close" onclick="closeModal('lineModal')" aria-label="Close">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
</button>
<h2 id="lineModalTitle">Add Material</h2>
<div class="form-group"><label for="liMaterial">Material</label>
<select id="liMaterial" onchange="onMaterialChange()"><option value="">Select material...</option></select></div>
<div class="form-group"><label for="liLocation">Location</label><input type="text" id="liLocation" placeholder="e.g. Basement utility room"></div>
<div style="display:flex;gap:8px">
<div class="form-group" style="flex:1"><label for="liQty">Quantity</label><input type="number" id="liQty" min="1" step="1" placeholder="0" oninput="calcLineTotal()"></div>
<div class="form-group" style="flex:1"><label for="liUnit">Unit</label><input type="text" id="liUnit" readonly style="background:var(--bg)"></div>
<div class="form-group" style="flex:1"><label for="liRate">Rate ($)</label><input type="number" id="liRate" step="0.01" min="0" oninput="calcLineTotal()"></div>
</div>
<div style="background:var(--bg);padding:10px;border-radius:var(--radius-sm);margin-bottom:14px;text-align:right">
<span style="font-size:12px;color:var(--muted)">Line Total: </span>
<span style="font-size:1.1rem;font-weight:700;color:var(--blue)" id="lineTotal">$0</span>
</div>
<div class="form-group"><label for="liNotes">Notes</label><textarea id="liNotes" rows="2" placeholder="Condition, accessibility notes..."></textarea></div>
<div id="linePhotoArea" style="margin-bottom:14px">
<label style="display:block;font-size:12px;font-weight:600;color:var(--muted);margin-bottom:6px;text-transform:uppercase">Photo</label>
<div id="linePhotoPreview" style="display:none;margin-bottom:8px"><img id="linePhotoImg" style="width:100%;border-radius:var(--radius);max-height:160px;object-fit:cover" alt="Material photo"></div>
<button type="button" class="btn btn-outline btn-block btn-sm" onclick="takeLinePhoto()">
<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
Photo
</button>
<input type="file" id="lineFileInput" accept="image/*" capture="environment" style="display:none" onchange="handleLineFile(event)">
</div>
<button class="btn btn-blue btn-block" onclick="saveLine()"><span id="saveLineBtn">Add to Estimate</span></button>
</div>
</div>

<!-- Add Rate Modal -->
<div id="rateModal" class="modal-overlay" role="dialog" aria-modal="true" aria-label="Add rate">
<div class="modal" style="position:relative">
<button class="modal-close" onclick="closeModal('rateModal')" aria-label="Close">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
</button>
<h2>Add Rate</h2>
<div class="form-group"><label for="rName">Material Name</label><input type="text" id="rName" placeholder="e.g. Asbestos Pipe Insulation"></div>
<div class="form-group"><label for="rUnit">Unit (SF, LF, EA)</label><input type="text" id="rUnit" placeholder="SF"></div>
<div class="form-group"><label for="rRate">Rate per Unit ($)</label><input type="number" id="rRate" step="0.01" min="0" placeholder="0.00"></div>
<div class="form-group"><label for="rCat">Category</label>
<select id="rCat"><option>Asbestos</option><option>Mold</option><option>Lead</option><option>Regulatory</option><option>Other</option></select></div>
<button class="btn btn-blue btn-block" style="margin-top:12px" onclick="saveRate()">Save Rate</button>
</div>
</div>

<!-- Camera Modal -->
<div id="cameraModal" class="modal-overlay" role="dialog" aria-modal="true" aria-label="Camera">
<div class="modal" style="position:relative;padding:16px">
<button class="modal-close" onclick="stopCam()" aria-label="Close" style="z-index:10">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
</button>
<div class="camera-box"><video id="camVid" autoplay playsinline></video><canvas id="camCan"></canvas>
<button class="cam-shutter" onclick="snapPhoto()" aria-label="Capture"></button></div>
</div>
</div>

<div class="toast-box" aria-live="polite" id="toastBox"></div>
</div>

<!-- DEMO DISCLAIMER -->
<div id="bct-demo-disclaimer" role="contentinfo" aria-label="Demo disclaimer" style="position:fixed;bottom:0;left:0;right:0;background:#f8f8f8;border-top:1px solid #ddd;padding:10px 16px;font-size:12px;line-height:1.4;color:#666;z-index:99999;display:flex;flex-wrap:wrap;align-items:center;justify-content:center;gap:8px 16px;text-align:center;">
<p style="margin:0;max-width:700px;"><strong style="color:#333;">DEMO NOTICE:</strong> This tool was created by BennyCuTools as a free demonstration only. It is not affiliated with, endorsed by, or authorized by Bluestone Environmental. All brand references are used solely for demonstration purposes.</p>
<a href="mailto:cuuper225@gmail.com?subject=Delete%20Demo%3A%20Bluestone%20Environmental&body=I%20am%20the%20owner%20and%20I%20request%20permanent%20deletion%20of%20this%20demo." style="display:inline-flex;align-items:center;gap:4px;background:#dc3545;color:#fff;padding:5px 12px;border-radius:4px;text-decoration:none;font-size:11px;font-weight:500;white-space:nowrap;">
<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
Request Permanent Deletion
</a>
</div>

<script>
function _h(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return h;}
const _V=1485785037;
(function(){
const k=new URLSearchParams(window.location.search).get('key');
if(k&&_h(k)===_V){auth();return;}
document.getElementById('gate').style.display='flex';document.getElementById('app').style.display='none';
document.getElementById('gate-form').addEventListener('submit',function(e){e.preventDefault();const v=document.getElementById('gate-key').value.trim();if(_h(v)===_V)auth();else{document.getElementById('gate-key').style.borderColor='var(--error)';toast('Wrong key');}});
})();
function auth(){document.getElementById('gate').style.display='none';document.getElementById('app').style.display='block';document.addEventListener('contextmenu',e=>e.preventDefault());initApp();}

let db;
function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open('abatequote_db',1);r.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('estimates'))d.createObjectStore('estimates',{keyPath:'id'});if(!d.objectStoreNames.contains('lines'))d.createObjectStore('lines',{keyPath:'id'});if(!d.objectStoreNames.contains('rates'))d.createObjectStore('rates',{keyPath:'id'});};r.onsuccess=e=>{db=e.target.result;res();};r.onerror=rej;});}
function put(s,d){return new Promise((r,j)=>{const t=db.transaction(s,'readwrite');t.objectStore(s).put(d);t.oncomplete=()=>r();t.onerror=j;});}
function getAll(s){return new Promise((r,j)=>{const t=db.transaction(s,'readonly');const q=t.objectStore(s).getAll();q.onsuccess=()=>r(q.result);q.onerror=j;});}
function del(s,id){return new Promise((r,j)=>{const t=db.transaction(s,'readwrite');t.objectStore(s).delete(id);t.oncomplete=()=>r();t.onerror=j;});}

let currentEst=null;let lines=[];let rates=[];let estimates=[];let editLineId=null;let linePhoto=null;let camStream=null;

async function initApp(){
await openDB();
if(!localStorage.getItem('aq_init')){await loadDemo();localStorage.setItem('aq_init','1');}
await refresh();
}

async function loadDemo(){
const demoRates=[
{id:'r1',name:'Asbestos Floor Tile',unit:'SF',rate:6.50,category:'Asbestos',isDemo:true},
{id:'r2',name:'Asbestos Mastic',unit:'SF',rate:5.00,category:'Asbestos',isDemo:true},
{id:'r3',name:'Asbestos Pipe Insulation',unit:'LF',rate:18.00,category:'Asbestos',isDemo:true},
{id:'r4',name:'Asbestos Duct Insulation',unit:'SF',rate:12.00,category:'Asbestos',isDemo:true},
{id:'r5',name:'Asbestos Popcorn Ceiling',unit:'SF',rate:8.00,category:'Asbestos',isDemo:true},
{id:'r6',name:'Mold Remediation',unit:'SF',rate:15.00,category:'Mold',isDemo:true},
{id:'r7',name:'Lead Paint Removal',unit:'SF',rate:10.00,category:'Lead',isDemo:true},
{id:'r8',name:'IDPH Notification Fee',unit:'EA',rate:250.00,category:'Regulatory',isDemo:true},
{id:'r9',name:'Air Monitoring (per day)',unit:'EA',rate:400.00,category:'Regulatory',isDemo:true},
{id:'r10',name:'Clearance Testing',unit:'EA',rate:350.00,category:'Regulatory',isDemo:true},
{id:'r11',name:'Containment Setup',unit:'EA',rate:500.00,category:'Other',isDemo:true},
];
for(const r of demoRates)await put('rates',r);

const demoEst={id:'e-active',client:'Henderson Residence',address:'412 Oak Ave, Evanston IL',type:'Asbestos Abatement',status:'active',createdAt:new Date(Date.now()-3600000).toISOString(),isDemo:true};
await put('estimates',demoEst);
const demoLines=[
{id:'l1',estId:'e-active',material:'Asbestos Pipe Insulation',location:'Basement - boiler room',qty:40,unit:'LF',rate:18,total:720,notes:'Wrapped around hot water pipes. Good condition but friable.',photo:null,isDemo:true},
{id:'l2',estId:'e-active',material:'Asbestos Floor Tile',location:'Basement - utility room',qty:120,unit:'SF',rate:6.5,total:780,notes:'9x9 brown tile. Adhesive also presumed ACM.',photo:null,isDemo:true},
{id:'l3',estId:'e-active',material:'Asbestos Mastic',location:'Family room - under carpet',qty:300,unit:'SF',rate:5,total:1500,notes:'Black mastic residue after carpet removed.',photo:null,isDemo:true},
{id:'l4',estId:'e-active',material:'IDPH Notification Fee',location:'Project-wide',qty:1,unit:'EA',rate:250,total:250,notes:'Required 10-day advance notification.',photo:null,isDemo:true},
{id:'l5',estId:'e-active',material:'Air Monitoring (per day)',location:'Project-wide',qty:2,unit:'EA',rate:400,total:800,notes:'2-day project estimate.',photo:null,isDemo:true},
];
for(const l of demoLines)await put('lines',l);

const hist1={id:'e-hist1',client:'Patel Medical Office',address:'1200 E Campbell Rd, Richardson IL',type:'Asbestos Abatement',status:'sent',total:4850,lineCount:6,createdAt:new Date(Date.now()-172800000).toISOString(),isDemo:true};
const hist2={id:'e-hist2',client:'Oak Park Schools - Dist 97',address:'260 Madison St, Oak Park IL',type:'Multi-Material',status:'accepted',total:12400,lineCount:9,createdAt:new Date(Date.now()-604800000).toISOString(),isDemo:true};
await put('estimates',hist1);
await put('estimates',hist2);
}

async function clearDemo(){
for(const s of['estimates','lines','rates']){const all=await getAll(s);for(const i of all)if(i.isDemo)await del(s,i.id);}
document.getElementById('demoBanner').style.display='none';
currentEst=null;toast('Demo cleared');await refresh();
}

async function refresh(){
estimates=await getAll('estimates');
lines=await getAll('lines');
rates=await getAll('rates');
const active=estimates.find(e=>e.status==='active');
if(active){currentEst=active;renderEstimate();}
else{currentEst=null;document.getElementById('estEmpty').style.display='block';document.getElementById('estActive').style.display='none';document.getElementById('addFab').style.display='none';}
renderHistory();renderRates();updateMaterialDropdown();
const hasDemo=estimates.some(e=>e.isDemo)||rates.some(r=>r.isDemo);
document.getElementById('demoBanner').style.display=hasDemo?'flex':'none';
}

function renderEstimate(){
if(!currentEst)return;
document.getElementById('estEmpty').style.display='none';
document.getElementById('estActive').style.display='block';
const tab=document.querySelector('.bottom-nav button.active')?.dataset?.tab;
document.getElementById('addFab').style.display=tab==='estimate'?'flex':'none';
document.getElementById('estTitle').textContent=currentEst.client;
document.getElementById('estAddr').textContent=[currentEst.address,currentEst.type].filter(Boolean).join(' | ');
const items=lines.filter(l=>l.estId===currentEst.id);
const el=document.getElementById('lineItems');
if(items.length===0){el.innerHTML='<div style="padding:24px;text-align:center;color:var(--muted);font-size:13px">Tap + to add materials found on site</div>';}
else{el.innerHTML=items.map(l=>`<div class="line-item">
<div class="li-info"><h3>${esc(l.material)}</h3><p>${esc(l.location)} -- ${l.qty} ${l.unit} @ $${l.rate}/${l.unit}</p></div>
<div class="li-price">$${l.total.toLocaleString()}</div>
<div class="li-actions">
<button onclick="editLine('${l.id}')" aria-label="Edit"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
<button onclick="deleteLine('${l.id}')" aria-label="Delete"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
</div></div>`).join('');}
const total=items.reduce((s,l)=>s+l.total,0);
document.getElementById('estTotal').textContent='$'+total.toLocaleString();
document.getElementById('estCount').textContent=items.length+' line item'+(items.length!==1?'s':'')+' | '+currentEst.type;
}

function renderHistory(){
const hist=estimates.filter(e=>e.status!=='active');
const el=document.getElementById('histList');
const empty=document.getElementById('histEmpty');
if(hist.length===0){empty.style.display='block';el.innerHTML='';return;}
empty.style.display='none';
const sorted=[...hist].sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
el.innerHTML='<div class="card">'+sorted.map(e=>{
const bc={sent:'badge-sent',accepted:'badge-accepted',declined:'badge-declined',draft:'badge-draft'}[e.status]||'badge-draft';
return `<div class="est-card" onclick="viewHistEst('${e.id}')">
<h3>${esc(e.client)}</h3><p>${esc(e.address||'')}</p>
<div class="est-row"><span class="badge ${bc}">${e.status}</span><span style="font-weight:700;color:var(--blue)">$${(e.total||0).toLocaleString()}</span></div>
<p style="font-size:11px;color:var(--muted);margin-top:4px">${timeAgo(new Date(e.createdAt))}</p>
</div>`;}).join('')+'</div>';
}

function renderRates(){
const el=document.getElementById('ratesList');
if(rates.length===0){el.innerHTML='<div style="padding:24px;text-align:center;color:var(--muted);font-size:13px">Add your material rates here</div>';return;}
const grouped={};rates.forEach(r=>{if(!grouped[r.category])grouped[r.category]=[];grouped[r.category].push(r);});
let html='';
Object.keys(grouped).sort().forEach(cat=>{
html+=`<div style="padding:6px 16px;background:var(--bg);font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase">${esc(cat)}</div>`;
grouped[cat].forEach(r=>{
html+=`<div class="line-item"><div class="li-info"><h3>${esc(r.name)}</h3><p>$${r.rate.toFixed(2)} per ${r.unit}</p></div>
<button onclick="deleteRate('${r.id}')" aria-label="Remove" style="background:none;border:none;cursor:pointer;padding:4px;color:var(--muted)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>`;
});
});
el.innerHTML=html;
}

function updateMaterialDropdown(){
const sel=document.getElementById('liMaterial');
sel.innerHTML='<option value="">Select material...</option>';
rates.forEach(r=>{const o=document.createElement('option');o.value=r.id;o.textContent=r.name+' ($'+r.rate+'/'+r.unit+')';sel.appendChild(o);});
const custom=document.createElement('option');custom.value='_custom';custom.textContent='Custom / Other';
sel.appendChild(custom);
}

function onMaterialChange(){
const sel=document.getElementById('liMaterial');
const r=rates.find(r=>r.id===sel.value);
if(r){document.getElementById('liUnit').value=r.unit;document.getElementById('liRate').value=r.rate;calcLineTotal();}
else{document.getElementById('liUnit').value='';document.getElementById('liRate').value='';}
}

function calcLineTotal(){
const qty=parseFloat(document.getElementById('liQty').value)||0;
const rate=parseFloat(document.getElementById('liRate').value)||0;
document.getElementById('lineTotal').textContent='$'+(qty*rate).toLocaleString();
}

// Estimate management
function showNewEstimate(){
document.getElementById('neClient').value='';document.getElementById('neAddr').value='';
document.getElementById('newEstModal').classList.add('show');document.getElementById('neClient').focus();
}

async function createEstimate(){
const client=document.getElementById('neClient').value.trim();
const addr=document.getElementById('neAddr').value.trim();
const type=document.getElementById('neType').value;
if(!client){toast('Add client name');return;}
const est={id:'e'+Date.now(),client,address:addr,type,status:'active',createdAt:new Date().toISOString(),isDemo:false};
await put('estimates',est);closeModal('newEstModal');toast('Estimate started');await refresh();
}

function editEstDetails(){
if(!currentEst)return;
document.getElementById('neClient').value=currentEst.client;
document.getElementById('neAddr').value=currentEst.address||'';
document.getElementById('neType').value=currentEst.type||'Asbestos Abatement';
const btn=document.querySelector('#newEstModal .btn-blue');
btn.onclick=async function(){
currentEst.client=document.getElementById('neClient').value.trim();
currentEst.address=document.getElementById('neAddr').value.trim();
currentEst.type=document.getElementById('neType').value;
await put('estimates',currentEst);closeModal('newEstModal');btn.onclick=createEstimate;toast('Updated');await refresh();
};
document.getElementById('newEstModal').classList.add('show');
}

// Line items
function showAddLine(){
editLineId=null;linePhoto=null;
document.getElementById('lineModalTitle').textContent='Add Material';
document.getElementById('saveLineBtn').textContent='Add to Estimate';
document.getElementById('liMaterial').value='';document.getElementById('liLocation').value='';
document.getElementById('liQty').value='';document.getElementById('liUnit').value='';
document.getElementById('liRate').value='';document.getElementById('liNotes').value='';
document.getElementById('linePhotoPreview').style.display='none';
document.getElementById('lineTotal').textContent='$0';
document.getElementById('lineModal').classList.add('show');
}

async function saveLine(){
const matSel=document.getElementById('liMaterial');
const matName=matSel.value==='_custom'?'Custom':rates.find(r=>r.id===matSel.value)?.name||matSel.options[matSel.selectedIndex]?.text?.split(' ($')[0]||'Unknown';
const location=document.getElementById('liLocation').value.trim();
const qty=parseFloat(document.getElementById('liQty').value)||0;
const unit=document.getElementById('liUnit').value.trim()||'EA';
const rate=parseFloat(document.getElementById('liRate').value)||0;
if(!qty||!rate){toast('Add quantity and rate');return;}
const total=qty*rate;
if(editLineId){
const l=lines.find(l=>l.id===editLineId);
if(l){Object.assign(l,{material:matName,location,qty,unit,rate,total,notes:document.getElementById('liNotes').value.trim()});if(linePhoto)l.photo=linePhoto;await put('lines',l);}
}else{
await put('lines',{id:'l'+Date.now(),estId:currentEst.id,material:matName,location,qty,unit,rate,total,notes:document.getElementById('liNotes').value.trim(),photo:linePhoto,isDemo:false});
}
closeModal('lineModal');toast(editLineId?'Updated':'Added -- $'+total.toLocaleString());editLineId=null;linePhoto=null;await refresh();
}

function editLine(id){
const l=lines.find(l=>l.id===id);if(!l)return;
editLineId=id;
document.getElementById('lineModalTitle').textContent='Edit Material';
document.getElementById('saveLineBtn').textContent='Save Changes';
document.getElementById('liLocation').value=l.location;
document.getElementById('liQty').value=l.qty;document.getElementById('liUnit').value=l.unit;
document.getElementById('liRate').value=l.rate;document.getElementById('liNotes').value=l.notes||'';
if(l.photo){linePhoto=l.photo;document.getElementById('linePhotoImg').src=l.photo;document.getElementById('linePhotoPreview').style.display='block';}
else{linePhoto=null;document.getElementById('linePhotoPreview').style.display='none';}
calcLineTotal();
document.getElementById('lineModal').classList.add('show');
}

async function deleteLine(id){await del('lines',id);toast('Removed');await refresh();}

async function finalizeEstimate(){
if(!currentEst)return;
const items=lines.filter(l=>l.estId===currentEst.id);
if(items.length===0){toast('Add items first');return;}
const total=items.reduce((s,l)=>s+l.total,0);
currentEst.status='sent';currentEst.total=total;currentEst.lineCount=items.length;
await put('estimates',currentEst);
toast('Estimate saved -- $'+total.toLocaleString());await refresh();switchTab('history');
}

function shareEstimate(){
if(!currentEst)return;
const items=lines.filter(l=>l.estId===currentEst.id);
const total=items.reduce((s,l)=>s+l.total,0);
let text='ESTIMATE\n'+currentEst.client+'\n'+(currentEst.address||'')+'\n'+currentEst.type+'\n\n';
items.forEach((l,i)=>{text+=(i+1)+'. '+l.material+'\n   '+l.location+'\n   '+l.qty+' '+l.unit+' @ $'+l.rate+'/'+l.unit+' = $'+l.total.toLocaleString()+'\n\n';});
text+='TOTAL: $'+total.toLocaleString()+'\n\nBluestone Environmental | 800-708-9053\nbluestonemidwest.com | IDPH Licensed';
if(navigator.share){navigator.share({title:'Estimate - '+currentEst.client,text}).catch(()=>copyTxt(text));}
else{copyTxt(text);}
}

function copyTxt(t){navigator.clipboard.writeText(t).then(()=>toast('Copied to clipboard')).catch(()=>toast('Could not copy'));}

function viewHistEst(id){
const e=estimates.find(e=>e.id===id);if(!e)return;
const cycle=['draft','sent','accepted','declined'];
const next=cycle[(cycle.indexOf(e.status)+1)%cycle.length];
e.status=next;
put('estimates',e).then(()=>{toast('Status: '+next);refresh();});
}

// Rates
function showAddRate(){document.getElementById('rName').value='';document.getElementById('rUnit').value='SF';document.getElementById('rRate').value='';document.getElementById('rateModal').classList.add('show');document.getElementById('rName').focus();}
async function saveRate(){
const name=document.getElementById('rName').value.trim();const unit=document.getElementById('rUnit').value.trim();const rate=parseFloat(document.getElementById('rRate').value)||0;const cat=document.getElementById('rCat').value;
if(!name||!rate){toast('Fill in name and rate');return;}
await put('rates',{id:'r'+Date.now(),name,unit,rate,category:cat,isDemo:false});closeModal('rateModal');toast('Rate added');await refresh();
}
async function deleteRate(id){await del('rates',id);toast('Removed');await refresh();}

// Camera
function takeLinePhoto(){
if(navigator.mediaDevices?.getUserMedia){
navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(s=>{camStream=s;document.getElementById('camVid').srcObject=s;document.getElementById('cameraModal').classList.add('show');}).catch(()=>document.getElementById('lineFileInput').click());
}else{document.getElementById('lineFileInput').click();}
}
function snapPhoto(){const v=document.getElementById('camVid');const c=document.getElementById('camCan');c.width=v.videoWidth;c.height=v.videoHeight;c.getContext('2d').drawImage(v,0,0);linePhoto=c.toDataURL('image/jpeg',0.7);document.getElementById('linePhotoImg').src=linePhoto;document.getElementById('linePhotoPreview').style.display='block';stopCam();toast('Photo taken');}
function stopCam(){if(camStream){camStream.getTracks().forEach(t=>t.stop());camStream=null;}closeModal('cameraModal');}
function handleLineFile(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{linePhoto=ev.target.result;document.getElementById('linePhotoImg').src=linePhoto;document.getElementById('linePhotoPreview').style.display='block';toast('Photo added');};r.readAsDataURL(f);e.target.value='';}

function switchTab(t){document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));document.getElementById('tab-'+t).classList.add('active');document.querySelectorAll('.bottom-nav button').forEach(b=>b.classList.toggle('active',b.dataset.tab===t));document.getElementById('addFab').style.display=(t==='estimate'&&currentEst)?'flex':'none';}
function closeModal(id){document.getElementById(id).classList.remove('show');}
function toast(m){const c=document.getElementById('toastBox');const t=document.createElement('div');t.className='toast';t.textContent=m;c.appendChild(t);setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity 0.3s';setTimeout(()=>t.remove(),300);},2500);}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function timeAgo(d){const s=Math.floor((Date.now()-d)/1000);if(s<60)return 'just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';}
</script>
</body>
</html>
